<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yousef Shtawi Schedule</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0c10;--s1:#12151c;--s2:#1a1e28;--s3:#232938;--brd:#2a3148;--brd2:#384160;--tx:#e2e6ef;--tx2:#8490a8;--tx3:#586380;--acc:#3b82f6;--acc2:#2563eb;--grn:#10b981;--red:#ef4444;--orn:#f59e0b;--pur:#8b5cf6;--cyn:#06b6d4;--r:10px;--ff:'Outfit',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--ff);background:var(--bg);color:var(--tx);min-height:100vh}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--s1)}::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:3px}
.topbar{background:var(--s1);border-bottom:1px solid var(--brd);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:300}
.topbar h1{font-size:17px;font-weight:800;letter-spacing:-.5px}.topbar h1 em{font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.top-r{display:flex;gap:8px;align-items:center;flex-shrink:0}
.shell{display:flex;min-height:calc(100vh - 52px)}.side{width:210px;background:var(--s1);border-right:1px solid var(--brd);padding:8px 0;flex-shrink:0;position:sticky;top:52px;height:calc(100vh - 52px);overflow-y:auto}.pane{flex:1;padding:20px 24px;overflow-x:auto;min-width:0}
.ns{padding:8px 14px 4px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1.8px;color:var(--tx3);margin-top:6px}
.ni{display:flex;align-items:center;gap:9px;padding:8px 14px;cursor:pointer;font-size:12.5px;font-weight:500;color:var(--tx2);transition:all .12s;border-left:3px solid transparent;user-select:none;position:relative}.ni:hover{color:var(--tx);background:var(--s2)}.ni.on{color:var(--acc);background:rgba(59,130,246,.07);border-left-color:var(--acc);font-weight:600}.ni .ic{width:16px;text-align:center;font-size:13px}.nb{margin-left:auto;font-size:9.5px;font-weight:700;background:var(--s3);color:var(--tx2);padding:1px 7px;border-radius:9px;font-family:var(--mono)}
.card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:14px;overflow:visible}.ch{padding:12px 16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between}.ch h3{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--tx2)}.cb{padding:14px 16px}
.btn{font-family:var(--ff);font-size:11.5px;font-weight:600;padding:6px 14px;border-radius:7px;cursor:pointer;transition:all .12s;border:none;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}.bp{background:var(--acc);color:#fff}.bp:hover{background:var(--acc2)}.bs2{background:var(--s3);color:var(--tx);border:1px solid var(--brd)}.bs2:hover{background:var(--brd)}.bd{background:#7f1d1d;color:#fca5a5}.bd:hover{background:#991b1b}.bg{background:#064e3b;color:#6ee7b7}.bg:hover{background:#065f46}.bsm{padding:4px 10px;font-size:10.5px}.bic{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;font-size:12px}
input,select{font-family:var(--ff);font-size:12.5px;background:var(--s2);border:1px solid var(--brd);border-radius:6px;padding:7px 10px;color:var(--tx);outline:none;transition:border .12s}input:focus,select:focus{border-color:var(--acc)}input[type=number]{width:62px;text-align:center;font-family:var(--mono)}input[type=color]{width:36px;height:34px;padding:2px;cursor:pointer;border-radius:4px}input[type=date]{width:148px}input[type=time]{width:110px;font-size:13px}select{cursor:pointer}label{font-size:11.5px;font-weight:500;color:var(--tx2)}.fr{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}.fg{display:flex;flex-direction:column;gap:3px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;font-size:13px;font-weight:500;z-index:9999;max-width:600px;text-align:center;opacity:0;transition:opacity .3s}.toast.show{opacity:1}.toast.ok{background:#052e16;border:1px solid #064e3b;color:#86efac}.toast.err{background:#450a0a;border:1px solid #7f1d1d;color:#fca5a5}
.tw{overflow-x:auto;border-radius:var(--r);border:1px solid var(--brd)}table{width:100%;border-collapse:collapse;font-size:12.5px}th{padding:9px 10px;background:var(--s2);font-weight:600;color:var(--tx2);font-size:10.5px;text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--brd);text-align:center;white-space:nowrap}td{padding:6px 10px;border-bottom:1px solid var(--brd);text-align:center;white-space:nowrap}td:first-child{text-align:left}tr:hover td{background:rgba(255,255,255,.02)}
.sb{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:24px;border-radius:5px;font-family:var(--mono);font-size:10.5px;font-weight:600;color:#fff}
.di{width:48px;text-align:center;background:transparent;border:1px solid transparent;color:var(--tx);font-family:var(--mono);font-size:12.5px;padding:3px;border-radius:4px}.di:hover{border-color:var(--brd)}.di:focus{border-color:var(--acc);background:var(--s2)}.dt{font-family:var(--mono);font-weight:700}.dok{color:var(--grn)}.dbd{color:var(--red)}
.ar{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:6px;margin-bottom:4px;background:var(--s2);transition:background .08s;font-size:13px}.ar:hover{background:var(--s3)}.gb{font-size:9.5px;font-weight:700;padding:2px 6px;border-radius:4px;font-family:var(--mono)}.gf{background:#4c1d95;color:#c4b5fd}.gm{background:#1e3a5f;color:#93c5fd}
.ir{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--s2);border-radius:6px;margin-bottom:4px;font-size:13px}.tg{font-size:9.5px;font-weight:700;padding:2px 7px;border-radius:4px;font-family:var(--mono);text-transform:uppercase}.tgh{background:#7f1d1d;color:#fca5a5}.tga{background:#064e3b;color:#6ee7b7}
.sg{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:14px}.sc{background:var(--s2);border-radius:8px;padding:10px;text-align:center}.scd{font-size:10px;font-weight:700;color:var(--tx2);text-transform:uppercase;margin-bottom:6px}.scs{display:flex;flex-wrap:wrap;gap:2px;justify-content:center}
.tgw{display:flex;align-items:center;gap:7px}.tg2{position:relative;width:36px;height:19px;background:var(--brd);border-radius:10px;cursor:pointer;transition:background .2s;flex-shrink:0}.tg2.on{background:var(--acc)}.tg2::after{content:'';position:absolute;top:2px;left:2px;width:15px;height:15px;background:#fff;border-radius:50%;transition:transform .2s}.tg2.on::after{transform:translateX(17px)}
.ph{margin-bottom:16px}.ph h2{font-size:18px;font-weight:700;letter-spacing:-.3px}.ph p{font-size:12px;color:var(--tx2);margin-top:3px}.emp{text-align:center;padding:28px;color:var(--tx3);font-size:12.5px}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:sp .5s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}
.day-checks{display:flex;gap:4px;flex-wrap:wrap}.day-checks label{display:inline-flex;align-items:center;gap:3px;font-size:11.5px;cursor:pointer;padding:3px 7px;border-radius:4px;background:var(--s3);border:1px solid var(--brd)}.day-checks input:checked+span{color:var(--acc);font-weight:600}
/* Shift card improved */
.shift-card{display:flex;align-items:center;gap:14px;padding:12px 16px;border-radius:8px;margin-bottom:6px;background:var(--s2);border-left:5px solid var(--acc)}.shift-card .s-badge{min-width:44px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:13px;font-weight:700;color:#fff}.shift-card .s-name{font-weight:600;font-size:14px;min-width:140px}.shift-card .s-time{font-family:var(--mono);font-size:14px;font-weight:500;color:var(--cyn);background:var(--s3);padding:4px 10px;border-radius:5px}
@media(max-width:860px){.side{position:fixed;left:-220px;top:52px;z-index:200;transition:left .2s;height:calc(100vh - 52px)}.side.open{left:0}.sg{grid-template-columns:repeat(4,1fr)}.pane{padding:12px}}
.ham{display:none;background:none;border:none;color:var(--tx);font-size:22px;cursor:pointer;padding:4px 8px}
@media(max-width:860px){.ham{display:inline-flex}}
</style>
</head>
<body>
<div class="topbar"><button class="ham" onclick="document.getElementById('sideNav').classList.toggle('open')">&#9776;</button><h1><em>Yousef Shtawi</em>&nbsp;Command Hub</h1><div class="top-r"><div class="tgw"><div class="tg2" id="tRand" onclick="this.classList.toggle('on')"></div><label style="font-size:11px;color:var(--tx2)">Random</label></div><input type="date" id="wkStart"><button class="btn bp" id="btnG" onclick="doGen()">&#9654; Generate</button><button class="btn bg" style="margin-left:4px" onclick="cloudSave()" id="btnCS" title="Save to Supabase">&#9729; Cloud Save</button></div></div>
<div class="shell">
<nav class="side" id="sideNav">
<div class="ni on" data-p="dashboard" style="margin-bottom:4px"><span class="ic">&#128200;</span>Dashboard</div>
<div class="ni" data-p="roster"><span class="ic">&#128197;</span>Schedule</div>
<div class="ni" data-p="dist"><span class="ic">&#9638;</span>Distribution</div>
<div class="ni" data-p="shifts"><span class="ic">&#9200;</span>Shifts<span class="nb" id="bS">0</span></div>
<div class="ni" data-p="rules"><span class="ic">&#9881;</span>Rules &amp; Gender</div>
<div class="ni" data-p="bksettings"><span class="ic">&#9881;</span>Break Settings</div>
<div class="ni" data-p="bkday"><span class="ic">&#9749;</span>Break Day View</div>
<div class="ni" data-p="bklive"><span class="ic" style="color:#10b981">&#9679;</span>Breaks Live</div>
<div class="ni" data-p="attendance"><span class="ic">&#9989;</span>Attendance</div>
<div class="ni" data-p="al"><span class="ic">&#128197;</span>Annual Leave</div>
<div class="ni" data-p="sr"><span class="ic">&#128221;</span>Requests</div>
<div class="ni" data-p="kpis"><span class="ic">&#128200;</span>Team KPIs</div>
<div class="ni" data-p="kb"><span class="ic">&#128214;</span>Knowledge Base</div>
<div class="ni" data-p="agents"><span class="ic">&#128101;</span>Agents<span class="nb" id="bA">0</span></div>
<div class="ni" data-p="coaching"><span class="ic">&#128100;</span>Coaching</div>
<div class="ni" data-p="conduct"><span class="ic">&#9888;</span>Conduct</div>
<div class="ni" data-p="archive"><span class="ic">&#128451;</span>Week Archive</div>
<div class="ni" data-p="aiagent"><span class="ic" style="color:#06b6d4">&#129302;</span>AI Agent</div>
<div style="flex:1"></div>
<div class="ni" data-p="cloud"><span class="ic">&#9881;</span>Settings</div>
</nav>
<div class="pane">
<div id="p-roster" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Weekly Roster</h2><p>Generated schedule â€” click any shift to swap</p></div><div style="display:flex;gap:6px;flex-wrap:wrap"><div style="display:flex;gap:4px;align-items:center;margin-right:8px"><button class="btn bs2 bsm" onclick="navWeek(-1)" title="Previous week">â—€ Prev</button><button class="btn bp bsm" onclick="navWeek(0)" title="Current week">Today</button><button class="btn bs2 bsm" onclick="navWeek(1)" title="Next week">Next â–¶</button><input type="date" id="rosterJump" onchange="jumpToWeek(this.value)" style="width:140px" title="Jump to date"></div><button class="btn bg bsm" onclick="saveWeekArchive()">&#128190; Save Week</button><button class="btn bs2 bsm" onclick="exportCSV()">&#128196; CSV</button><button class="btn bg bsm" onclick="exportXLSX()">&#128202; Excel</button><button class="btn bp bsm" onclick="exportTeamHTML()">&#128279; Team View</button></div></div><div id="rWeekLabel" style="font-family:var(--mono);font-size:12px;color:var(--cyn);margin-bottom:8px"></div><div id="rArea"><div class="emp">Configure settings then click <b>Generate</b>.</div></div><div id="sArea"></div></div>
<div id="p-dist" class="pg" style="display:none"><div class="ph"><h2>Daily Distribution</h2><p>Headcount per shift per day. Total must = agent count (<b id="dAC">0</b>).</p></div><div class="card"><div class="cb" style="overflow-x:auto"><table id="dTbl"></table></div></div><div class="card"><div class="ch"><h3>Quick Adjust</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Day</label><select id="qaDay" style="width:80px"></select></div><div class="fg"><label>From</label><select id="qaFrom" style="width:90px"></select></div><div class="fg"><label>To</label><select id="qaTo" style="width:90px"></select></div><div class="fg"><label>Amt</label><input type="number" id="qaAmt" value="1" min="1" style="width:50px"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="quickAdj()">Move</button></div></div></div></div></div>
<div id="p-agents" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Agents</h2><p>Manage team</p></div><div style="display:flex;gap:4px"><button class="btn bp bsm" onclick="showEl('addAF')">+ Add Agent</button><button class="btn bs2 bsm" onclick="showEl('agLinksPanel')">&#128279; Agent Links</button></div></div><div id="addAF" class="card" style="display:none"><div class="cb"><div class="fr"><div class="fg"><label>Name</label><input id="nAN" placeholder="Full name..." style="width:240px"></div><div class="fg"><label>Gender</label><select id="nAG"><option value="F">Female</option><option value="M" selected>Male</option></select></div><div style="display:flex;gap:4px;align-self:flex-end"><button class="btn bp bsm" onclick="addAgent()">Add</button><button class="btn bs2 bsm" onclick="hideEl('addAF')">Cancel</button></div></div></div></div><div id="agLinksPanel" class="card" style="display:none"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>&#128279; Agent Portal Links</h3><button class="btn bs2 bsm bic" onclick="hideEl('agLinksPanel')">&#10005;</button></div><div class="cb"><p style="font-size:11px;color:var(--tx2);margin-bottom:8px">Each agent gets a unique link to view their schedule, breaks, annual leave, and submit requests.</p><div id="agLinksArea" style="max-height:350px;overflow-y:auto"></div></div></div><div class="card"><div class="cb" id="aList"></div></div></div>
<div id="p-shifts" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Shift Definitions</h2><p>Add/edit/remove shifts</p></div><button class="btn bp bsm" onclick="showEl('addSF')">+ Add Shift</button></div><div id="addSF" class="card" style="display:none"><div class="cb"><div class="fr"><div class="fg"><label>Code</label><input id="nSI" placeholder="E" style="width:60px;text-transform:uppercase"></div><div class="fg"><label>Name</label><input id="nSN" placeholder="Evening" style="width:150px"></div><div class="fg"><label>Start</label><input type="time" id="nSS" value="09:00"></div><div class="fg"><label>End</label><input type="time" id="nSE" value="17:00"></div><div class="fg"><label>Color</label><input type="color" id="nSC" value="#6366f1"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="addShift()">Add</button></div></div></div></div><div id="sList"></div></div>
<div id="p-rules" class="pg" style="display:none"><div class="ph"><h2>Rules &amp; Gender</h2></div><div class="card"><div class="ch"><h3>Weekly Limits</h3></div><div class="cb"><div class="fr"><label style="width:220px">Max OFF / agent / week</label><input type="number" id="rMO" min="0" max="7" value="2"></div><div class="fr"><label style="width:220px">Max working days / agent / week</label><input type="number" id="rMW" min="1" max="7" value="5"></div><button class="btn bp bsm" style="margin-top:8px" onclick="saveRules()">Save</button></div></div><div class="card"><div class="ch"><h3>Gender â†’ Shift Restrictions</h3></div><div class="cb" id="grArea"></div></div></div>
<div id="p-al" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Annual Leave</h2><p>Year-based tracking, overlap validation, agent request portal</p></div><div style="display:flex;gap:6px"><button class="btn bs2 bsm" onclick="showEl('alRulesPanel')">&#9881; Rules</button><button class="btn bs2 bsm" onclick="showEl('alLinksPanel')">&#128279; Agent Links</button></div></div>
<div id="alRulesPanel" class="card" style="display:none;margin-bottom:14px"><div class="ch"><h3>Annual Leave Rules</h3><button class="btn bs2 bsm bic" onclick="hideEl('alRulesPanel')">âœ•</button></div><div class="cb"><div class="fr"><div class="fg"><label>Total AL days/year</label><input type="number" id="alrTotal" value="30" min="0" max="60" onchange="saveALRules()"></div><div class="fg"><label>Max concurrent agents on AL</label><input type="number" id="alrMaxConc" value="2" min="1" max="10" onchange="saveALRules()"></div><div class="fg"><label>Min notice (days)</label><input type="number" id="alrNotice" value="14" min="0" max="90" onchange="saveALRules()"></div></div><div class="fr" style="margin-top:8px"><div class="fg"><label>Min agents on shift</label><input type="number" id="alrMinCoverage" value="10" min="1" max="50" onchange="saveALRules()"></div><div class="fg"><label>Notify before (days)</label><input type="number" id="alrNotifyDays" value="7" min="1" max="30" onchange="saveALRules()"></div><div class="fg"><label>Blackout dates</label><input id="alrBlackout" placeholder="2026-12-25,2026-01-01" style="width:240px" onchange="saveALRules()"></div></div><div style="margin-top:10px;padding:8px 12px;background:var(--s3);border-radius:6px;font-size:11px;color:var(--tx2)">&#9432; Overlap rule: If <b>Max concurrent</b> is 2, any new request that overlaps with 2+ existing approved/ongoing leaves will be <b>blocked</b>. Set to 1 for strict single-agent AL.</div></div></div>
<div id="alLinksPanel" class="card" style="display:none;margin-bottom:14px"><div class="ch"><h3>&#128279; Agent Portal Links</h3><button class="btn bs2 bsm bic" onclick="hideEl('alLinksPanel')">âœ•</button></div><div class="cb" id="alLinksArea"></div></div>
<div id="alNotifications" style="margin-bottom:14px"></div>
<div style="display:flex;gap:6px;margin-bottom:14px"><button class="btn bs2 bsm alYearBtn" data-y="2025" onclick="setALYear(2025)">2025</button><button class="btn bp bsm alYearBtn" data-y="2026" onclick="setALYear(2026)">2026</button><button class="btn bs2 bsm alYearBtn" data-y="all" onclick="setALYear('all')">All</button></div>
<div class="card"><div class="ch"><h3>Add Leave</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="alA" style="width:240px"></select></div><div class="fg"><label>From</label><input type="date" id="alS"></div><div class="fg"><label>To</label><input type="date" id="alE"></div><div class="fg"><label>Status</label><select id="alSt"><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Completed">Completed</option><option value="Ongoing">Ongoing</option><option value="Rejected">Rejected</option></select></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="addAL()">Add Leave</button></div></div><div id="alPreview" style="margin-top:8px"></div></div></div>
<div class="card"><div class="ch"><h3>Leave Records</h3><span class="nb" id="alCount">0</span></div><div class="cb" id="alL"></div></div>
<div class="card"><div class="ch"><h3>Agent Balance Summary</h3></div><div class="cb" id="alBalance"></div></div>
<div id="alPendingRequests" style="margin-top:14px"></div></div>
<div id="p-sr" class="pg" style="display:none"><div class="ph"><h2>Special Requests</h2><p>Assign a weekly shift or specific-day overrides. Solver places OFFs automatically.</p></div><div class="card"><div class="ch"><h3>Add Request</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="srA" style="width:220px"></select></div><div class="fg"><label>Shift</label><select id="srSh" style="width:100px"></select></div></div><div style="margin:6px 0 4px"><label>Days</label></div><div class="fr" style="margin-bottom:10px"><div class="day-checks" id="srDays"></div><button class="btn bs2 bsm" onclick="toggleAllD()" style="margin-left:4px">All/None</button></div><button class="btn bp bsm" onclick="addSR()">Add Request</button></div></div><div class="card"><div class="cb" id="srL"></div></div></div>
<div id="p-attendance" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Attendance</h2><p>Track daily attendance â€” Present / Absent / Sick / Annual</p></div><div class="fr" style="flex-wrap:wrap"><button class="btn bs2 bsm" onclick="attPrevWeek()">â—€ Prev</button><input type="date" id="attWeek" onchange="renderAttendance()" style="width:140px"><button class="btn bs2 bsm" onclick="attNextWeek()">Next â–¶</button></div></div>
<div class="card" style="margin-bottom:12px"><div class="ch"><h3>ðŸ“Š Export Reports</h3></div><div class="cb">
<div class="fr" style="margin-bottom:8px"><div class="fg"><label>From</label><input type="date" id="attExpFrom"></div><div class="fg"><label>To</label><input type="date" id="attExpTo"></div><button class="btn bg bsm" style="align-self:flex-end" onclick="exportAttendanceRange()">ðŸ“¥ Export Payslip Report</button></div>
<div class="fr"><select id="attExpMonth" style="width:140px"></select><button class="btn bp bsm" onclick="exportNightShiftReport()">ðŸŒ™ Export C-Shift Monthly</button></div>
</div></div>
<div id="attArea"><div class="emp">Generate roster first.</div></div></div>
<div id="p-cloud" class="pg" style="display:none"><div class="ph"><h2>Settings &amp; Cloud Sync</h2><p>Save to Supabase, share with team, host your app</p></div>
<div class="card" style="margin-bottom:12px;border-left:3px solid var(--orn)"><div class="ch"><h3>&#127760; Host Online â€” Agent Links</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Your agent links use <code>file:///</code> which only works on your laptop. To share with agents, you need to host this file online. <b>Free options:</b></p>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px;margin-bottom:8px">
<b style="color:var(--grn)">Option 1: Netlify Drop (easiest â€” 30 seconds)</b><br>
1. Go to <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--cyn)">app.netlify.com/drop</a><br>
2. Drag and drop your YousefShtawiSchedule.html file<br>
3. You'll get a URL like <code>https://xyz-abc.netlify.app</code><br>
4. Agent links become: <code>https://xyz-abc.netlify.app/YousefShtawiSchedule.html?agent=ID</code>
</div>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px;margin-bottom:8px">
<b style="color:var(--grn)">Option 1: GitHub Pages (your current setup)</b><br>
Your repo: <code style="color:var(--cyn)">aizen993.github.io/Qmobility-Command-Hub/</code><br><br>
<b style="color:var(--orn)">To activate agent links:</b><br>
1. Go to your repo â†’ <b>Settings</b> tab (top menu)<br>
2. Scroll to <b>Pages</b> section (left sidebar)<br>
3. Under "Source", select <b>Deploy from a branch</b><br>
4. Select branch: <b>main</b>, folder: <b>/ (root)</b><br>
5. Click <b>Save</b><br>
6. Wait 1-2 minutes â†’ your site is live!<br>
7. <b>IMPORTANT:</b> Your HTML file must be named <code>index.html</code><br>
   â†’ Rename YousefShtawiSchedule.html to <code>index.html</code> in the repo<br>
8. Agent links become: <code>https://aizen993.github.io/Qmobility-Command-Hub/?agent=ID</code>
</div>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px">
<b style="color:var(--grn)">Option 3: Tiiny.host (instant)</b><br>
1. Go to <a href="https://tiiny.host" target="_blank" style="color:var(--cyn)">tiiny.host</a><br>
2. Upload the HTML file â†’ Get a shareable link instantly
</div>
<p style="font-size:10px;color:var(--tx3);margin-top:8px">Once hosted, all agent links will work from any device. The app still uses Supabase for data, so everything syncs automatically.</p>
</div></div>
<div id="cloudArea"></div>
<div class="card" style="margin-top:12px;border-left:3px solid var(--cyn)"><div class="ch"><h3>&#9729; Genesys Cloud Integration</h3></div><div class="cb">
<p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Connect to Genesys Cloud to auto-fetch agent AHT, interactions, hold time, and ACW data.</p>
<div class="fr" style="margin-bottom:8px"><div class="fg" style="flex:1"><label>Proxy URL</label><input id="genesysUrl" placeholder="https://your-project.vercel.app" style="width:100%" value=""></div>
<div style="align-self:flex-end;display:flex;gap:4px"><button class="btn bg bsm" onclick="setGenesysProxy(document.getElementById('genesysUrl').value);toast('Saved!')">Save</button><button class="btn bs2 bsm" onclick="testGenesysProxy()">Test</button></div></div>
<div id="genesysTestResult"></div>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px;margin-top:8px">
<b style="color:var(--orn)">Setup Steps:</b><br>
1. In Genesys Cloud: <b>Admin â†’ Integrations â†’ OAuth â†’ Add Client</b><br>
2. Grant Type: <b>Client Credentials</b> â†’ assign analytics roles<br>
3. Deploy the <code>genesys-proxy</code> folder to <a href="https://vercel.com" target="_blank" style="color:var(--cyn)">Vercel</a><br>
4. Set env vars: <code>GENESYS_CLIENT_ID</code>, <code>GENESYS_CLIENT_SECRET</code>, <code>GENESYS_REGION=mec1.pure.cloud</code><br>
5. Paste the Vercel URL above and click <b>Test</b>
</div>
</div></div></div>
<div id="p-bklive" class="pg" style="display:none"><div class="ph"><h2>Live Break View</h2><p>Real-time break tracking</p></div><div id="bkLiveArea"><div class="emp">Generate roster first, then generate breaks from <b>Break Settings</b>.</div></div></div>
<div id="p-bkday" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Day Break Schedule</h2><p>Click a day to view breaks</p></div><div style="display:flex;gap:4px" id="bkDayTabs"></div></div><div id="bkDayArea"><div class="emp">Generate breaks first.</div></div></div>
<div id="p-bksettings" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Break Settings</h2><p>Configure break patterns and peak windows</p></div><button class="btn bp" id="btnBK" onclick="genBreaks()">&#9654; Generate Breaks</button></div><div id="bkSettingsArea"></div></div>
<div id="p-archive" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Week Archive</h2><p>Saved schedules. Load any past week or import from file.</p></div><div style="display:flex;gap:6px"><button class="btn bp bsm" onclick="importWeekFile()">&#128194; Import JSON</button><input type="file" id="impFile" accept=".json" style="display:none" onchange="handleImport(event)"></div></div><div class="card"><div class="cb" id="archList"><div class="emp">No saved weeks yet. Generate a roster and click <b>Save Week</b>.</div></div></div></div>

<!-- AI AGENT PAGE -->
<div id="p-aiagent" class="pg" style="display:none">
<div class="ph" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
  <div><h2>&#129302; AI Agent</h2><p>DARB &amp; Mawaqif knowledge base â€” voice &amp; chat powered by ElevenLabs</p></div>
  <span id="aiKBStatus" style="font-size:10px;color:var(--tx3)"></span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:14px">
  <div class="card" style="border-left:3px solid var(--cyn)">
    <div class="ch"><h3 style="color:var(--cyn)">&#127908; Voice Mode</h3></div>
    <div class="cb" style="text-align:center;padding:20px 16px">
      <p style="font-size:12px;color:var(--tx2);margin-bottom:14px">Real-time voice with Qmobility AI Agent via WebRTC.</p>
      <div style="display:flex;justify-content:center;align-items:center;min-height:110px;background:var(--s2);border-radius:10px;padding:14px"><elevenlabs-convai agent-id="agent_1301kepw78ysfjm9d30gssmm6dja"></elevenlabs-convai></div>
      <p style="font-size:10px;color:var(--tx3);margin-top:10px">&#128274; Needs microphone permission</p>
    </div>
  </div>
  <div class="card" style="border-left:3px solid var(--acc)">
    <div class="ch" style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--acc)">&#128172; Chat Mode</h3>
      <div style="display:flex;gap:4px"><select id="agentChatMode" style="font-size:10px;padding:3px 6px;width:auto"><option value="kb">KB Only</option><option value="eleven" selected>ElevenLabs</option></select><button class="btn bs2 bsm" onclick="clearAgentChat()">Clear</button></div>
    </div>
    <div class="cb" style="padding:0">
      <div id="agentChatLog" style="height:280px;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px">
        <div style="background:var(--s3);border-radius:8px;padding:10px 12px;border-left:3px solid var(--acc)"><b style="color:var(--acc);font-size:11px">Qmobility Agent</b><br><span style="color:var(--tx2);font-size:12px">Hello! I have full knowledge of DARB tolling and Mawaqif parking. How can I help?</span></div>
      </div>
      <div id="agentTypingRow" style="display:none;padding:4px 12px;font-size:10px;color:var(--tx3)"><span class="spin" style="display:inline-block;width:10px;height:10px;border-width:2px;vertical-align:middle;margin-right:5px"></span>Searching...</div>
      <div style="padding:10px;border-top:1px solid var(--brd);display:flex;gap:6px">
        <input id="agentChatInput" placeholder="Ask about DARB, Mawaqif, procedures..." style="flex:1;font-size:12px" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAgentChat()}">
        <button class="btn bp bsm" onclick="sendAgentChat()" id="agentSendBtn">Send</button>
      </div>
    </div>
  </div>
</div>
<div class="card" style="margin-bottom:12px">
  <div class="ch"><h3>&#128161; Quick Prompts</h3></div>
  <div class="cb"><div style="display:flex;flex-wrap:wrap;gap:5px">
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('How to register in DARB toll system?')">DARB Registration</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('What happens if DARB account has insufficient balance?')">Low balance</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('How to dispute a Mawaqif fine?')">Dispute fine</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('Mawaqif parking fees and hours?')">Parking fees</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('How to handle angry customer call script?')">Angry customer</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('DARB toll fine grace period?')">Fine grace period</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('Mawaqif permit requirements?')">Mawaqif permit</button>
    <button class="btn bs2 bsm" onclick="agentQuickPrompt('Escalation procedure?')">Escalation</button>
  </div></div>
</div>
<div class="card">
  <div class="ch" style="display:flex;justify-content:space-between;align-items:center">
    <h3>&#128214; KB Articles â€” <span id="aiKBCount">132</span> loaded</h3>
    <div style="display:flex;gap:6px">
      <input id="aiKBSearch" placeholder="Search..." style="width:180px;font-size:11px" oninput="renderAIKB()">
      <select id="aiKBCat" style="font-size:11px;width:130px" onchange="renderAIKB()"><option value="">All</option><option>DARB FAQ</option><option>DARB Wallet</option><option>DARB Rules</option><option>DARB Guide</option><option>Mawaqif FAQ</option><option>Mawaqif Updates</option><option>Call Scripts</option><option>General Info</option></select>
    </div>
  </div>
  <div class="cb" id="aiKBList" style="max-height:300px;overflow-y:auto"><p style="color:var(--tx3)">Loading...</p></div>
</div>
</div>
<div id="p-dashboard" class="pg" style="display:none">
<div class="ph" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
  <div><h2>Dashboard</h2><p id="dashDateLine" style="color:var(--cyn);font-family:var(--mono);font-size:12px"></p></div>
  <button class="btn bs2 bsm" onclick="refreshGenesysLive()">&#9654; Live Refresh</button>
</div>
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:12px">
  <div class="card" style="border-left:3px solid var(--acc)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Total</div><div id="dashAgents" style="font-size:22px;font-weight:800">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--grn)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Working</div><div id="dashScheduled" style="font-size:22px;font-weight:800">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--red)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Off Today</div><div id="dashOffCount" style="font-size:22px;font-weight:800;color:var(--red)">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--cyn)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Clocked In</div><div id="dashPresent" style="font-size:22px;font-weight:800;color:var(--grn)">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--orn)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">On Break</div><div id="dashBreak" style="font-size:22px;font-weight:800;color:var(--orn)">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--pur)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Pend.Leave</div><div id="dashPendAL" style="font-size:22px;font-weight:800;color:var(--pur)">0</div></div></div>
  <div class="card" style="border-left:3px solid var(--red)"><div class="cb" style="padding:10px"><div style="font-size:9px;color:var(--tx2);text-transform:uppercase">Incidents</div><div id="dashIncidents" style="font-size:22px;font-weight:800;color:var(--red)">0</div></div></div>
</div>
<div class="card" style="margin-bottom:12px;border-left:3px solid var(--cyn)">
  <div class="ch" style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="color:var(--cyn)">&#9729; Genesys Live &nbsp;<span id="dashLiveTime" style="font-size:10px;font-weight:400;color:var(--tx3)"></span></h3>
    <div style="display:flex;align-items:center;gap:8px"><span id="dashLiveStatus" style="font-size:10px;color:var(--tx3)"></span><span id="dashSLBadge" style="font-size:12px;font-weight:700;padding:3px 12px;border-radius:12px;background:var(--s3);color:var(--tx2)">SL: â€”</span></div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:8px;padding:12px 16px;border-bottom:1px solid var(--brd)">
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Waiting</div><div id="dashWaiting" style="font-size:20px;font-weight:800;color:var(--red)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Answered</div><div id="dashAnswered" style="font-size:20px;font-weight:800;color:var(--grn)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Offered</div><div id="dashOffered" style="font-size:20px;font-weight:800;color:var(--acc)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Abandoned</div><div id="dashAbandonedNum" style="font-size:20px;font-weight:800;color:var(--orn)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Abandon%</div><div id="dashAbandoned" style="font-size:20px;font-weight:800;color:var(--orn)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Avg AHT</div><div id="dashAHT" style="font-size:20px;font-weight:800;color:var(--cyn)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">ASA</div><div id="dashASA" style="font-size:20px;font-weight:800;color:var(--pur)">â€”</div></div>
    <div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px">Longest Wait</div><div id="dashLongest" style="font-size:20px;font-weight:800;color:var(--pur)">â€”</div></div>
  </div>
  <div style="padding:10px 16px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;flex-wrap:wrap;gap:6px">
      <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--tx3);letter-spacing:.5px">Agent Status Live</div>
      <div style="display:flex;gap:6px;align-items:center">
        <label style="font-size:9px;color:var(--tx3);display:flex;align-items:center;gap:4px"><input type="checkbox" id="dashFilterCC" onchange="applyAgentStatusFilter()" checked> <span>CC Only</span></label>
        <select id="dashStatusFilter" onchange="applyAgentStatusFilter()" style="font-size:9px;padding:2px 5px;background:var(--s2);border:1px solid var(--brd);border-radius:4px;color:var(--tx)">
          <option value="all">All</option>
          <option value="online">Online Only</option>
          <option value="offline">Offline Only</option>
        </select>
      </div>
    </div>
    <div id="dashAgentStatusTable" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:5px;max-height:200px;overflow-y:auto"><div style="font-size:11px;color:var(--tx3);padding:6px">Click Live Refresh to load from Genesys</div></div>
  </div>
  <div id="dashLateAlerts" style="padding:0 16px 8px;display:none"><div style="font-size:9px;font-weight:700;color:var(--red);margin-bottom:4px;text-transform:uppercase">&#9888; Login Alerts</div><div id="dashLateAlertsList"></div></div>
  <div id="dashBreakAlerts" style="padding:0 16px 8px;display:none"><div style="font-size:9px;font-weight:700;color:var(--orn);margin-bottom:4px;text-transform:uppercase">&#9749; Break Compliance</div><div id="dashBreakAlertsList"></div></div>
  <!-- Agent QA compact row -->
  <div id="dashAgentQA" style="padding:8px 16px;border-top:1px solid var(--brd);display:none">
    <div style="font-size:9px;font-weight:700;text-transform:uppercase;color:var(--tx3);margin-bottom:5px;letter-spacing:.5px">Agent Quality Scores (Latest Month)</div>
    <div id="dashQAList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:4px"></div>
  </div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
  <div class="card"><div class="ch" style="display:flex;justify-content:space-between"><h3>&#128197; Shift Requests</h3><span id="dashSRCount" class="nb" style="background:var(--orn);color:#fff">0</span></div><div class="cb" id="dashSRList" style="max-height:200px;overflow-y:auto"><p style="color:var(--tx3);font-size:12px">No pending requests</p></div></div>
  <div class="card"><div class="ch" style="display:flex;justify-content:space-between"><h3>&#127774; Leave Requests</h3><span id="dashALCount2" class="nb" style="background:var(--pur);color:#fff">0</span></div><div class="cb" id="dashLeaveReq" style="max-height:200px;overflow-y:auto"><p style="color:var(--tx3);font-size:12px">No pending requests</p></div></div>
  <div class="card"><div class="ch"><h3>&#9888; Exceptions</h3></div><div class="cb" id="dashAttExc" style="max-height:200px;overflow-y:auto"><p style="color:var(--tx3);font-size:12px">No exceptions today</p></div></div>

<!-- Request History Log -->
<div style="margin-top:16px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <h3 style="font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:.5px">ðŸ“‹ Request History Log</h3>
    <div style="display:flex;gap:6px;align-items:center">
      <select id="dashHistoryFilter" onchange="renderRequestHistory()" style="font-size:10px;padding:3px 6px;background:var(--s2);color:var(--tx1);border:1px solid var(--brd);border-radius:4px">
        <option value="all">All Types</option>
        <option value="leave">Leave Only</option>
        <option value="shift">Shift Only</option>
      </select>
      <select id="dashHistoryStatus" onchange="renderRequestHistory()" style="font-size:10px;padding:3px 6px;background:var(--s2);color:var(--tx1);border:1px solid var(--brd);border-radius:4px">
        <option value="all">All Status</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
        <option value="Pending">Pending</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </div>
  </div>
  <div class="card" style="padding:0;overflow:hidden">
    <table style="width:100%;border-collapse:collapse;font-size:11px">
      <thead>
        <tr style="background:var(--s2);border-bottom:1px solid var(--brd)">
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Agent</th>
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Type</th>
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Request</th>
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Date Submitted</th>
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Status</th>
          <th style="padding:8px 10px;text-align:left;color:var(--tx3);font-weight:600;font-size:10px;text-transform:uppercase">Comment</th>
        </tr>
      </thead>
      <tbody id="dashHistoryBody">
        <tr><td colspan="6" style="padding:16px;text-align:center;color:var(--tx3)">No request history yet</td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>
</div>

<div id="p-kpis" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap"><div><h2>Team Performance Dashboard</h2><p>Monthly KPI tracking, outlier detection &amp; action plans</p></div><div style="display:flex;gap:4px"><select id="kpiMonth" onchange="renderKPIs()" style="width:130px"><option value="2026-02">Feb 2026</option><option value="2026-01">Jan 2026</option><option value="2025-12">Dec 2025</option><option value="2025-11">Nov 2025</option><option value="2025-10">Oct 2025</option><option value="2025-09">Sep 2025</option></select><button class="btn bp bsm" onclick="showEl('kpiEntry');buildKPIBulkTable()">+ Enter Data</button><button class="btn bg bsm" onclick="fetchGenesysKPIs()" id="btnGenesys" title="Fetch KPIs from Genesys Cloud">&#9729; Fetch Genesys</button></div></div>
<div id="genesysStatus" style="display:none;margin-bottom:8px"></div>
<div id="kpiSummary" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px"></div>
<div id="kpiEntry" style="display:none" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>&#128203; Bulk KPI Entry â€” Paste from Excel</h3><button class="btn bs2 bsm bic" onclick="hideEl('kpiEntry')">âœ•</button></div><div class="cb">
<div class="fr" style="margin-bottom:8px"><div class="fg"><label>Month</label><input type="month" id="kpiDataMonth" value="2026-02"></div>
<div style="display:flex;gap:4px;align-self:flex-end"><button class="btn bg bsm" onclick="saveAllKPI()">&#128190; Save All</button><button class="btn bs2 bsm" onclick="clearKPITable()">Clear</button></div></div>
<div style="margin-bottom:8px;padding:8px;background:var(--s2);border-radius:6px;border-left:3px solid var(--cyn)">
<p style="font-size:11px;color:var(--tx2);margin:0">&#128161; <b>Copy from Excel:</b> Select cells in Excel (columns: QA, AHT seconds, Unplanned, Adherence %, Interactions, CSAT) and paste directly into the table below. Agent names are pre-filled. You can also type values manually.</p>
</div>
<div class="tw" style="max-height:500px;overflow-y:auto"><table id="kpiBulkTable" style="font-size:11px;width:100%"><thead><tr><th style="text-align:left;min-width:180px">Agent</th><th style="min-width:65px">QA<br><span style="font-size:8px;color:var(--tx3);font-weight:400">0-100</span></th><th style="min-width:65px">AHT<br><span style="font-size:8px;color:var(--tx3);font-weight:400">seconds</span></th><th style="min-width:55px">Unplanned<br><span style="font-size:8px;color:var(--tx3);font-weight:400">leaves</span></th><th style="min-width:70px">Adherence<br><span style="font-size:8px;color:var(--tx3);font-weight:400">%</span></th><th style="min-width:75px">Interactions<br><span style="font-size:8px;color:var(--tx3);font-weight:400">count</span></th><th style="min-width:55px">CSAT<br><span style="font-size:8px;color:var(--tx3);font-weight:400">0-5 or %</span></th></tr></thead><tbody id="kpiBulkBody"></tbody></table></div>
</div></div>
<div class="card" style="margin-bottom:12px"><div class="ch"><h3>Agent KPIs â€” <span id="kpiMonthLabel">Feb 2026</span></h3></div><div class="cb"><div class="tw" id="kpiTable"></div></div></div>
<div class="card" style="margin-bottom:12px"><div class="ch"><h3>&#128202; Performance Charts</h3></div><div class="cb">
<div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap" id="kpiChartTabs"></div>
<div id="kpiChartArea" style="min-height:200px"><p style="color:var(--tx3)">Enter data to see charts</p></div>
</div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
<div class="card"><div class="ch"><h3 style="color:var(--red)">&#9888; Outliers &amp; Action Required</h3></div><div class="cb" id="kpiOutliers"><p style="color:var(--tx3)">Enter data to detect outliers</p></div></div>
<div class="card"><div class="ch"><h3 style="color:var(--grn)">&#127942; Top Performers</h3></div><div class="cb" id="kpiTop"><p style="color:var(--tx3)">Enter data to see rankings</p></div></div>
</div>
<div class="card"><div class="ch"><h3>&#128218; Recommended Training &amp; Action Plans</h3></div><div class="cb" id="kpiActions"><p style="color:var(--tx3)">Outliers will get automatic training recommendations</p></div></div></div>
<div id="p-kb" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Knowledge Base</h2><p>Articles, guides, and chat assistant</p></div><button class="btn bp bsm" onclick="showEl('kbAddForm')">+ New Article</button></div>
<div class="card" style="margin-bottom:12px"><div class="cb" style="display:flex;gap:8px"><input id="kbSearch" placeholder="Search articles, topics, keywords..." style="flex:1" oninput="renderKB()"><select id="kbCat" style="width:140px" onchange="renderKB()"><option value="">All Categories</option><option>Product</option><option>Process</option><option>Policy</option><option>Technical</option><option>Training</option></select></div></div>
<div class="card" style="margin-bottom:12px;border-left:3px solid var(--acc)"><div class="cb" style="display:flex;align-items:center;justify-content:space-between"><div><b style="font-size:13px">KB Chat Assistant</b><p style="font-size:11px;color:var(--tx2)">Ask questions and get instant answers from the knowledge base</p></div><button class="btn bp bsm" onclick="showEl('kbChat')">Open Chat</button></div></div>
<div id="kbChat" style="display:none;margin-bottom:12px" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>&#128172; KB Assistant</h3><button class="btn bs2 bsm bic" onclick="hideEl('kbChat')">âœ•</button></div><div class="cb"><div style="margin-bottom:6px;display:flex;gap:4px;align-items:center"><label style="font-size:10px;color:var(--tx2)">ChatGPT API Key:</label><input id="kbApiKey" type="password" placeholder="sk-..." style="flex:1;font-size:10px" value=""><button class="btn bs2 bsm" style="font-size:9px" onclick="localStorage.setItem('gpt_key',document.getElementById('kbApiKey').value);toast('Key saved')">Save</button></div><div id="kbChatLog" style="height:250px;overflow-y:auto;margin-bottom:8px;font-size:12px;padding:8px;background:var(--bg);border-radius:6px"><p style="color:var(--tx3)">Ask me anything about the knowledge base. If you provide a ChatGPT API key, I'll use AI to give detailed answers based on your KB articles.</p></div><div style="display:flex;gap:4px"><input id="kbChatIn" placeholder="Type a question..." style="flex:1" onkeydown="if(event.key==='Enter')kbAsk()"><button class="btn bp bsm" onclick="kbAsk()">Send</button></div></div></div>
<div id="kbAddForm" style="display:none;margin-bottom:12px" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>New Article</h3><button class="btn bs2 bsm bic" onclick="hideEl('kbAddForm')">âœ•</button></div><div class="cb"><div class="fr"><div class="fg"><label>Title</label><input id="kbTitle" style="width:300px"></div><div class="fg"><label>Category</label><select id="kbNewCat"><option>Product</option><option>Process</option><option>Policy</option><option>Technical</option><option>Training</option></select></div></div><div class="fg" style="margin-top:8px"><label>Content</label><textarea id="kbContent" rows="6" style="width:100%;resize:vertical"></textarea></div><div style="margin-top:8px;padding:10px;background:var(--s2);border-radius:6px;border:1px dashed var(--brd)"><div style="font-size:11px;font-weight:600;margin-bottom:4px">&#128194; Upload File to KB</div><p style="font-size:10px;color:var(--tx3);margin-bottom:6px">Upload .docx, .txt, .csv, .xlsx â€” content will be extracted and added as articles</p><input type="file" id="kbFileUpload" accept=".txt,.csv,.xlsx,.json,.docx,.doc" onchange="kbProcessFile(event)" style="font-size:10px"></div><button class="btn bp bsm" style="margin-top:8px" onclick="addKBArticle()">Save Article</button></div></div>
<div class="card"><div class="cb" id="kbList"><div class="emp" style="text-align:center"><span style="font-size:48px;opacity:.3">&#128214;</span><p style="margin-top:8px">No articles found. Create your first knowledge base article.</p></div></div></div></div>
<div id="p-coaching" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Coaching &amp; Development</h2><p>Track coaching sessions and agent development</p></div><button class="btn bp bsm" onclick="showEl('coachForm')">&#128100; New Session</button></div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Total Sessions</div><div id="coachTotal" style="font-size:24px;font-weight:800">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">This Month</div><div id="coachMonth" style="font-size:24px;font-weight:800;color:var(--orn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Follow-ups Needed</div><div id="coachFollow" style="font-size:24px;font-weight:800;color:var(--red)">0</div></div></div>
</div>
<div id="coachForm" style="display:none;margin-bottom:12px" class="card"><div class="ch"><h3>New Coaching Session</h3><button class="btn bs2 bsm bic" onclick="hideEl('coachForm')">âœ•</button></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="coachAgent" style="width:200px"></select></div><div class="fg"><label>Type</label><select id="coachType"><option>Quality</option><option>Performance</option><option>Behavior</option><option>Development</option></select></div><div class="fg"><label>Date</label><input type="date" id="coachDate"></div></div><div class="fg" style="margin-top:8px"><label>Notes</label><textarea id="coachNotes" rows="3" style="width:100%"></textarea></div><div style="display:flex;gap:4px;margin-top:6px"><label style="font-size:11px"><input type="checkbox" id="coachFup"> Needs follow-up</label></div><button class="btn bp bsm" style="margin-top:8px" onclick="addCoaching()">Save Session</button></div></div>
<div class="card"><div class="ch"><h3>Recent Coaching Sessions</h3></div><div class="cb" id="coachList"><p style="color:var(--tx3)">No coaching sessions recorded yet.</p></div></div></div>
<div id="p-conduct" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Behavior &amp; Conduct Management</h2><p>Log and track incidents</p></div><button class="btn bd bsm" onclick="showEl('incidentForm')">&#9888; Log Incident</button></div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Open Incidents</div><div id="condOpen" style="font-size:24px;font-weight:800;color:var(--red)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Critical</div><div id="condCrit" style="font-size:24px;font-weight:800;color:var(--orn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Improved</div><div id="condImpr" style="font-size:24px;font-weight:800;color:var(--grn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Repeated</div><div id="condRep" style="font-size:24px;font-weight:800;color:var(--pur)">0</div></div></div>
</div>
<div id="incidentForm" style="display:none;margin-bottom:12px" class="card"><div class="ch"><h3>Log Incident</h3><button class="btn bs2 bsm bic" onclick="hideEl('incidentForm')">âœ•</button></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="incAgent" style="width:200px"></select></div><div class="fg"><label>Severity</label><select id="incSev"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></div><div class="fg"><label>Type</label><select id="incType"><option>Attendance</option><option>Quality</option><option>Behavior</option><option>Policy Violation</option><option>Customer Complaint</option></select></div></div><div class="fg" style="margin-top:8px"><label>Description</label><textarea id="incDesc" rows="3" style="width:100%"></textarea></div><button class="btn bd bsm" style="margin-top:8px" onclick="addIncident()">Log Incident</button></div></div>
<div class="card"><div class="ch"><h3>All Incidents</h3></div><div class="cb" id="incList"><p style="color:var(--tx3)">No incidents recorded.</p></div></div></div>
</div></div>
<div id="loginOverlay" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:9000;align-items:center;justify-content:center"><div style="background:var(--s1);border:1px solid var(--brd);border-radius:12px;padding:32px;width:360px;text-align:center"><h1 style="font-size:20px;font-weight:800;margin-bottom:4px"><em style="font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Command Hub</h1><p style="color:var(--tx2);font-size:12px;margin-bottom:20px">Admin Login</p><input id="lEmail" placeholder="Email" style="width:100%;margin-bottom:8px;padding:10px"><input id="lPass" type="password" placeholder="Password" style="width:100%;margin-bottom:8px;padding:10px"><p id="lErr" style="color:var(--red);font-size:11px;margin-bottom:8px;min-height:16px"></p><button class="btn bp" style="width:100%;padding:12px" onclick="doLogin()">Sign In</button></div></div>
<div id="viewerBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#064e3b,#065f46);z-index:400;padding:8px 20px;align-items:center;justify-content:space-between"><span style="font-size:12px;font-weight:600;color:#6ee7b7">&#128279; Shared Live View â€” Read Only</span><span style="font-size:11px;color:#a7f3d0" id="viewerUpdate">Last updated: â€”</span></div>
<div id="toast" class="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

<script>
const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const uid=()=>Math.random().toString(36).slice(2,9);
const stableId=(name)=>{let h=0;for(let i=0;i<name.length;i++){h=((h<<5)-h)+name.charCodeAt(i);h|=0}return'a'+Math.abs(h).toString(36).slice(0,8)};
let D={
  shifts:[{id:"A",name:"Morning",start:"07:00",end:"16:00",color:"#059669"},{id:"MS",name:"Middle Support",start:"11:00",end:"20:00",color:"#d97706"},{id:"B",name:"Afternoon",start:"16:00",end:"01:00",color:"#7c3aed"},{id:"C",name:"Night",start:"00:00",end:"09:00",color:"#1e3a5f"}],
  agents:[
    ...["Nafisa Ali","AYA Alaeldin","Mennatallah Mohamed Farouk Mostafa Ismail","Amina Saad","Nadeen Ahmed Said Salem","Habiba Ayman Mohamed Refaat Mahmoud Elbassyouny","Shimaa Adel Abdelmanaem Khalil Ebrahem"].map(n=>({id:stableId(n),name:n,gender:"F"})),
    ...["Walid Hamdy Mahmoud Ahmed","Mohamed Nada","Omer Hassan","Mahmoud Yasser Mahmoud Zanker","Islam Abdalla Suliman Khalifa","Morad Mahmoud Hassen Mohamed Morad","Mohamed Magdi Mohamed Hassan Ali","Mohamed Ezzat Mohamed Hussein Sadiq","Amir Mounir RizqAllah Fam","Mohamed Ahmed Abdallah Zidan","Omar Nasreldien Mahrous","Mohamed Mahmoud Nasr Othman Kher","Ali Yasser Ali Elgohary","Abdelrahman Reda Mohamed Abouelnasr Elmaghraby"].map(n=>({id:stableId(n),name:n,gender:"M"}))
  ],
  rules:{max_off:2,max_work:5},
  genderRules:{F:["A","MS"],M:[]},
  dist:{Mon:{A:8,MS:2,B:5,C:1,OFF:5,AL:2},Tue:{A:7,MS:2,B:4,C:1,OFF:7,AL:2},Wed:{A:7,MS:2,B:4,C:1,OFF:7,AL:2},Thu:{A:7,MS:2,B:5,C:1,OFF:6,AL:2},Fri:{A:8,MS:2,B:5,C:1,OFF:5,AL:2},Sat:{A:8,MS:2,B:4,C:1,OFF:6,AL:2},Sun:{A:8,MS:2,B:4,C:1,OFF:6,AL:2}},
  al:[
{id:uid(),aid:"",name:"Mennatallah Mohamed Farouk Mostafa Ismail",start:"2025-08-25",end:"2025-09-07",status:"Completed"},
{id:uid(),aid:"",name:"Mennatallah Mohamed Farouk Mostafa Ismail",start:"2025-09-29",end:"2025-10-14",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Aly",start:"2025-07-01",end:"2025-07-17",status:"Completed"},
{id:uid(),aid:"",name:"Omar Nasreldien Mahrous",start:"2025-07-24",end:"2025-08-19",status:"Completed"},
{id:uid(),aid:"",name:"Nadeen Ahmed Said Salem",start:"2025-06-23",end:"2025-07-22",status:"Completed"},
{id:uid(),aid:"",name:"Abanoub Soliman",start:"2025-08-05",end:"2025-09-03",status:"Completed"},
{id:uid(),aid:"",name:"Amir Mounir RizqAllah Fam",start:"2025-07-21",end:"2025-08-05",status:"Completed"},
{id:uid(),aid:"",name:"Amir Mounir RizqAllah Fam",start:"2025-11-17",end:"2025-12-01",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Mahmoud Nasr Othman Kher",start:"2025-10-06",end:"2025-11-02",status:"Completed"},
{id:uid(),aid:"",name:"Nafisa Abdi",start:"2025-10-16",end:"2025-10-30",status:"Completed"},
{id:uid(),aid:"",name:"Nafisa Abdi",start:"2025-11-01",end:"2025-11-15",status:"Completed"},
{id:uid(),aid:"",name:"Mahmoud Yasser Mahmoud Zanker",start:"2025-11-07",end:"2025-12-09",status:"Completed"},
{id:uid(),aid:"",name:"AYA Alaeldin",start:"2025-09-14",end:"2025-09-28",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Magdi Mohamed Hassan Ali",start:"2025-09-03",end:"2025-09-15",status:"Completed"},
{id:uid(),aid:"",name:"Habiba Ayman Mohamed Refaat Mahmoud Elbassyouny",start:"2025-09-07",end:"2025-09-29",status:"Completed"},
{id:uid(),aid:"",name:"Joud Mohammad Alkurdi",start:"2025-07-31",end:"2025-08-20",status:"Completed"},
{id:uid(),aid:"",name:"Omer Hassan",start:"2025-12-05",end:"2025-12-30",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Ezzat Mohamed Hussein Sadiq",start:"2026-01-04",end:"2026-02-02",status:"Completed"},
{id:uid(),aid:"",name:"Morad Mahmoud Hassen Mohamed Morad",start:"2026-01-04",end:"2026-02-02",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Nada",start:"2026-02-01",end:"2026-03-02",status:"Ongoing"},
{id:uid(),aid:"",name:"Ahmed Nasser",start:"2025-12-10",end:"2025-12-31",status:"Completed"},
{id:uid(),aid:"",name:"Amina Saad",start:"2026-06-04",end:"2026-06-26",status:"Pending"},
{id:uid(),aid:"",name:"Islam Abdalla Suliman Khalifa",start:"2026-02-09",end:"2026-03-11",status:"Ongoing"},
{id:uid(),aid:"",name:"Omar Nasreldien Mahrous",start:"2026-03-02",end:"2026-04-03",status:"Pending"}
],sr:[],swapRequests:[],roster:null,summary:null
};
function allIds(){return D.shifts.map(s=>s.id).concat(["OFF","AL"])}
function workIds(){return D.shifts.map(s=>s.id)}
function sColor(sid){const s=D.shifts.find(x=>x.id===sid);if(s)return s.color;if(sid==="OFF")return"#4b5563";if(sid==="AL")return"#dc2626";return"#374151"}
function save(){try{localStorage.setItem("ys_v11",JSON.stringify(D))}catch(e){}}
function loadSaved(){try{const s=localStorage.getItem("ys_v11");if(s){const p=JSON.parse(s);if(p.agents&&p.shifts)Object.assign(D,p)}}catch(e){}}
function showEl(id){document.getElementById(id).style.display="block"}
function hideEl(id){document.getElementById(id).style.display="none"}
let toastT;function toast(m,t="ok"){const el=document.getElementById("toast");el.textContent=m;el.className="toast "+t+" show";clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove("show"),4000)}
document.getElementById("sideNav").addEventListener("click",e=>{const ni=e.target.closest(".ni");if(!ni)return;const p=ni.dataset.p;if(!p)return;document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-"+p).style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));ni.classList.add("on");document.getElementById("sideNav").classList.remove("open")});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOLVER â€” Two-phase with 12hr rest, consecutive OFFs, single-shift
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _shiftMins(sid){const s=D.shifts.find(x=>x.id===sid);if(!s)return null;const[sh,sm]=s.start.split(":").map(Number),[eh,em]=s.end.split(":").map(Number);let st=sh*60+sm,en=eh*60+em;if(en<=st)en+=1440;return{s:st,e:en}}
function _restOk(s1,s2){if(!s1||!s2)return true;const a=_shiftMins(s1),b=_shiftMins(s2);if(!a||!b)return true;const rest=(b.s+1440)-a.e;return rest>=720}
function _checkRest(sch,ai,wk){for(let di=0;di<6;di++){const s1=sch[ai][di],s2=sch[ai][di+1];if(wk.includes(s1)&&wk.includes(s2)&&!_restOk(s1,s2))return false}return true}
function solve(randomize){
  const agents=D.agents,N=agents.length,wk=workIds(),all=allIds();
  const maxOff=D.rules.max_off,maxWork=D.rules.max_work;
  const dist={};for(const d of DAYS){dist[d]={};for(const k of Object.keys(D.dist[d]))dist[d][k]=D.dist[d][k]}
  const errors=[];
  // Check totals
  for(const day of DAYS){const t=all.reduce((s,id)=>s+(dist[day][id]||0),0);if(t!==N){errors.push(`${day}: total=${t}, need ${N}. Fix Distribution.`);return{ok:false,errors}}}
  const gAllow=g=>{const r=D.genderRules[g]||[];return r.length?new Set(r.filter(x=>wk.includes(x))):new Set(wk)};
  const gAllowAll=g=>{const s=gAllow(g);s.add("OFF");return s};
  const idx={};agents.forEach((a,i)=>idx[a.id]=i);
  // Detect AL agents for this week
  const alAll=new Set();
  const ws=document.getElementById("wkStart").value;
  if(ws){const wd=new Date(ws+"T12:00:00");
    const nameIdx={};agents.forEach((a,i)=>nameIdx[a.name.toLowerCase().trim()]=i);
    for(const al of D.al){if(al.status==="Rejected"||al.status==="Completed")continue;
      const sd=new Date(al.start+"T12:00:00"),ed=new Date(al.end+"T12:00:00");
      let ai=idx[al.aid];if(ai===undefined&&al.name){ai=nameIdx[al.name.toLowerCase().trim()]}
      if(ai===undefined)continue;
      let fullWeek=true;for(let i=0;i<7;i++){const dd=new Date(wd);dd.setDate(wd.getDate()+i);if(!(dd>=sd&&dd<=ed)){fullWeek=false;break}}
      if(fullWeek)alAll.add(ai)}}
  // Build special requests map
  const srMap=Array.from({length:N},()=>({}));
  for(const sr of D.sr){if(idx[sr.aid]===undefined)continue;const ai=idx[sr.aid],di=DAYS.indexOf(sr.day);if(di>=0)srMap[ai][di]=sr.sid}
  // â”€â”€ Auto-balance distribution â”€â”€
  const actualAL=alAll.size;
  for(const day of DAYS){
    const distAL=dist[day].AL||0;
    if(distAL!==actualAL){
      let diff=distAL-actualAL;dist[day].AL=actualAL;
      while(diff>0){let bs=wk[0],bv=0;for(const s of wk){if((dist[day][s]||0)>=bv){bv=dist[day][s]||0;bs=s}}dist[day][bs]=(dist[day][bs]||0)+1;diff--}
      while(diff<0){let bs=wk[0],bv=0;for(const s of wk){if((dist[day][s]||0)>bv){bv=dist[day][s]||0;bs=s}}if(bv<=0)break;dist[day][bs]--;diff++}
    }
  }
  const nonAL=N-actualAL;
  // Auto-fix OFF capacity: if total OFF > nonAL*maxOff, reduce OFF and add to work shifts
  let totalOff=DAYS.reduce((s,d)=>s+(dist[d].OFF||0),0);
  while(totalOff>nonAL*maxOff){
    let bd=null,bv=0;for(const d of DAYS){if((dist[d].OFF||0)>bv){bv=dist[d].OFF||0;bd=d}}
    if(!bd||bv<=0)break;dist[bd].OFF--;
    let bs=wk[0],sv=0;for(const s of wk){if((dist[bd][s]||0)>=sv){sv=dist[bd][s]||0;bs=s}}
    dist[bd][bs]=(dist[bd][bs]||0)+1;totalOff--;
  }
  const totalWork=DAYS.reduce((s,d)=>s+wk.reduce((s2,id)=>s2+(dist[d][id]||0),0),0);
  if(totalWork>nonAL*maxWork){errors.push(`Need ${totalWork} work slots but only ${nonAL}*${maxWork}=${nonAL*maxWork} capacity.`);return{ok:false,errors}}
  // â”€â”€ RNG â”€â”€
  let seed=randomize?Date.now():42;
  const rng=()=>{seed=(seed*16807)%2147483647;return(seed-1)/2147483646};
  const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b};

  // â”€â”€ Helper: count agent's assigned shifts â”€â”€
  const countWork=(sch,ai)=>{let c=0;for(let di=0;di<7;di++)if(wk.includes(sch[ai][di]))c++;return c};
  const countOff=(sch,ai)=>{let c=0;for(let di=0;di<7;di++)if(sch[ai][di]==="OFF")c++;return c};
  const countShiftDay=(sch,di,sid)=>{let c=0;for(let ai=0;ai<N;ai++)if(sch[ai][di]===sid)c++;return c};

  // â”€â”€ Main solver loop â”€â”€
  let bestSch=null,bestScore=-1;
  const maxAttempts=6000;
  for(let attempt=0;attempt<maxAttempts;attempt++){
    seed=(randomize?Date.now():42)+attempt*7+attempt;
    const sch=Array.from({length:N},()=>Array(7).fill(null));
    // 1. Place AL
    for(const ai of alAll)for(let di=0;di<7;di++)sch[ai][di]="AL";
    // 2. Place special requests (hard constraints)
    for(let ai=0;ai<N;ai++)if(!alAll.has(ai))for(const di in srMap[ai])sch[ai][parseInt(di)]=srMap[ai][di];

    // 3. Count how many work shifts are pre-assigned per agent via special requests
    // and figure out how many OFFs each agent NEEDS
    const agentPreWork=Array(N).fill(0);
    const agentPreOff=Array(N).fill(0);
    const agentPreFilled=Array(N).fill(0);
    for(let ai=0;ai<N;ai++){
      if(alAll.has(ai))continue;
      for(let di=0;di<7;di++){
        if(sch[ai][di]!==null){
          agentPreFilled[ai]++;
          if(wk.includes(sch[ai][di]))agentPreWork[ai]++;
          if(sch[ai][di]==="OFF")agentPreOff[ai]++;
        }
      }
    }

    // 4. Assign OFF days â€” smarter approach
    // For each agent, determine how many OFFs they still need
    // Account for special requests that are already OFF or work shifts
    const dayOffCounts=DAYS.map((d,di)=>{let have=0;for(let ai=0;ai<N;ai++)if(sch[ai][di]==="OFF")have++;return{di,need:dist[d].OFF||0,have}});
    
    // Sort agents: those with more special requests (less flexibility) get OFFs first
    const agentOrder=shuffle([...Array(N).keys()].filter(ai=>!alAll.has(ai)))
      .sort((a,b)=>{
        const flexA=7-agentPreFilled[a];
        const flexB=7-agentPreFilled[b];
        return flexA-flexB; // less flexible agents first
      });
    
    for(const ai of agentOrder){
      const myOffs=countOff(sch,ai);
      const needed=maxOff-myOffs;
      if(needed<=0)continue;
      
      // Check: if agent already has too many work requests, they may need more OFFs
      // But cap at maxOff
      const emptySlots=[];
      for(let di=0;di<7;di++)if(sch[ai][di]===null)emptySlots.push(di);
      
      if(emptySlots.length<needed)continue; // can't place enough OFFs, skip (will try to fix later)
      
      // Try consecutive pairs first
      const offPairs=[];
      for(let i=0;i<emptySlots.length-1;i++){
        if(emptySlots[i+1]-emptySlots[i]===1)offPairs.push([emptySlots[i],emptySlots[i+1]]);
      }
      
      let placed=false;
      if(needed===2&&myOffs===0){
        const sp=shuffle(offPairs);
        // First try: both days under their target
        for(const[d1,d2]of sp){
          if(dayOffCounts[d1].have<dayOffCounts[d1].need&&dayOffCounts[d2].have<dayOffCounts[d2].need){
            sch[ai][d1]="OFF";sch[ai][d2]="OFF";dayOffCounts[d1].have++;dayOffCounts[d2].have++;placed=true;break;
          }
        }
        // Second try: at least one day under target
        if(!placed){
          for(const[d1,d2]of sp){
            if(dayOffCounts[d1].have<dayOffCounts[d1].need||dayOffCounts[d2].have<dayOffCounts[d2].need){
              sch[ai][d1]="OFF";sch[ai][d2]="OFF";dayOffCounts[d1].have++;dayOffCounts[d2].have++;placed=true;break;
            }
          }
        }
        // Third try: any consecutive empty pair
        if(!placed&&sp.length>0){
          const[d1,d2]=sp[0];
          sch[ai][d1]="OFF";sch[ai][d2]="OFF";dayOffCounts[d1].have++;dayOffCounts[d2].have++;placed=true;
        }
      }
      
      if(!placed){
        // Place individual OFFs prioritizing days that need more OFFs
        const sortedEmpty=shuffle([...emptySlots]).sort((a,b)=>
          (dayOffCounts[b].need-dayOffCounts[b].have)-(dayOffCounts[a].need-dayOffCounts[a].have));
        let cnt=myOffs;
        for(const di of sortedEmpty){
          if(cnt>=maxOff)break;
          sch[ai][di]="OFF";dayOffCounts[di].have++;cnt++;
        }
      }
    }

    // 5. Fix OFF distribution: if some days have too many/few OFFs, swap OFFs between agents
    for(let fixIter=0;fixIter<200;fixIter++){
      let offOk=true;
      for(let di=0;di<7;di++){
        const need=dist[DAYS[di]].OFF||0;
        const have=countShiftDay(sch,di,"OFF");
        if(have>need){
          offOk=false;
          // Find an agent with OFF on this day who can move their OFF elsewhere
          const cands=[];
          for(let ai=0;ai<N;ai++){
            if(alAll.has(ai)||sch[ai][di]!=="OFF")continue;
            if(srMap[ai][di]!==undefined)continue; // special request, can't move
            cands.push(ai);
          }
          const sc=shuffle(cands);
          let fixed=false;
          for(const ai of sc){
            if(fixed)break;
            // Find a day where this agent has a work shift and that day needs more OFFs
            for(let dj=0;dj<7;dj++){
              if(dj===di||sch[ai][dj]===null||sch[ai][dj]==="OFF"||sch[ai][dj]==="AL")continue;
              if(srMap[ai][dj]!==undefined)continue;
              const djNeed=dist[DAYS[dj]].OFF||0;
              const djHave=countShiftDay(sch,dj,"OFF");
              if(djHave>=djNeed)continue;
              // Swap: remove OFF from di, put work shift; put OFF on dj
              sch[ai][di]=null; // will be filled later
              sch[ai][dj]="OFF";
              dayOffCounts[di].have--;dayOffCounts[dj].have++;
              fixed=true;break;
            }
          }
          // If we couldn't swap, just remove the OFF and leave null
          if(!fixed&&sc.length>0){
            const ai=sc[0];
            sch[ai][di]=null;dayOffCounts[di].have--;
            // try to place OFF on any day that needs it
            for(let dj=0;dj<7;dj++){
              if(sch[ai][dj]!==null)continue;
              const djNeed=dist[DAYS[dj]].OFF||0;
              const djHave=countShiftDay(sch,dj,"OFF");
              if(djHave<djNeed){sch[ai][dj]="OFF";dayOffCounts[dj].have++;break}
            }
          }
        }
      }
      if(offOk)break;
    }

    // 6. Fill remaining nulls with work shifts, respecting gender + distribution need
    for(let di=0;di<7;di++){
      const dayCounts={};for(const s of all)dayCounts[s]=0;
      for(let ai=0;ai<N;ai++)if(sch[ai][di]!==null)dayCounts[sch[ai][di]]=(dayCounts[sch[ai][di]]||0)+1;
      const unfilled=[];for(let ai=0;ai<N;ai++)if(!alAll.has(ai)&&sch[ai][di]===null)unfilled.push(ai);

      // Build need list: what shifts still need to be filled
      const needs=[];
      for(const s of wk){const need=(dist[DAYS[di]][s]||0)-(dayCounts[s]||0);for(let j=0;j<Math.max(0,need);j++)needs.push(s)}
      const offNeed=Math.max(0,(dist[DAYS[di]].OFF||0)-(dayCounts.OFF||0));
      for(let j=0;j<offNeed;j++)needs.push("OFF");

      // Sort unfilled agents: assign gender-restricted agents first (females first since they have fewer options)
      const sortedUnfilled=shuffle(unfilled).sort((a,b)=>{
        const ga=gAllow(agents[a].gender).size;
        const gb=gAllow(agents[b].gender).size;
        return ga-gb; // fewer options first
      });

      // Smart assignment: for each agent, find the best matching need
      const needsAvail=[...needs];
      for(const ai of sortedUnfilled){
        if(needsAvail.length===0){
          // Overflow: assign any compatible work shift
          sch[ai][di]=[...gAllow(agents[ai].gender)][0]||"A";
          continue;
        }
        const allowed=gAllowAll(agents[ai].gender);
        // Check work limit
        const curWork=countWork(sch,ai);
        const curOff=countOff(sch,ai);
        
        // Find best need for this agent
        let bestIdx=-1;
        for(let j=0;j<needsAvail.length;j++){
          const s=needsAvail[j];
          if(s==="OFF"){
            if(curOff>=maxOff)continue;
            bestIdx=j;break;
          }
          if(!allowed.has(s))continue;
          if(curWork>=maxWork)continue;
          // Check rest constraint
          const old=sch[ai][di];sch[ai][di]=s;
          const rok=_checkRest(sch,ai,wk);sch[ai][di]=old;
          if(!rok)continue;
          bestIdx=j;break;
        }
        if(bestIdx===-1){
          // Fallback: try any need
          for(let j=0;j<needsAvail.length;j++){
            const s=needsAvail[j];
            if(s==="OFF"&&curOff<maxOff+1){bestIdx=j;break}
            if(allowed.has(s)){bestIdx=j;break}
          }
        }
        if(bestIdx>=0){
          sch[ai][di]=needsAvail[bestIdx];
          needsAvail.splice(bestIdx,1);
        }else{
          // Last resort
          if(curWork<maxWork)sch[ai][di]=[...gAllow(agents[ai].gender)][0]||"A";
          else sch[ai][di]="OFF";
        }
      }
    }

    // 7. Enhanced repair phase: fix distribution mismatches
    for(let iter=0;iter<500;iter++){
      let allOk=true;
      for(let di=0;di<7;di++){
        const dd=dist[DAYS[di]],counts={};
        for(let ai=0;ai<N;ai++)counts[sch[ai][di]]=(counts[sch[ai][di]]||0)+1;
        for(const sOver of all){
          const excess=(counts[sOver]||0)-(dd[sOver]||0);if(excess<=0)continue;allOk=false;
          for(const sUnder of all){
            const deficit=(dd[sUnder]||0)-(counts[sUnder]||0);if(deficit<=0)continue;
            const cands=[];
            for(let ai=0;ai<N;ai++){
              if(alAll.has(ai)||sch[ai][di]!==sOver)continue;
              if(srMap[ai][di]!==undefined)continue;
              if(sUnder!=="OFF"&&sUnder!=="AL"&&!gAllow(agents[ai].gender).has(sUnder))continue;
              if(sUnder==="OFF"&&countOff(sch,ai)>=maxOff+1)continue;
              if(sOver==="OFF"&&countOff(sch,ai)<=0)continue;
              if(wk.includes(sUnder)&&countWork(sch,ai)>=maxWork)continue;
              if(wk.includes(sOver)&&countWork(sch,ai)<=0)continue;
              const old=sch[ai][di];sch[ai][di]=sUnder;
              const rok=_checkRest(sch,ai,wk);sch[ai][di]=old;
              if(!rok)continue;cands.push(ai)}
            const sc=shuffle(cands);let sw=0;
            for(const ai of sc){
              if(sw>=Math.min(excess,deficit))break;
              sch[ai][di]=sUnder;
              counts[sOver]--;counts[sUnder]=(counts[sUnder]||0)+1;
              sw++;
            }
            if(sw>0)break;
          }
        }
      }
      // Cross-day repair: if a shift is over on day A and under on day B, try to swap an agent's assignment
      if(!allOk){
        for(let di=0;di<7;di++){
          const dd=dist[DAYS[di]],counts={};
          for(let ai=0;ai<N;ai++)counts[sch[ai][di]]=(counts[sch[ai][di]]||0)+1;
          for(const sOver of all){
            const excess=(counts[sOver]||0)-(dd[sOver]||0);if(excess<=0)continue;
            // Find another day where sOver is under-assigned and some other shift is over
            for(let dj=0;dj<7;dj++){
              if(dj===di)continue;
              const ddj=dist[DAYS[dj]],countsj={};
              for(let ai=0;ai<N;ai++)countsj[sch[ai][dj]]=(countsj[sch[ai][dj]]||0)+1;
              const excessJ=(countsj[sOver]||0)-(ddj[sOver]||0);
              // We need sOver to be under-assigned on dj (or at least not over)
              if(excessJ>0)continue; // also over there, no help
              // Find an agent on di with sOver who could swap with an agent on dj
              for(let aiA=0;aiA<N;aiA++){
                if(alAll.has(aiA)||sch[aiA][di]!==sOver||srMap[aiA][di]!==undefined)continue;
                for(let aiB=0;aiB<N;aiB++){
                  if(aiA===aiB||alAll.has(aiB))continue;
                  if(sch[aiB][di]===sOver||srMap[aiB][di]!==undefined||srMap[aiB][dj]!==undefined)continue;
                  if(srMap[aiA][dj]!==undefined)continue;
                  // Try swapping: aiA gets aiB's shift on di, aiB gets sOver on di
                  // AND aiA gets something else on dj, aiB gets aiA's old shift on dj
                  // This is complex, so just try direct two-agent swap on di
                  const sB=sch[aiB][di];
                  if(sB===sOver||sB===null)continue;
                  const deficitB=(dd[sB]||0)-(counts[sB]||0);
                  if(deficitB>=0)continue; // sB is not under-needed
                  // Check: can aiA do sB? can aiB do sOver?
                  if(sB!=="OFF"&&sB!=="AL"&&!gAllow(agents[aiA].gender).has(sB))continue;
                  if(sOver!=="OFF"&&sOver!=="AL"&&!gAllow(agents[aiB].gender).has(sOver))continue;
                  // Check work/off limits
                  if(sB==="OFF"&&countOff(sch,aiA)>=maxOff+1)continue;
                  if(sOver==="OFF"&&countOff(sch,aiB)>=maxOff+1)continue;
                  if(wk.includes(sB)&&countWork(sch,aiA)>=maxWork)continue;
                  if(wk.includes(sOver)&&countWork(sch,aiB)>=maxWork)continue;
                  // Check rest
                  sch[aiA][di]=sB;sch[aiB][di]=sOver;
                  const rokA=_checkRest(sch,aiA,wk);const rokB=_checkRest(sch,aiB,wk);
                  if(!rokA||!rokB){sch[aiA][di]=sOver;sch[aiB][di]=sB;continue}
                  // Accept swap
                  break;
                }
              }
            }
          }
        }
      }
      if(allOk)break;
    }

    // 8. Validate
    let valid=true;
    for(let di=0;di<7&&valid;di++){
      const counts={};for(let ai=0;ai<N;ai++)counts[sch[ai][di]]=(counts[sch[ai][di]]||0)+1;
      const dd=dist[DAYS[di]];for(const s of all)if((counts[s]||0)!==(dd[s]||0)){valid=false;break}}
    if(!valid)continue;
    // Check rest and work limits
    for(let ai=0;ai<N&&valid;ai++){
      if(alAll.has(ai))continue;
      const w=countWork(sch,ai),o=countOff(sch,ai);
      if(w>maxWork){valid=false;break}
      if(o>maxOff+1){valid=false;break}
      if(!_checkRest(sch,ai,wk)){valid=false;break}
    }
    if(!valid)continue;
    // Score: prioritize exact OFF match, then consecutive OFFs, then single-shift, then rest quality
    let score=0;
    for(let ai=0;ai<N;ai++){
      if(alAll.has(ai))continue;
      const o=countOff(sch,ai);
      if(o===maxOff)score+=10;else if(o<=maxOff)score+=5;else score+=2;
      const offs=[];for(let di=0;di<7;di++)if(sch[ai][di]==="OFF")offs.push(di);
      if(offs.length>=2){
        let consec=false;for(let i=0;i<offs.length-1;i++)if(offs[i+1]-offs[i]===1)consec=true;
        if(consec)score+=3;
      }
      const ws2=new Set();for(let di=0;di<7;di++){const s=sch[ai][di];if(wk.includes(s))ws2.add(s)}
      if(ws2.size<=1)score+=2;
    }
    if(score>bestScore){bestScore=score;bestSch=sch.map(r=>[...r])}
    if(score>=nonAL*15)break; // perfect score
  }
  if(bestSch)return{ok:true,schedule:bestSch};
  // Diagnostic
  const diag=[];
  diag.push(`Agents: ${N}, AL: ${actualAL} (${[...alAll].map(i=>agents[i].name).join(", ")||"none"})`);
  diag.push(`Non-AL: ${nonAL}, Max OFF/agent: ${maxOff}, Max Work/agent: ${maxWork}`);
  diag.push(`Total OFF in dist: ${totalOff}, Capacity: ${nonAL}*${maxOff}=${nonAL*maxOff}`);
  diag.push(`Total Work in dist: ${totalWork}, Capacity: ${nonAL}*${maxWork}=${nonAL*maxWork}`);
  diag.push(`Special Requests: ${D.sr.length}`);
  for(const s of wk){const need=DAYS.reduce((sum,d)=>sum+(dist[d][s]||0),0);const canDo=agents.filter((a,i)=>!alAll.has(i)&&gAllow(a.gender).has(s)).length;diag.push(`Shift ${s}: need ${need}/wk, ${canDo} eligible (cap ${canDo*maxWork})${canDo*maxWork<need?" âš ":""}`);}
  errors.push("Could not find valid schedule.\n"+diag.join("\n"));
  return{ok:false,errors};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){document.getElementById("bA").textContent=D.agents.length;document.getElementById("bS").textContent=D.shifts.length;renderDist();renderAgents();renderShifts();renderGR();renderAL();renderSR();popSel();save()}
function renderDist(){
  const ai=allIds();document.getElementById("dAC").textContent=D.agents.length;
  const wsVal=document.getElementById("wkStart").value;const weekDts=getWeekDates(wsVal);
  let h="<thead><tr><th>Day</th>";ai.forEach(s=>h+=`<th>${s}</th>`);h+="<th>Total</th><th></th></tr></thead><tbody>";
  DAYS.forEach((day,di)=>{const dd=D.dist[day]||{};const dateStr=weekDts?'<div style="font-size:8px;color:var(--tx3);font-weight:400">'+fmtShortDate(weekDts[di])+'</div>':'';h+=`<tr><td style="font-weight:600">${day}${dateStr}</td>`;ai.forEach(s=>h+=`<td><input class="di" type="number" min="0" value="${dd[s]||0}" data-d="${day}" data-s="${s}" onchange="chDist(this)"></td>`);const t=ai.reduce((s,id)=>s+(dd[id]||0),0);const ok=t===D.agents.length;h+=`<td class="dt ${ok?"dok":"dbd"}">${t}</td><td class="dt ${ok?"dok":"dbd"}">${ok?"âœ“":"â‰ "+D.agents.length}</td></tr>`});
  document.getElementById("dTbl").innerHTML=h+"</tbody>";
  ["qaDay","qaFrom","qaTo"].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.innerHTML=(i===0?DAYS:ai).map(v=>`<option>${v}</option>`).join("")});
}
function chDist(el){D.dist[el.dataset.d][el.dataset.s]=parseInt(el.value)||0;renderDist();save()}
function quickAdj(){const d=document.getElementById("qaDay").value,f=document.getElementById("qaFrom").value,t=document.getElementById("qaTo").value,a=parseInt(document.getElementById("qaAmt").value)||1;if(f===t)return toast("Same","err");if((D.dist[d][f]||0)<a)return toast("Not enough","err");D.dist[d][f]-=a;D.dist[d][t]=(D.dist[d][t]||0)+a;renderDist();save();toast(`Moved ${a}: ${f}â†’${t}`)}
function renderAgents(){const el=document.getElementById("aList");if(!D.agents.length){el.innerHTML='<div class="emp">No agents.</div>';return}el.innerHTML=D.agents.map(a=>`<div class="ar"><span class="gb ${a.gender==="F"?"gf":"gm"}">${a.gender}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis" title="${a.name}">${a.name}</span><button class="btn bd bsm bic" onclick="delAgent('${a.id}')">âœ•</button></div>`).join("")}
function renderAgentLinks(){const el=document.getElementById("agLinksArea");if(!el)return;const base=location.origin+location.pathname;el.innerHTML=D.agents.map(a=>'<div class="ar"><span class="gb '+(a.gender==="F"?"gf":"gm")+'" style="font-size:9px">'+a.gender+'</span><b style="min-width:160px;font-size:11px;overflow:hidden;text-overflow:ellipsis">'+a.name+'</b><code style="font-family:var(--mono);font-size:9px;color:var(--cyn);background:var(--s3);padding:2px 5px;border-radius:3px;flex:1;word-break:break-all;overflow:hidden;text-overflow:ellipsis">'+base+'?agent='+a.id+'</code><button class="btn bs2 bsm" style="font-size:10px" onclick="navigator.clipboard.writeText(\''+base+'?agent='+a.id+'\');toast(\'Copied!\')">Copy</button></div>').join("")}
function addAgent(){const n=document.getElementById("nAN").value.trim(),g=document.getElementById("nAG").value;if(!n)return toast("Name required","err");D.agents.push({id:stableId(n),name:n,gender:g});document.getElementById("nAN").value="";hideEl("addAF");renderAll();toast("Added")}
function delAgent(id){if(!confirm("Remove?"))return;D.agents=D.agents.filter(a=>a.id!==id);D.al=D.al.filter(x=>x.aid!==id);D.sr=D.sr.filter(x=>x.aid!==id);renderAll()}
function renderShifts(){
  const el=document.getElementById("sList");
  el.innerHTML=D.shifts.map(s=>`<div class="shift-card" style="border-left-color:${s.color}"><span class="s-badge" style="background:${s.color}">${s.id}</span><input class="s-name" value="${s.name}" style="background:transparent;border:none;color:var(--tx);font-size:14px;font-weight:600;width:150px" onchange="updS('${s.id}','name',this.value)"><span class="s-time">${s.start} â†’ ${s.end}</span><input type="time" value="${s.start}" onchange="updS('${s.id}','start',this.value)" style="width:110px"><span style="color:var(--tx3)">to</span><input type="time" value="${s.end}" onchange="updS('${s.id}','end',this.value)" style="width:110px"><input type="color" value="${s.color}" onchange="updS('${s.id}','color',this.value)"><button class="btn bd bsm bic" onclick="delShift('${s.id}')">âœ•</button></div>`).join("");
}
function addShift(){const id=document.getElementById("nSI").value.trim().toUpperCase();if(!id||id==="OFF"||id==="AL")return toast("Invalid","err");if(D.shifts.find(s=>s.id===id))return toast("Exists","err");D.shifts.push({id,name:document.getElementById("nSN").value.trim()||id,start:document.getElementById("nSS").value,end:document.getElementById("nSE").value,color:document.getElementById("nSC").value});DAYS.forEach(d=>D.dist[d][id]=0);hideEl("addSF");renderAll();toast("Shift added")}
function updS(id,f,v){const s=D.shifts.find(x=>x.id===id);if(s){s[f]=v;renderShifts();save()}}
function delShift(id){if(!confirm("Delete "+id+"?"))return;D.shifts=D.shifts.filter(s=>s.id!==id);DAYS.forEach(d=>delete D.dist[d][id]);D.sr=D.sr.filter(x=>x.sid!==id);for(const g in D.genderRules)D.genderRules[g]=D.genderRules[g].filter(x=>x!==id);renderAll()}
function renderGR(){const area=document.getElementById("grArea"),wk=workIds();let h='<p style="font-size:11.5px;color:var(--tx2);margin-bottom:10px">Check which shifts each gender <b>can</b> work. None = all.</p>';["F","M"].forEach(g=>{const al=D.genderRules[g]||[];h+=`<div class="fr" style="margin-bottom:8px"><label style="width:70px;font-weight:600">${g==="F"?"Female":"Male"}</label>`;wk.forEach(sid=>{h+=`<label style="display:inline-flex;align-items:center;gap:3px;cursor:pointer;font-size:12px"><input type="checkbox" ${al.includes(sid)?"checked":""} onchange="tgGR('${g}','${sid}',this.checked)"> ${sid}</label>`});if(!al.length)h+='<span style="font-size:10.5px;color:var(--grn);margin-left:6px">All</span>';h+="</div>"});area.innerHTML=h}
function tgGR(g,sid,on){if(!D.genderRules[g])D.genderRules[g]=[];if(on){if(!D.genderRules[g].includes(sid))D.genderRules[g].push(sid)}else D.genderRules[g]=D.genderRules[g].filter(x=>x!==sid);renderGR();save()}
function saveRules(){D.rules.max_off=parseInt(document.getElementById("rMO").value);D.rules.max_work=parseInt(document.getElementById("rMW").value);save();toast("Saved")}
function alDays(start,end){const s=new Date(start+"T00:00:00"),e=new Date(end+"T00:00:00");if(e<s)return 0;return Math.round((e-s)/86400000)+1}
function alStatusColor(st){return{Pending:"#f59e0b",Approved:"#10b981",Completed:"#6b7280",Ongoing:"#3b82f6",Rejected:"#ef4444"}[st]||"#586380"}
function alYear(d,rec){if(rec&&rec.yearTag)return rec.yearTag;return new Date(d+"T00:00:00").getFullYear()}
if(!D.alRules)D.alRules={totalDays:30,noticeDays:14,maxConcurrent:2,minCoverage:10,notifyDays:7,blackoutDates:""};
let AL_YEAR=2026;
function setALYear(y){AL_YEAR=y;document.querySelectorAll(".alYearBtn").forEach(b=>{b.className="btn bsm alYearBtn "+(b.dataset.y==String(y)?"bp":"bs2")});renderAL()}
function alFiltered(){if(AL_YEAR==="all")return D.al;return D.al.filter(a=>alYear(a.start,a)===AL_YEAR||alYear(a.end,a)===AL_YEAR)}
function alOverlap(start,end,excludeId){const s=new Date(start+"T00:00:00"),e=new Date(end+"T00:00:00");return D.al.filter(a=>{if(a.id===excludeId)return false;const st=a.status||"Approved";if(st==="Rejected"||st==="Completed")return false;const as2=new Date(a.start+"T00:00:00"),ae=new Date(a.end+"T00:00:00");return as2<=e&&ae>=s})}
function alValidateRequest(aid,start,end,excludeId){const errs=[],warns=[];const days=alDays(start,end);const maxConc=D.alRules?.maxConcurrent||2;const overlap=alOverlap(start,end,excludeId);if(overlap.length>=maxConc)errs.push("âŒ BLOCKED: "+overlap.length+" agents already on leave (max "+maxConc+"). Overlapping: "+overlap.map(a=>a.name).join(", "));
  const today=new Date();const startD=new Date(start+"T00:00:00");const notice=Math.round((startD-today)/86400000);if(notice<(D.alRules?.noticeDays||14))warns.push("âš  Only "+notice+" days notice (min "+(D.alRules?.noticeDays||14)+")");
  const blackout=(D.alRules?.blackoutDates||"").split(",").map(x=>x.trim()).filter(Boolean);for(const bd of blackout){const bdt=new Date(bd+"T00:00:00");if(bdt>=new Date(start+"T00:00:00")&&bdt<=new Date(end+"T00:00:00"))errs.push("âŒ Includes blackout date: "+bd)}
  const yr=alYear(start);const agLeaves=D.al.filter(a=>a.aid===aid&&a.id!==excludeId&&alYear(a.start)===yr&&(a.status||"Approved")!=="Rejected");const usedDays=agLeaves.reduce((s,a)=>s+alDays(a.start,a.end),0);const totalYear=D.alRules?.totalDays||30;if(usedDays+days>totalYear)warns.push("âš  Would exceed yearly allowance: "+usedDays+"+"+days+"="+( usedDays+days)+" / "+totalYear+" days for "+yr);
  return{days,errs,warns,overlap,blocked:errs.length>0}}
function saveALRules(){D.alRules={totalDays:parseInt(document.getElementById("alrTotal").value)||30,noticeDays:parseInt(document.getElementById("alrNotice").value)||14,maxConcurrent:parseInt(document.getElementById("alrMaxConc").value)||2,minCoverage:parseInt(document.getElementById("alrMinCoverage").value)||10,notifyDays:parseInt(document.getElementById("alrNotifyDays").value)||7,blackoutDates:(document.getElementById("alrBlackout").value||"").trim()};save();toast("Rules saved")}
function loadALRules(){if(!D.alRules)return;const r=D.alRules;const g=id=>document.getElementById(id);if(g("alrTotal"))g("alrTotal").value=r.totalDays||30;if(g("alrNotice"))g("alrNotice").value=r.noticeDays||14;if(g("alrMaxConc"))g("alrMaxConc").value=r.maxConcurrent||2;if(g("alrMinCoverage"))g("alrMinCoverage").value=r.minCoverage||10;if(g("alrNotifyDays"))g("alrNotifyDays").value=r.notifyDays||7;if(g("alrBlackout"))g("alrBlackout").value=r.blackoutDates||""}
function alPreview(){const s=document.getElementById("alS").value,e=document.getElementById("alE").value,aid=document.getElementById("alA").value,el=document.getElementById("alPreview");if(!el||!s||!e){if(el)el.innerHTML="";return}const v=alValidateRequest(aid,s,e);el.innerHTML='<div style="font-size:12px"><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+v.days+' days</span>'+(v.errs.length?'<div style="margin-top:4px">'+v.errs.map(w=>'<div style="color:var(--red);font-size:11px;font-weight:600">'+w+'</div>').join("")+"</div>":"")+(v.warns.length?'<div style="margin-top:2px">'+v.warns.map(w=>'<div style="color:var(--orn);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(!v.errs.length&&!v.warns.length?'<span style="color:var(--grn);margin-left:8px">âœ“ No issues</span>':"")+"</div>"}
function renderAL(){const el=document.getElementById("alL");const filtered=alFiltered();document.getElementById("alCount").textContent=filtered.length;if(!filtered.length){el.innerHTML='<div class="emp">No leave records'+(AL_YEAR!=="all"?" for "+AL_YEAR:"")+'.</div>';renderALBalance();renderALNotify();renderALPending();return}const sorted=[...filtered].sort((a,b)=>new Date(a.start)-new Date(b.start));el.innerHTML=sorted.map(a=>{const days=alDays(a.start,a.end);const st=a.status||"Approved";const ol=alOverlap(a.start,a.end,a.id);const maxConc=D.alRules?.maxConcurrent||2;const olNames=ol.map(x=>x.name.split(" ")[0]);const olWarn=ol.length>=maxConc?' <span style="color:var(--red);font-size:10px;font-weight:700;cursor:help" title="Overlaps with: '+ol.map(x=>x.name).join(", ")+'">âš  OVER('+ol.length+') ðŸ‘¥ '+olNames.join(", ")+'</span>':ol.length>0?' <span style="color:var(--orn);font-size:10px;cursor:help" title="Overlaps with: '+ol.map(x=>x.name).join(", ")+'">ðŸ‘¥ '+ol.length+' (OK â‰¤'+maxConc+')</span>':"";return'<div class="ir" style="border-left:4px solid '+alStatusColor(st)+'"><span class="tg" style="background:'+alStatusColor(st)+'20;color:'+alStatusColor(st)+'">'+st+'</span><b style="min-width:180px">'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' â†’ '+a.end+'</span><span style="font-family:var(--mono);font-weight:700;color:var(--cyn);min-width:50px">'+days+'d</span>'+olWarn+'<select onchange="chALStatus(\''+a.id+'\',this.value)" style="width:90px;font-size:10px;padding:3px"><option '+(st==="Pending"?"selected":"")+'>Pending</option><option '+(st==="Approved"?"selected":"")+'>Approved</option><option '+(st==="Ongoing"?"selected":"")+'>Ongoing</option><option '+(st==="Completed"?"selected":"")+'>Completed</option><option '+(st==="Rejected"?"selected":"")+'>Rejected</option></select>'+(a.adminNote?'<span style="font-size:10px;color:var(--tx3)" title="'+a.adminNote+'">ðŸ’¬</span>':'')+(a.yearTag&&a.yearTag!==new Date(a.start+"T00:00:00").getFullYear()?'<span style="font-size:9px;background:#4c1d95;color:#c4b5fd;padding:1px 5px;border-radius:3px">â†’'+a.yearTag+'</span>':'')+'<button class="btn bs2 bsm bic" onclick="editALDates(\''+a.id+'\')" title="Edit dates">âœ</button><button class="btn bs2 bsm bic" onclick="editALYear(\''+a.id+'\')" title="Assign year">ðŸ“…</button><button class="btn bs2 bsm bic" onclick="addALNote(\''+a.id+'\')" title="Add note">ðŸ’¬</button><button class="btn bd bsm bic" onclick="delAL(\''+a.id+'\')">âœ•</button></div>'}).join("");renderALBalance();renderALNotify();renderALPending();renderALLinks();loadALRules()}
function chALStatus(id,st){const a=D.al.find(x=>x.id===id);if(a){a.status=st;a.decidedAt=new Date().toISOString();save();renderAL();autoCloudSync()}}
async function autoCloudSync(){if(!SB||!SB_WS||!SB_WEEK_ID)return;try{await SB.from("weeks").update({annual_leave_json:D.al,settings_json:{shifts:D.shifts,rules:D.rules,genderRules:D.genderRules,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows,alRules:D.alRules||{},swapRequests:D.swapRequests||[],schedPrefs:D.schedPrefs||[],kpis:D.kpis||{},coaching:D.coaching||[],incidents:D.incidents||[],kb:D.kb||[]},attendance_json:D.attendance||{},roster_json:D.roster||null,breaks_json:BK.results||null}).eq("id",SB_WEEK_ID)}catch(e){console.log("Auto-sync failed:",e)}}
function editALDates(id){const a=D.al.find(x=>x.id===id);if(!a)return;const ns=prompt("Start date (YYYY-MM-DD):",a.start);if(!ns)return;const ne=prompt("End date (YYYY-MM-DD):",a.end);if(!ne)return;if(new Date(ne)<new Date(ns)){toast("End before start","err");return}a.start=ns;a.end=ne;save();renderAL();toast("Dates updated: "+alDays(ns,ne)+" days")}
function editALYear(id){const a=D.al.find(x=>x.id===id);if(!a)return;const yr=prompt("Assign to year (e.g. 2025 or 2026):",a.yearTag||alYear(a.start));if(!yr)return;a.yearTag=parseInt(yr);save();renderAL();toast("Assigned to "+yr)}
function addALNote(id){const a=D.al.find(x=>x.id===id);if(!a)return;const note=prompt("Admin note for "+a.name+":",a.adminNote||"");if(note!==null){a.adminNote=note;save();renderAL()}}
function addAL(){const aid=document.getElementById("alA").value,s=document.getElementById("alS").value,e=document.getElementById("alE").value,st=document.getElementById("alSt").value;if(!aid||!s||!e)return toast("Fill all","err");if(new Date(e)<new Date(s))return toast("End before start","err");const v=alValidateRequest(aid,s,e);if(v.blocked&&st!=="Rejected"){if(!confirm("âš  OVERLAP VIOLATION\\n\\n"+v.errs.join("\\n")+"\\n\\nAdd anyway?"))return}const ag=D.agents.find(a=>a.id===aid);D.al.push({id:uid(),aid,name:ag?.name||"",start:s,end:e,status:st,addedAt:new Date().toISOString()});renderAL();save();toast("Leave added â€” "+v.days+" days")}
function delAL(id){if(!confirm("Delete this leave?"))return;D.al=D.al.filter(x=>x.id!==id);renderAL();save()}
function renderALBalance(){const el=document.getElementById("alBalance");if(!el)return;const yr=AL_YEAR==="all"?null:AL_YEAR;const totalYear=D.alRules?.totalDays||30;const byAgent={};D.agents.forEach(a=>byAgent[a.id]={name:a.name,used:0,pending:0,approved:0});D.al.forEach(a=>{if(!byAgent[a.aid])return;if(yr&&alYear(a.start)!==yr)return;const days=alDays(a.start,a.end);const st=a.status||"Approved";if(st==="Completed"||st==="Ongoing")byAgent[a.aid].used+=days;else if(st==="Approved")byAgent[a.aid].approved+=days;else if(st==="Pending")byAgent[a.aid].pending+=days});let h='<div class="tw"><table><thead><tr><th style="text-align:left">Agent</th><th>Year</th><th>Entitled</th><th>Used</th><th>Approved</th><th>Pending</th><th>Remaining</th></tr></thead><tbody>';const entries=Object.entries(byAgent).filter(([,b])=>b.used||b.approved||b.pending).sort((a,b)=>(totalYear-a[1].used-a[1].approved)-(totalYear-b[1].used-b[1].approved));for(const[aid,b]of entries){const rem=totalYear-b.used-b.approved;const remC=rem<=0?"var(--red)":rem<=5?"var(--orn)":"var(--grn)";h+='<tr><td style="text-align:left">'+b.name+'</td><td style="font-family:var(--mono);color:var(--tx3)">'+(yr||"All")+'</td><td style="font-family:var(--mono)">'+totalYear+'</td><td style="font-family:var(--mono)">'+b.used+'</td><td style="font-family:var(--mono)">'+b.approved+'</td><td style="font-family:var(--mono);color:var(--orn)">'+b.pending+'</td><td style="font-family:var(--mono);font-weight:700;color:'+remC+'">'+rem+'</td></tr>'}h+='</tbody></table></div>';el.innerHTML=h}
function renderALNotify(){const el=document.getElementById("alNotifications");if(!el)return;const notifyDays=D.alRules?.notifyDays||7;const today=new Date();const upcoming=[];D.al.forEach(a=>{if(a.status==="Rejected"||a.status==="Completed")return;const startD=new Date(a.start+"T00:00:00");const daysUntil=Math.round((startD-today)/86400000);if(daysUntil>=0&&daysUntil<=notifyDays)upcoming.push({name:a.name,start:a.start,end:a.end,status:a.status||"Approved",daysUntil,days:alDays(a.start,a.end)})});if(!upcoming.length){el.innerHTML="";return}upcoming.sort((a,b)=>a.daysUntil-b.daysUntil);el.innerHTML='<div class="card" style="border-left:4px solid var(--orn)"><div class="ch"><h3 style="color:var(--orn)">&#128276; Upcoming Leave</h3></div><div class="cb">'+upcoming.map(a=>'<div class="ar" style="border-left:3px solid '+(a.daysUntil<=2?"var(--red)":"var(--orn)")+'"><span class="tg" style="background:'+(a.daysUntil<=2?"#7f1d1d":"#78350f")+';color:'+(a.daysUntil<=2?"#fca5a5":"#fcd34d")+'">'+(a.daysUntil===0?"TODAY":a.daysUntil===1?"TOMORROW":"in "+a.daysUntil+"d")+'</span><b>'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' â†’ '+a.end+' ('+a.days+'d)</span><span class="tg" style="background:'+alStatusColor(a.status)+'20;color:'+alStatusColor(a.status)+'">'+a.status+'</span></div>').join("")+'</div></div>'}
function renderALPending(){const el=document.getElementById("alPendingRequests");if(!el)return;const pending=D.al.filter(a=>(a.status||"Approved")==="Pending"&&a.source==="agent");if(!pending.length){el.innerHTML="";return}el.innerHTML='<div class="card" style="border-left:4px solid var(--pur)"><div class="ch"><h3 style="color:var(--pur)">&#128233; Agent Requests Awaiting Approval</h3></div><div class="cb">'+pending.map(a=>{const v=alValidateRequest(a.aid,a.start,a.end,a.id);return'<div class="ar" style="border-left:3px solid var(--pur)"><b>'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' â†’ '+a.end+' ('+v.days+'d)</span>'+(v.blocked?'<span style="font-size:10px;color:var(--red);font-weight:700">âš  OVERLAP</span>':'<span style="font-size:10px;color:var(--grn)">âœ“ OK</span>')+'<button class="btn bg bsm" onclick="chALStatus(\''+a.id+'\',\'Approved\')">âœ“ Approve</button><button class="btn bd bsm" onclick="rejectALRequest(\''+a.id+'\')">âœ— Reject</button></div>'}).join("")+'</div></div>'}
function rejectALRequest(id){const reason=prompt("Rejection reason:");if(reason===null)return;const a=D.al.find(x=>x.id===id);if(a){a.status="Rejected";a.adminNote=reason;a.decidedAt=new Date().toISOString();save();renderAL();toast("Rejected with comment")}}
function renderALLinks(){const el=document.getElementById("alLinksArea");if(!el)return;const base=location.origin+location.pathname;el.innerHTML='<p style="font-size:12px;color:var(--tx2);margin-bottom:10px">Each agent gets a unique link to view their schedule, breaks, and AL â€” and submit leave requests.</p><div style="max-height:300px;overflow-y:auto">'+D.agents.map(a=>'<div class="ar"><b style="min-width:200px;font-size:12px">'+a.name+'</b><code style="font-family:var(--mono);font-size:10px;color:var(--cyn);background:var(--s3);padding:2px 6px;border-radius:3px;word-break:break-all;flex:1">'+base+'?agent='+a.id+'</code><button class="btn bs2 bsm" onclick="navigator.clipboard.writeText(\''+base+'?agent='+a.id+'\');toast(\'Copied!\')">Copy</button></div>').join("")+'</div>'}
function renderSR(){const el=document.getElementById("srL");if(!D.sr.length){el.innerHTML='<div class="emp">No requests.</div>';return}const byA={};D.sr.forEach(s=>{if(!byA[s.aid])byA[s.aid]=[];byA[s.aid].push(s)});let h="";for(const aid in byA){const items=byA[aid];const byS={};items.forEach(s=>{if(!byS[s.sid])byS[s.sid]=[];byS[s.sid].push(s)});for(const sid in byS){const g=byS[sid],days=g.map(s=>s.day).join(", "),ids=g.map(s=>s.id);h+=`<div class="ir"><span class="tg tgh">HARD</span><b>${g[0].name}</b><span style="color:var(--tx2)">${sid} â†’ ${days}</span><span style="flex:1"></span><button class="btn bd bsm" onclick="delSRG('${ids.join(",")}')">âœ•</button></div>`}}el.innerHTML=h}
function initSRD(){document.getElementById("srDays").innerHTML=DAYS.map(d=>`<label><input type="checkbox" value="${d}" checked><span>${d}</span></label>`).join("")}
function toggleAllD(){const c=document.querySelectorAll("#srDays input");const on=[...c].every(x=>x.checked);c.forEach(x=>x.checked=!on)}
function addSR(){const aid=document.getElementById("srA").value,sid=document.getElementById("srSh").value;const days=[...document.querySelectorAll("#srDays input:checked")].map(c=>c.value);if(!aid||!sid||!days.length)return toast("Select all","err");const ag=D.agents.find(a=>a.id===aid);days.forEach(day=>{D.sr=D.sr.filter(x=>!(x.aid===aid&&x.day===day));D.sr.push({id:uid(),aid,name:ag?.name||"",day,sid,type:"hard"})});renderSR();save();toast(`Added ${sid} Ã— ${days.length} days`)}
function delSRG(s){const ids=s.split(",");D.sr=D.sr.filter(x=>!ids.includes(x.id));renderSR();save()}
function popSel(){const ao=D.agents.map(a=>`<option value="${a.id}">${a.gender==="F"?"â™€":"â™‚"} ${a.name}</option>`).join("");["alA","srA"].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=ao});const el=document.getElementById("srSh");if(el)el.innerHTML=allIds().map(s=>`<option>${s}</option>`).join("");initSRD()}

function doGen(){const btn=document.getElementById("btnG");btn.innerHTML='<span class="spin"></span>';btn.disabled=true;setTimeout(()=>{try{const t0=performance.now();const r=solve(document.getElementById("tRand").classList.contains("on"));const ms=Math.round(performance.now()-t0);if(r.ok){buildRoster(r.schedule);toast(`Generated in ${ms}ms â€” generating breaks...`);
              // Auto-generate breaks
              setTimeout(()=>{BK.results={};DAYS.forEach(d=>{const agents2=D.roster.filter(r2=>r2.shifts[d]&&!NW2.has(r2.shifts[d])).map(r2=>({name:r2.name,code:r2.shifts[d]}));const off=D.roster.filter(r2=>NW2.has(r2.shifts[d])).map(r2=>[r2.name,r2.shifts[d]]);const br=bkSolveDay(d,agents2);BK.results[d]={assignments:br.ok?br.assignments:[],error:br.ok?null:br.error,offAgents:off,validation:br.validation||{}}});D.breakResults=BK.results;D.breakPattern=BK.breakPattern;D.breakPatternC=BK.breakPatternC;D.peakWindows=BK.peakWindows;save();toast(`Schedule + breaks generated in ${ms}ms`)},10);
              document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-roster").style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="roster"]').classList.add("on")}else{const msg=r.errors[0];if(msg.length>100){const errDiv=document.createElement("div");errDiv.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1c1917;border:2px solid #dc2626;border-radius:10px;padding:16px;max-width:500px;z-index:9999;color:#fca5a5;font-size:11px;white-space:pre-wrap;font-family:var(--mono)";errDiv.textContent=msg;const cb=document.createElement("button");cb.textContent="Close";cb.style.cssText="margin-top:10px;padding:6px 16px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer";cb.onclick=()=>errDiv.remove();errDiv.appendChild(cb);document.body.appendChild(errDiv)}else toast(msg,"err")}}catch(e){toast("Solver error: "+e.message,"err");console.error(e)}btn.innerHTML="&#9654; Generate";btn.disabled=false},30)}
function buildRoster(sch){const wk=workIds(),N=D.agents.length;D.roster=D.agents.map((a,ai)=>{const shifts={};let wd=0,od=0,ald=0;DAYS.forEach((d,di)=>{const s=sch[ai][di];shifts[d]=s;if(wk.includes(s))wd++;else if(s==="OFF")od++;else if(s==="AL")ald++});return{...a,shifts,wd,od,ald}});D.summary={};DAYS.forEach((day,di)=>{const c={};for(let ai=0;ai<N;ai++){const s=sch[ai][di];c[s]=(c[s]||0)+1}D.summary[day]=c});const bREl=document.getElementById("bR");if(bREl)bREl.textContent=N;renderRoster();save()}
// â•â•â• WEEK NAVIGATION â•â•â•
function getWeekDates(wsVal){
  if(!wsVal)return null;
  const ws=new Date(wsVal+"T12:00:00");
  const dates=[];for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(ws.getDate()+i);dates.push(d)}
  return dates;
}
function fmtShortDate(d){return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")}
function navWeek(dir){
  const ws=document.getElementById("wkStart");
  if(dir===0){
    // Go to current week (Monday)
    const td=new Date(),w2=td.getDay(),d2=w2===0?-6:1-w2;const m2=new Date(td);m2.setDate(td.getDate()+d2);ws.value=m2.toISOString().split("T")[0];
  }else{
    const d=new Date(ws.value+"T12:00:00");d.setDate(d.getDate()+dir*7);ws.value=d.toISOString().split("T")[0];
  }
  // Try to load from archive
  const list=loadArchiveList();const snap=list.find(x=>x.week===ws.value);
  if(snap){Object.assign(D,snap.data);if(snap.breaks){BK.results=snap.breaks.results;BK.breakPattern=snap.breaks.breakPattern;BK.breakPatternC=snap.breaks.breakPatternC;BK.peakWindows=snap.breaks.peakWindows}else{BK.results=null}renderAll();if(D.roster)renderRoster();toast(`Loaded week ${ws.value}`)}
  else{D.roster=null;D.summary=null;BK.results=null;renderRoster();toast("No saved schedule for "+ws.value+". Generate one or save a week first.","err")}
}
function jumpToWeek(dateStr){
  if(!dateStr)return;
  // Find the Monday of that week
  const d=new Date(dateStr+"T12:00:00");const dow=d.getDay();const monOff=dow===0?-6:1-dow;d.setDate(d.getDate()+monOff);
  const ws=document.getElementById("wkStart");ws.value=d.toISOString().split("T")[0];
  const list=loadArchiveList();const snap=list.find(x=>x.week===ws.value);
  if(snap){Object.assign(D,snap.data);if(snap.breaks){BK.results=snap.breaks.results;BK.breakPattern=snap.breaks.breakPattern;BK.breakPatternC=snap.breaks.breakPatternC;BK.peakWindows=snap.breaks.peakWindows}else{BK.results=null}renderAll();if(D.roster)renderRoster();toast(`Loaded week ${ws.value}`)}
  else{D.roster=null;D.summary=null;BK.results=null;renderRoster();toast("No saved schedule for "+ws.value,"err")}
}

function renderRoster(){if(!D.roster){document.getElementById("rArea").innerHTML='<div class="emp">No schedule yet. Click <b>Generate</b> or navigate to a saved week.</div>';document.getElementById("sArea").innerHTML='';const lbl=document.getElementById("rWeekLabel");if(lbl)lbl.innerHTML='';return}
  const ai=allIds();const wsVal=document.getElementById("wkStart").value;const weekDates=getWeekDates(wsVal);
  // Week label
  const lbl=document.getElementById("rWeekLabel");
  if(lbl&&weekDates){const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];lbl.innerHTML='&#128197; Week of <b>'+wsVal+'</b> â€” '+mn[weekDates[0].getMonth()]+' '+weekDates[0].getDate()+' to '+mn[weekDates[6].getMonth()]+' '+weekDates[6].getDate()+', '+weekDates[6].getFullYear()}
  // Update jump calendar
  const jmp=document.getElementById("rosterJump");if(jmp)jmp.value=wsVal;
  let h='';
  // Show pending swap requests from agents
  if(D.swapRequests&&D.swapRequests.filter(r=>r.status==="Pending").length){h+='<div style="background:#1e1b4b;border:1px solid #312e81;border-radius:8px;padding:10px 14px;margin-bottom:10px"><div style="font-size:12px;font-weight:700;color:#a78bfa;margin-bottom:6px">ðŸ”„ Shift Swap Requests</div>';D.swapRequests.filter(r=>r.status==="Pending").forEach(r=>{const from=D.roster.find(x=>x.id===r.from),to=D.roster.find(x=>x.id===r.to);if(!from||!to)return;h+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0;flex-wrap:wrap"><b style="font-size:11px">'+r.fromName+'</b> <span class="sb" style="background:'+sColor(from.shifts[r.day])+';height:18px;min-width:28px;font-size:9px">'+from.shifts[r.day]+'</span> <span style="font-size:11px;color:var(--tx3)">â†”</span> <b style="font-size:11px">'+r.toName+'</b> <span class="sb" style="background:'+sColor(to.shifts[r.day])+';height:18px;min-width:28px;font-size:9px">'+to.shifts[r.day]+'</span> <span style="font-size:10px;color:var(--tx3)">on '+r.day+'</span><button class="btn bg bsm" style="font-size:10px;padding:2px 8px" onclick="approveSwapReq(\''+r.id+'\')">âœ“ Approve</button><button class="btn bd bsm" style="font-size:10px;padding:2px 8px" onclick="rejectSwapReq(\''+r.id+'\')">âœ— Reject</button></div>'});h+='</div>'}
  // Schedule Preference Requests
  if(D.schedPrefs&&D.schedPrefs.filter(p=>p.status==="Pending").length){h+='<div style="background:#1c1917;border:1px solid #44403c;border-radius:8px;padding:10px 14px;margin-bottom:10px"><div style="font-size:12px;font-weight:700;color:#fb923c;margin-bottom:6px">ðŸ“‹ Schedule Preference Requests</div>';D.schedPrefs.filter(p=>p.status==="Pending").forEach(p=>{h+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0;flex-wrap:wrap"><b style="font-size:11px">'+p.name+'</b><span style="font-size:10px;color:var(--tx3)">wants</span><span class="sb" style="background:'+sColor(p.request)+';height:18px;min-width:28px;font-size:9px">'+p.request+'</span><span style="font-size:10px;color:var(--tx3)">on '+p.day+'</span>'+(p.reason?'<span style="font-size:10px;color:var(--tx2)">â€” '+p.reason+'</span>':'')+'<button class="btn bg bsm" style="font-size:10px;padding:2px 8px" onclick="approvePref(\''+p.id+'\')">âœ“ Note</button><button class="btn bd bsm" style="font-size:10px;padding:2px 8px" onclick="rejectPref(\''+p.id+'\')">âœ— Reject</button></div>'});h+='</div>'}
  if(SWAP_MODE)h+='<div style="background:#78350f;border:1px solid #92400e;border-radius:6px;padding:8px 12px;margin-bottom:10px;font-size:12px;color:#fcd34d">&#128260; <b>SWAP MODE</b> â€” Click another agent on <b>'+SWAP_MODE.day+'</b> to swap with <b>'+D.roster[SWAP_MODE.ri].name+'</b> <button class="btn bs2 bsm" style="margin-left:8px" onclick="SWAP_MODE=null;renderRoster()">Cancel</button></div>';
  h+='<div class="tw"><table><thead><tr><th style="text-align:left;min-width:180px">Agent</th><th>G</th>';DAYS.forEach((d,di)=>{const dateStr=weekDates?'<div style="font-size:8px;color:var(--tx3);font-weight:400">'+fmtShortDate(weekDates[di])+'</div>':'';h+=`<th>${d}${dateStr}</th>`});h+="<th>W</th><th>O</th><th>AL</th></tr></thead><tbody>";D.roster.forEach((r,ri)=>{const isSwapSrc=SWAP_MODE&&SWAP_MODE.ri===ri;h+=`<tr style="${isSwapSrc?"background:rgba(245,158,11,0.1)":""}"><td title="${r.name}" style="max-width:220px;overflow:hidden;text-overflow:ellipsis">${isSwapSrc?"ðŸ”„ ":""}${r.name}</td><td><span class="gb ${r.gender==="F"?"gf":"gm"}" style="font-size:9px">${r.gender}</span></td>`;DAYS.forEach((d,di)=>{const s=r.shifts[d];const isSwapDay=SWAP_MODE&&SWAP_MODE.day===d&&!isSwapSrc;h+=`<td><span class="sb" style="background:${sColor(s)};cursor:pointer;${isSwapDay?"outline:2px solid #f59e0b;outline-offset:1px":""}" onclick="swapShift(${ri},'${d}')" title="${isSwapDay?"Click to swap":"Click to change"}">${s}</span></td>`});h+=`<td style="font-family:var(--mono);font-weight:600">${r.wd}</td><td style="font-family:var(--mono);font-weight:600">${r.od}</td><td style="font-family:var(--mono);font-weight:600">${r.ald}</td></tr>`});document.getElementById("rArea").innerHTML=h+"</tbody></table></div>";
let sh='<div style="margin-top:16px"><h3 style="font-size:12px;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">Daily Summary</h3><div class="sg">';DAYS.forEach((day,di)=>{const c=D.summary[day]||{};const dateStr=weekDates?'<div style="font-size:9px;color:var(--tx3);font-weight:400">'+fmtShortDate(weekDates[di])+'</div>':'';sh+=`<div class="sc"><div class="scd">${day}${dateStr}</div><div class="scs">`;ai.forEach(sid=>{sh+=`<span class="sb" style="background:${sColor(sid)};font-size:9.5px;min-width:40px;height:20px">${sid}:${c[sid]||0}</span>`});sh+="</div></div>"});document.getElementById("sArea").innerHTML=sh+"</div></div>"}
// Inline shift swap + agent-to-agent swap
let SWAP_MODE=null;
function regenBreaksForDay(day){
  if(!D.roster||!BK.results)return;
  const agents2=D.roster.filter(r=>r.shifts[day]&&!NW2.has(r.shifts[day])).map(r=>({name:r.name,code:r.shifts[day]}));
  const off=D.roster.filter(r=>NW2.has(r.shifts[day])).map(r=>[r.name,r.shifts[day]]);
  const br=bkSolveDay(day,agents2);
  BK.results[day]={assignments:br.ok?br.assignments:[],error:br.ok?null:br.error,offAgents:off,validation:br.validation||{}};
  D.breakResults=BK.results;
}
function regenAllBreaks(){
  if(!D.roster)return;
  BK.results={};DAYS.forEach(d=>regenBreaksForDay(d));save();
}
function swapShift(ri,day){const r=D.roster[ri];if(!r)return;const cur=r.shifts[day];
  // If swap mode is active, do agent-to-agent swap
  if(SWAP_MODE&&SWAP_MODE.day===day&&SWAP_MODE.ri!==ri){const r2=D.roster[SWAP_MODE.ri];const s1=r.shifts[day],s2=r2.shifts[day];
    const wk2=workIds();
    for(const[ag,ns] of [[r,s2],[r2,s1]]){const old={};DAYS.forEach(d=>old[d]=ag.shifts[d]);old[day]=ns;
      for(let i=0;i<6;i++){const a=old[DAYS[i]],b=old[DAYS[i+1]];if(wk2.includes(a)&&wk2.includes(b)&&!_restOk(a,b)){toast(ag.name+": rest violation "+a+"â†’"+b,"err");SWAP_MODE=null;renderRoster();return}}}
    r.shifts[day]=s2;r2.shifts[day]=s1;
    [r,r2].forEach(ag=>{let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=ag.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});ag.wd=wd2;ag.od=od2;ag.ald=ald2});
    D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
    SWAP_MODE=null;regenBreaksForDay(day);renderRoster();save();toast("Swapped: "+r.name+" â†” "+r2.name+" on "+day);return}
  if(SWAP_MODE){SWAP_MODE=null;renderRoster();return}
  // Show inline action popup
  const popup=document.createElement("div");popup.id="shiftPopup";popup.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--s1);border:1px solid var(--brd);border-radius:10px;padding:16px;z-index:9000;min-width:280px;box-shadow:0 8px 32px rgba(0,0,0,.5)";
  let ph='<div style="font-size:13px;font-weight:700;margin-bottom:10px">'+r.name+' â€” '+day+' <span class="sb" style="background:'+sColor(cur)+'">'+cur+'</span></div>';
  ph+='<div style="font-size:11px;color:var(--tx2);margin-bottom:8px">Change shift:</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">';
  allIds().forEach(sid=>{ph+='<span class="sb" style="background:'+sColor(sid)+';cursor:pointer;'+(sid===cur?"outline:2px solid #fff;":"opacity:0.7")+'" onclick="doShiftChange('+ri+',\''+day+'\',\''+sid+'\')">'+sid+'</span>'});
  ph+='</div><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn bp bsm" onclick="SWAP_MODE={ri:'+ri+',day:\''+day+'\'};document.getElementById(\'shiftPopup\').remove();renderRoster();toast(\'Click another agent on '+day+' to swap\')">â†” Swap Day</button><button class="btn bg bsm" onclick="startFullWeekSwap('+ri+');document.getElementById(\'shiftPopup\').remove()">â†” Swap Full Week</button><button class="btn bs2 bsm" onclick="document.getElementById(\'shiftPopup\').remove()">Cancel</button></div>';
  popup.innerHTML=ph;document.body.appendChild(popup)}
function startFullWeekSwap(ri){
  const r=D.roster[ri];
  const popup=document.createElement("div");popup.id="shiftPopup";popup.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--s1);border:1px solid var(--brd);border-radius:10px;padding:16px;z-index:9000;min-width:320px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.5)";
  let ph='<div style="font-size:13px;font-weight:700;margin-bottom:10px">Swap Full Week â€” '+r.name+'</div>';
  ph+='<div style="font-size:11px;color:var(--tx2);margin-bottom:8px">Select agent to swap entire week schedule with:</div>';
  ph+='<div style="max-height:400px;overflow-y:auto">';
  D.roster.forEach((r2,ri2)=>{
    if(ri2===ri)return;
    ph+='<div class="ar" style="cursor:pointer" onclick="doFullWeekSwap('+ri+','+ri2+');document.getElementById(\'shiftPopup\').remove()"><span class="gb '+(r2.gender==="F"?"gf":"gm")+'" style="font-size:9px">'+r2.gender+'</span><b style="font-size:12px;flex:1">'+r2.name+'</b><span style="font-size:10px;color:var(--cyn)">Click to swap</span></div>';
  });
  ph+='</div><button class="btn bs2 bsm" style="margin-top:8px" onclick="document.getElementById(\'shiftPopup\').remove()">Cancel</button>';
  popup.innerHTML=ph;document.body.appendChild(popup)}
function doFullWeekSwap(ri1,ri2){
  const r1=D.roster[ri1],r2=D.roster[ri2];const wk2=workIds();
  DAYS.forEach(d=>{const tmp=r1.shifts[d];r1.shifts[d]=r2.shifts[d];r2.shifts[d]=tmp});
  [r1,r2].forEach(ag=>{let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=ag.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});ag.wd=wd2;ag.od=od2;ag.ald=ald2});
  D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
  regenAllBreaks();renderRoster();save();toast("Full week swapped: "+r1.name+" â†” "+r2.name)}
function doShiftChange(ri,day,ns){document.getElementById("shiftPopup")?.remove();const r=D.roster[ri];const cur=r.shifts[day];if(ns===cur)return;
  const wk2=workIds();const oldShifts={};DAYS.forEach(d=>oldShifts[d]=r.shifts[d]);oldShifts[day]=ns;
  for(let i=0;i<6;i++){const s1=oldShifts[DAYS[i]],s2=oldShifts[DAYS[i+1]];if(wk2.includes(s1)&&wk2.includes(s2)&&!_restOk(s1,s2)){toast("Rest violation: "+s1+"â†’"+s2,"err");return}}
  r.shifts[day]=ns;
  let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=r.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});r.wd=wd2;r.od=od2;r.ald=ald2;
  D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
  const dist=D.dist[day]||{};const actual=D.summary[day]||{};let distOk=true;allIds().forEach(sid=>{if((actual[sid]||0)!==(dist[sid]||0))distOk=false});
  regenBreaksForDay(day);renderRoster();save();toast(r.name+": "+day+" â†’ "+ns+(distOk?"":" âš  Distribution mismatch!"))}
function approveSwapReq(reqId){if(!D.swapRequests)return;const req=D.swapRequests.find(r=>r.id===reqId);if(!req)return;
  const fromR=D.roster.find(r=>r.id===req.from),toR=D.roster.find(r=>r.id===req.to);if(!fromR||!toR){toast("Agents not found","err");return}
  const s1=fromR.shifts[req.day],s2=toR.shifts[req.day];fromR.shifts[req.day]=s2;toR.shifts[req.day]=s1;
  const wk2=workIds();[fromR,toR].forEach(ag=>{let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=ag.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});ag.wd=wd2;ag.od=od2;ag.ald=ald2});
  D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
  req.status="Approved";req.decidedAt=new Date().toISOString();regenBreaksForDay(req.day);save();renderRoster();toast("Swap approved: "+req.fromName+" â†” "+req.toName+" on "+req.day)}
function rejectSwapReq(reqId){if(!D.swapRequests)return;const req=D.swapRequests.find(r=>r.id===reqId);if(!req)return;req.status="Rejected";req.decidedAt=new Date().toISOString();save();renderRoster();toast("Swap rejected")}
function approvePref(prefId){if(!D.schedPrefs)return;const p=D.schedPrefs.find(x=>x.id===prefId);if(!p)return;const note=prompt("Admin note for "+p.name+"'s preference ("+p.day+" â†’ "+p.request+"):\nLeave blank to just acknowledge.","Noted, will try to accommodate");p.status="Approved";p.adminNote=note||"Acknowledged";p.decidedAt=new Date().toISOString();save();renderRoster();autoCloudSync();toast("Preference noted")}
function rejectPref(prefId){if(!D.schedPrefs)return;const p=D.schedPrefs.find(x=>x.id===prefId);if(!p)return;const note=prompt("Reason for rejecting "+p.name+"'s preference:","Cannot accommodate this week");p.status="Rejected";p.adminNote=note||"";p.decidedAt=new Date().toISOString();save();renderRoster();autoCloudSync();toast("Preference rejected")}
// â•â•â• ARCHIVE â•â•â•
function getArchiveKey(){return"ys_archive"}
function loadArchiveList(){try{const s=localStorage.getItem(getArchiveKey());return s?JSON.parse(s):[]}catch(e){return[]}}
function saveArchiveList(list){try{localStorage.setItem(getArchiveKey(),JSON.stringify(list))}catch(e){}}
function saveWeekArchive(){if(!D.roster)return toast("Generate first","err");const wk=document.getElementById("wkStart").value;if(!wk)return toast("Set week date","err");const snap={week:wk,savedAt:new Date().toISOString(),data:JSON.parse(JSON.stringify(D)),breaks:BK.results?JSON.parse(JSON.stringify({results:BK.results,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows})):null};const list=loadArchiveList();const idx=list.findIndex(x=>x.week===wk);if(idx>=0){if(!confirm(`Overwrite saved week ${wk}?`))return;list[idx]=snap}else list.unshift(snap);saveArchiveList(list);renderArchive();toast(`Week ${wk} saved!`);
  // Also download as JSON file
  const blob=new Blob([JSON.stringify(snap,null,2)],{type:"application/json"});dl(blob,`schedule_${wk}.json`)}
function loadWeekArchive(wk){const list=loadArchiveList();const snap=list.find(x=>x.week===wk);if(!snap)return toast("Not found","err");if(!confirm(`Load week ${wk}? Current unsaved changes will be lost.`))return;Object.assign(D,snap.data);if(snap.breaks){BK.results=snap.breaks.results;BK.breakPattern=snap.breaks.breakPattern;BK.breakPatternC=snap.breaks.breakPatternC;BK.peakWindows=snap.breaks.peakWindows}else{BK.results=null}document.getElementById("wkStart").value=snap.week;document.getElementById("rMO").value=D.rules.max_off;document.getElementById("rMW").value=D.rules.max_work;renderAll();if(D.roster)renderRoster();toast(`Loaded week ${wk}`);document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-roster").style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="roster"]').classList.add("on")}
function deleteWeekArchive(wk){if(!confirm(`Delete week ${wk}?`))return;const list=loadArchiveList().filter(x=>x.week!==wk);saveArchiveList(list);renderArchive();toast("Deleted")}
function renderArchive(){const el=document.getElementById("archList");const list=loadArchiveList();if(!list.length){el.innerHTML='<div class="emp">No saved weeks.</div>';return}el.innerHTML=list.map(s=>{const d=new Date(s.savedAt);const agents=s.data.roster?s.data.roster.length:s.data.agents.length;return`<div class="ar" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:10px"><b style="font-family:var(--mono)">${s.week}</b><span style="color:var(--tx2);font-size:11px">${agents} agents â€” saved ${d.toLocaleDateString()} ${d.toLocaleTimeString()}</span></div><div style="display:flex;gap:4px"><button class="btn bp bsm" onclick="loadWeekArchive('${s.week}')">Load</button><button class="btn bs2 bsm" onclick="dlArchive('${s.week}')">&#128229; JSON</button><button class="btn bd bsm bic" onclick="deleteWeekArchive('${s.week}')">âœ•</button></div></div>`}).join("")}
function dlArchive(wk){const list=loadArchiveList();const snap=list.find(x=>x.week===wk);if(!snap)return;dl(new Blob([JSON.stringify(snap,null,2)],{type:"application/json"}),`schedule_${wk}.json`)}
function importWeekFile(){document.getElementById("impFile").click()}
function handleImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const snap=JSON.parse(ev.target.result);if(!snap.data||!snap.week)throw"Invalid";const list=loadArchiveList();const idx=list.findIndex(x=>x.week===snap.week);if(idx>=0)list[idx]=snap;else list.unshift(snap);saveArchiveList(list);renderArchive();toast(`Imported week ${snap.week}`)}catch(err){toast("Invalid file","err")}};r.readAsText(f);e.target.value=""}
// â•â•â• TEAM VIEW EXPORT â•â•â•
function exportTeamHTML(){if(!D.roster)return toast("Generate first","err");const wk=document.getElementById("wkStart").value;let h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Schedule ${wk}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#0a0c10;color:#e2e6ef;padding:20px}h1{font-size:20px;margin-bottom:4px}h1 em{font-style:normal;color:#38bdf8}.sub{color:#8490a8;font-size:12px;margin-bottom:16px}table{width:100%;border-collapse:collapse;font-size:13px;background:#12151c;border-radius:10px;overflow:hidden}th{padding:10px;background:#1a1e28;color:#8490a8;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #2a3148}td{padding:8px 10px;border-bottom:1px solid #2a3148;text-align:center;white-space:nowrap}td:first-child{text-align:left}.sb{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:24px;border-radius:5px;font-family:monospace;font-size:11px;font-weight:600;color:#fff}.sg{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:16px}.sc{background:#1a1e28;border-radius:8px;padding:10px;text-align:center}.scd{font-size:10px;font-weight:700;color:#8490a8;text-transform:uppercase;margin-bottom:6px}.scs{display:flex;flex-wrap:wrap;gap:2px;justify-content:center}.m{font-size:10px;color:#586380;margin-top:16px;text-align:center}</style></head><body>`;
  h+=`<h1><em>Yousef Shtawi</em> Schedule</h1><p class="sub">Week of ${wk} â€” ${D.roster.length} agents</p>`;
  h+=`<table><thead><tr><th style="text-align:left;min-width:180px">Agent</th><th>G</th>`;DAYS.forEach(d=>h+=`<th>${d}</th>`);h+=`<th>W</th><th>O</th><th>AL</th></tr></thead><tbody>`;
  D.roster.forEach(r=>{h+=`<tr><td>${r.name}</td><td>${r.gender}</td>`;DAYS.forEach(d=>{const s=r.shifts[d];h+=`<td><span class="sb" style="background:${sColor(s)}">${s}</span></td>`});h+=`<td>${r.wd}</td><td>${r.od}</td><td>${r.ald}</td></tr>`});
  h+=`</tbody></table><div class="sg">`;const ai2=allIds();DAYS.forEach(day=>{const c=D.summary[day]||{};h+=`<div class="sc"><div class="scd">${day}</div><div class="scs">`;ai2.forEach(sid=>{h+=`<span class="sb" style="background:${sColor(sid)};font-size:9px;min-width:36px;height:18px">${sid}:${c[sid]||0}</span>`});h+=`</div></div>`});
  h+=`</div><p class="m">Generated by Yousef Shtawi Schedule</p>`;
  // Add breaks if available â€” click-by-day tabs
  if(BK.results){h+=`<h2 style="font-size:16px;margin:20px 0 10px;color:#e2e6ef">Break Schedule</h2>`;
    h+=`<div style="display:flex;gap:4px;margin-bottom:12px">`;
    DAYS.forEach((day,i)=>{const dd=BK.results[day];if(!dd||!dd.assignments||!dd.assignments.length)return;h+=`<button onclick="document.querySelectorAll('.bkTabContent').forEach(e=>e.style.display='none');document.getElementById('bk_${day}').style.display='block';document.querySelectorAll('.bkTabBtn').forEach(b=>{b.style.background='#1a1e28';b.style.color='#8490a8'});this.style.background='#3b82f6';this.style.color='#fff'" class="bkTabBtn" style="padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:${i===0?'#3b82f6':'#1a1e28'};color:${i===0?'#fff':'#8490a8'}">${day}</button>`});
    h+=`</div>`;let first=true;
    DAYS.forEach(day=>{const dd=BK.results[day];if(!dd||!dd.assignments||!dd.assignments.length)return;
      const maxS=Math.max(BK.breakPattern.length,BK.breakPatternC.length,4);
      h+=`<div id="bk_${day}" class="bkTabContent" style="display:${first?'block':'none'}"><table><thead><tr><th style="text-align:left">Agent</th><th>Shift</th><th>Hours</th>`;
      for(let i=0;i<maxS;i++)h+=`<th>Break ${i+1}</th>`;h+=`<th>Total</th></tr></thead><tbody>`;
      for(const a of dd.assignments){const br=fBR(a.breakSlots,a.pattern);h+=`<tr><td style="text-align:left">${a.name}</td><td><span class="sb" style="background:${sColor(a.code)}">${a.code}</span></td><td style="font-family:monospace;font-size:11px">${mT2(a.start)}-${mT2(a.end)}</td>`;
        for(let i=0;i<maxS;i++)h+=i<br.length?`<td style="font-family:monospace;font-size:11px">${br[i]}</td>`:`<td style="color:#586380">â€”</td>`;
        h+=`<td style="font-family:monospace;font-weight:600">${a.breakSlots.length*15}m</td></tr>`}h+=`</tbody></table></div>`;first=false})}
  h+=`</body></html>`;
  dl(new Blob([h],{type:"text/html"}),`team_schedule_${wk}.html`);toast("Team view exported!")}
function exportCSV(){if(!D.roster)return toast("Generate first","err");let c="Agent,Gender,"+DAYS.join(",")+",Work,OFF,AL\n";D.roster.forEach(r=>{c+=`"${r.name}",${r.gender},`+DAYS.map(d=>r.shifts[d]).join(",")+`,${r.wd},${r.od},${r.ald}\n`});dl(new Blob([c],{type:"text/csv"}),"schedule.csv")}
function exportXLSX(){if(!D.roster)return toast("Generate first","err");if(typeof XLSX==="undefined")return toast("SheetJS not loaded","err");const wb=XLSX.utils.book_new();const hdr=["Agent","Gender",...DAYS,"Work","OFF","AL"];const rows=D.roster.map(r=>[r.name,r.gender,...DAYS.map(d=>r.shifts[d]),r.wd,r.od,r.ald]);const ws=XLSX.utils.aoa_to_sheet([hdr,...rows]);ws["!cols"]=[{wch:40},{wch:7},...DAYS.map(()=>({wch:6})),{wch:6},{wch:6},{wch:6}];XLSX.utils.book_append_sheet(wb,ws,"Roster");const ai2=allIds();const sh=[["Day",...ai2,"Total"],...DAYS.map(d=>{const c=D.summary[d]||{};const v=ai2.map(s=>c[s]||0);return[d,...v,v.reduce((a,b)=>a+b,0)]})];XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sh),"Summary");XLSX.writeFile(wb,"schedule.xlsx");toast("Excel exported")}
function dl(b,n){const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=n;a.click();URL.revokeObjectURL(a.href)}
// â•â•â• BREAK ENGINE â•â•â•
const BK={breakPattern:[1,1,1,1],breakPatternC:[1,1],peakWindows:[{from:420,to:660,max:1},{from:660,to:900,max:2},{from:900,to:1020,max:1},{from:1020,to:1500,max:2},{from:0,to:420,max:2}],results:null};
const SH_MAP=()=>{const m={};D.shifts.forEach(s=>{const[sh2,sm2]=s.start.split(":").map(Number),[eh2,em2]=s.end.split(":").map(Number);let st=sh2*60+sm2,en=eh2*60+em2;if(en<=st)en+=1440;m[s.id]={s:st,e:en}});return m};
const NW2=new Set(["OFF","AL"]);
const mT2=m=>`${String(Math.floor(m/60)%24).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
const tToMin=s=>{const[h,m]=s.split(":").map(Number);return h*60+m};
function bkCapAt(t){for(const pw of BK.peakWindows){let f=pw.from,to=pw.to;if(f<to){if(t>=f&&t<to)return pw.max}else{if(t>=f||t<to)return pw.max}}return 2}
function bkSlots(code){const sh=SH_MAP();const sd=sh[code];if(!sd)return[];const r=[];if(code==="C"){for(let t=sd.s+30;t<=(sd.e-30)-15;t+=15){if(t>=60&&t<420)continue;r.push(t)}}else{for(let t=sd.s+60;t<=sd.e-60-15;t+=15)r.push(t)}return r}
function bkSolveDay(dn,agents){const sh=SH_MAP();const w=[],errs=[];for(const{name,code}of agents){if(NW2.has(code))continue;if(!sh[code]){errs.push(`Unknown '${code}' for ${name}`);continue}const pat=code==="C"?BK.breakPatternC:BK.breakPattern;const rq=pat.reduce((a,b)=>a+b,0);w.push({name,code,rq,pattern:pat,vs:bkSlots(code),start:sh[code].s,end:sh[code].e})}
  if(errs.length)return{ok:false,error:{day:dn,reasons:errs}};
  const rng=(()=>{let s=42;return()=>{s=Math.imul(s^(s>>>16),0x45d9f3b);s=Math.imul(s^(s>>>13),0x45d9f3b);return((s^=s>>>16)>>>0)/4294967296}})();
  const ord=[...w.keys()].sort((a,b)=>w[a].vs.length-w[b].vs.length);const su={},asgn=w.map(()=>[]);let iters=0;
  function getIdeal(ag,pat){const us=ag.start+60,ue=ag.end-60,ul=ue-us,pos=[];for(let si=0;si<pat.length;si++)pos.push(us+Math.round(ul*(si+1)/(pat.length+1)));return pos}
  function bt(oidx){if(iters>300000)return false;if(oidx>=ord.length)return true;const ai=ord[oidx],ag=w[ai];return tryA(ai,ag,0,[],ag.pattern,oidx,getIdeal(ag,ag.pattern))}
  function tryA(ai,ag,si,placed,pat,oidx,ideals){if(iters>300000)return false;iters++;if(si>=pat.length){asgn[ai]=[...placed];return bt(oidx+1)}
    const segLen=pat[si],minGap=60,minStart=placed.length>0?placed[placed.length-1]+15+minGap:ag.vs[0];const cands=[];
    for(let i=0;i<=ag.vs.length-segLen;i++){if(ag.vs[i]<minStart)continue;let ok=true;const ss=[];for(let j=0;j<segLen;j++){const t=ag.vs[i+j];if(j>0&&t!==ag.vs[i+j-1]+15){ok=false;break}if((su[t]||0)>=bkCapAt(t)){ok=false;break}ss.push(t)}if(!ok)continue;
      let score=-Math.abs(ss[0]-(ideals[si]||0))*0.5;for(const t of ss)score-=(su[t]||0)*40;score+=rng()*4;cands.push({slots:ss,score})}
    cands.sort((a,b)=>b.score-a.score);for(let ci=0;ci<Math.min(cands.length,15);ci++){const{slots}=cands[ci];for(const t of slots)su[t]=(su[t]||0)+1;
      if(tryA(ai,ag,si+1,[...placed,...slots],pat,oidx,ideals))return true;for(const t of slots){su[t]--;if(!su[t])delete su[t]}}return false}
  if(!bt(0))return{ok:false,error:{day:dn,reasons:["Solver exhausted options"]}};
  const sc={};w.forEach(a=>sc[a.code]=(sc[a.code]||0)+1);const tReq=w.reduce((s2,a)=>s2+a.rq,0);
  return{ok:true,assignments:w.map((a,i)=>({name:a.name,code:a.code,start:a.start,end:a.end,breakSlots:asgn[i].slice().sort((a2,b)=>a2-b),pattern:a.pattern})),validation:{shiftCounts:sc,totalAgents:w.length,totalRequired:tReq}}
}
function fBR(slots,pat){if(!slots.length)return[];const sorted=[...slots].sort((a,b)=>a-b);const ranges=[];let idx=0;for(const segLen of pat){if(idx>=sorted.length)break;ranges.push(`${mT2(sorted[idx])}-${mT2(sorted[idx+segLen-1]+15)}`);idx+=segLen}return ranges}
function genBreaks(){if(!D.roster){toast("Generate roster first","err");return}
  const btn=document.getElementById("btnBK");btn.innerHTML='<span class="spin"></span>';btn.disabled=true;
  setTimeout(()=>{BK.results={};DAYS.forEach(d=>{const agents=D.roster.filter(r=>r.shifts[d]&&!NW2.has(r.shifts[d])).map(r=>({name:r.name,code:r.shifts[d]}));
    const off=D.roster.filter(r=>NW2.has(r.shifts[d])).map(r=>[r.name,r.shifts[d]]);
    const r=bkSolveDay(d,agents);BK.results[d]={assignments:r.ok?r.assignments:[],error:r.ok?null:r.error,offAgents:off,validation:r.validation||{}}});
    D.breakResults=BK.results;D.breakPattern=BK.breakPattern;D.breakPatternC=BK.breakPatternC;D.peakWindows=BK.peakWindows;save();
    btn.innerHTML="&#9654; Generate Breaks";btn.disabled=false;toast("Breaks generated!");showBkDay("Mon")},30)}
function renderBkSettings(){const el=document.getElementById("bkSettingsArea");if(!el)return;
  let bpH="";BK.breakPattern.forEach((seg,i)=>{bpH+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700;color:var(--acc);width:24px">${i+1}</span><label style="font-size:12px">Duration:</label><select style="width:80px" onchange="BK.breakPattern[${i}]=parseInt(this.value);renderBkSettings()"><option value="1" ${seg===1?"selected":""}>15 min</option><option value="2" ${seg===2?"selected":""}>30 min</option><option value="3" ${seg===3?"selected":""}>45 min</option></select>${BK.breakPattern.length>1?`<button class="btn bd bsm" onclick="BK.breakPattern.splice(${i},1);renderBkSettings()">Remove</button>`:""}</div>`});
  let bpCH="";BK.breakPatternC.forEach((seg,i)=>{bpCH+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700;color:var(--orn);width:24px">${i+1}</span><label style="font-size:12px">Duration:</label><select style="width:80px" onchange="BK.breakPatternC[${i}]=parseInt(this.value);renderBkSettings()"><option value="1" ${seg===1?"selected":""}>15 min</option><option value="2" ${seg===2?"selected":""}>30 min</option></select>${BK.breakPatternC.length>1?`<button class="btn bd bsm" onclick="BK.breakPatternC.splice(${i},1);renderBkSettings()">Remove</button>`:""}</div>`});
  let pkH="";BK.peakWindows.forEach((pw,i)=>{pkH+=`<div class="fr" style="padding:6px 0"><input type="time" value="${mT2(pw.from)}" onchange="BK.peakWindows[${i}].from=tToMin(this.value)" style="width:100px"><span style="color:var(--tx3)">to</span><input type="time" value="${mT2(pw.to)}" onchange="BK.peakWindows[${i}].to=tToMin(this.value)" style="width:100px"><span style="font-size:11px">max:</span><select style="width:50px" onchange="BK.peakWindows[${i}].max=parseInt(this.value)"><option value="1" ${pw.max===1?"selected":""}>1</option><option value="2" ${pw.max===2?"selected":""}>2</option><option value="3" ${pw.max===3?"selected":""}>3</option></select><span class="tg" style="background:${pw.max===1?"#7f1d1d":"#064e3b"};color:${pw.max===1?"#fca5a5":"#6ee7b7"}">${pw.max===1?"PEAK":"NORMAL"}</span><button class="btn bd bsm bic" onclick="BK.peakWindows.splice(${i},1);renderBkSettings()">âœ•</button></div>`});
  const totA=BK.breakPattern.reduce((a,b)=>a+b,0)*15,totC=BK.breakPatternC.reduce((a,b)=>a+b,0)*15;
  el.innerHTML=`<div class="card"><div class="ch"><h3>A/MS/B Break Pattern (${totA}min total)</h3></div><div class="cb">${bpH}<button class="btn bs2 bsm" onclick="BK.breakPattern.push(1);renderBkSettings()" style="margin-top:6px">+ Add Break</button></div></div><div class="card"><div class="ch"><h3>C Shift Break Pattern (${totC}min total)</h3></div><div class="cb">${bpCH}<button class="btn bs2 bsm" onclick="BK.breakPatternC.push(1);renderBkSettings()" style="margin-top:6px">+ Add Break</button></div></div><div class="card"><div class="ch"><h3>Peak / Capacity Windows</h3></div><div class="cb"><p style="font-size:11px;color:var(--tx2);margin-bottom:8px">Max concurrent agents on break per time window. Peak = max 1.</p>${pkH}<button class="btn bs2 bsm" onclick="BK.peakWindows.push({from:0,to:60,max:1});renderBkSettings()" style="margin-top:6px">+ Add Window</button></div></div>`}
function showBkDay(day){const pg=document.getElementById("p-bkday");if(pg.style.display==="none"){document.querySelectorAll(".pg").forEach(x=>x.style.display="none");pg.style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="bkday"]').classList.add("on")}
  const tabs=document.getElementById("bkDayTabs");const wsVal=document.getElementById("wkStart").value;const weekDts=getWeekDates(wsVal);tabs.innerHTML=DAYS.map((d,di)=>{const dateStr=weekDts?' <span style="font-size:9px;color:var(--tx3)">'+fmtShortDate(weekDts[di])+'</span>':'';return`<button class="btn ${d===day?"bp":"bs2"} bsm" onclick="showBkDay('${d}')">${d}${dateStr}</button>`}).join("");
  const area=document.getElementById("bkDayArea");if(!BK.results||!BK.results[day]){area.innerHTML='<div class="emp">Generate breaks first.</div>';return}
  // â”€â”€ Validate: check if break data matches current roster â”€â”€
  if(D.roster&&BK.results[day]&&BK.results[day].assignments){
    const as=BK.results[day].assignments;let mismatch=false;
    for(const ba of as){const ra=D.roster.find(r=>r.name===ba.name);
      if(ra&&ra.shifts[day]!==ba.code){mismatch=true;break}}
    if(mismatch){
      // Auto-regenerate breaks for this day
      const agents2=D.roster.filter(r=>r.shifts[day]&&!NW2.has(r.shifts[day])).map(r=>({name:r.name,code:r.shifts[day]}));
      const off=D.roster.filter(r=>NW2.has(r.shifts[day])).map(r=>[r.name,r.shifts[day]]);
      const br=bkSolveDay(day,agents2);
      BK.results[day]={assignments:br.ok?br.assignments:[],error:br.ok?null:br.error,offAgents:off,validation:br.validation||{}};
      D.breakResults=BK.results;save();
    }
  }
  const dd=BK.results[day],as=dd.assignments||[],off=dd.offAgents||[];
  if(dd.error){area.innerHTML=`<div class="card"><div class="ch"><h3 style="color:var(--red)">Error â€” ${day}</h3></div><div class="cb">${(dd.error.reasons||[]).map(r=>`<p style="color:var(--red);font-size:12px">${r}</p>`).join("")}</div></div>`;return}
  const maxS=Math.max(BK.breakPattern.length,BK.breakPatternC.length,4);let thB="";for(let i=0;i<maxS;i++)thB+=`<th>Break ${i+1}</th>`;
  let rows="";for(const a of as){const br=fBR(a.breakSlots,a.pattern);let c="";for(let i=0;i<maxS;i++)c+=i<br.length?`<td><span style="font-family:var(--mono);font-size:11px;background:var(--s3);padding:2px 6px;border-radius:4px">${br[i]}</span></td>`:'<td style="color:var(--tx3)">â€”</td>';
    rows+=`<tr><td style="text-align:left">${a.name}</td><td><span class="sb" style="background:${sColor(a.code)}">${a.code}</span></td><td style="font-family:var(--mono);font-size:11px">${mT2(a.start)}-${mT2(a.end)}</td>${c}<td style="font-family:var(--mono);font-weight:600">${a.breakSlots.length*15}m</td></tr>`}
  let offH="";if(off.length){offH='<div style="margin-top:12px"><p style="font-size:11px;color:var(--tx2);margin-bottom:6px">Not Working:</p><div style="display:flex;flex-wrap:wrap;gap:4px">'+off.map(([n,c])=>`<span style="font-size:11px;background:var(--s3);padding:2px 8px;border-radius:4px;color:var(--tx2)">${n} (${c})</span>`).join("")+"</div></div>"}
  const val=dd.validation||{};let valH=`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px"><span class="tg tga">${val.totalAgents||0} Working</span>`;if(val.shiftCounts)for(const[s2,c]of Object.entries(val.shiftCounts))valH+=`<span class="sb" style="background:${sColor(s2)};font-size:10px">${s2}: ${c}</span>`;valH+=`<span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">${val.totalRequired||0} break slots needed</span><span class="tg tga">âœ“ Feasible</span></div>`;
  area.innerHTML=valH+`<div class="tw"><table><thead><tr><th style="text-align:left">Agent</th><th>Shift</th><th>Hours</th>${thB}<th>Total</th></tr></thead><tbody>${rows}</tbody></table></div>`+offH}
function renderBkLive(){const area=document.getElementById("bkLiveArea");if(!area)return;if(!BK.results){area.innerHTML='<div class="emp">Generate breaks first.</div>';return}
  const now=new Date(),h=now.getHours(),m=now.getMinutes(),s=now.getSeconds(),nowMin=h*60+m;
  const dayName=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][now.getDay()];const dd=BK.results[dayName];
  if(!dd){area.innerHTML=`<div class="emp">No break data for ${dayName}.</div>`;return}
  // â”€â”€ Validate: check if break data matches current roster â”€â”€
  if(D.roster&&dd.assignments){
    let mismatch=false;
    for(const ba of dd.assignments){const ra=D.roster.find(r=>r.name===ba.name);
      if(ra&&ra.shifts[dayName]!==ba.code){mismatch=true;break}}
    if(mismatch){
      const agents2=D.roster.filter(r=>r.shifts[dayName]&&!NW2.has(r.shifts[dayName])).map(r=>({name:r.name,code:r.shifts[dayName]}));
      const off=D.roster.filter(r=>NW2.has(r.shifts[dayName])).map(r=>[r.name,r.shifts[dayName]]);
      const br=bkSolveDay(dayName,agents2);
      BK.results[dayName]={assignments:br.ok?br.assignments:[],error:br.ok?null:br.error,offAgents:off,validation:br.validation||{}};
      D.breakResults=BK.results;save();
    }
  }
  const as=dd.assignments||[];const onBreak=[],upcoming=[];
  for(const a of as){const sorted=[...a.breakSlots].sort((x,y)=>x-y);let idx=0;for(const segLen of a.pattern){if(idx>=sorted.length)break;const ss=sorted[idx],se=sorted[idx+segLen-1]+15;
    if(nowMin>=ss&&nowMin<se){onBreak.push({name:a.name,code:a.code,start:ss,end:se,elapsed:nowMin-ss,total:se-ss,progress:((nowMin-ss)/(se-ss))*100})}
    else if(ss>nowMin&&ss-nowMin<=60){upcoming.push({name:a.name,code:a.code,start:ss,end:se,mins:ss-nowMin})}idx+=segLen}}
  upcoming.sort((a,b)=>a.mins-b.mins);
  const timeStr=`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;const secStr=String(s).padStart(2,"0");
  const dayFull=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][now.getDay()];
  const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  let bH="";if(!onBreak.length)bH='<p style="color:var(--tx3);font-size:12px">No agents on break right now</p>';
  else for(const b of onBreak){bH+=`<div class="ar" style="gap:8px"><span class="sb" style="background:${sColor(b.code)};font-size:9px">${b.code}</span><span style="flex:1;font-weight:600">${b.name}</span><span style="font-family:var(--mono);font-size:11px;color:var(--cyn)">${mT2(b.start)}-${mT2(b.end)}</span><span style="font-size:10px;color:var(--tx2)">${b.elapsed}/${b.total}min</span></div><div style="height:3px;background:var(--s3);border-radius:2px;margin:-2px 0 4px;overflow:hidden"><div style="height:100%;width:${b.progress}%;background:linear-gradient(90deg,var(--acc),var(--grn));border-radius:2px"></div></div>`}
  let uH="";if(!upcoming.length)uH='<p style="color:var(--tx3);font-size:12px">No upcoming breaks</p>';
  else for(const u of upcoming.slice(0,5)){uH+=`<div class="ar" style="gap:8px;background:var(--s3)"><span class="sb" style="background:${sColor(u.code)};font-size:9px">${u.code}</span><span style="flex:1;color:var(--tx2)">${u.name}</span><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">${mT2(u.start)}-${mT2(u.end)}</span><span style="font-family:var(--mono);font-size:12px;font-weight:700;color:var(--orn)">in ${u.mins}m</span></div>`}
  area.innerHTML=`<div class="card" style="background:linear-gradient(135deg,rgba(59,130,246,.04),rgba(16,185,129,.03));border-color:rgba(59,130,246,.2)"><div class="ch"><h3 style="color:var(--grn)">â— Live â€” ${dayName}</h3><span style="font-size:11px;color:var(--tx2)">${as.length} agents working</span></div><div class="cb"><div style="display:grid;grid-template-columns:auto 1fr;gap:16px"><div style="text-align:center"><div style="font-family:var(--mono);font-size:2rem;font-weight:700;color:var(--acc)">${timeStr}<span style="font-size:1rem;color:var(--tx3)">:${secStr}</span></div><div style="font-size:11px;color:var(--tx2)">${dayFull}, ${now.getDate()} ${mn[now.getMonth()]} ${now.getFullYear()}</div><div class="card" style="margin-top:10px;padding:10px;text-align:center"><div style="font-size:2rem;font-weight:800;color:${onBreak.length?"var(--acc)":"var(--tx3)"}">${onBreak.length}</div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase">On Break Now</div></div></div><div><div style="margin-bottom:12px"><p style="font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;margin-bottom:6px">â˜• Currently on Break</p>${bH}</div><div><p style="font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;margin-bottom:6px">â³ Coming Up (60min)</p>${uH}</div></div></div></div></div>`}
let bkLiveTimer=null;

// â•â•â• AGENT PORTAL â•â•â•
let AGENT_MODE=false,AGENT_ID=null,AGENT_DATA=null;
function checkAgentMode(){const params=new URLSearchParams(location.search);const agId=params.get("agent");if(!agId)return false;AGENT_MODE=true;AGENT_ID=agId;
  // Show loading screen immediately
  document.body.innerHTML='<div id="agLoadScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--tx)"><div style="text-align:center"><h1 style="font-size:20px;font-weight:800;margin-bottom:8px"><em style="font-style:normal;background:linear-gradient(135deg,#3b82f6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Schedule</h1><p style="color:#8490a8;font-size:13px" id="agLoadMsg">Loading your schedule...</p><div style="margin-top:16px;width:40px;height:40px;border:3px solid #232938;border-top-color:#3b82f6;border-radius:50%;animation:spin .8s linear infinite;margin:16px auto"></div></div></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style><div id="agToast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#052e16;border:1px solid #064e3b;color:#86efac;border-radius:8px;font-size:12px;z-index:9999;opacity:0;transition:opacity .3s"></div>';
  // Try to find agent locally first
  AGENT_DATA=D.agents.find(function(a){return a.id===agId;});
  
  async function initAgentWithCloud(){
    // Try supabase load with retry
    for(let attempt=1;attempt<=3;attempt++){
      try{
        const loadMsg=document.getElementById("agLoadMsg");
        if(loadMsg)loadMsg.textContent="Loading from cloud (attempt "+attempt+"/3)...";
        
        // Wait for supabase to init if needed
        if(!SB){
          for(let t=0;t<10;t++){
            if(typeof supabase!=="undefined"){initSupabase();break;}
            await new Promise(r=>setTimeout(r,200));
          }
        }
        
        if(SB){
          await agLoadFromCloud();
          AGENT_DATA=D.agents.find(function(a){return a.id===agId;});
          if(!AGENT_DATA){
            // Try partial match
            AGENT_DATA=D.agents.find(function(a){return a.id.startsWith(agId.slice(0,4));});
          }
          if(AGENT_DATA){AGENT_ID=AGENT_DATA.id;renderAgentPortal();return;}
        }
        
        if(attempt<3)await new Promise(r=>setTimeout(r,800));
      }catch(e){
        console.warn("Agent load attempt "+attempt+" failed:",e);
        if(attempt<3)await new Promise(r=>setTimeout(r,800));
      }
    }
    // All attempts failed
    if(D.agents.length===0){
      showAgentNotFound();
    }else{
      // Show all agents list as fallback
      var _ag='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0a0c10;color:#e2e6ef;padding:20px"><div style="max-width:500px;width:100%"><h1 style="font-size:20px;font-weight:800;margin-bottom:4px"><em style="font-style:normal;background:linear-gradient(135deg,#3b82f6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Schedule</h1><p style="color:#8490a8;font-size:12px;margin-bottom:20px">Agent not found: '+agId+'</p><div style="background:#12151c;border:1px solid #2a3148;border-radius:8px;padding:16px"><p style="font-size:12px;font-weight:700;margin-bottom:12px;color:#8490a8">AGENTS IN SYSTEM</p>';
      D.agents.forEach(function(a){_ag+='<div style="padding:8px;cursor:pointer;border-radius:6px;font-size:13px;font-weight:500;color:#e2e6ef;margin-bottom:2px;background:#0d1018" onclick="window.location.search=String(\"?agent='+a.id+'\")">â–¶ '+a.name+'</div>';});
      _ag+='</div></div></div>';
      document.body.innerHTML=_ag;
    }
  }
  
  if(AGENT_DATA){
    // Found locally - still load fresh data from cloud
    if(SB){agLoadFromCloud().then(function(){renderAgentPortal();}).catch(function(){renderAgentPortal();});}
    else renderAgentPortal();
    return true;
  }
  // Not found locally â€” must try cloud with retry
  initAgentWithCloud();
  return true;
}
function showAgentNotFound(){
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0a0c10;color:#e2e6ef"><div style="text-align:center;max-width:400px;padding:20px"><h1 style="font-size:20px;font-weight:800;margin-bottom:8px"><em style="font-style:normal;background:linear-gradient(135deg,#3b82f6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Schedule</h1><div style="font-size:48px;margin:20px 0">ðŸ”—</div><h2 style="font-size:16px;margin-bottom:8px">Agent Link Not Found</h2><p style="color:#8490a8;font-size:13px;margin-bottom:16px">This link may be outdated or the schedule hasn\'t been saved to cloud yet.</p><div style="background:#12151c;border:1px solid #2a3148;border-radius:8px;padding:14px;text-align:left"><p style="font-size:11px;font-weight:600;color:#8490a8;margin-bottom:8px">Possible fixes:</p><p style="font-size:11px;color:#586380;margin-bottom:4px">1. Ask your supervisor to click <b style="color:#3b82f6">Cloud Save</b> first</p><p style="font-size:11px;color:#586380;margin-bottom:4px">2. Get a fresh link from the <b style="color:#3b82f6">Agents</b> page</p><p style="font-size:11px;color:#586380">3. Make sure the schedule has been generated</p></div></div></div>';
}
async function agLoadFromCloud(){if(!SB)return;
  // Find workspace
  const{data:ws}=await SB.from("workspaces").select("*").limit(1).single();if(!ws)return;
  const{data:weeks}=await SB.from("weeks").select("*").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1);
  if(weeks&&weeks.length){const row=weeks[0];const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(s.rules)D.rules=s.rules;if(s.alRules)D.alRules=s.alRules;
    if(row.agents_json)D.agents=row.agents_json;if(row.distribution_json)D.dist=row.distribution_json;
    if(row.roster_json)D.roster=row.roster_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
    if(row.attendance_json)D.attendance=row.attendance_json;
    if(s.kpis)D.kpis=s.kpis;if(s.schedPrefs)D.schedPrefs=s.schedPrefs;if(s.swapRequests)D.swapRequests=s.swapRequests;if(s.requestHistory)D.requestHistory=s.requestHistory;
    if(row.week_start)try{localStorage.setItem("ys_weekStart",row.week_start)}catch(e){}
    if(row.breaks_json&&s.breakPattern){BK.results=row.breaks_json;BK.breakPattern=s.breakPattern;BK.breakPatternC=s.breakPatternC;BK.peakWindows=s.peakWindows}
    AGENT_DATA=D.agents.find(a=>a.id===AGENT_ID)}
  // Subscribe to realtime updates
  SB.channel("agent-live").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:"workspace_id=eq."+ws.id},payload=>{
    const row=payload.new;const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(row.roster_json)D.roster=row.roster_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
    if(row.attendance_json)D.attendance=row.attendance_json;if(row.breaks_json){BK.results=row.breaks_json;if(s.breakPattern)BK.breakPattern=s.breakPattern}
    if(s.kpis)D.kpis=s.kpis;
    if(s.schedPrefs)D.schedPrefs=s.schedPrefs;
    if(s.requestHistory)D.requestHistory=s.requestHistory;
    if(row.agents_json)D.agents=row.agents_json;AGENT_DATA=D.agents.find(a=>a.id===AGENT_ID);
    renderAgentPortal();showAgToast("Schedule updated!")}).subscribe()}
let agToastT;function showAgToast(m){const el=document.getElementById("agToast");if(!el)return;el.textContent=m;el.style.opacity="1";clearTimeout(agToastT);agToastT=setTimeout(()=>el.style.opacity="0",3000)}
function renderAgentPortal(){
  const a=AGENT_DATA;if(!a){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--tx)"><h2>Agent not found</h2></div>';return}
  const myLeaves=D.al.filter(x=>x.aid===AGENT_ID&&x.status!=="Rejected"&&x.status!=="Deleted").sort((x,y)=>new Date(y.start)-new Date(x.start));const myRoster=D.roster?D.roster.find(r=>r.id===AGENT_ID):null;const totalYear=D.alRules?.totalDays||30;const yr=new Date().getFullYear();const usedDays=myLeaves.filter(l=>alYear(l.start)===yr&&(l.status==="Completed"||l.status==="Ongoing")).reduce((s,l)=>s+alDays(l.start,l.end),0);const approvedDays=myLeaves.filter(l=>alYear(l.start)===yr&&l.status==="Approved").reduce((s,l)=>s+alDays(l.start,l.end),0);const rem=totalYear-usedDays-approvedDays;
  // Get week dates for date labels - in agent mode wkStart input doesn't exist, use stored week start
  let agWsVal="";
  const wkEl=document.getElementById("wkStart");
  if(wkEl&&wkEl.value)agWsVal=wkEl.value;
  else{try{const stored=localStorage.getItem("ys_weekStart");if(stored)agWsVal=stored}catch(e){}}
  if(!agWsVal){const td=new Date(),w2=td.getDay(),d2=w2===0?1:(w2===1?0:8-w2);const m2=new Date(td);m2.setDate(td.getDate()+d2);agWsVal=m2.toISOString().split("T")[0]}
  const agWeekDates=getWeekDates(agWsVal);
  let h='<div style="max-width:960px;margin:0 auto;padding:20px">';
  h+='<div style="text-align:center;margin-bottom:20px"><h1 style="font-size:20px;font-weight:800"><em style="font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Schedule</h1><p style="color:var(--tx2);font-size:13px;margin-top:4px">'+a.name+'</p></div>';
  // Agent alert banners â€” late login, exceeded breaks
  (function(){
    var today2=new Date();
    var todayN2=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][today2.getDay()];
    var nowMin2=today2.getHours()*60+today2.getMinutes();
    var myRosterNow=D.roster?D.roster.find(function(r){return r.id===AGENT_ID;}):null;
    // Late login alert
    if(myRosterNow){
      var sh2=myRosterNow.shifts[todayN2];
      var shObj2=sh2&&sh2!=="OFF"&&sh2!=="AL"?D.shifts.find(function(s){return s.id===sh2;}):null;
      if(shObj2){
        var sp2=shObj2.start.split(":");
        var startMin2=parseInt(sp2[0])*60+parseInt(sp2[1]);
        var attToday=D.attendance&&D.attendance[today2.toISOString().split("T")[0]]?D.attendance[today2.toISOString().split("T")[0]][AGENT_ID]:null;
        if(!attToday&&nowMin2>startMin2+15){
          h+='<div style="background:#450a0a;border:1px solid #7f1d1d;border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:8px">';
          h+='<span style="font-size:16px">âš ï¸</span><div><b style="color:#fca5a5;font-size:12px">Late Login Alert</b><p style="color:#fca5a5;font-size:11px;margin-top:2px">Your shift '+sh2+' started at '+shObj2.start+' but you are not yet clocked in. Please log in immediately.</p></div></div>';
        }
      }
    }
    // Exceeded break alert
    if(BK&&BK.results&&BK.results[todayN2]){
      var myBk=BK.results[todayN2].assignments?BK.results[todayN2].assignments.find(function(x){return x.name===a.name;}):null;
      if(myBk&&myBk.breakSlots){
        myBk.breakSlots.forEach(function(t,bi){
          if(nowMin2>=t+20&&nowMin2<t+45){
            h+='<div style="background:#451a03;border:1px solid #92400e;border-radius:8px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:8px">';
            h+='<span style="font-size:16px">â˜•</span><div><b style="color:#fde68a;font-size:12px">Break Overrun â€” Break '+(bi+1)+'</b><p style="color:#fde68a;font-size:11px;margin-top:2px">Your break was '+(mT2?mT2(t):t+":00")+' for 15 minutes. You have been on break for '+(nowMin2-t)+' minutes. Please return to your station.</p></div></div>';
          }
        });
      }
    }
  })();
  h+='<div style="display:flex;gap:6px;justify-content:center;margin-bottom:16px"><button class="btn bp bsm agTab" data-t="sched" onclick="agTab(\'sched\')">ðŸ“… Schedule</button><button class="btn bs2 bsm agTab" data-t="breaks" onclick="agTab(\'breaks\')">â˜• Breaks</button><button class="btn bs2 bsm agTab" data-t="leave" onclick="agTab(\'leave\')">ðŸŒ´ Leave</button><button class="btn bs2 bsm agTab" data-t="att" onclick="agTab(\'att\')">âœ… Attendance</button><button class="btn bs2 bsm agTab" data-t="kpi" onclick="agTab(\'kpi\')">ðŸ“Š Performance</button><button class="btn bs2 bsm agTab" data-t="aiagent" onclick="agTab(\'aiagent\')">ðŸ¤– AI Agent</button></div>';
  // Schedule
  h+='<div id="agSched" class="card"><div class="ch"><h3>ðŸ“… My Weekly Schedule</h3></div><div class="cb">';
  if(agWeekDates){const ws2=agWeekDates[0];const we=agWeekDates[6];const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];h+='<div style="text-align:center;font-family:var(--mono);font-size:11px;color:var(--cyn);margin-bottom:8px">Week of '+ws2.getDate()+' '+mn[ws2.getMonth()]+' â€” '+we.getDate()+' '+mn[we.getMonth()]+' '+we.getFullYear()+'</div>'}
  if(myRoster){h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">';DAYS.forEach((d,di)=>{const s2=myRoster.shifts[d];const dateStr=agWeekDates?'<div style="font-size:9px;color:var(--tx3);margin-bottom:2px">'+agWeekDates[di].getDate()+'/'+(agWeekDates[di].getMonth()+1)+'</div>':'';h+='<div style="text-align:center;padding:12px 6px;background:var(--s2);border-radius:6px;cursor:pointer" onclick="agSwapPick(\''+d+'\')">'+dateStr+'<div style="font-size:10px;font-weight:700;color:var(--tx2);margin-bottom:6px">'+d+'</div><span class="sb" style="background:'+sColor(s2)+';min-width:48px;height:30px;font-size:13px">'+s2+'</span></div>'});h+='</div><div style="margin-top:8px;text-align:center;font-size:12px;color:var(--tx2)">Work: <b>'+myRoster.wd+'</b> | OFF: <b>'+myRoster.od+'</b>'+(myRoster.ald?' | AL: <b>'+myRoster.ald+'</b>':'')+'</div>';
    h+='<div style="margin-top:10px;font-size:10px;color:var(--tx3);text-align:center">Click a day to request a shift swap</div>';
    h+='<div id="agSwapArea"></div>';
    // Schedule Preference Request
    h+='<div style="border:1px solid var(--brd);border-radius:8px;padding:12px;margin-top:14px;background:var(--s2)"><h4 style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:8px">ðŸ“‹ SCHEDULE PREFERENCES (Next Week)</h4>';
    h+='<p style="font-size:10px;color:var(--tx3);margin-bottom:8px">Request a specific day off or preferred shift for next week.</p>';
    h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"><div class="fg"><label style="font-size:10px">Day</label><select id="agPrefDay" style="width:90px">';DAYS.forEach(d=>{h+='<option value="'+d+'">'+d+'</option>'});
    h+='</select></div><div class="fg"><label style="font-size:10px">Request</label><select id="agPrefType" style="width:120px"><option value="OFF">Day OFF</option>';D.shifts.forEach(s=>{h+='<option value="'+s.id+'">Shift '+s.id+' ('+s.start+'-'+s.end+')</option>'});
    h+='</select></div><div class="fg"><label style="font-size:10px">Reason (optional)</label><input id="agPrefReason" placeholder="e.g. Doctor appointment" style="width:160px"></div>';
    h+='<div style="align-self:flex-end"><button class="btn bp bsm" onclick="agSubmitPref()">Submit</button></div></div>';
    h+='<div id="agPrefList"></div></div>';
    // Show existing preferences
    const myPrefs=(D.schedPrefs||[]).filter(p=>p.aid===AGENT_ID).sort((a2,b)=>new Date(b.addedAt)-new Date(a2.addedAt));
    if(myPrefs.length){h+='<div id="agPrefExisting" style="margin-top:8px"><b style="font-size:10px;color:var(--tx3)">My Requests</b>';myPrefs.slice(0,10).forEach(function(p){var st=p.status||"Pending";var delBtn=st==="Pending"?'<button onclick="agDeletePref(this.getAttribute(\'data-id\'))" data-id="'+p.id+'" style="font-size:9px;padding:1px 6px;border:1px solid #444;border-radius:3px;background:#1e2235;color:#8490a8;cursor:pointer;margin-left:auto">âœ• Cancel</button>':'';h+='<div style="display:flex;align-items:center;gap:6px;padding:5px 0;font-size:11px;border-bottom:1px solid var(--brd)"><span style="font-size:9px;padding:1px 5px;border-radius:3px;background:#1e2235;color:#f59e0b">'+st+'</span><b>'+p.day+'</b><span>'+p.request+'</span>'+(p.adminNote?'<span style="color:#f59e0b;font-size:10px">ðŸ’¬ '+p.adminNote+'</span>':'')+delBtn+'</div>';});h+='</div>'}
  }else h+='<p style="color:var(--tx3)">No roster generated yet</p>';
  h+='</div></div>';
  // Breaks
  h+='<div id="agAiAgent" style="display:none">'
  +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">'
  // Voice panel - left
  +'<div class="card" style="border-left:3px solid var(--cyn)">'
  +'<div class="ch"><h3 style="color:var(--cyn)">ðŸŽ™ï¸ Voice Mode</h3></div>'
  +'<div class="cb" style="text-align:center;padding:20px 16px">'
  +'<p style="font-size:12px;color:var(--tx2);margin-bottom:14px">Real-time voice conversation with the Qmobility AI assistant.</p>'
  +'<div style="display:flex;justify-content:center;align-items:center;min-height:110px;background:var(--s2);border-radius:10px;padding:14px"><elevenlabs-convai agent-id="agent_1301kepw78ysfjm9d30gssmm6dja" style="width:100%;display:block"></elevenlabs-convai></div>'
  +'<p style="font-size:10px;color:var(--tx3);margin-top:10px">ðŸ”’ Needs microphone permission</p>'
  +'</div></div>'
  // Text/chat panel - right
  +'<div class="card" style="border-left:3px solid var(--acc)">'
  +'<div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3 style="color:var(--acc)">ðŸ’¬ Chat Mode</h3></div>'
  +'<div class="cb" style="padding:0">'
  +'<div id="agTextChatLog" style="height:260px;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px">'
  +'<div style="background:var(--s3);border-radius:8px;padding:10px 12px;border-left:3px solid var(--acc)"><b style="color:var(--acc);font-size:11px">Qmobility Agent</b><br><span style="color:var(--tx2);font-size:12px">Hi! I can help with DARB tolling, Mawaqif parking, your schedule, leave, and more. How can I help?</span></div>'
  +'</div>'
  +'<div style="padding:10px;border-top:1px solid var(--brd);display:flex;gap:6px">'
  +'<input id="agTextChatInput" placeholder="Ask about procedures, schedule, leave..." style="flex:1;font-size:12px" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();agTextChatSend()}">'
  +'<button class="btn bp bsm" onclick="agTextChatSend()">Send</button>'
  +'</div></div></div>'
  +'</div>'
  +'</div>';
h+='<div id="agBreaks" class="card" style="display:none"><div class="ch"><h3>â˜• My Breaks</h3></div><div class="cb">';
  if(BK.results){
    var hasDays=[];
    DAYS.forEach(function(d){
      var dd=BK.results[d];
      if(!dd||!dd.assignments)return;
      // Check if agent has a work shift on this day (not OFF, not AL)
      var rosterShiftForDay=null;
      if(D.roster){var rA=D.roster.find(function(r){return r.name===a.name;});if(rA)rosterShiftForDay=rA.shifts[d];}
      // If roster says OFF or AL, skip this day entirely
      if(rosterShiftForDay==="OFF"||rosterShiftForDay==="AL")return;
      // Also skip if no roster entry yet but check break assignments
      var myRow=dd.assignments.find(function(x){return x.name===a.name;});
      if(myRow)hasDays.push(d);
    });
    if(hasDays.length){
      var todayDayN=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date().getDay()];
      var defaultDay=hasDays.includes(todayDayN)?todayDayN:hasDays[0];
      h+='<div style="display:flex;gap:4px;margin-bottom:10px">';
      hasDays.forEach(function(d){
        h+='<button class="btn '+(d===defaultDay?'bp':'bs2')+' bsm agBkBtn" data-d="'+d+'" onclick="document.querySelectorAll(\'.agBkDay\').forEach(function(e){e.style.display=\'none\'});document.getElementById(\'agBk_'+d+'\').style.display=\'block\';document.querySelectorAll(\'.agBkBtn\').forEach(function(b){b.className=\'btn bs2 bsm agBkBtn\'});this.className=\'btn bp bsm agBkBtn\'">'+d+'</button>';
      });
      h+='</div>';
      hasDays.forEach(function(d){
        var dd=BK.results[d];
        var my=dd.assignments.find(function(x){return x.name===a.name;});
        // Cross-check with roster for correct shift
        var rosterShift=null;
        if(D.roster){var rAgent=D.roster.find(function(r){return r.name===a.name;});if(rAgent)rosterShift=rAgent.shifts[d];}
        var shiftMismatch=rosterShift&&rosterShift!=='OFF'&&rosterShift!=='AL'&&rosterShift!==my.code;
        var displayCode=shiftMismatch?rosterShift:my.code;
        var shObj=D.shifts.find(function(s){return s.id===displayCode;});
        var startMin=shObj?Math.floor(shObj.start.split(':')[0])*60+parseInt(shObj.start.split(':')[1]):my.start;
        var endMin=shObj?Math.floor(shObj.end.split(':')[0])*60+parseInt(shObj.end.split(':')[1]):my.end;
        if(endMin<=startMin)endMin+=1440;
        var displaySlots=my.breakSlots;
        var displayPattern=my.pattern;
        var recalcNote='';
        if(shiftMismatch){
          try{
            var fr=bkSolveDay(d,[{name:a.name,code:displayCode}]);
            if(fr&&fr.ok&&fr.assignments&&fr.assignments.length){
              displaySlots=fr.assignments[0].breakSlots;
              displayPattern=fr.assignments[0].pattern;
              recalcNote='<span style="font-size:9px;color:#6ee7b7;padding:2px 6px;background:#064e3b;border-radius:3px">&#10003; Recalculated for shift '+displayCode+'</span>';
            }else{
              recalcNote='<span style="font-size:9px;color:#f59e0b;padding:2px 6px;background:#78350f40;border-radius:3px">&#9888; Regenerate breaks for exact times</span>';
            }
          }catch(e2){
            recalcNote='<span style="font-size:9px;color:#f59e0b;padding:2px 6px;background:#78350f40;border-radius:3px">&#9888; Regenerate breaks for exact times</span>';
          }
        }
        var br=fBR(displaySlots,displayPattern);
        h+='<div id="agBk_'+d+'" class="agBkDay" style="display:'+(d===defaultDay?'block':'none')+'">';
        h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap">';
        h+='<span class="sb" style="background:'+sColor(displayCode)+';height:24px;min-width:36px;font-size:10px">'+displayCode+'</span>';
        h+='<span style="font-family:var(--mono);font-size:12px;color:var(--tx2)">'+mT2(startMin)+'â€“'+mT2(endMin)+'</span>';
        h+=recalcNote;
        h+='</div>';
        h+='<div style="display:grid;grid-template-columns:repeat('+br.length+',1fr);gap:8px">';
        br.forEach(function(b2,bi){
          h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px">';
          h+='<div style="font-size:9px;color:var(--tx3);margin-bottom:4px">Break '+(bi+1)+'</div>';
          h+='<div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--cyn)">'+b2+'</div>';
          h+='</div>';
        });
        h+='</div></div>';
      });
    }else{
      h+='<p style="color:var(--tx3)">No breaks this week</p>';
    }
  }else{
    h+='<p style="color:var(--tx3)">Breaks not generated yet</p>';
  }
  h+='</div></div>';
  // Leave
  h+='<div id="agLeave" class="card" style="display:none"><div class="ch"><h3>ðŸŒ´ My Annual Leave</h3></div><div class="cb">';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;text-align:center"><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Entitled '+yr+'</div><div style="font-size:20px;font-weight:700;color:var(--cyn)">'+totalYear+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Used</div><div style="font-size:20px;font-weight:700">'+usedDays+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Approved</div><div style="font-size:20px;font-weight:700;color:var(--grn)">'+approvedDays+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Remaining</div><div style="font-size:20px;font-weight:700;color:'+(rem<=5?"var(--red)":rem<=10?"var(--orn)":"var(--grn)")+'">'+rem+'</div></div></div>';
  h+='<div style="border:1px solid var(--brd);border-radius:8px;padding:12px;margin-bottom:12px;background:var(--s2)"><h4 style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:8px">REQUEST LEAVE</h4><div class="fr"><div class="fg"><label>From</label><input type="date" id="agReqS" onchange="agReqPreview()"></div><div class="fg"><label>To</label><input type="date" id="agReqE" onchange="agReqPreview()"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="agSubmitRequest()">Submit</button></div></div><div id="agReqPreview" style="margin-top:6px"></div></div>';
  if(myLeaves.length){myLeaves.forEach(l=>{const days=alDays(l.start,l.end);const st=l.status||"Approved";h+='<div class="ar" style="border-left:3px solid '+alStatusColor(st)+'"><span class="tg" style="background:'+alStatusColor(st)+'20;color:'+alStatusColor(st)+';font-size:9px">'+st+'</span><span style="font-family:var(--mono);font-size:11px">'+l.start+' â†’ '+l.end+'</span><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+days+'d</span>'+(l.adminNote?'<span style="font-size:10px;color:var(--tx3)">ðŸ’¬ '+l.adminNote+'</span>':'')+'</div>'})}
  h+='</div></div>';
  // Attendance
  h+='<div id="agAtt" class="card" style="display:none"><div class="ch"><h3>âœ… My Attendance</h3></div><div class="cb">';
  const att=D.attendance||{};const attDates=Object.keys(att).filter(d=>att[d][AGENT_ID]).sort().reverse().slice(0,28);
  if(attDates.length){h+='<div class="tw"><table><thead><tr><th>Date</th><th>Day</th><th>Status</th></tr></thead><tbody>';attDates.forEach(d=>{const st=att[d][AGENT_ID];const dayName=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(d+"T00:00:00").getDay()];h+='<tr><td style="font-family:var(--mono)">'+d+'</td><td>'+dayName+'</td><td style="font-weight:600;color:'+(ATT_COLORS[st]||"var(--tx3)")+'">'+st+'</td></tr>'});h+='</tbody></table></div>'}else h+='<p style="color:var(--tx3)">No attendance records yet</p>';
  h+='</div></div>';
  // Agent KPI section
  h+='<div id="agKpi" class="card" style="display:none"><div class="ch"><h3>ðŸ“Š My Performance</h3></div><div class="cb">';
  const kpis=D.kpis||{};const months=Object.keys(kpis).sort().reverse();const myKpiMonths=months.filter(m=>kpis[m]&&kpis[m][AGENT_ID]);
  if(myKpiMonths.length){const curM=myKpiMonths[0];const cur=kpis[curM][AGENT_ID];
    h+='<div style="font-size:11px;color:var(--tx2);margin-bottom:8px">Latest: <b>'+curM+'</b></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">QA Score</div><div style="font-size:20px;font-weight:800;color:var(--pur)">'+(cur.qa||0).toFixed(1)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">AHT</div><div style="font-size:20px;font-weight:800;color:var(--orn)">'+Math.floor((cur.aht||0)/60)+':'+String(Math.round((cur.aht||0)%60)).padStart(2,"0")+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">CSAT</div><div style="font-size:20px;font-weight:800;color:var(--acc)">'+(cur.csat||0).toFixed(2)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Adherence</div><div style="font-size:20px;font-weight:800;color:var(--cyn)">'+(cur.adherence||0).toFixed(1)+'%</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Interactions</div><div style="font-size:20px;font-weight:800;color:var(--grn)">'+(cur.interactions||0)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Unplanned</div><div style="font-size:20px;font-weight:800;color:var(--red)">'+(cur.unplanned||0)+'</div></div>';
    h+='</div>';
    // Coaching notes if any
    const myCoach=(D.coaching||[]).filter(c=>c.aid===AGENT_ID).sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(myCoach.length){h+='<div style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:4px">Recent Coaching Notes:</div>';myCoach.slice(0,5).forEach(c=>{h+='<div style="font-size:10px;padding:4px 8px;margin-bottom:3px;background:var(--s2);border-radius:4px;border-left:2px solid '+(c.followUp?"var(--red)":"var(--grn)")+'"><b>'+c.date+'</b> â€” '+c.type+(c.notes?' â€” <span style="color:var(--tx2)">'+c.notes+'</span>':'')+'</div>'})}
    // History
    if(myKpiMonths.length>1){h+='<div style="font-size:11px;font-weight:700;color:var(--tx2);margin-top:10px;margin-bottom:4px">Monthly History:</div><div class="tw"><table style="font-size:10px"><thead><tr><th>Month</th><th>QA</th><th>AHT</th><th>CSAT</th><th>Adh%</th><th>Int</th><th>UPL</th></tr></thead><tbody>';myKpiMonths.forEach(m=>{const d2=kpis[m][AGENT_ID];h+='<tr><td>'+m+'</td><td>'+(d2.qa||0).toFixed(1)+'</td><td>'+Math.floor((d2.aht||0)/60)+':'+String(Math.round((d2.aht||0)%60)).padStart(2,"0")+'</td><td>'+(d2.csat||0).toFixed(2)+'</td><td>'+(d2.adherence||0).toFixed(1)+'%</td><td>'+(d2.interactions||0)+'</td><td>'+(d2.unplanned||0)+'</td></tr>'});h+='</tbody></table></div>'}
  }else h+='<p style="color:var(--tx3)">No performance data available yet.</p>';
  h+='</div></div>';
  h+='<div id="agToast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#052e16;border:1px solid #064e3b;color:#86efac;padding:10px 20px;border-radius:8px;font-size:13px;opacity:0;transition:opacity .3s;z-index:999"></div>';
  h+='</div>';
  document.body.innerHTML='<div style="min-height:100vh;background:var(--bg);color:var(--tx)">'+h+'</div>';
  // Inline chat only â€” no floating chat bubble to avoid duplication
  // Load ElevenLabs script for voice widget
  if(!document.querySelector('script[src*="elevenlabs"]')){
    const s=document.createElement("script");
    s.src="https://unpkg.com/@elevenlabs/convai-widget-embed";
    s.async=true;s.type="text/javascript";
    document.head.appendChild(s);
  }
  // Build inline text chat function for AI Agent tab
  if(!window.agTextChatSend){
    window.agTextChatSend=async function(){
      const input=document.getElementById("agTextChatInput");
      if(!input)return;
      const msg=input.value.trim();if(!msg)return;
      input.value="";
      const log=document.getElementById("agTextChatLog");
      if(!log)return;
      const uDiv=document.createElement("div");
      uDiv.style.cssText="background:var(--s3);border-radius:8px;padding:10px 12px;border-left:3px solid var(--cyn);align-self:flex-end";
      uDiv.innerHTML="<b style='color:var(--cyn);font-size:11px'>You</b><br><span style='color:var(--tx);font-size:12px'>"+msg.replace(/[<>]/g,c=>c==="<"?"&lt;":"&gt;")+"</span>";
      log.appendChild(uDiv);
      const typDiv=document.createElement("div");
      typDiv.id="agTextTyping";typDiv.style.cssText="background:var(--s2);border-radius:8px;padding:8px 12px;border-left:3px solid var(--acc)";
      typDiv.innerHTML="<b style='color:var(--acc);font-size:11px'>Qmobility Agent</b><br><span style='color:var(--tx3);font-size:12px;font-style:italic'>Thinking...</span>";
      log.appendChild(typDiv);log.scrollTop=log.scrollHeight;
      
      // Build context
      const myRoster3=D.roster?D.roster.find(r=>r.id===AGENT_ID):null;
      const myAL2=(D.al||[]).filter(x=>x.aid===AGENT_ID&&x.status!=="Rejected");
      const q=msg.toLowerCase();
      let reply="";
      
      try{
        const r2=await fetch("https://api.elevenlabs.io/v1/convai/conversation/text",{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({agent_id:"agent_1301kepw78ysfjm9d30gssmm6dja",user_message:msg,context:(AGENT_DATA?"Agent: "+AGENT_DATA.name+". ":"")+(myRoster3?"Schedule: "+DAYS.map(d=>d+"="+myRoster3.shifts[d]).join(", ")+". ":"")})
        });
        if(r2.ok){const dd=await r2.json();reply=dd.response||dd.agent_response||dd.text||""}
      }catch(e){}
      
      if(!reply){
        // Local KB + schedule fallback
        const kbMatch=AI_KB_ARTICLES?AI_KB_ARTICLES.find(a2=>{
          const kq=a2.title.toLowerCase();
          return kq.includes(q.slice(0,15))||q.split(" ").filter(w=>w.length>3).some(w=>kq.includes(w)||a2.content.toLowerCase().includes(w));
        }):null;
        if(kbMatch)reply=kbMatch.title+"\n\n"+kbMatch.content.slice(0,600);
        else if(q.includes("schedule")||q.includes("shift"))reply=myRoster3?"Your schedule: "+DAYS.map(d=>d+": "+myRoster3.shifts[d]).join(", "):"No schedule yet.";
        else if(q.includes("break")){const todayN2=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date().getDay()];const bk=BK.results?.[todayN2]?.assignments?.find(x=>x.name===AGENT_DATA?.name);reply=bk?"Today's breaks: "+fBR(bk.breakSlots,bk.pattern).join(", "):"No break data for today.";}
        else if(q.includes("leave")||q.includes("annual"))reply=myAL2.length?"Your leaves: "+myAL2.map(a2=>a2.start+" â†’ "+a2.end+" ("+a2.status+")").join(". "):"No leave records.";
        else reply="I can help with DARB tolling, Mawaqif parking, your schedule, breaks, or leave balance. What would you like to know?";
      }
      
      const typing2=document.getElementById("agTextTyping");
      if(typing2){
        typing2.innerHTML="<b style='color:var(--acc);font-size:11px'>Qmobility Agent</b><br><span style='color:var(--tx2);font-size:12px'>"+reply.replace(/[<>]/g,c=>c==="<"?"&lt;":"&gt;").replace(/\n/g,"<br>")+"</span>";
      }
      log.scrollTop=log.scrollHeight;
    };
  }
}
function agKBSend(){
  var inp=document.getElementById("agKBChatInput");
  if(!inp||!inp.value.trim())return;
  var msg=inp.value.trim();inp.value="";
  var log=document.getElementById("agKBChatLog");
  if(!log)return;
  var uDiv=document.createElement("div");
  uDiv.style.cssText="background:var(--s3);border-radius:7px;padding:8px 11px;border-left:3px solid var(--cyn)";
  uDiv.innerHTML="<b style='color:var(--cyn);font-size:10px'>You</b><br><span style='color:var(--tx2);font-size:11px'>"+msg.replace(/[<>]/g,function(c){return c==="<"?"&lt;":"&gt;"})+"</span>";
  log.appendChild(uDiv);
  var results=AI_KB_ARTICLES?AI_KB_ARTICLES.filter(function(a){
    var q=msg.toLowerCase();
    return a.title.toLowerCase().includes(q)||a.content.toLowerCase().includes(q);
  }).sort(function(a,b){
    return (b.title.toLowerCase().includes(msg.toLowerCase())?10:0)-(a.title.toLowerCase().includes(msg.toLowerCase())?10:0);
  }).slice(0,1):[];
  var aDiv=document.createElement("div");
  aDiv.style.cssText="background:var(--s2);border-radius:7px;padding:8px 11px;border-left:3px solid var(--acc)";
  if(results.length){
    var safe=results[0].content.slice(0,400).replace(/[<>]/g,function(c){return c==="<"?"&lt;":"&gt;"}).replace(/\n/g,"<br>");
    aDiv.innerHTML="<b style='color:var(--acc);font-size:10px'>Qmobility Agent</b><br><span style='color:var(--tx2);font-size:11px'><b>"+results[0].title+"</b><br>"+safe+"</span>";
  }else{
    aDiv.innerHTML="<b style='color:var(--acc);font-size:10px'>Qmobility Agent</b><br><span style='color:var(--tx3);font-size:11px'>No matching articles found. Try voice mode for full AI.</span>";
  }
  log.appendChild(aDiv);log.scrollTop=log.scrollHeight;
}
function agTab(t){
  var tabMap={sched:"Sched",breaks:"Breaks",leave:"Leave",att:"Att",kpi:"Kpi",aiagent:"AiAgent"};
  Object.keys(tabMap).forEach(function(x){
    var el=document.getElementById("ag"+tabMap[x]);
    if(el)el.style.display=x===t?"block":"none";
  });
  document.querySelectorAll(".agTab").forEach(function(b){
    b.className="btn bsm agTab "+(b.dataset.t===t?"bp":"bs2");
  });
}
function agSwapPick(day){const el=document.getElementById("agSwapArea");if(!el)return;const myRoster=D.roster?D.roster.find(r=>r.id===AGENT_ID):null;if(!myRoster)return;const mySh=myRoster.shifts[day];if(mySh==="AL"){showAgToast("Can't swap AL day");return}
  const others=D.roster.filter(r=>r.id!==AGENT_ID&&r.shifts[day]!=="AL").map(r=>({id:r.id,name:r.name,shift:r.shifts[day]}));
  let h2='<div style="border:1px solid var(--brd);border-radius:8px;padding:12px;margin-top:10px;background:var(--s2)"><h4 style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:8px">REQUEST SWAP â€” '+day+' (your shift: <span class="sb" style="background:'+sColor(mySh)+';height:18px;min-width:28px;font-size:9px">'+mySh+'</span>)</h4>';
  h2+='<div style="max-height:200px;overflow-y:auto">';
  others.forEach(o=>{h2+='<div class="ar" style="cursor:pointer" onclick="agSubmitSwap(\''+day+'\',\''+o.id+'\',\''+o.name+'\')"><b style="font-size:12px;min-width:180px">'+o.name+'</b><span class="sb" style="background:'+sColor(o.shift)+';height:20px;min-width:32px;font-size:9px">'+o.shift+'</span><span style="font-size:10px;color:var(--cyn)">â†’ Click to request swap</span></div>'});
  h2+='</div><button class="btn bs2 bsm" style="margin-top:6px" onclick="document.getElementById(\'agSwapArea\').innerHTML=\'\'">Cancel</button></div>';
  el.innerHTML=h2}
async function agSubmitSwap(day,targetId,targetName){if(!D.swapRequests)D.swapRequests=[];
  D.swapRequests.push({id:uid(),from:AGENT_ID,fromName:AGENT_DATA.name,to:targetId,toName:targetName,day:day,status:"Pending",addedAt:new Date().toISOString()});
  save();
  if(SB){const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();if(ws){const{data:wk}=await SB.from("weeks").select("id,settings_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();if(wk){const sj=wk.settings_json||{};sj.swapRequests=D.swapRequests;await SB.from("weeks").update({settings_json:sj}).eq("id",wk.id)}}}
  showAgToast("Swap request sent to admin!");document.getElementById("agSwapArea").innerHTML='<div style="padding:8px;background:#052e16;border:1px solid #064e3b;border-radius:6px;margin-top:8px;font-size:12px;color:#86efac">âœ“ Swap request sent for '+day+' with '+targetName+'. Waiting for admin approval.</div>'}
function agReqPreview(){const s=document.getElementById("agReqS").value,e=document.getElementById("agReqE").value,el=document.getElementById("agReqPreview");if(!s||!e){el.innerHTML="";return}const v=alValidateRequest(AGENT_ID,s,e);el.innerHTML='<div style="font-size:12px"><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+v.days+' days</span>'+(v.errs.length?'<div style="margin-top:4px">'+v.errs.map(w=>'<div style="color:var(--red);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(v.warns.length?'<div>'+v.warns.map(w=>'<div style="color:var(--orn);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(!v.blocked?'<span style="color:var(--grn);margin-left:6px">âœ“ Eligible</span>':"")+"</div>"}
async function agSubmitRequest(){const s=document.getElementById("agReqS").value,e=document.getElementById("agReqE").value;if(!s||!e){showAgToast("Select dates");return}if(new Date(e)<new Date(s)){showAgToast("End before start");return}const v=alValidateRequest(AGENT_ID,s,e);if(v.blocked){showAgToast("Blocked â€” overlap with "+v.overlap.length+" agents");return}
  D.al.push({id:uid(),aid:AGENT_ID,name:AGENT_DATA.name,start:s,end:e,status:"Pending",source:"agent",addedAt:new Date().toISOString()});save();
  // Also push to Supabase if available
  if(SB){const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();if(ws){const{data:wk}=await SB.from("weeks").select("id,annual_leave_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();if(wk){await SB.from("weeks").update({annual_leave_json:D.al}).eq("id",wk.id)}}}
  showAgToast("Request submitted! Waiting for approval.");renderAgentPortal()}
async function agDeletePref(id){
  if(!D.schedPrefs)return;
  const p=D.schedPrefs.find(x=>x.id===id);
  if(!p||p.status!=="Pending"){showAgToast("Can only cancel pending requests");return}
  if(!confirm("Cancel this request: "+p.day+" â†’ "+p.request+"?"))return;
  p.status="Cancelled";
  p.cancelledAt=new Date().toISOString();
  save();
  // Sync cancellation to cloud
  if(SB){
    try{
      const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();
      if(ws){
        const{data:wk}=await SB.from("weeks").select("id,settings_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();
        if(wk){
          const sj=wk.settings_json||{};
          const cloudPrefs=sj.schedPrefs||[];
          // Update the matching entry in cloud
          const ci=cloudPrefs.findIndex(function(x){return x.id===id;});
          if(ci>=0){cloudPrefs[ci].status="Cancelled";cloudPrefs[ci].cancelledAt=p.cancelledAt;}
          sj.schedPrefs=cloudPrefs;
          await SB.from("weeks").update({settings_json:sj}).eq("id",wk.id);
        }
      }
    }catch(e){console.warn("Cancel cloud sync failed:",e);}
  }
  showAgToast("Request cancelled");
  renderAgentPortal();
}
async function agSubmitPref(){if(!D.schedPrefs)D.schedPrefs=[];
  const day=document.getElementById("agPrefDay")?.value;
  const req=document.getElementById("agPrefType")?.value;
  const reason=document.getElementById("agPrefReason")?.value||"";
  if(!day||!req){showAgToast("Select day and request");return}
  // Check for duplicate
  const dup=D.schedPrefs.find(p=>p.aid===AGENT_ID&&p.day===day&&p.status==="Pending");
  if(dup){showAgToast("You already have a pending request for "+day);return}
  D.schedPrefs.push({id:uid(),aid:AGENT_ID,name:AGENT_DATA.name,day:day,request:req,reason:reason,status:"Pending",source:"agent",addedAt:new Date().toISOString()});
  save();
  // Push to cloud â€” do fresh read first to avoid overwriting other agents' data
  if(SB){
    try{
      const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();
      if(ws){
        const{data:wk}=await SB.from("weeks").select("id,settings_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();
        if(wk){
          // IMPORTANT: read fresh cloud schedPrefs and merge, don't overwrite
          const sj=wk.settings_json||{};
          const cloudPrefs=sj.schedPrefs||[];
          // Merge: keep all cloud prefs + our new one (avoid exact duplicate by id)
          const newPref=D.schedPrefs[D.schedPrefs.length-1];
          const alreadyInCloud=cloudPrefs.find(function(p){return p.id===newPref.id;});
          if(!alreadyInCloud){cloudPrefs.push(newPref);}
          sj.schedPrefs=cloudPrefs;
          D.schedPrefs=cloudPrefs; // sync local to full cloud state
          save();
          await SB.from("weeks").update({settings_json:sj}).eq("id",wk.id);
          showAgToast("âœ“ Request saved to cloud!");
        }else{showAgToast("âœ“ Saved locally (no cloud week found)");}
      }
    }catch(e){showAgToast("Saved locally â€” cloud sync failed: "+e.message);}
  }else{
    showAgToast("Saved! (Connect to cloud in Settings to sync across devices)");
  }
  renderAgentPortal();
}

// â•â•â• ATTENDANCE â•â•â•
if(!D.attendance)D.attendance={};
const ATT_STATUSES=["Present","Absent","Sick","Annual"];
const ATT_COLORS={Present:"#059669",Absent:"#ef4444",Sick:"#f59e0b",Annual:"#8b5cf6"};
function renderAttendance(){const el=document.getElementById("attArea");if(!el)return;
  if(!D.attendance||Array.isArray(D.attendance))D.attendance={};
  const wkInput=document.getElementById("attWeek");if(!wkInput.value)wkInput.value=document.getElementById("wkStart").value||new Date().toISOString().split("T")[0];
  const wkStart=new Date(wkInput.value+"T12:00:00");const dow=wkStart.getDay();const monOffset=dow===0?-6:1-dow;const mon=new Date(wkStart);mon.setDate(wkStart.getDate()+monOffset);
  const weekDates=[];for(let i=0;i<7;i++){const d2=new Date(mon);d2.setDate(mon.getDate()+i);weekDates.push(d2.getFullYear()+"-"+String(d2.getMonth()+1).padStart(2,"0")+"-"+String(d2.getDate()).padStart(2,"0"))}
  const agents=D.agents||[];if(!agents.length){el.innerHTML='<div class="emp">Add agents first.</div>';return}
  let h='<div class="tw"><table style="font-size:11px"><thead><tr><th style="text-align:left;min-width:140px">Agent</th>';
  DAYS.forEach((d,i)=>h+='<th>'+d+'<div style="font-size:8px;color:var(--tx3);font-weight:400">'+weekDates[i].slice(5)+'</div></th>');
  h+='<th>P</th><th>A</th><th>S</th></tr></thead><tbody>';
  agents.forEach(r=>{let pC=0,aC=0,sC=0;
    h+='<tr><td style="text-align:left;max-width:150px;overflow:hidden;text-overflow:ellipsis;font-size:11px" title="'+r.name+'">'+r.name+'</td>';
    weekDates.forEach(dateStr=>{const cur=(D.attendance[dateStr]&&D.attendance[dateStr][r.id])||"";if(cur==="Present")pC++;if(cur==="Absent")aC++;if(cur==="Sick")sC++;
      if(VIEWER_MODE||AGENT_MODE){h+='<td style="font-size:10px;font-weight:600;color:'+(ATT_COLORS[cur]||"var(--tx3)")+'">'+(cur?cur.charAt(0):"\u2014")+'</td>'}
      else{h+='<td><select onchange="setAtt(\''+r.id+'\',\''+dateStr+'\',this.value)" style="width:58px;font-size:9px;padding:2px;'+(cur?"color:"+ATT_COLORS[cur]:"")+'">';
        h+='<option value="">\u2014</option>';ATT_STATUSES.forEach(s=>h+='<option value="'+s+'" '+(cur===s?"selected":"")+'>'+s+'</option>');h+='</select></td>'}});
    h+='<td style="font-family:var(--mono);color:var(--grn);font-weight:600;font-size:11px">'+pC+'</td><td style="font-family:var(--mono);color:var(--red);font-weight:600;font-size:11px">'+aC+'</td><td style="font-family:var(--mono);color:var(--orn);font-weight:600;font-size:11px">'+sC+'</td></tr>'});
  h+='</tbody></table></div>';el.innerHTML=h}
function setAtt(aid,dateStr,val){if(!D.attendance)D.attendance={};if(!D.attendance[dateStr])D.attendance[dateStr]={};D.attendance[dateStr][aid]=val;save()}
function attPrevWeek(){const w=document.getElementById("attWeek");const d=new Date(w.value+"T00:00:00");d.setDate(d.getDate()-7);w.value=d.toISOString().split("T")[0];renderAttendance()}
function attNextWeek(){const w=document.getElementById("attWeek");const d=new Date(w.value+"T00:00:00");d.setDate(d.getDate()+7);w.value=d.toISOString().split("T")[0];renderAttendance()}
// Attendance month selector init
function initAttMonths(){const sel=document.getElementById("attExpMonth");if(!sel)return;const now=new Date();sel.innerHTML="";for(let i=0;i<12;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);const v=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];sel.innerHTML+='<option value="'+v+'">'+mn[d.getMonth()]+' '+d.getFullYear()+'</option>'}}
function exportAttendanceRange(){
  if(typeof XLSX==="undefined"){toast("XLSX library not loaded","err");return}
  const from=document.getElementById("attExpFrom").value,to=document.getElementById("attExpTo").value;
  if(!from||!to){toast("Select From and To dates","err");return}
  const sd=new Date(from+"T00:00:00"),ed=new Date(to+"T00:00:00");
  if(ed<sd){toast("To must be after From","err");return}
  // Build date range
  const dates=[];for(let d=new Date(sd);d<=ed;d.setDate(d.getDate()+1)){dates.push(d.toISOString().split("T")[0])}
  const dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const wb=XLSX.utils.book_new();
  // Header rows
  const hdr1=["Agent",...dates.map(d=>d)];
  const hdr2=["",...dates.map(d=>dayNames[new Date(d+"T00:00:00").getDay()])];
  const rows=D.agents.map(a=>{
    const row=[a.name];
    dates.forEach(d=>{const att=D.attendance&&D.attendance[d]&&D.attendance[d][a.id];row.push(att||"")});
    return row;
  });
  // Add summary columns
  hdr1.push("Present","Absent","Sick","Annual");
  hdr2.push("","","","");
  rows.forEach(row=>{
    let p=0,ab=0,s=0,al=0;
    for(let i=1;i<row.length-3;i++){if(row[i]==="Present")p++;if(row[i]==="Absent")ab++;if(row[i]==="Sick")s++;if(row[i]==="Annual")al++}
    row.push(p,ab,s,al);
  });
  const ws=XLSX.utils.aoa_to_sheet([hdr1,hdr2,...rows]);
  ws["!cols"]=[{wch:35},...dates.map(()=>({wch:10})),{wch:8},{wch:8},{wch:8},{wch:8}];
  XLSX.utils.book_append_sheet(wb,ws,"Attendance");
  XLSX.writeFile(wb,"attendance_"+from+"_to_"+to+".xlsx");
  toast("Payslip attendance report exported!")}
function exportNightShiftReport(){
  if(typeof XLSX==="undefined"){toast("XLSX library not loaded","err");return}
  const monthVal=document.getElementById("attExpMonth").value;
  if(!monthVal){toast("Select month","err");return}
  const[yr,mo]=monthVal.split("-").map(Number);
  const firstDay=new Date(yr,mo-1,1);const lastDay=new Date(yr,mo,0);
  const dates=[];for(let d=new Date(firstDay);d<=lastDay;d.setDate(d.getDate()+1)){dates.push(d.toISOString().split("T")[0])}
  const dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  // Find agents who worked C shift â€” check from saved weeks/roster
  const wb=XLSX.utils.book_new();
  const hdr1=["Agent",...dates.map(d=>d.slice(8)+"/"+d.slice(5,7))];
  const hdr2=["",...dates.map(d=>dayNames[new Date(d+"T00:00:00").getDay()])];
  hdr1.push("Total C Shifts");hdr2.push("");
  // Check roster data for C shift assignments
  const rows=D.agents.map(a=>{
    const row=[a.name];let total=0;
    dates.forEach(d=>{
      // Check if agent had C shift on this date â€” look in current roster by matching day name
      const dayN=dayNames[new Date(d+"T00:00:00").getDay()];
      const myR=D.roster?D.roster.find(r=>r.id===a.id):null;
      const hadC=myR&&myR.shifts[dayN]==="C"?1:"";
      if(hadC)total++;
      row.push(hadC);
    });
    row.push(total);
    return row;
  }).filter(row=>row[row.length-1]>0); // Only agents with C shifts
  const ws=XLSX.utils.aoa_to_sheet([hdr1,hdr2,...rows]);
  ws["!cols"]=[{wch:35},...dates.map(()=>({wch:5})),{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws,"C Shift "+mn[mo-1]+" "+yr);
  XLSX.writeFile(wb,"C_shift_"+monthVal+".xlsx");
  toast("C-Shift monthly report exported!")}

// â•â•â• SUPABASE CLOUD LAYER â•â•â•
const SB_URL="https://flgngysndlvkgbyvhqoz.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZ25neXNuZGx2a2dieXZocW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODA0NTAsImV4cCI6MjA4MjA1NjQ1MH0.-8AWG-ocwHXJlEmjwNQhnzipT3NilH21ZGPJ8AP2t8Q"; // â† Replace with your key from Supabase Settings > API
let SB=null,SB_USER=null,SB_WS=null,VIEWER_MODE=false,SB_WEEK_ID=null;

function initSupabase(){
  if(typeof supabase==="undefined"){console.warn("Supabase JS not loaded");return false}
  if(!supabase.createClient){console.warn("Supabase createClient not found");return false}
  if(!SB_KEY||SB_KEY.length<20||SB_KEY.indexOf("PASTE")>=0){console.warn("Supabase key not set");return false}
  try{SB=supabase.createClient(SB_URL,SB_KEY);console.log("Supabase connected!");return true}catch(e){console.error("Supabase init failed:",e);return false}}

async function checkViewerMode(){
  const params=new URLSearchParams(window.location.search);
  const viewId=params.get("view");
  if(!viewId||!SB)return false;
  VIEWER_MODE=true;
  // Hide admin controls
  document.querySelectorAll(".btn.bp,.btn.bg,.btn.bd,#btnG,#btnCS,#btnBK").forEach(el=>el.style.display="none");
  document.querySelectorAll("input,select").forEach(el=>{if(!el.closest("#viewerBanner"))el.disabled=true});
  document.getElementById("viewerBanner").style.display="flex";
  document.querySelector(".topbar").style.marginTop="36px";
  // Load data
  const{data:ws}=await SB.from("workspaces").select("*").eq("public_id",viewId).single();
  if(!ws){toast("Workspace not found","err");return true}
  SB_WS=ws;
  const{data:weeks}=await SB.from("weeks").select("*").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1);
  if(weeks&&weeks.length){loadWeekFromCloud(weeks[0]);document.getElementById("viewerUpdate").textContent="Last updated: "+new Date(weeks[0].updated_at).toLocaleString()}
  // Subscribe to realtime
  SB.channel("viewer").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:`workspace_id=eq.${ws.id}`},payload=>{
    loadWeekFromCloud(payload.new);document.getElementById("viewerUpdate").textContent="Last updated: "+new Date().toLocaleTimeString();toast("Schedule updated!")}).subscribe();
  return true}

function loadWeekFromCloud(row){
  const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(s.rules)D.rules=s.rules;if(s.genderRules)D.genderRules=s.genderRules;
  if(row.agents_json)D.agents=row.agents_json;if(row.distribution_json)D.dist=row.distribution_json;
  if(row.special_requests_json)D.sr=row.special_requests_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
  if(row.roster_json)D.roster=row.roster_json;if(row.breaks_json){BK.results=row.breaks_json;D.breakResults=row.breaks_json}
  if(row.attendance_json)D.attendance=row.attendance_json;
  if(s.breakPattern)BK.breakPattern=s.breakPattern;if(s.breakPatternC)BK.breakPatternC=s.breakPatternC;if(s.peakWindows)BK.peakWindows=s.peakWindows;if(s.alRules)D.alRules=s.alRules;if(s.swapRequests)D.swapRequests=s.swapRequests;if(s.schedPrefs)D.schedPrefs=s.schedPrefs;if(s.kpis)D.kpis=s.kpis;if(s.coaching)D.coaching=s.coaching;if(s.incidents)D.incidents=s.incidents;if(s.kb)D.kb=s.kb;
  SB_WEEK_ID=row.id;document.getElementById("wkStart").value=row.week_start;
  renderAll();if(D.roster)renderRoster();renderAttendance()}

async function doCloudLogin(){
  if(!SB){toast("Supabase not ready","err");return}
  const email=(document.getElementById("cEmail")||document.getElementById("lEmail")).value.trim();
  const pass=(document.getElementById("cPass")||document.getElementById("lPass")).value;
  const errEl=document.getElementById("cErr")||document.getElementById("lErr");
  if(errEl)errEl.textContent="";
  if(!email||!pass){if(errEl)errEl.textContent="Enter email and password";return}
  const{data,error}=await SB.auth.signInWithPassword({email,password:pass});
  if(error){if(errEl)errEl.textContent=error.message;return}
  SB_USER=data.user;document.getElementById("loginOverlay").style.display="none";
  const{data:ws}=await SB.from("workspaces").select("*").eq("owner_id",SB_USER.id).single();
  if(ws){SB_WS=ws;toast("Logged in! Workspace: "+ws.name)}
  else{const{data:nws}=await SB.from("workspaces").insert({name:"Qmobility Call Center",public_id:"qmobility-live",owner_id:SB_USER.id}).select().single();
    if(nws){SB_WS=nws;toast("Workspace created!")}}
  renderCloudPanel();await cloudLoadLatest()}

async function doLogin(){await doCloudLogin()}

async function cloudSave(){
  if(!SB||!SB_WS){toast("Log in to cloud first","err");return}
  const ws=document.getElementById("wkStart").value;if(!ws){toast("Set week date","err");return}
  const end=new Date(ws+"T00:00:00");end.setDate(end.getDate()+6);
  const row={workspace_id:SB_WS.id,week_start:ws,week_end:end.toISOString().split("T")[0],
    settings_json:{shifts:D.shifts,rules:D.rules,genderRules:D.genderRules,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows,alRules:D.alRules||{},swapRequests:D.swapRequests||[],schedPrefs:D.schedPrefs||[],kpis:D.kpis||{},coaching:D.coaching||[],incidents:D.incidents||[],kb:D.kb||[]},
    distribution_json:D.dist,agents_json:D.agents,special_requests_json:D.sr,annual_leave_json:D.al,
    annual_leave_json:D.al,
    roster_json:D.roster||null,breaks_json:BK.results||null,attendance_json:D.attendance||{}};
  let res;
  if(SB_WEEK_ID){res=await SB.from("weeks").update(row).eq("id",SB_WEEK_ID)}
  else{const{data:existing}=await SB.from("weeks").select("id").eq("workspace_id",SB_WS.id).eq("week_start",ws).single();
    if(existing){SB_WEEK_ID=existing.id;res=await SB.from("weeks").update(row).eq("id",SB_WEEK_ID)}
    else{res=await SB.from("weeks").insert(row).select().single();if(res.data)SB_WEEK_ID=res.data.id}}
  if(res.error)toast("Save failed: "+res.error.message,"err");else{toast("Saved to cloud! Viewers will update.");renderCloudPanel();subscribeAdminRealtime()}}

function subscribeAdminRealtime(){if(!SB||!SB_WS||window._adminSubbed)return;window._adminSubbed=true;
  SB.channel("admin-live").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:"workspace_id=eq."+SB_WS.id},payload=>{
    const row=payload.new;const s=row.settings_json||{};
    if(row.annual_leave_json){D.al=row.annual_leave_json;renderAL()}
    if(s.swapRequests){D.swapRequests=s.swapRequests;if(D.roster)renderRoster()}
    if(row.attendance_json)D.attendance=row.attendance_json;
    save();updatePendingBadges();toast("ðŸ“¬ New request from agent â€” check Dashboard!")}).subscribe();
  // Also start a periodic poll every 30s as backup
  if(!window._adminPollTimer)window._adminPollTimer=setInterval(async()=>{
    try{const{data}=await SB.from("weeks").select("settings_json,annual_leave_json").eq("workspace_id",SB_WS.id).order("week_start",{ascending:false}).limit(1);
    if(data&&data[0]){const s=data[0].settings_json||{};if(s.swapRequests)D.swapRequests=s.swapRequests;if(data[0].annual_leave_json)D.al=data[0].annual_leave_json;save();updatePendingBadges()}}catch(e){}
  },30000)}
function updatePendingBadges(){
  const pendAL=D.al.filter(a=>(a.status||"Approved")==="Pending"&&a.source==="agent").length;
  const pendSwap=(D.swapRequests||[]).filter(r=>r.status==="Pending").length;
  const total=pendAL+pendSwap;
  // Update sidebar badges
  document.querySelectorAll(".ni").forEach(ni=>{
    const old=ni.querySelector(".pend-badge");if(old)old.remove();
    if(ni.dataset.p==="al"&&pendAL>0){ni.insertAdjacentHTML("beforeend",'<span class="pend-badge" style="position:absolute;top:4px;right:4px;min-width:16px;height:16px;background:#ef4444;color:#fff;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:1px 4px">'+pendAL+'</span>')}
    if(ni.dataset.p==="roster"&&pendSwap>0){ni.insertAdjacentHTML("beforeend",'<span class="pend-badge" style="position:absolute;top:4px;right:4px;min-width:16px;height:16px;background:#8b5cf6;color:#fff;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:1px 4px">'+pendSwap+'</span>')}
    if(ni.dataset.p==="dashboard"&&total>0){ni.insertAdjacentHTML("beforeend",'<span class="pend-badge" style="position:absolute;top:4px;right:4px;min-width:16px;height:16px;background:#f59e0b;color:#000;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:1px 4px">'+total+'</span>')}
  });
  // Update dashboard counters if visible
  const dashPendEl=document.getElementById("dashPendAL");if(dashPendEl)dashPendEl.textContent=pendAL;
}

async function cloudLoadLatest(){
  if(!SB||!SB_WS)return;
  const{data}=await SB.from("weeks").select("*").eq("workspace_id",SB_WS.id).order("week_start",{ascending:false}).limit(1);
  if(data&&data.length){loadWeekFromCloud(data[0]);subscribeAdminRealtime();updatePendingBadges()}}

async function cloudLoadWeek(weekStart){
  if(!SB||!SB_WS)return;
  const{data}=await SB.from("weeks").select("*").eq("workspace_id",SB_WS.id).eq("week_start",weekStart).single();
  if(data)loadWeekFromCloud(data);else toast("Not found","err")}

function renderCloudPanel(){const el=document.getElementById("cloudArea");if(!el)return;
  if(!SB){el.innerHTML='<div class="card"><div class="cb"><p style="color:var(--orn);font-size:13px;margin-bottom:10px">âš  Supabase not configured.</p><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Open this HTML file in a text editor (Notepad) and replace <code style="background:var(--s3);padding:2px 6px;border-radius:3px">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZ25neXNuZGx2a2dieXZocW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODA0NTAsImV4cCI6MjA4MjA1NjQ1MH0.-8AWG-ocwHXJlEmjwNQhnzipT3NilH21ZGPJ8AP2t8Q</code> with your Supabase anon key.</p><p style="font-size:11px;color:var(--tx3)">Key length: '+SB_KEY.length+' chars. Key starts with: '+SB_KEY.substring(0,20)+'...</p><p style="font-size:11px;color:var(--tx3);margin-top:4px">Supabase loaded: '+(typeof supabase!=="undefined"?"YES":"NO")+'</p></div></div>';return}
  if(!SB_USER){el.innerHTML='<div class="card" style="max-width:400px"><div class="ch"><h3>â˜ Cloud Login</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:12px">Log in with your Supabase account to enable cloud save, shared views, and real-time sync.</p><div class="fg" style="margin-bottom:8px"><label>Email</label><input id="cEmail" placeholder="chtiwe007@gmail.com" style="width:100%"></div><div class="fg" style="margin-bottom:8px"><label>Password</label><input id="cPass" type="password" placeholder="Your password" style="width:100%"></div><p id="cErr" style="color:var(--red);font-size:11px;min-height:16px;margin-bottom:8px"></p><button class="btn bp" style="width:100%" onclick="doCloudLogin()">Sign In</button><p style="font-size:10px;color:var(--tx3);margin-top:10px">Don\'t have an account? Create one in Supabase Dashboard â†’ Authentication â†’ Users â†’ Add User</p></div></div>';return}
  let h=`<div class="card"><div class="ch"><h3>Connection</h3></div><div class="cb"><div class="fr"><span class="tg tga">â— Connected</span><span style="font-size:12px;color:var(--tx2)">${SB_USER.email}</span><span style="font-size:11px;color:var(--tx3)">Workspace: ${SB_WS?SB_WS.name:"â€”"}</span></div></div></div>`;
  h+=`<div class="card"><div class="ch"><h3>Actions</h3></div><div class="cb"><div class="fr"><button class="btn bg" onclick="cloudSave()">â˜ Save to Cloud</button><button class="btn bs2" onclick="cloudLoadLatest()">â†“ Load Latest</button><button class="btn bs2" onclick="SB.auth.signOut().then(()=>{SB_USER=null;renderCloudPanel();toast('Logged out')})">Logout</button></div></div></div>`;
  if(SB_WS)h+=`<div class="card"><div class="ch"><h3>Shared View Link</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Share this link with your team (read-only, auto-updates):</p><div class="fr"><code style="font-family:var(--mono);font-size:13px;background:var(--s3);padding:8px 12px;border-radius:6px;color:var(--cyn);word-break:break-all;flex:1" id="shareLink">${location.origin+location.pathname}?view=${SB_WS.public_id}</code><button class="btn bs2 bsm" onclick="navigator.clipboard.writeText(document.getElementById('shareLink').textContent);toast('Copied!')">Copy</button></div></div></div>`;
  // Week list
  if(SB_WS){SB.from("weeks").select("week_start,version,updated_at").eq("workspace_id",SB_WS.id).order("week_start",{ascending:false}).then(({data})=>{
    if(!data||!data.length)return;let wh='<div class="card"><div class="ch"><h3>Cloud Archive</h3></div><div class="cb">';
    data.forEach(w=>{wh+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700">${w.week_start}</span><span style="font-size:11px;color:var(--tx2)">v${w.version} â€” ${new Date(w.updated_at).toLocaleString()}</span><button class="btn bs2 bsm" onclick="cloudLoadWeek('${w.week_start}')">Load</button></div>`});
    wh+='</div></div>';el.innerHTML+=wh})}
  el.innerHTML=h}

// â•â•â• INIT CLOUD â•â•â•
async function initCloud(){
  // Retry up to 3 times if supabase script hasn't loaded yet
  for(let i=0;i<3;i++){if(initSupabase())break;await new Promise(r=>setTimeout(r,500))}
  if(!SB){console.warn("Supabase not available after retries");renderCloudPanel();return}
  // Check if viewer mode
  if(await checkViewerMode())return;
  // Check existing session
  const{data}=await SB.auth.getSession();
  if(data.session){SB_USER=data.session.user;
    const{data:ws}=await SB.from("workspaces").select("*").eq("owner_id",SB_USER.id).single();
    if(ws)SB_WS=ws;renderCloudPanel();await cloudLoadLatest()}else{renderCloudPanel()}}

// â•â•â• INIT BREAKS â•â•â•
function initBkSettings(){if(D.breakPattern)BK.breakPattern=D.breakPattern;if(D.breakPatternC)BK.breakPatternC=D.breakPatternC;if(D.peakWindows)BK.peakWindows=D.peakWindows;if(D.breakResults)BK.results=D.breakResults;
  // â”€â”€ Validate breaks match current roster, regenerate if stale â”€â”€
  if(D.roster&&BK.results){
    let needsRegen=false;
    for(const day of DAYS){
      const dd=BK.results[day];if(!dd||!dd.assignments)continue;
      for(const ba of dd.assignments){
        const ra=D.roster.find(r=>r.name===ba.name);
        if(ra&&ra.shifts[day]!==ba.code){needsRegen=true;break}}
      if(needsRegen)break;
    }
    if(needsRegen){
      console.log("Break data stale â€” regenerating to match roster");
      BK.results={};DAYS.forEach(d=>{
        const agents2=D.roster.filter(r=>r.shifts[d]&&!NW2.has(r.shifts[d])).map(r=>({name:r.name,code:r.shifts[d]}));
        const off=D.roster.filter(r=>NW2.has(r.shifts[d])).map(r=>[r.name,r.shifts[d]]);
        const br=bkSolveDay(d,agents2);
        BK.results[d]={assignments:br.ok?br.assignments:[],error:br.ok?null:br.error,offAgents:off,validation:br.validation||{}}});
      D.breakResults=BK.results;save();
    }
  }
  renderBkSettings()}

loadSaved();if(!D.kb)D.kb=[];if(!D.coaching)D.coaching=[];if(!D.incidents)D.incidents=[];if(!D.swapRequests)D.swapRequests=[];if(!D.schedPrefs)D.schedPrefs=[];if(!D.attendance||Array.isArray(D.attendance))D.attendance={};if(!D.kpis)D.kpis={};
// â”€â”€ Migrate agent IDs to stable IDs â”€â”€
(function migrateAgentIds(){
  const idMap={};let changed=false;
  D.agents.forEach(a=>{
    const newId=stableId(a.name);
    if(a.id!==newId){idMap[a.id]=newId;a.id=newId;changed=true}
  });
  if(!changed)return;
  // Update all references to old IDs
  D.al.forEach(a=>{if(idMap[a.aid])a.aid=idMap[a.aid]});
  D.sr.forEach(s=>{if(idMap[s.aid])s.aid=idMap[s.aid]});
  (D.swapRequests||[]).forEach(s=>{if(idMap[s.aid])s.aid=idMap[s.aid];if(idMap[s.targetAid])s.targetAid=idMap[s.targetAid]});
  (D.coaching||[]).forEach(c=>{if(idMap[c.aid])c.aid=idMap[c.aid]});
  (D.incidents||[]).forEach(i=>{if(idMap[i.aid])i.aid=idMap[i.aid]});
  // Migrate KPI data
  Object.keys(D.kpis).forEach(month=>{const md=D.kpis[month];const newMd={};Object.keys(md).forEach(oldId=>{newMd[idMap[oldId]||oldId]=md[oldId]});D.kpis[month]=newMd});
  // Migrate attendance
  if(D.attendance)Object.keys(D.attendance).forEach(date=>{const dd=D.attendance[date];const newDd={};Object.keys(dd).forEach(oldId=>{newDd[idMap[oldId]||oldId]=dd[oldId]});D.attendance[date]=newDd});
  // Migrate roster
  if(D.roster)D.roster.forEach(r=>{if(idMap[r.id])r.id=idMap[r.id]});
  try{localStorage.setItem("ys_v11",JSON.stringify(D))}catch(e){}
  console.log("Migrated",Object.keys(idMap).length,"agent IDs to stable IDs");
})();
// Auto-link AL records to agent IDs by name
try{D.al.forEach(a=>{if(!a.aid||!D.agents.find(x=>x.id===a.aid)){const match=D.agents.find(x=>x.name===a.name||(a.name&&x.name&&a.name.includes(x.name.split(" ")[0])&&a.name.includes(x.name.split(" ").pop())));if(match)a.aid=match.id}})}catch(e){console.warn("AL linking error:",e)}
// Check if agent portal mode â€” init Supabase first for live data
try{initSupabase()}catch(e){console.warn("Supabase init error:",e)} // Try immediate init
if(checkAgentMode()){/* Agent portal rendered, stop admin init */}else{

try{
const td=new Date(),w2=td.getDay(),d2=w2===0?1:(w2===1?0:8-w2);const m2=new Date(td);m2.setDate(td.getDate()+d2);document.getElementById("wkStart").value=m2.toISOString().split("T")[0];document.getElementById("rMO").value=D.rules.max_off;document.getElementById("rMW").value=D.rules.max_work;renderAll();if(D.roster){renderRoster();renderAttendance()}renderArchive();initBkSettings();document.querySelectorAll('.pg').forEach(x=>x.style.display='none');document.getElementById('p-dashboard').style.display='block';renderDashboard();
}catch(e){console.error("Init render error:",e);toast("Initialization error: "+e.message,"err")}
// Live break timer on nav change
document.getElementById("sideNav").addEventListener("click",e=>{const ni=e.target.closest(".ni");if(!ni)return;if(bkLiveTimer){clearInterval(bkLiveTimer);bkLiveTimer=null}if(ni.dataset.p==="aiagent"){agentChatHistory=[];renderAIKB();loadKBIntoAgent();} if(ni.dataset.p==="bklive"&&BK.results){renderBkLive();bkLiveTimer=setInterval(renderBkLive,1000)}if(ni.dataset.p==="bksettings")renderBkSettings();if(ni.dataset.p==="bkday"&&BK.results)showBkDay("Mon");if(ni.dataset.p==="archive")renderArchive();if(ni.dataset.p==="attendance"){renderAttendance();initAttMonths()};if(ni.dataset.p==="cloud"){renderCloudPanel();const gu=document.getElementById("genesysUrl");if(gu)gu.value=GENESYS_PROXY_URL||""};if(ni.dataset.p==="al"){renderAL();loadALRules();setTimeout(()=>{const aS=document.getElementById("alS"),aE=document.getElementById("alE");if(aS)aS.onchange=alPreview;if(aE)aE.onchange=alPreview},50)}if(ni.dataset.p==="dashboard")renderDashboard();if(ni.dataset.p==="agents")renderAgentLinks();if(ni.dataset.p==="kb"){renderKB();const k=localStorage.getItem("gpt_key");if(k)document.getElementById("kbApiKey").value=k}if(ni.dataset.p==="kpis")renderKPIs();if(ni.dataset.p==="coaching"){renderCoaching();const cs=document.getElementById("coachAgent");if(cs)cs.innerHTML=D.agents.map(a=>'<option value="'+a.id+'">'+a.name+'</option>').join("")}if(ni.dataset.p==="conduct"){renderIncidents();const is2=document.getElementById("incAgent");if(is2)is2.innerHTML=D.agents.map(a=>'<option value="'+a.id+'">'+a.name+'</option>').join("")}});
// Init Supabase cloud
initCloud();
// Auto-subscribe to realtime after a short delay to allow cloud connection
setTimeout(()=>{if(SB&&SB_WS)subscribeAdminRealtime();updatePendingBadges()},3000);
}

// â•â•â• GLOBAL FUNCTIONS â•â•â•

// â•â•â• DASHBOARD â•â•â•
function renderDashboard(){
  function el(id){return document.getElementById(id)}
  var today=new Date();
  var dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  var mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  var dayN=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][today.getDay()];
  var dlEl=el("dashDateLine");
  if(dlEl)dlEl.textContent=dayNames[today.getDay()]+" "+today.getDate()+" "+mn[today.getMonth()]+" "+today.getFullYear();
  el("dashAgents").textContent=D.agents.length;
  var scheduled=0,offCount=0;
  if(D.roster){D.roster.forEach(function(r){var s=r.shifts[dayN];if(s&&s!=="OFF"&&s!=="AL")scheduled++;else if(s==="OFF"||s==="AL")offCount++;})}
  el("dashScheduled").textContent=scheduled;
  if(el("dashOffCount"))el("dashOffCount").textContent=offCount;
  var todayStr=today.toISOString().split("T")[0];
  var att=(D.attendance&&D.attendance[todayStr])||{};
  var pres=0;Object.values(att).forEach(function(v){if(v==="Present")pres++;});
  el("dashPresent").textContent=pres;
  var pendAL=D.al.filter(function(a){return a.status==="Pending";}).length;
  el("dashPendAL").textContent=pendAL;
  if(el("dashALCount2"))el("dashALCount2").textContent=pendAL;
  var incidents=(D.incidents||[]).filter(function(i){return i.status==="Open";}).length;
  el("dashIncidents").textContent=incidents;
  var bkNow=0;
  var breakAlerts=[];
  if(BK&&BK.results&&BK.results[dayN]){
    var now=today.getHours()*60+today.getMinutes();
    var asgns=(BK.results[dayN].assignments)||[];
    asgns.forEach(function(a){
      if(a.breakSlots&&a.breakSlots.some(function(t){return t<=now&&now<t+15;}))bkNow++;
      // Check for break compliance
      if(a.breakSlots){
        a.breakSlots.forEach(function(t,bi){
          var label="Break "+(bi+1);
          if(now>=t&&now<t+5){
            // Agent should be on break now - check attendance if they clocked
          }
          if(now>=t+15&&now<t+30){
            // Possibly exceeded break (break is 15min, 15+ minutes overdue)
            breakAlerts.push({name:a.name,type:"exceeded",label:label,time:mT2(t)+"-"+mT2(t+15)});
          }else if(now>=t-5&&now<t){
            // About to start break in <5 min - not late yet
          }
        });
      }
    });
  }
  el("dashBreak").textContent=bkNow;
  // Break alerts
  var bkAlertEl=el("dashBreakAlerts");
  var bkListEl=el("dashBreakAlertsList");
  if(bkAlertEl&&bkListEl){
    if(breakAlerts.length){
      bkAlertEl.style.display="block";
      bkListEl.innerHTML=breakAlerts.map(function(x){
        return "<div style='display:flex;gap:6px;align-items:center;font-size:10px;padding:2px 0'><span style='color:var(--orn)'>âš </span><b>"+x.name+"</b><span style='color:var(--tx3)'>"+x.label+" ("+x.time+") â€” "+x.type+"</span></div>";
      }).join("");
    }else{
      bkAlertEl.style.display="none";
    }
  }
  // Attendance exceptions â€” cross-check with Genesys (agents logged in Genesys = present)
  var excEl=el("dashAttExc");
  if(excEl){
    var excs=[];
    // Build set of agents logged into Genesys
    var genesysLoggedIn=new Set();
    if(window._genesysUsersData){
      window._genesysUsersData.forEach(function(u){
        if(u.isOnline){
          var agent=D.agents.find(function(a){
            var an=a.name.toLowerCase(),gn=u.name.toLowerCase();
            if(an===gn)return true;
            var ap=an.split(" "),gp=gn.split(" ");
            return ap[0]===gp[0]&&ap[ap.length-1]===gp[gp.length-1];
          });
          if(agent)genesysLoggedIn.add(agent.id);
        }
      });
    }
    if(D.roster){D.roster.forEach(function(r){
      var s=r.shifts[dayN];
      if(s&&s!=="OFF"&&s!=="AL"){
        var isPresent=att[r.id]||genesysLoggedIn.has(r.id);
        if(!isPresent){
          var sh=D.shifts.find(function(x){return x.id===s;});
          // Check if shift is in future (not yet started)
          var shStartMin=0;
          if(sh){var sp=sh.start.split(":");shStartMin=parseInt(sp[0])*60+parseInt(sp[1]);}
          var nowM=today.getHours()*60+today.getMinutes();
          // Only flag if shift should have started (give 15min grace)
          if(shStartMin>0&&nowM<shStartMin+15)return; // not started yet
          excs.push({name:r.name,shift:s,start:sh?sh.start:""});
        }
      }
    });}
    if(excs.length){
      excEl.innerHTML=excs.map(function(x){
        return "<div style='display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid var(--brd);font-size:11px'>"
          +"<span style='color:var(--red)'>&#9888;</span>"
          +"<b>"+x.name+"</b>"
          +"<span style='color:var(--tx3)'>Shift "+x.shift+(x.start?" @ "+x.start:"")+"</span>"
          +"<span style='color:var(--red);font-size:10px'>Not clocked in</span></div>";
      }).join("");
    }else{
      excEl.innerHTML="<p style='color:var(--tx3);font-size:12px'>No exceptions today &#10003;</p>";
    }
  }
  // Pending leave requests
  var lrEl=el("dashLeaveReq");
  if(lrEl){
    var pends=D.al.filter(function(a){return a.status==="Pending";}).sort(function(a,b){return new Date(a.start)-new Date(b.start);});
    if(pends.length){
      lrEl.innerHTML=pends.map(function(a){
        return "<div style='padding:5px 0;border-bottom:1px solid var(--brd)'>"
          +"<div style='display:flex;align-items:center;gap:4px;flex-wrap:wrap'>"
          +"<b style='font-size:11px'>"+a.name+"</b>"
          +"<span style='font-family:var(--mono);font-size:10px;color:var(--tx2)'>"+a.start+" to "+a.end+"</span>"
          +"<span style='font-size:10px;color:var(--cyn);font-weight:700'>"+alDays(a.start,a.end)+"d</span></div>"
          +"<div style='display:flex;gap:4px;margin-top:3px'>"
          +"<button class='btn bg' style='padding:2px 8px;font-size:9px' onclick='dashApproveAL(\""+a.id+"\")'>&#10003; Approve</button>"
          +"<button class='btn bd' style='padding:2px 8px;font-size:9px' onclick='dashRejectAL(\""+a.id+"\")'>&#10005; Reject</button>"
          +"<button class='btn bs2' style='padding:2px 8px;font-size:9px' onclick='dashCommentAL(\""+a.id+"\")'>&#128172; Comment</button>"
          +"</div></div>";
      }).join("");
    }else{
      lrEl.innerHTML="<p style='color:var(--tx3);font-size:12px'>No pending leave &#10003;</p>";
    }
  }
  // Shift requests
  var srEl=el("dashSRList");
  if(srEl){
    var pendSR=(D.schedPrefs||[]).filter(function(p){return p.status==="Pending"&&p.source==="agent";}).sort(function(a,b){return new Date(b.addedAt)-new Date(a.addedAt);});
    if(el("dashSRCount"))el("dashSRCount").textContent=pendSR.length;
    if(pendSR.length){
      srEl.innerHTML=pendSR.map(function(p){
        return "<div style='padding:5px 0;border-bottom:1px solid var(--brd)'>"
          +"<div style='display:flex;align-items:center;gap:4px;flex-wrap:wrap'>"
          +"<b style='font-size:11px'>"+p.name+"</b>"
          +"<span style='font-family:var(--mono);font-size:10px;color:var(--acc)'>"+p.day+"</span>"
          +"<span style='font-size:10px;color:var(--tx2)'>"+p.request+"</span>"
          +(p.reason?"<span style='font-size:10px;color:var(--tx3)'>"+p.reason+"</span>":"")
          +"</div>"
          +"<div style='display:flex;gap:4px;margin-top:3px'>"
          +"<button class='btn bg' style='padding:2px 8px;font-size:9px' onclick='dashApproveSR(\""+p.id+"\")'>&#10003; Approve</button>"
          +"<button class='btn bd' style='padding:2px 8px;font-size:9px' onclick='dashRejectSR(\""+p.id+"\")'>&#10005; Reject</button>"
          +"<button class='btn bs2' style='padding:2px 8px;font-size:9px' onclick='dashCommentSR(\""+p.id+"\")'>&#128172; Comment</button>"
          +"</div></div>";
      }).join("");
    }else{
      srEl.innerHTML="<p style='color:var(--tx3);font-size:12px'>No pending requests &#10003;</p>";
    }
  }
  // Update history log
  renderRequestHistory();
  // Agent QA quality scores
  var qaEl=el("dashAgentQA");
  var qaListEl=el("dashQAList");
  if(qaEl&&qaListEl){
    var latestMonth=Object.keys(D.kpis||{}).sort().pop();
    if(latestMonth&&D.kpis[latestMonth]){
      var qaData=[];
      Object.entries(D.kpis[latestMonth]).forEach(function(entry){
        var aid=entry[0],kd=entry[1];
        if(kd.qa>0){
          var ag=D.agents.find(function(a){return a.id===aid;});
          if(ag)qaData.push({name:ag.name,qa:kd.qa});
        }
      });
      if(qaData.length){
        qaData.sort(function(a,b){return b.qa-a.qa;});
        qaEl.style.display="block";
        qaListEl.innerHTML=qaData.map(function(x){
          var col=x.qa>=90?"var(--grn)":x.qa>=80?"var(--orn)":"var(--red)";
          var shortN=x.name.length>22?x.name.slice(0,20)+"â€¦":x.name;
          return '<div style="display:flex;align-items:center;gap:5px;padding:3px 6px;background:var(--s2);border-radius:4px">'
            +'<span style="font-size:9px;font-weight:700;color:'+col+';min-width:32px;font-family:var(--mono)">'+x.qa.toFixed(0)+'</span>'
            +'<span style="font-size:9px;color:var(--tx2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+x.name+'">'+shortN+'</span></div>';
        }).join("");
      }else{qaEl.style.display="none";}
    }else{qaEl.style.display="none";}
  }
  // Auto-trigger Genesys live if proxy URL is set
  if(GENESYS_PROXY_URL){
    var statusEl=document.getElementById("dashLiveStatus");
    if(statusEl)statusEl.textContent="Auto-refreshing...";
    setTimeout(refreshGenesysLive, 500);
  }
}

function logRequestHistory(type, name, requestDesc, status, comment) {
  if(!D.requestHistory) D.requestHistory = [];
  D.requestHistory.push({
    id: uid(),
    type: type,
    name: name,
    request: requestDesc,
    status: status,
    comment: comment || "",
    decidedAt: new Date().toISOString()
  });
}
function dashApproveAL(id){
  var a=D.al.find(function(x){return x.id===id;});
  if(!a)return;
  a.status="Approved";
  a.decidedAt=new Date().toISOString();
  logRequestHistory("leave", a.name, a.start+" â†’ "+a.end+" ("+alDays(a.start,a.end)+"d)", "Approved", a.adminNote||"");
  save();renderAL();renderDashboard();renderRequestHistory();
  toast("âœ“ AL Approved: "+a.name);
}
function dashRejectAL(id){
  var a=D.al.find(function(x){return x.id===id;});
  if(!a)return;
  var reason=prompt("Reason for rejection (optional):", "");
  if(reason===null)return;
  a.status="Rejected";
  a.adminNote=reason||a.adminNote;
  a.decidedAt=new Date().toISOString();
  logRequestHistory("leave", a.name, a.start+" â†’ "+a.end+" ("+alDays(a.start,a.end)+"d)", "Rejected", reason||"");
  save();renderAL();renderDashboard();renderRequestHistory();
  toast("âœ— AL Rejected: "+a.name);
}
function dashCommentAL(id){
  var a=D.al.find(function(x){return x.id===id;});
  if(!a)return;
  var note=prompt("Comment for "+a.name+":", a.adminNote||"");
  if(note!==null){a.adminNote=note;save();renderDashboard();toast("Comment saved");}
}
function dashApproveSR(id){
  if(!D.schedPrefs)return;
  var p=D.schedPrefs.find(function(x){return x.id===id;});
  if(!p)return;
  p.status="Approved";
  p.decidedAt=new Date().toISOString();
  logRequestHistory("shift", p.name, p.day+" â†’ "+p.request, "Approved", p.adminNote||"");
  save();renderDashboard();renderRequestHistory();
  toast("âœ“ Request approved: "+p.name+" â€” "+p.day);
}
function dashRejectSR(id){
  if(!D.schedPrefs)return;
  var p=D.schedPrefs.find(function(x){return x.id===id;});
  if(!p)return;
  var reason=prompt("Reason for rejection (optional):", "");
  if(reason===null)return;
  p.status="Rejected";
  p.adminNote=reason||p.adminNote;
  p.decidedAt=new Date().toISOString();
  logRequestHistory("shift", p.name, p.day+" â†’ "+p.request, "Rejected", reason||"");
  save();renderDashboard();renderRequestHistory();
  toast("âœ— Request rejected: "+p.name);
}
function dashCommentSR(id){
  if(!D.schedPrefs)return;
  var p=D.schedPrefs.find(function(x){return x.id===id;});
  if(!p)return;
  var note=prompt("Comment for "+p.name+":", p.adminNote||"");
  if(note!==null){p.adminNote=note;save();renderDashboard();toast("Comment saved");}
}
function renderRequestHistory(){
  var body=document.getElementById("dashHistoryBody");
  if(!body)return;
  if(!D.requestHistory)D.requestHistory=[];
  
  // Also pull all decided AL and SR requests for full history
  var allHistory=[];
  // From request history log
  D.requestHistory.forEach(function(r){allHistory.push(r);});
  // Also show all decided AL/SR that aren't in log yet (legacy)
  (D.al||[]).forEach(function(a){
    if(a.status==="Approved"||a.status==="Rejected"){
      var already=D.requestHistory.find(function(r){return r.type==="leave"&&r.name===a.name&&r.request&&r.request.includes(a.start);});
      if(!already){
        allHistory.push({type:"leave",name:a.name,request:a.start+" â†’ "+a.end,status:a.status,comment:a.adminNote||"",decidedAt:a.decidedAt||a.addedAt||""});
      }
    }
  });
  (D.schedPrefs||[]).forEach(function(p){
    if(p.status==="Approved"||p.status==="Rejected"||p.status==="Cancelled"){
      var already=D.requestHistory.find(function(r){return r.type==="shift"&&r.name===p.name&&r.request&&r.request.includes(p.day);});
      if(!already){
        allHistory.push({type:"shift",name:p.name,request:p.day+" â†’ "+p.request,status:p.status,comment:p.adminNote||"",decidedAt:p.decidedAt||p.addedAt||""});
      }
    }
  });
  
  // Apply filters
  var typeFilter=document.getElementById("dashHistoryFilter")?document.getElementById("dashHistoryFilter").value:"all";
  var statusFilter=document.getElementById("dashHistoryStatus")?document.getElementById("dashHistoryStatus").value:"all";
  if(typeFilter!=="all")allHistory=allHistory.filter(function(r){return r.type===typeFilter;});
  if(statusFilter!=="all")allHistory=allHistory.filter(function(r){return r.status===statusFilter;});
  
  // Sort by date, newest first
  allHistory.sort(function(a,b){return new Date(b.decidedAt||0)-new Date(a.decidedAt||0);});
  
  if(!allHistory.length){
    body.innerHTML='<tr><td colspan="6" style="padding:16px;text-align:center;color:var(--tx3);font-size:11px">No request history yet â€” approve or reject requests to build the log</td></tr>';
    return;
  }
  
  var statusColors={Approved:"#059669",Rejected:"#ef4444",Pending:"#f59e0b",Cancelled:"#6b7280"};
  body.innerHTML=allHistory.map(function(r){
    var typeIcon=r.type==="leave"?"ðŸŒ´":"ðŸ“…";
    var typeLabel=r.type==="leave"?"Leave":"Shift";
    var sc=statusColors[r.status]||"#6b7280";
    var date=r.decidedAt?r.decidedAt.split("T")[0]:"â€”";
    return "<tr style='border-bottom:1px solid var(--brd)'>"
      +"<td style='padding:7px 10px;font-size:11px;font-weight:500'>"+r.name+"</td>"
      +"<td style='padding:7px 10px'><span style='font-size:9px;padding:2px 6px;border-radius:3px;background:var(--s3);color:var(--tx2)'>"+typeIcon+" "+typeLabel+"</span></td>"
      +"<td style='padding:7px 10px;font-family:var(--mono);font-size:10px;color:var(--tx2)'>"+r.request+"</td>"
      +"<td style='padding:7px 10px;font-family:var(--mono);font-size:10px;color:var(--tx3)'>"+date+"</td>"
      +"<td style='padding:7px 10px'><span style='font-size:9px;padding:2px 7px;border-radius:3px;background:"+sc+"20;color:"+sc+";font-weight:700'>"+r.status+"</span></td>"
      +"<td style='padding:7px 10px;font-size:10px;color:var(--tx3);max-width:150px;overflow:hidden;text-overflow:ellipsis'>"+((r.comment||"")?"ðŸ’¬ "+r.comment:"â€”")+"</td>"
      +"</tr>";
  }).join("");
}

// â•â•â• GENESYS LIVE DASHBOARD â•â•â•
async function refreshGenesysLive(){
  const el=id=>document.getElementById(id);
  const statusEl=el("dashLiveStatus");
  const baseUrl=(GENESYS_PROXY_URL||"").replace(/\/+$/,"");
  
  // Ensure URL has https://
  const url="https://"+baseUrl.replace(/^(https?:\/\/)+/,"");
  
  if(!url||url==="https://"){
    toast("Set Genesys proxy URL in Settings first","err");
    if(statusEl){statusEl.textContent="âš  No proxy URL set";statusEl.style.color="var(--red)";}
    return;
  }
  
  if(statusEl){statusEl.textContent="Connecting to "+url.replace("https://","")+"...";statusEl.style.color="var(--tx3)";}
  
  try{
    // Step 1: Health check
    let healthOk=false, region="unknown";
    try{
      const hRes=await fetch(url+"/api/genesys?action=health",{mode:"cors"});
      if(!hRes.ok)throw new Error("HTTP "+hRes.status);
      const hData=await hRes.json();
      if(!hData.ok)throw new Error(hData.error||"Health check failed");
      healthOk=true;
      region=hData.region||"unknown";
      if(statusEl){statusEl.textContent="âœ“ Connected Â· "+region;statusEl.style.color="var(--grn)";}
    }catch(he){
      if(statusEl){statusEl.textContent="âš  Proxy unreachable: "+he.message;statusEl.style.color="var(--red)";}
      if(el("dashAgentStatusTable"))el("dashAgentStatusTable").innerHTML=
        '<div style="padding:12px;font-size:11px;color:var(--red)">'+
        '<b>Cannot reach Genesys proxy</b><br>'+
        '<span style="color:var(--tx2)">URL tried: '+url+'</span><br>'+
        '<span style="color:var(--tx3)">Error: '+he.message+'</span><br><br>'+
        '<span style="color:var(--tx3)">Checklist:<br>'+
        '1. Your Vercel deployment is live<br>'+
        '2. The URL in Settings has no trailing slash<br>'+
        '3. Vercel env vars GENESYS_CLIENT_ID, GENESYS_CLIENT_SECRET, GENESYS_REGION are set<br>'+
        '4. Vercel function adds CORS header: Access-Control-Allow-Origin: *</span></div>';
      return;
    }
    
    // Step 2: Fetch realtime + users in parallel
    const [rtRes, usRes, kpRes] = await Promise.allSettled([
      fetch(url+"/api/genesys?action=realtime",{mode:"cors"}),
      fetch(url+"/api/genesys?action=users",{mode:"cors"}),
      fetch(url+"/api/genesys?action=kpis&month="+new Date().toISOString().slice(0,7),{mode:"cors"})
    ]);
    
    let rtData={ok:false,stats:[]};
    let usData={ok:false,users:[]};
    let kpData={ok:false,kpis:{}};
    
    if(rtRes.status==="fulfilled"&&rtRes.value.ok){try{rtData=await rtRes.value.json()}catch(e){}}
    if(usRes.status==="fulfilled"&&usRes.value.ok){try{usData=await usRes.value.json()}catch(e){}}
    if(kpRes.status==="fulfilled"&&kpRes.value.ok){try{kpData=await kpRes.value.json()}catch(e){}}
    
    const now=new Date();
    if(el("dashLiveTime"))el("dashLiveTime").textContent="Updated "+now.getHours().toString().padStart(2,"0")+":"+now.getMinutes().toString().padStart(2,"0");
    
    // Aggregate queue stats
    let totalWaiting=0,totalAnswered=0,totalAbandoned=0,totalOffered=0,longestWait=0,totalASA=0,asaCount=0;
    let sumAHT=0,ahtCount=0;
    
    if(rtData.ok&&rtData.stats){
      rtData.stats.forEach(q=>{
        (q.data||[]).forEach(m=>{
          if(m.metric==="oWaiting")totalWaiting+=m.stats?.count||0;
          if(m.metric==="nAnswered"||m.metric==="nConnected")totalAnswered+=m.stats?.count||0;
          if(m.metric==="nOffered")totalOffered+=m.stats?.count||0;
          if(m.metric==="nAbandonedWithinXSeconds"||m.metric==="nAbandoned")totalAbandoned+=m.stats?.count||0;
          if(m.metric==="tMaxWaitTime")longestWait=Math.max(longestWait,m.stats?.max||0);
          if(m.metric==="tAnswered"&&m.stats?.count){totalASA+=(m.stats.sum||0);asaCount+=m.stats.count;}
        });
      });
    }
    if(kpData.ok&&kpData.kpis){
      Object.values(kpData.kpis).forEach(k=>{
        if(k.answered>0){sumAHT+=k.aht*k.answered;ahtCount+=k.answered;}
        if(!rtData.ok||!rtData.stats){totalAnswered+=k.answered||0;totalOffered+=k.interactions||k.answered||0;}
      });
    }
    
    // Update stat displays
    if(el("dashWaiting"))el("dashWaiting").textContent=totalWaiting||0;
    if(el("dashAnswered"))el("dashAnswered").textContent=totalAnswered||"â€”";
    if(el("dashOffered"))el("dashOffered").textContent=totalOffered||"â€”";
    if(el("dashAbandonedNum"))el("dashAbandonedNum").textContent=totalAbandoned||"â€”";
    const abPct=totalOffered>0?(totalAbandoned/totalOffered*100).toFixed(1)+"%":"â€”";
    if(el("dashAbandoned"))el("dashAbandoned").textContent=abPct;
    const avgAHT=ahtCount>0?Math.round(sumAHT/ahtCount):0;
    if(el("dashAHT"))el("dashAHT").textContent=avgAHT>0?Math.floor(avgAHT/60)+":"+String(avgAHT%60).padStart(2,"0"):"â€”";
    const avgASA=asaCount>0?Math.round(totalASA/asaCount/1000):0;
    if(el("dashASA"))el("dashASA").textContent=avgASA>0?(avgASA<60?avgASA+"s":Math.floor(avgASA/60)+"m"+avgASA%60+"s"):"â€”";
    const lw=longestWait>0?Math.floor(longestWait/60)+"m "+longestWait%60+"s":"â€”";
    if(el("dashLongest"))el("dashLongest").textContent=lw;
    
    // Service level badge
    const slBadge=el("dashSLBadge");
    if(slBadge){
      const sl=kpData.sl||(totalAnswered>0?Math.round((1-totalAbandoned/(totalAnswered+totalAbandoned||1))*100):null);
      if(sl!==null){
        slBadge.textContent="SL: "+sl+"%";
        slBadge.style.background=sl>=80?"#064e3b":sl>=60?"#78350f":"#7f1d1d";
        slBadge.style.color=sl>=80?"#6ee7b7":sl>=60?"#fde68a":"#fca5a5";
      }
    }
    
    // Agent status table â€” sort online first, CC filter
    const tbl=el("dashAgentStatusTable");
    if(tbl){
      if(usData.ok&&usData.users&&usData.users.length){
        const statusOrder={"Interacting":0,"Available":1,"On Call":2,"Break":3,"Away":4,"Offline":5};
        const statusColors={"Available":"var(--grn)","Busy":"var(--orn)","Break":"var(--cyn)","Away":"var(--tx3)","Offline":"var(--brd2)","On Queue":"var(--acc)","Interacting":"var(--acc)","On Call":"var(--orn)"};
        
        // Build CC agent names set for filter
        const ccNames=new Set(D.agents.map(a=>a.name.toLowerCase()));
        
        // Process users with status
        window._genesysUsersData=usData.users.map(u=>{
          const rs=u.routingStatus?.status||"UNKNOWN";
          const pres=u.presence?.presenceDefinition?.systemPresence||"Offline";
          const status=rs==="IDLE"?"Available":rs==="INTERACTING"?"Interacting":rs==="COMMUNICATING"?"On Call":pres;
          const isOnline=status!=="Offline"&&status!=="Away"&&pres!=="Offline";
          const isCC=ccNames.has(u.name.toLowerCase())||D.agents.some(a=>{
            const an=a.name.toLowerCase(),gn=u.name.toLowerCase();
            const ap=an.split(" "),gp=gn.split(" ");
            return ap[0]===gp[0]&&ap[ap.length-1]===gp[gp.length-1];
          });
          return {...u,status,isOnline,isCC,sortOrder:(isOnline?0:10)+(statusOrder[status]||5)};
        });
        
        // Sort: online first, then by status order
        window._genesysUsersData.sort((a,b)=>a.sortOrder-b.sortOrder);
        
        applyAgentStatusFilter();
        
        // Auto-update attendance â€” agents logged in Genesys count as clocked in
        const todayStr2=new Date().toISOString().split("T")[0];
        if(!D.attendance)D.attendance={};
        if(!D.attendance[todayStr2])D.attendance[todayStr2]={};
        let matched=0;
        usData.users.forEach(u=>{
          const rs=u.routingStatus?.status||"";
          const pres=u.presence?.presenceDefinition?.systemPresence||"Offline";
          // Any non-offline presence means logged in
          if(pres!=="Offline"&&pres!=="Unknown"||rs==="IDLE"||rs==="INTERACTING"||rs==="COMMUNICATING"){
            const agent=D.agents.find(a=>{
              const an=a.name.toLowerCase(),gn=u.name.toLowerCase();
              if(an===gn)return true;
              const ap=an.split(" "),gp=gn.split(" ");
              return ap[0]===gp[0]&&ap[ap.length-1]===gp[gp.length-1];
            });
            if(agent&&!D.attendance[todayStr2][agent.id]){D.attendance[todayStr2][agent.id]="Present";matched++;}
          }
        });
        if(matched>0){save();renderDashboard();}
      }else{
        tbl.innerHTML='<div style="padding:8px;font-size:11px;color:var(--tx3)">'+
          (usData.ok?"No agents found in Genesys":"Could not load agent status â€” proxy returned: "+JSON.stringify(usData).slice(0,100))+'</div>';
      }
    }
    
    if(statusEl){statusEl.textContent="âœ“ Live Â· "+region+" Â· "+now.toLocaleTimeString();statusEl.style.color="var(--grn)";}
    
  }catch(e){
    if(statusEl){statusEl.textContent="âš  Error: "+e.message;statusEl.style.color="var(--red)";}
    const errEl=el("dashAgentStatusTable");
    if(errEl)errEl.innerHTML='<div style="padding:12px;font-size:11px;color:var(--red)">'+
      '<b>Genesys fetch error</b><br><span style="color:var(--tx2)">'+e.message+'</span><br>'+
      '<span style="color:var(--tx3)">Open browser DevTools â†’ Console to see full error</span></div>';
    console.error("Genesys refresh error:",e);
  }
}
function toggleEl(id){const el=document.getElementById(id);if(el)el.style.display=el.style.display==="none"?"block":"none"}

// â”€â”€â”€ Apply filter to agent status grid â”€â”€â”€
function applyAgentStatusFilter(){
  const tbl=document.getElementById("dashAgentStatusTable");
  if(!tbl||!window._genesysUsersData)return;
  const statusColors={"Available":"var(--grn)","Busy":"var(--orn)","Break":"var(--cyn)","Away":"var(--tx3)","Offline":"var(--brd2)","On Queue":"var(--acc)","Interacting":"var(--acc)","On Call":"var(--orn)"};
  const ccOnly=document.getElementById("dashFilterCC")?.checked!==false;
  const statusFilt=document.getElementById("dashStatusFilter")?.value||"all";
  
  let users=window._genesysUsersData;
  if(ccOnly)users=users.filter(u=>u.isCC);
  if(statusFilt==="online")users=users.filter(u=>u.isOnline);
  if(statusFilt==="offline")users=users.filter(u=>!u.isOnline);
  
  if(!users.length){tbl.innerHTML='<div style="font-size:11px;color:var(--tx3);padding:6px">No agents match filter</div>';return;}
  
  // Get today's shift end time from roster
  const today=new Date();
  const todayN=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][today.getDay()];
  const nowMin=today.getHours()*60+today.getMinutes();
  
  tbl.innerHTML=users.map(u=>{
    const col=statusColors[u.status]||"var(--tx3)";
    const isOffline=!u.isOnline;
    
    // Check if this agent's shift is over (finished)
    let shiftDone=false;
    if(isOffline){
      const agent=D.agents.find(a=>{
        const an=a.name.toLowerCase(),gn=u.name.toLowerCase();
        if(an===gn)return true;
        const ap=an.split(" "),gp=gn.split(" ");
        return ap[0]===gp[0]&&ap[ap.length-1]===gp[gp.length-1];
      });
      if(agent&&D.roster){
        const r=D.roster.find(x=>x.id===agent.id);
        if(r){
          const sh=r.shifts[todayN];
          const shObj=D.shifts.find(s=>s.id===sh);
          if(shObj){
            const [eh,em]=shObj.end.split(":").map(Number);
            let endMin=eh*60+em;
            if(endMin<parseInt(shObj.start)*60)endMin+=1440;
            if(nowMin>endMin-30)shiftDone=true;
          }else if(sh==="OFF"||sh==="AL")shiftDone=true;
        }
      }
    }
    
    const opacity=shiftDone?"opacity:.4;":"";
    const badge=shiftDone?'<span style="font-size:8px;color:var(--tx3);background:var(--s3);padding:1px 4px;border-radius:2px">Done</span>':'';
    
    return '<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--s2);border-radius:6px;border-left:3px solid '+col+';'+opacity+'">'+
      '<div style="width:7px;height:7px;border-radius:50%;background:'+col+';flex-shrink:0"></div>'+
      '<span style="font-size:11px;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+u.name+'</span>'+
      badge+
      '<span style="font-size:9px;color:'+col+';font-weight:700;flex-shrink:0">'+u.status+'</span></div>';
  }).join("");
}

// â•â•â• GENESYS CLOUD INTEGRATION â•â•â•
var GENESYS_PROXY_URL=(function(){var _gu=localStorage.getItem("genesys_proxy_url")||"";_gu=_gu.trim().replace(/^(https?:\/\/)+/,"");if(_gu)_gu="https://"+_gu;return _gu;})();
function setGenesysProxy(url){url=url.trim().replace(/^(https?:\/\/)+/,"").replace(/\/+$/,"");if(url)url="https://"+url;GENESYS_PROXY_URL=url;localStorage.setItem("genesys_proxy_url",url);const el=document.getElementById("genesysUrl");if(el)el.value=url}
async function testGenesysProxy(){
  let url=(document.getElementById("genesysUrl")?.value||"").trim().replace(/^(https?:\/\/)+/,"").replace(/\/+$/,"");if(url)url="https://"+url;
  if(!url){toast("Enter proxy URL first","err");return}
  setGenesysProxy(url);
  const el=document.getElementById("genesysTestResult");
  el.innerHTML='<div style="padding:6px;font-size:11px;color:var(--cyn)"><span class="spin" style="width:12px;height:12px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></span>Testing connection...</div>';
  try{
    const r=await fetch(url+"/api/genesys?action=health");
    const d=await r.json();
    if(d.ok){el.innerHTML='<div style="padding:6px;font-size:11px;color:var(--grn)">âœ“ Connected! Region: <b>'+d.region+'</b> | Token cached: '+(d.tokenCached?"Yes":"No")+'</div>'}
    else throw new Error(d.error||"Failed");
  }catch(e){el.innerHTML='<div style="padding:6px;font-size:11px;color:var(--red)">âœ— '+e.message+'</div>'}
}
const KPI_METRICS=[{id:"qa",label:"QA Score",unit:"",color:"#8b5cf6",target:85,dir:"high",fmt:v=>v.toFixed(1)},{id:"aht",label:"AHT",unit:"s",color:"#f59e0b",target:300,dir:"low",fmt:v=>Math.floor(v/60)+":"+String(Math.round(v%60)).padStart(2,"0")},{id:"unplanned",label:"Unplanned",unit:"",color:"#ef4444",target:1,dir:"low",fmt:v=>v.toFixed(0)},{id:"adherence",label:"Adherence",unit:"%",color:"#06b6d4",target:90,dir:"high",fmt:v=>v.toFixed(1)+"%"},{id:"interactions",label:"Interactions",unit:"",color:"#10b981",target:800,dir:"high",fmt:v=>v.toFixed(0)},{id:"csat",label:"CSAT",unit:"",color:"#3b82f6",target:4.0,dir:"high",fmt:v=>v.toFixed(2)}];

async function fetchGenesysKPIs(){
  if(!GENESYS_PROXY_URL){
    // Show setup prompt
    const url=prompt("Enter your Genesys proxy URL (e.g. https://your-project.vercel.app):\n\nTo set this up:\n1. Deploy the genesys-proxy to Vercel\n2. Configure Genesys OAuth credentials\n3. Enter the URL here","https://");
    if(!url||url==="https://")return;
    setGenesysProxy(url);
  }
  const month=document.getElementById("kpiMonth")?.value||"2026-02";
  const statusEl=document.getElementById("genesysStatus");
  statusEl.style.display="block";
  statusEl.innerHTML='<div class="card" style="border-left:3px solid var(--cyn)"><div class="cb" style="display:flex;align-items:center;gap:8px"><span class="spin" style="width:16px;height:16px;border-width:2px"></span><span style="font-size:12px;color:var(--cyn)">Fetching KPIs from Genesys Cloud for <b>'+month+'</b>...</span></div></div>';
  try{
    // First check health
    const hRes=await fetch(GENESYS_PROXY_URL+"/api/genesys?action=health");
    if(!hRes.ok)throw new Error("Proxy unreachable ("+hRes.status+")");
    const health=await hRes.json();
    if(!health.ok)throw new Error(health.error||"Health check failed");
    // Fetch KPIs
    const kRes=await fetch(GENESYS_PROXY_URL+"/api/genesys?action=kpis&month="+month);
    if(!kRes.ok)throw new Error("KPI fetch failed ("+kRes.status+")");
    const kData=await kRes.json();
    if(!kData.ok)throw new Error(kData.error||"KPI response error");
    // Map Genesys data to Command Hub agents
    if(!D.kpis[month])D.kpis[month]={};
    let matched=0,unmatched=[];
    for(const[gName,gKpi]of Object.entries(kData.kpis)){
      // Try to find matching agent by name (fuzzy)
      const agent=D.agents.find(a=>{
        const an=a.name.toLowerCase(),gn=gName.toLowerCase();
        if(an===gn)return true;
        // Match by first+last name
        const aParts=an.split(" "),gParts=gn.split(" ");
        if(aParts[0]===gParts[0]&&aParts[aParts.length-1]===gParts[gParts.length-1])return true;
        // Match if Genesys name contains first name and partial last
        if(gn.includes(aParts[0])&&aParts.length>1&&gn.includes(aParts[1]))return true;
        return false;
      });
      if(agent){
        const existing=D.kpis[month][agent.id]||{};
        // Merge â€” Genesys provides AHT + interactions, keep manual QA/CSAT/adherence/unplanned
        D.kpis[month][agent.id]={
          qa:existing.qa||0,
          aht:gKpi.aht||existing.aht||0,
          unplanned:existing.unplanned||0,
          adherence:existing.adherence||0,
          interactions:gKpi.interactions||existing.interactions||0,
          csat:existing.csat||0,
          // Extra Genesys fields
          avgTalk:gKpi.avgTalk||0,
          avgHold:gKpi.avgHold||0,
          avgAcw:gKpi.avgAcw||0,
          answered:gKpi.answered||0,
          transfers:gKpi.transfers||0,
        };
        matched++;
      }else{
        unmatched.push(gName);
      }
    }
    save();renderKPIs();
    let msg='<div class="card" style="border-left:3px solid var(--grn)"><div class="cb"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:16px">âœ“</span><b style="font-size:12px;color:var(--grn)">Genesys data imported!</b></div><div style="font-size:11px;color:var(--tx2)">'+matched+' agents matched â€¢ Region: '+health.region+'</div>';
    if(unmatched.length)msg+='<div style="font-size:10px;color:var(--orn);margin-top:4px">Unmatched Genesys users: '+unmatched.join(", ")+'</div>';
    msg+='<div style="font-size:10px;color:var(--tx3);margin-top:4px">AHT + Interactions auto-filled. QA, CSAT, Adherence, Unplanned still need manual entry.</div>';
    msg+='<div style="margin-top:6px"><button class="btn bs2 bsm" onclick="setGenesysProxy(String());document.getElementById(String.raw`genesysStatus`).style.display=String.raw`none`">Change Proxy URL</button></div>';
    msg+='</div></div>';
    statusEl.innerHTML=msg;
  }catch(e){
    statusEl.innerHTML='<div class="card" style="border-left:3px solid var(--red)"><div class="cb"><div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span style="font-size:16px">âœ—</span><b style="font-size:12px;color:var(--red)">Genesys fetch failed</b></div><div style="font-size:11px;color:var(--tx2)">'+e.message+'</div><div style="margin-top:6px;display:flex;gap:4px"><button class="btn bs2 bsm" onclick="GENESYS_PROXY_URL=String();fetchGenesysKPIs()">Change URL</button><button class="btn bs2 bsm" onclick="document.getElementById(String.raw`genesysStatus`).style.display=String.raw`none`">Dismiss</button></div></div></div>';
  }
}
// â•â•â• KPIs â•â•â•
if(!D.kpis)D.kpis={};// {month: {agentId: {qa,aht,unplanned,adherence,interactions,csat}}}
var kpiActiveChart="qa";
function buildKPIBulkTable(){
  const body=document.getElementById("kpiBulkBody");if(!body)return;
  const month=document.getElementById("kpiDataMonth").value;
  const existing=D.kpis[month]||{};
  body.innerHTML=D.agents.map(a=>{
    const d=existing[a.id]||{};
    return'<tr data-aid="'+a.id+'"><td style="text-align:left;font-size:11px;font-weight:500;padding:4px 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px" title="'+a.name+'">'+a.name+'</td>'+
    '<td><input type="number" class="di kbf" data-m="qa" step="0.1" value="'+(d.qa||"")+'"></td>'+
    '<td><input type="number" class="di kbf" data-m="aht" value="'+(d.aht||"")+'"></td>'+
    '<td><input type="number" class="di kbf" data-m="unplanned" value="'+(d.unplanned||"")+'"></td>'+
    '<td><input type="number" class="di kbf" data-m="adherence" step="0.1" value="'+(d.adherence||"")+'"></td>'+
    '<td><input type="number" class="di kbf" data-m="interactions" value="'+(d.interactions||"")+'"></td>'+
    '<td><input type="number" class="di kbf" data-m="csat" step="0.01" value="'+(d.csat||"")+'"></td></tr>';
  }).join("");
  // Attach paste listener to the table
  const tbl=document.getElementById("kpiBulkTable");
  tbl.removeEventListener("paste",handleKPIPaste);
  tbl.addEventListener("paste",handleKPIPaste);
}
function handleKPIPaste(e){
  const active=document.activeElement;
  if(!active||!active.classList.contains("kbf"))return;
  const clipText=(e.clipboardData||window.clipboardData).getData("text");
  if(!clipText)return;
  const rows=clipText.trim().split(/\r?\n/).map(r=>r.split(/\t/));
  if(rows.length<=1&&rows[0].length<=1)return; // single value, let default handle it
  e.preventDefault();
  // Find the starting cell position
  const startRow=active.closest("tr");
  const startCell=active.closest("td");
  const allRows=[...document.getElementById("kpiBulkBody").children];
  const rowIdx=allRows.indexOf(startRow);
  const cells=[...startRow.querySelectorAll("td")];
  const colIdx=cells.indexOf(startCell);
  const metricCols=["qa","aht","unplanned","adherence","interactions","csat"];
  // Map column index (td index 0 is name, 1-6 are metrics)
  for(let ri=0;ri<rows.length;ri++){
    const targetRowIdx=rowIdx+ri;
    if(targetRowIdx>=allRows.length)break;
    const tr=allRows[targetRowIdx];
    const inputs=[...tr.querySelectorAll("input.kbf")];
    for(let ci=0;ci<rows[ri].length;ci++){
      const targetColIdx=(colIdx-1)+ci; // -1 because first td is name
      if(targetColIdx<0||targetColIdx>=inputs.length)continue;
      let val=rows[ri][ci].trim().replace(/[,%]/g,"").replace(/\s/g,"");
      // Handle time format like "4:10" -> convert to seconds
      if(inputs[targetColIdx].dataset.m==="aht"&&val.includes(":")){
        const parts=val.split(":");
        val=String(parseInt(parts[0])*60+parseInt(parts[1]||0));
      }
      // Handle percentage already as number
      const num=parseFloat(val);
      inputs[targetColIdx].value=isNaN(num)?"":num;
    }
  }
  toast(rows.length+" rows pasted!");
}
function saveAllKPI(){
  const month=document.getElementById("kpiDataMonth").value;
  if(!month)return toast("Select month","err");
  if(!D.kpis[month])D.kpis[month]={};
  const rows=[...document.getElementById("kpiBulkBody").children];
  let count=0;
  rows.forEach(tr=>{
    const aid=tr.dataset.aid;
    const inputs=[...tr.querySelectorAll("input.kbf")];
    const vals={};let hasData=false;
    inputs.forEach(inp=>{
      const v=parseFloat(inp.value);
      if(!isNaN(v)&&v>0){vals[inp.dataset.m]=v;hasData=true}
      else vals[inp.dataset.m]=0;
    });
    if(hasData){D.kpis[month][aid]=vals;count++}
  });
  save();renderKPIs();
  toast(count+" agents saved for "+month);
}
function clearKPITable(){
  const inputs=document.querySelectorAll("#kpiBulkBody input.kbf");
  inputs.forEach(inp=>inp.value="");
  toast("Table cleared");
}
function saveKPI(){saveAllKPI()} // backward compat
function renderKPIs(){const month=document.getElementById("kpiMonth")?.value||"2026-02";const data=D.kpis[month]||{};const agents=D.kpis[month]?Object.keys(data).map(id=>({id,...D.agents.find(a=>a.id===id)||{name:"Unknown"},...data[id]})):[];
  document.getElementById("kpiMonthLabel").textContent=month;
  // Summary cards
  const sumEl=document.getElementById("kpiSummary");let sh="";KPI_METRICS.forEach(m=>{const vals=agents.map(a=>a[m.id]||0).filter(v=>v>0);const avg=vals.length?vals.reduce((s,v)=>s+v,0)/vals.length:0;sh+='<div class="card"><div class="cb" style="text-align:center"><div style="font-size:9px;color:var(--tx2)">Avg '+m.label+'</div><div style="font-size:20px;font-weight:800;color:'+m.color+'">'+m.fmt(avg)+'</div><div style="font-size:8px;color:var(--tx3)">Target: '+(m.id==="aht"?m.fmt(m.target):m.target+m.unit)+'</div></div></div>'});sumEl.innerHTML=sh;
  // Agent table
  const tEl=document.getElementById("kpiTable");if(!agents.length){tEl.innerHTML='<p style="color:var(--tx3)">No data for this month. Click <b>+ Enter Data</b> to add.</p>';document.getElementById("kpiOutliers").innerHTML='<p style="color:var(--tx3)">Enter data to detect outliers</p>';document.getElementById("kpiTop").innerHTML='<p style="color:var(--tx3)">Enter data to see rankings</p>';document.getElementById("kpiActions").innerHTML='<p style="color:var(--tx3)">Enter data for recommendations</p>';document.getElementById("kpiChartArea").innerHTML='<p style="color:var(--tx3)">Enter data to see charts</p>';document.getElementById("kpiChartTabs").innerHTML="";return}
  let th='<table style="font-size:11px;width:100%"><thead><tr><th style="text-align:left">Agent</th>';KPI_METRICS.forEach(m=>th+='<th style="color:'+m.color+'">'+m.label+'</th>');th+='</tr></thead><tbody>';
  agents.forEach(a=>{th+='<tr><td style="text-align:left;font-size:10px;max-width:130px;overflow:hidden;text-overflow:ellipsis">'+a.name+'</td>';KPI_METRICS.forEach(m=>{const v=a[m.id]||0;const bad=m.dir==="high"?v<m.target*0.8:v>m.target*1.3;th+='<td style="font-family:var(--mono);font-size:10px;'+(bad?"color:var(--red);font-weight:700":"")+'">'+m.fmt(v)+'</td>'});th+='</tr>'});
  th+='<tr style="border-top:2px solid var(--brd);font-weight:700"><td style="text-align:left;color:var(--cyn)">TEAM AVG</td>';KPI_METRICS.forEach(m=>{const vals=agents.map(a=>a[m.id]||0).filter(v=>v>0);const avg=vals.length?vals.reduce((s,v)=>s+v,0)/vals.length:0;th+='<td style="font-family:var(--mono);font-size:10px;color:var(--cyn)">'+m.fmt(avg)+'</td>'});th+='</tr></tbody></table>';tEl.innerHTML=th;
  // â”€â”€ Charts â”€â”€
  renderKPIChartTabs(agents);
  renderKPIChart(agents,kpiActiveChart);
  // Outliers
  const outliers=[];agents.forEach(a=>{const issues=[];KPI_METRICS.forEach(m=>{const v=a[m.id]||0;if(v===0)return;if(m.dir==="high"&&v<m.target*0.8)issues.push({metric:m.label,val:m.fmt(v),target:m.id==="aht"?m.fmt(m.target):m.target+m.unit,gap:"below"});if(m.dir==="low"&&v>m.target*1.3)issues.push({metric:m.label,val:m.fmt(v),target:m.id==="aht"?m.fmt(m.target):m.target+m.unit,gap:"above"})});if(issues.length)outliers.push({name:a.name,id:a.id,issues})});
  const oEl=document.getElementById("kpiOutliers");oEl.innerHTML=outliers.length?outliers.map(o=>'<div style="border-left:3px solid var(--red);padding:6px 10px;margin-bottom:6px;background:var(--s2);border-radius:0 4px 4px 0"><b style="font-size:12px">'+o.name+'</b>'+o.issues.map(i=>'<div style="font-size:10px;color:var(--red)">'+i.metric+': <b>'+i.val+'</b> (target: '+i.target+') â€” '+i.gap+'</div>').join("")+'</div>').join(""):'<p style="color:var(--grn)">No outliers â€” all agents within target range!</p>';
  // Top performers â€” rank by composite score
  const ranked=[...agents].sort((a,b)=>(b.qa||0)-(a.qa||0));document.getElementById("kpiTop").innerHTML=ranked.slice(0,5).map((a,i)=>'<div class="ar"><span style="font-size:14px;min-width:24px">'+(i===0?"ðŸ¥‡":i===1?"ðŸ¥ˆ":i===2?"ðŸ¥‰":"#"+(i+1))+'</span><b style="font-size:11px;flex:1">'+a.name+'</b><span style="font-family:var(--mono);color:var(--pur);font-weight:700">QA: '+(a.qa||0).toFixed(1)+'</span></div>').join("");
  // Action plans
  const actEl=document.getElementById("kpiActions");const PLANS={qa:{course:"QA Fundamentals & Call Quality Workshop",action:"Schedule 1:1 QA coaching, review 5 calls together"},aht:{course:"Efficient Call Handling & Wrap-up Optimization",action:"Shadow top performer, practice concise summarization"},unplanned:{course:"Time Management & Attendance Awareness",action:"HR meeting, set attendance improvement plan"},adherence:{course:"Schedule Adherence & Time Management Training",action:"Daily adherence check-ins for 2 weeks"},interactions:{course:"Productivity & Efficiency Workshop",action:"Review idle time, optimize after-call work"},csat:{course:"Customer Experience & Empathy Training",action:"Role-play exercises, listen to top CSAT calls"}};
  if(outliers.length){actEl.innerHTML=outliers.map(o=>'<div class="card" style="margin-bottom:8px;border-left:3px solid var(--orn)"><div class="cb"><b style="font-size:12px">'+o.name+'</b>'+o.issues.map(i=>{const mid=KPI_METRICS.find(m=>m.label===i.metric)?.id||"";const plan=PLANS[mid]||{course:"General training",action:"Schedule coaching"};return'<div style="margin-top:4px;font-size:10px"><span style="color:var(--red)">'+i.metric+':</span> '+i.val+' â†’ <span style="color:var(--orn)">&#128218; '+plan.course+'</span><br><span style="color:var(--tx3)">Action: '+plan.action+'</span></div>'}).join("")+'</div></div>').join("")}else{actEl.innerHTML='<p style="color:var(--grn)">All agents performing within targets. Consider advanced development programs.</p>'}
}
function renderKPIChartTabs(agents){
  const el=document.getElementById("kpiChartTabs");
  el.innerHTML=KPI_METRICS.filter(m=>m.id!=="unplanned").map(m=>
    '<button class="btn bsm '+(kpiActiveChart===m.id?"bp":"bs2")+'" onclick="kpiActiveChart=\''+m.id+'\';renderKPIChart(null,\''+m.id+'\');renderKPIChartTabs(null)" style="font-size:10px">'+m.label+'</button>'
  ).join("");
}
function renderKPIChart(agentsParam,metricId){
  const el=document.getElementById("kpiChartArea");
  const month=document.getElementById("kpiMonth")?.value||"2026-02";
  const data=D.kpis[month]||{};
  const agents=agentsParam||Object.keys(data).map(id=>({id,...D.agents.find(a=>a.id===id)||{name:"Unknown"},...data[id]}));
  if(!agents.length){el.innerHTML='<p style="color:var(--tx3)">No data</p>';return}
  const m=KPI_METRICS.find(x=>x.id===metricId);if(!m)return;
  // Sort: for "low is better" (AHT) sort ascending, for "high is better" sort descending
  const sorted=[...agents].filter(a=>(a[m.id]||0)>0).sort((a,b)=>{
    return m.dir==="low"?(a[m.id]||0)-(b[m.id]||0):(b[m.id]||0)-(a[m.id]||0);
  });
  if(!sorted.length){el.innerHTML='<p style="color:var(--tx3)">No data for '+m.label+'</p>';return}
  const vals=sorted.map(a=>a[m.id]||0);
  const maxVal=Math.max(...vals);
  const minVal=Math.min(...vals);
  const avgVal=vals.reduce((s,v)=>s+v,0)/vals.length;
  const range=maxVal-0; // always start from 0 for proportional bars
  const barMax=maxVal*1.15; // leave headroom
  // Build horizontal bar chart
  let h='<div style="display:flex;gap:12px;align-items:flex-start"><div style="flex:1">';
  h+='<div style="display:flex;justify-content:space-between;margin-bottom:8px;padding:0 4px"><span style="font-size:11px;font-weight:700;color:'+m.color+'">'+m.label+(m.dir==="low"?" (lower is better)":" (higher is better)")+'</span>';
  h+='<span style="font-size:10px;color:var(--tx3)">Target: '+(m.id==="aht"?m.fmt(m.target):m.target+m.unit)+' | Avg: '+m.fmt(avgVal)+'</span></div>';
  sorted.forEach((a,i)=>{
    const v=a[m.id]||0;
    const pct=barMax>0?(v/barMax)*100:0;
    const targetPct=barMax>0?(m.target/barMax)*100:0;
    // Color logic: green=good, red=bad
    let barColor;
    if(m.dir==="high"){
      barColor=v>=m.target?m.color:v>=m.target*0.8?"#f59e0b":"#ef4444";
    }else{
      barColor=v<=m.target?m.color:v<=m.target*1.3?"#f59e0b":"#ef4444";
    }
    // Medal for top 3
    const medal=i===0?"ðŸ¥‡ ":i===1?"ðŸ¥ˆ ":i===2?"ðŸ¥‰ ":"";
    const shortName=a.name.length>20?a.name.slice(0,18)+"â€¦":a.name;
    h+='<div style="display:flex;align-items:center;margin-bottom:3px;gap:6px">';
    h+='<span style="font-size:10px;min-width:140px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:right;color:'+(i<3?"var(--tx)":"var(--tx2)")+';font-weight:'+(i<3?600:400)+'" title="'+a.name+'">'+medal+shortName+'</span>';
    h+='<div style="flex:1;height:20px;background:var(--s2);border-radius:4px;position:relative;overflow:hidden">';
    h+='<div style="height:100%;width:'+pct+'%;background:'+barColor+';border-radius:4px;transition:width .3s;opacity:0.85"></div>';
    // Target line
    if(targetPct>0&&targetPct<100)h+='<div style="position:absolute;top:0;bottom:0;left:'+targetPct+'%;width:2px;background:#fff;opacity:0.4" title="Target: '+m.fmt(m.target)+'"></div>';
    h+='</div>';
    h+='<span style="font-family:var(--mono);font-size:10px;min-width:50px;text-align:right;font-weight:600;color:'+barColor+'">'+m.fmt(v)+'</span>';
    h+='</div>';
  });
  // Legend
  h+='<div style="display:flex;gap:12px;margin-top:8px;padding-top:6px;border-top:1px solid var(--brd)">';
  h+='<span style="font-size:9px;color:var(--tx3)"><span style="display:inline-block;width:8px;height:8px;background:'+m.color+';border-radius:2px;margin-right:3px"></span>'+(m.dir==="high"?"At/above":"At/below")+' target</span>';
  h+='<span style="font-size:9px;color:var(--tx3)"><span style="display:inline-block;width:8px;height:8px;background:#f59e0b;border-radius:2px;margin-right:3px"></span>Warning zone</span>';
  h+='<span style="font-size:9px;color:var(--tx3)"><span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:2px;margin-right:3px"></span>Below threshold</span>';
  h+='<span style="font-size:9px;color:var(--tx3)"><span style="display:inline-block;width:8px;height:2px;background:#fff;opacity:0.5;margin-right:3px;vertical-align:middle"></span>Target line</span>';
  h+='</div></div>';
  // Side stats panel
  h+='<div style="min-width:140px;background:var(--s2);border-radius:8px;padding:10px">';
  h+='<div style="font-size:10px;font-weight:700;color:var(--tx2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Stats</div>';
  h+='<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--tx3)">Best</div><div style="font-size:13px;font-weight:700;color:var(--grn)">'+m.fmt(m.dir==="low"?minVal:maxVal)+'</div><div style="font-size:9px;color:var(--tx3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+sorted[0].name+'">'+sorted[0].name.slice(0,18)+'</div></div>';
  h+='<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--tx3)">Worst</div><div style="font-size:13px;font-weight:700;color:var(--red)">'+m.fmt(m.dir==="low"?maxVal:minVal)+'</div><div style="font-size:9px;color:var(--tx3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+sorted[sorted.length-1].name+'">'+sorted[sorted.length-1].name.slice(0,18)+'</div></div>';
  h+='<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--tx3)">Average</div><div style="font-size:13px;font-weight:700;color:var(--cyn)">'+m.fmt(avgVal)+'</div></div>';
  h+='<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--tx3)">Target</div><div style="font-size:13px;font-weight:700;color:var(--tx2)">'+m.fmt(m.target)+'</div></div>';
  const onTarget=vals.filter(v=>m.dir==="high"?v>=m.target:v<=m.target).length;
  h+='<div><div style="font-size:9px;color:var(--tx3)">On Target</div><div style="font-size:13px;font-weight:700;color:'+(onTarget===vals.length?"var(--grn)":"var(--orn)")+'">'+onTarget+'/'+vals.length+'</div></div>';
  h+='</div></div>';
  el.innerHTML=h;
}
// â•â•â• KNOWLEDGE BASE â•â•â•
if(!D.kb)D.kb=[];
function addKBArticle(){const t=document.getElementById("kbTitle").value,c=document.getElementById("kbContent").value,cat=document.getElementById("kbNewCat").value;if(!t||!c)return toast("Fill title and content","err");D.kb.push({id:uid(),title:t,content:c,category:cat,createdAt:new Date().toISOString()});save();hideEl("kbAddForm");renderKB();toast("Article saved")}
function renderKB(){const el=document.getElementById("kbList");if(!el)return;const q=(document.getElementById("kbSearch")?.value||"").toLowerCase();const cat=document.getElementById("kbCat")?.value||"";let items=D.kb||[];if(q)items=items.filter(a=>a.title.toLowerCase().includes(q)||a.content.toLowerCase().includes(q));if(cat)items=items.filter(a=>a.category===cat);if(!items.length){el.innerHTML='<div class="emp" style="text-align:center"><span style="font-size:48px;opacity:.3">&#128214;</span><p style="margin-top:8px">No articles found.</p></div>';return}el.innerHTML=items.map(a=>'<div class="ar" style="border-left:3px solid var(--acc)"><div style="flex:1"><b style="font-size:13px">'+a.title+'</b><span class="tg" style="background:var(--s3);color:var(--tx2);margin-left:8px;font-size:9px">'+a.category+'</span><p style="font-size:11px;color:var(--tx2);margin-top:2px">'+a.content.slice(0,120)+(a.content.length>120?"...":"")+'</p></div><button class="btn bd bsm bic" onclick="delKB(\''+a.id+'\')">âœ•</button></div>').join("")}
function delKB(id){D.kb=D.kb.filter(x=>x.id!==id);save();renderKB()}
function kbAsk(){const inp=document.getElementById("kbChatIn");const q=inp.value.trim();if(!q)return;inp.value="";const log=document.getElementById("kbChatLog");log.innerHTML+='<div style="margin-bottom:6px"><b style="color:var(--acc)">You:</b> '+q+'</div>';
  const apiKey=document.getElementById("kbApiKey")?.value||localStorage.getItem("gpt_key")||"";
  const articles=(D.kb||[]).map(a=>a.title+": "+a.content).join("\n\n");
  if(apiKey&&apiKey.startsWith("sk-")){
    log.innerHTML+='<div style="margin-bottom:6px;color:var(--tx3)"><i>Thinking...</i></div>';log.scrollTop=log.scrollHeight;
    fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},body:JSON.stringify({model:"gpt-4o-mini",max_tokens:500,messages:[{role:"system",content:"You are a call center knowledge base assistant. Answer ONLY based on the following KB articles. If the answer is not in the articles, say so. Be concise and helpful.\n\nKB ARTICLES:\n"+articles},{role:"user",content:q}]})}).then(r=>r.json()).then(data=>{log.lastElementChild.remove();const ans=data.choices?.[0]?.message?.content||data.error?.message||"Error getting response";log.innerHTML+='<div style="margin-bottom:8px;padding:8px;background:var(--s2);border-radius:4px;border-left:3px solid var(--grn)"><b style="color:var(--grn)">AI:</b> '+ans.replace(/\n/g,"<br>")+'</div>';log.scrollTop=log.scrollHeight}).catch(e=>{log.lastElementChild.remove();log.innerHTML+='<div style="color:var(--red)">Error: '+e.message+'</div>';log.scrollTop=log.scrollHeight})
  }else{const results=(D.kb||[]).filter(a=>a.title.toLowerCase().includes(q.toLowerCase())||a.content.toLowerCase().includes(q.toLowerCase()));if(results.length){log.innerHTML+='<div style="margin-bottom:8px;padding:6px;background:var(--s2);border-radius:4px"><b style="color:var(--grn)">KB:</b> Found '+results.length+' article(s):<br>'+results.map(a=>'â€¢ <b>'+a.title+'</b>: '+a.content.slice(0,120)+'...').join("<br>")+'</div>'}else{log.innerHTML+='<div style="margin-bottom:8px;padding:6px;background:var(--s2);border-radius:4px"><b style="color:var(--orn)">KB:</b> No matching articles. Add a ChatGPT API key for AI-powered answers, or create more articles.</div>'}log.scrollTop=log.scrollHeight}}
function kbProcessFile(e){const file=e.target.files[0];if(!file)return;const ext=file.name.split(".").pop().toLowerCase();
  if(ext==="txt"||ext==="csv"){const reader=new FileReader();reader.onload=ev=>{const text=ev.target.result;if(ext==="csv"){const lines=text.split("\n").filter(l=>l.trim());const headers=lines[0];lines.slice(1).forEach((line,i)=>{if(line.trim())D.kb.push({id:uid(),title:file.name+" - Row "+(i+1),content:line.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(lines.length-1+" rows imported as KB articles")}else{const chunks=text.split(/\n\n+/).filter(c=>c.trim().length>20);if(chunks.length>1){chunks.forEach((chunk,i)=>{D.kb.push({id:uid(),title:file.name+" - Section "+(i+1),content:chunk.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(chunks.length+" sections imported")}else{document.getElementById("kbTitle").value=file.name.replace(/\.[^.]+$/,"");document.getElementById("kbContent").value=text;toast("File loaded â€” click Save Article")}}};reader.readAsText(file)}
  else if(ext==="xlsx"){const reader=new FileReader();reader.onload=ev=>{if(typeof XLSX==="undefined"){toast("XLSX library not loaded","err");return}const wb=XLSX.read(ev.target.result,{type:"array"});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{header:1});rows.forEach((row,i)=>{if(i===0||!row[0])return;D.kb.push({id:uid(),title:String(row[0]),content:row.slice(1).join(" | "),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast((rows.length-1)+" rows imported from Excel")};reader.readAsArrayBuffer(file)}
  else if(ext==="json"){const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(Array.isArray(data)){data.forEach(item=>{D.kb.push({id:uid(),title:item.title||item.name||"Imported",content:JSON.stringify(item),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(data.length+" items imported")}else{document.getElementById("kbContent").value=JSON.stringify(data,null,2);toast("JSON loaded")}}catch(err){toast("Invalid JSON","err")}};reader.readAsText(file)}
  else if(ext==="docx"||ext==="doc"){const reader=new FileReader();reader.onload=ev=>{if(typeof mammoth==="undefined"){toast("Mammoth.js not loaded","err");return}mammoth.extractRawText({arrayBuffer:ev.target.result}).then(result=>{const text=result.value;const sections=text.split(/\n\n+/).filter(s=>s.trim().length>15);if(sections.length>1){sections.forEach((sec,i)=>{const title=sec.split("\n")[0].slice(0,80)||file.name+" - Section "+(i+1);D.kb.push({id:uid(),title:title,content:sec.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(sections.length+" sections imported from "+file.name)}else{document.getElementById("kbTitle").value=file.name.replace(/\.[^.]+$/,"");document.getElementById("kbContent").value=text;toast("Word doc loaded â€” click Save Article")}}).catch(err=>toast("Error reading docx: "+err.message,"err"))};reader.readAsArrayBuffer(file)}
  else{toast("Unsupported file type. Use .docx, .txt, .csv, .xlsx, or .json","err")}}
// â•â•â• COACHING â•â•â•
if(!D.coaching)D.coaching=[];
function addCoaching(){const aid=document.getElementById("coachAgent").value,type=document.getElementById("coachType").value,date=document.getElementById("coachDate").value,notes=document.getElementById("coachNotes").value,fup=document.getElementById("coachFup").checked;if(!aid)return toast("Select agent","err");const ag=D.agents.find(a=>a.id===aid);D.coaching.push({id:uid(),aid,name:ag?.name||"",type,date:date||new Date().toISOString().split("T")[0],notes,followUp:fup,status:fup?"Pending":"Done",createdAt:new Date().toISOString()});save();hideEl("coachForm");renderCoaching();toast("Session saved")}
function renderCoaching(){const el=document.getElementById("coachList");if(!el)return;const now=new Date();const month=now.getMonth();const yr=now.getFullYear();const total=D.coaching.length;const thisMonth=D.coaching.filter(c=>{const d=new Date(c.date);return d.getMonth()===month&&d.getFullYear()===yr}).length;const fups=D.coaching.filter(c=>c.followUp&&c.status==="Pending").length;document.getElementById("coachTotal").textContent=total;document.getElementById("coachMonth").textContent=thisMonth;document.getElementById("coachFollow").textContent=fups;if(!D.coaching.length){el.innerHTML='<p style="color:var(--tx3)">No coaching sessions yet.</p>';return}el.innerHTML=[...D.coaching].reverse().slice(0,20).map(c=>'<div class="ar" style="border-left:3px solid '+(c.followUp&&c.status==="Pending"?"var(--red)":"var(--grn)")+'"><b>'+c.name+'</b><span class="tg" style="background:var(--s3);color:var(--tx2);font-size:9px">'+c.type+'</span><span style="font-family:var(--mono);font-size:10px;color:var(--tx3)">'+c.date+'</span>'+(c.notes?'<span style="font-size:10px;color:var(--tx2)">'+c.notes.slice(0,60)+'</span>':'')+(c.followUp?'<span class="tg" style="background:#7f1d1d;color:#fca5a5;font-size:9px">Follow-up</span>':'')+'</div>').join("")}
// â•â•â• CONDUCT â•â•â•
if(!D.incidents)D.incidents=[];
function addIncident(){const aid=document.getElementById("incAgent").value,sev=document.getElementById("incSev").value,type=document.getElementById("incType").value,desc=document.getElementById("incDesc").value;if(!aid||!desc)return toast("Fill agent and description","err");const ag=D.agents.find(a=>a.id===aid);D.incidents.push({id:uid(),aid,name:ag?.name||"",severity:sev,type,description:desc,status:"Open",createdAt:new Date().toISOString()});save();hideEl("incidentForm");renderIncidents();toast("Incident logged")}
function renderIncidents(){const el=document.getElementById("incList");if(!el)return;const open=D.incidents.filter(i=>i.status==="Open").length;const crit=D.incidents.filter(i=>i.severity==="Critical"&&i.status==="Open").length;const impr=D.incidents.filter(i=>i.status==="Improved").length;const rep=D.incidents.filter(i=>{const same=D.incidents.filter(j=>j.aid===i.aid);return same.length>1}).length;document.getElementById("condOpen").textContent=open;document.getElementById("condCrit").textContent=crit;document.getElementById("condImpr").textContent=impr;document.getElementById("condRep").textContent=rep;if(!D.incidents.length){el.innerHTML='<p style="color:var(--tx3)">No incidents recorded.</p>';return}el.innerHTML=[...D.incidents].reverse().map(i=>{const sevC={Low:"var(--grn)",Medium:"var(--orn)",High:"var(--red)",Critical:"#dc2626"}[i.severity]||"var(--tx3)";return'<div class="ar" style="border-left:3px solid '+sevC+'"><b>'+i.name+'</b><span class="tg" style="background:'+sevC+'20;color:'+sevC+';font-size:9px">'+i.severity+'</span><span class="tg" style="background:var(--s3);color:var(--tx2);font-size:9px">'+i.type+'</span><span style="font-size:10px;color:var(--tx2)">'+i.description.slice(0,60)+'</span><span style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+i.createdAt.split("T")[0]+'</span><select onchange="chIncStatus(\''+i.id+'\',this.value)" style="width:80px;font-size:9px;padding:2px"><option '+(i.status==="Open"?"selected":"")+'>Open</option><option '+(i.status==="In Progress"?"selected":"")+'>In Progress</option><option '+(i.status==="Improved"?"selected":"")+'>Improved</option><option '+(i.status==="Closed"?"selected":"")+'>Closed</option></select></div>'}).join("")}
function chIncStatus(id,st){const i=D.incidents.find(x=>x.id===id);if(i){i.status=st;save();renderIncidents()}}

// â•â•â• AI AGENT CHAT + KB â•â•â•
const ELEVEN_AGENT_ID = "agent_1301kepw78ysfjm9d30gssmm6dja";
let agentChatHistory = [];
let AI_KB_ARTICLES = [{"title": "DARB: What are the requirements to register an account in the tolling system Darb", "category": "DARB FAQ", "content": "Q: What are the requirements to register an account in the tolling system Darb?\n\nA: The registration requirements are as following: The traffic file number code of the person or company. The Emirates ID of the account holder. An active personal email if you are registering a personal account, preferably to use the establishment mail when registering an establishment account. Mobile number registered with the traffic file number. Note: the traffic file number can be found on the vehicle\u2019s registration it contains 10 numbers. For Dubai drivers its 8 numbers.", "source": "DARB_FAQs"}, {"title": "DARB: What should I do if my phone number is not displayed in the contact numbers", "category": "DARB FAQ", "content": "Q: What should I do if my phone number is not displayed in the contact numbers list when I am trying to register?\n\nA: You should contact the customer service center (8003009) and talk to the system admin to register your contact details.", "source": "DARB_FAQs"}, {"title": "DARB: Do Abu Dhabi vehicles must register in the toll gate system?", "category": "DARB FAQ", "content": "Q: Do Abu Dhabi vehicles must register in the toll gate system?\n\nA: Yes, the owners of the vehicles registered in Abu Dhabi Emirate and in other Emirates must register in the toll gate system and register their vehicles as well.", "source": "DARB_FAQs"}, {"title": "DARB: How can I register my new vehicle in the system if I have a previous accoun", "category": "DARB FAQ", "content": "Q: How can I register my new vehicle in the system if I have a previous account?\n\nA: The system has been fully connected with the Federal Traffic System (Vehicle Licensing System), and accordingly, in the event that any new vehicle is owned, it will be automatically added to Darb system and you can register the vehicle directly by clicking on \"Register Vehicle\" icon shown on the dashboard of the new vehicle. Note: the traffic file number can be found on the vehicle\u2019s registration it contains 10 numbers. For Dubai drivers its 8 numbers.", "source": "DARB_FAQs"}, {"title": "DARB: Should I register more than an account if I have more than one traffic numb", "category": "DARB FAQ", "content": "Q: Should I register more than an account if I have more than one traffic number in different emirates?\n\nA: No, once you register using one of your traffic codes, all vehicles related to you will be retrieved automatically using the integration with the Unified Traffic System. You also have the option to add another traffic code manually from the profile page using the \u201cAdd Traffic Code\u201d feature, provided you own the other traffic code. The logged in user can add the traffic code from the dashboard screen of Darb portal or from the profile screen of Darb Mobile Application.", "source": "DARB_FAQs"}, {"title": "DARB: Can I register a vehicle that I do not own using my individual account or m", "category": "DARB FAQ", "content": "Q: Can I register a vehicle that I do not own using my individual account or my establishment account in the system?\n\nA: No, the user cannot register a vehicle that he/she does not own using his/her individual account or establishment account since these accounts linked with the traffic codes defined in the account profiles.", "source": "DARB_FAQs"}, {"title": "DARB: Can I register more than one vehicle that I own at the same time as an indi", "category": "DARB FAQ", "content": "Q: Can I register more than one vehicle that I own at the same time as an individual account?\n\nA: Yes, the system provides the ability of registering a group of vehicles by selecting the vehicles to be registered from the Vehicles page and pressing the \"Register Vehicles\" button.", "source": "DARB_FAQs"}, {"title": "DARB: Can I register more than one vehicle that I own at the same time as an esta", "category": "DARB FAQ", "content": "Q: Can I register more than one vehicle that I own at the same time as an establishment account?\n\nA: Yes, the system provides the ability of registering a group of vehicles, which the establishment user can click on \"Register All Vehicles\" button in vehicles page if the available balance is enough to register all vehicles. Note that it is required to create a separate account for each branch.", "source": "DARB_FAQs"}, {"title": "DARB: What is the procedure when changing the vehicle's license plate number?", "category": "DARB FAQ", "content": "Q: What is the procedure when changing the vehicle's license plate number?\n\nA: If the vehicle is already registered in the DARB system and the license plate number is changed for the same owner, the registration remains valid. The customer must submit a request to re-register. However, if the vehicle is sold or ownership is transferred, the new owner must re-register the vehicle. Account", "source": "DARB_FAQs"}, {"title": "DARB: How can I reset my password?", "category": "DARB FAQ", "content": "Q: How can I reset my password?\n\nA: From the login page, you have to press on \"forgot password \"option and fill your registered email, emirates ID or traffic file number, then the system will send you a link by email and by SMS to the registered mobile number in the account to reset your password.", "source": "DARB_FAQs"}, {"title": "DARB: Can I check that my personal information is updated in the system?", "category": "DARB FAQ", "content": "Q: Can I check that my personal information is updated in the system?\n\nA: Yes, you have to login by your registered account, then click on your name on the top right of the page to navigate to the personal profile page and press \"sync profile information\" to get the updated profile details using the integration with the Federal Authority for Identity and Citizenship.", "source": "DARB_FAQs"}, {"title": "DARB: How can I add my new phone number to the system?", "category": "DARB FAQ", "content": "Q: How can I add my new phone number to the system?\n\nA: You have to login by your registered account, then click on your name on the top right of the page which you will be navigated to profile page, then click on add new number.", "source": "DARB_FAQs"}, {"title": "DARB: What do I need to do when I sell my vehicle?", "category": "DARB FAQ", "content": "Q: What do I need to do when I sell my vehicle?\n\nA: Nothing is needed from your side; the system within few hours will automatically remove the vehicle information from your account and link it with the new owner\u2019s account after vehicle ownership is transferred to the new owner through the integration with the Unified Traffic system.", "source": "DARB_FAQs"}, {"title": "DARB: How can I close my account?", "category": "DARB FAQ", "content": "Q: How can I close my account?\n\nA: Login to your DARB Account. Go to My Profile Screen. Press Settings. Select Close Account. Type your Bank Account details (IBAN), if there is a balance in the Wallet. Type the Reason for Closure. Submit Please note that when requesting the closure of an account, please note that\u00a0all registered vehicles\u00a0will be changed to\u00a0unregistered status. Additionally, you will\u00a0not be able to create a new account\u00a0until the outstanding amount is refunded to their bank account. The refund process will take up to\u00a045 working days\u00a0to be completed. General", "source": "DARB_FAQs"}, {"title": "DARB: What is Darb toll gate?", "category": "DARB FAQ", "content": "Q: What is Darb toll gate?\n\nA: Darb is the road toll system of Abu Dhabi, and it works without kiosks or barriers.", "source": "DARB_FAQs"}, {"title": "DARB: How does the toll gate system work?", "category": "DARB FAQ", "content": "Q: How does the toll gate system work?\n\nA: When passing through the Darb toll gates during the Peak Hours, all vehicles are identified through the plate number and the data is sent to the Darb system and processed. The approved policies and regulations for the Toll Gates are applied. There is no need to purchase an external tag and apply it to the vehicle windshield.", "source": "DARB_FAQs"}, {"title": "DARB: Where are the toll gates located?", "category": "DARB FAQ", "content": "Q: Where are the toll gates located?\n\nA: Toll gates are located on main bridges leading to Abu Dhabi City which are: Sheikh Zayed Bridge, Sheikh Khalifa bin Zayed Bridge, Al Maqtaa Bridge, and Mussafah Bridge. Click\u00a0here\u00a0for more info.", "source": "DARB_FAQs"}, {"title": "DARB: How is the toll fee collected?", "category": "DARB FAQ", "content": "Q: How is the toll fee collected?\n\nA: The toll fees will be collected from the users according to the rules and regulations*. For vehicles registered out of Abu Dhabi Emirate, the toll fees will be collected automatically from the financial wallet of the vehicle for every pass under the gates (if the vehicle is registered in DARB system), while for Abu Dhabi vehicles, the user has the option to enable/disable the Auto-Payment feature for his vehicle' transactions. Provided that all toll fees for his vehicle are paid before any renewal / waiver / amendment / cancel / export for the vehicle in the Vehicles and Drivers Licensing Department.", "source": "DARB_FAQs"}, {"title": "DARB: Who is responsible for managing the toll gates?", "category": "DARB FAQ", "content": "Q: Who is responsible for managing the toll gates?\n\nA: The Q Mobility manages the toll gate system in Abu Dhabi.", "source": "DARB_FAQs"}, {"title": "DARB: Is there a speed limit on the toll gates?", "category": "DARB FAQ", "content": "Q: Is there a speed limit on the toll gates?\n\nA: Legislation and regulations of the competent authority shall apply regarding speed limits on roads (Abu Dhabi Police General Command).", "source": "DARB_FAQs"}, {"title": "DARB: What identifiers can I use to login into the system?", "category": "DARB FAQ", "content": "Q: What identifiers can I use to login into the system?\n\nA: Emirates ID number. The email address registered on the account. The traffic code registered on the account.", "source": "DARB_FAQs"}, {"title": "DARB: Does the system provide a secondary Authentication mechanism when the user ", "category": "DARB FAQ", "content": "Q: Does the system provide a secondary Authentication mechanism when the user login into an active account?\n\nA: Send a text message Send an email Send a text message and an email. The logged in user will be able to activate the secondary authentication feature from profile page by clicking on the username on the top left of the page and activate the feature by selecting one of the authentication options and press the save button.", "source": "DARB_FAQs"}, {"title": "DARB: Is registration compulsory even if I do not cross the toll gates during pea", "category": "DARB FAQ", "content": "Q: Is registration compulsory even if I do not cross the toll gates during peak times?\n\nA: Registration in the Darb toll road system is not compulsory and the user has the freedom to choose if he does not want to register as he will not pass through the toll gates during peak hours. Emphasizing that if the user crosses the Darb toll gates during the specified peak times, the user will be given a period of 10 working days to register in the system, otherwise he will be subject to a violation according to the executive regulations for toll system in the Emirate of Abu Dhabi.", "source": "DARB_FAQs"}, {"title": "DARB: What are the available channels for creating an account or logging into the", "category": "DARB FAQ", "content": "Q: What are the available channels for creating an account or logging into the Darb toll system?\n\nA: The website for the Darb toll system:\u00a0https://darb.qmobility.ae Darb application for smart phones on all stores (App Store | Google Play | AppGallery) Tolls and Charges", "source": "DARB_FAQs"}, {"title": "DARB: What are the daily toll fees?", "category": "DARB FAQ", "content": "Q: What are the daily toll fees?\n\nA: Morning peak period (07:00 AM - 09:00 AM) The morning rush hour begins at seven in the morning and ends at nine in the morning. All vehicles passing through the toll gates will be charged a fee of AED 4\u202f for each pass. Evening peak period (03:00 PM to 07:00 PM). Evening peak hours start at three in the evening and end at seven in the evening. All vehicles passing through the toll gates will be charged a fee of AED 4 for each pass. Please note that toll deductions will not be applied on\u00a0Sundays\u00a0or\u00a0official holidays\u2014these days will be\u00a0free\u00a0of charge.", "source": "DARB_FAQs"}, {"title": "DARB: How much will it cost me to register my vehicles?", "category": "DARB FAQ", "content": "Q: How much will it cost me to register my vehicles?\n\nA: The registration fee per vehicle is 100 dirhams, as follows: 50 AED is a registration fees and 50 AED is a balance for passing toll gates will be deposited in the financial wallet of user account", "source": "DARB_FAQs"}, {"title": "DARB: Why are my transactions not paid while I have topped up my wallet?", "category": "DARB FAQ", "content": "Q: Why are my transactions not paid while I have topped up my wallet?\n\nA: For Abu Dhabi vehicles only, you can activate/Pause the \"Auto-Payment\" feature from the vehicle page, therefore, the toll transactions fees will be paid automatically from the available balance of the linked wallet\u202fafter activating the Auto-payment\u202ffeature. For vehicles registered out of Abu Dhabi Emirate, the transaction fees will be paid automatically from the wallet as the Auto-payment feature is not available for them (The availability of the balance is mandatory for the payment of Toll fees for vehicles outside the Emirate of Abu Dhabi).", "source": "DARB_FAQs"}, {"title": "DARB: Can I enable or pause the auto payment for group of vehicles in a single st", "category": "DARB FAQ", "content": "Q: Can I enable or pause the auto payment for group of vehicles in a single step?\n\nA: Yes, the system provides the feature to activate or pause automatic payment of toll fees for a bulk of registered vehicles in the individual or establishment account in one step by specifying the required vehicles from the vehicles screen and pressing the button \"Activate Auto payment for vehicles \"or \"Pause Auto Payment for vehicles page\".\u202fThis feature available for Abu Dhabi vehicles only.", "source": "DARB_FAQs"}, {"title": "DARB: What are the peak times during the holy month of Ramadan that are applied t", "category": "DARB FAQ", "content": "Q: What are the peak times during the holy month of Ramadan that are applied to the toll fees?\n\nA: The peak times in the holy month of Ramadan, during which the toll fees apply, are from 8:00 to 10:00 in the morning time, and from 2:00 to 4:00 in the evening from Monday to Saturday. Where the toll fee is calculated on vehicles at 4 AED for each pass under the gates. Wallets", "source": "DARB_FAQs"}, {"title": "DARB: How can I top up my wallet?", "category": "DARB FAQ", "content": "Q: How can I top up my wallet?\n\nA: You can top up your wallet by logging in to your account, and pressing the Top-up button beside the wallet name from the dashboard - top left corner. Also you can top up your wallets from vehicles page by pressing on top up button for any vehicles which the system will allow you to top up the assigned wallet for the chosen wallet. You have also the option to charge your wallet from profile page by clicking on your name on the top right of the page after logging in to your account.", "source": "DARB_FAQs"}, {"title": "DARB: What should I do when I pass through a toll gate without having sufficient ", "category": "DARB FAQ", "content": "Q: What should I do when I pass through a toll gate without having sufficient balance in my wallet?\n\nA: You must recharge your wallet within five working days, otherwise, you will receive a notice of a fine. Vehicles registered within the Emirate of Abu Dhabi do not have to have credit in their accounts and can pay their transactions fees at time of renewal of the vehicle. Vehicles from other emirates must be registered and have sufficient balance in the wallet in order to avoid violations.", "source": "DARB_FAQs"}, {"title": "DARB: How can I add a new wallet?", "category": "DARB FAQ", "content": "Q: How can I add a new wallet?\n\nA: You have to login by your registered account, then press on Manage Wallets\u202ffrom the dashboard\u202fthen press on Add New Wallet Icon on condition the number of wallets should not exceed the number of vehicles in the account.", "source": "DARB_FAQs"}, {"title": "DARB: Does the system require prepaid cards?", "category": "DARB FAQ", "content": "Q: Does the system require prepaid cards?\n\nA: No toll cards are required. Users can simply recharge their wallets using their credit cards.", "source": "DARB_FAQs"}, {"title": "DARB: How can I refund the failed payment that might occur during the top up proc", "category": "DARB FAQ", "content": "Q: How can I refund the failed payment that might occur during the top up process?\n\nA: The System will refund the failed payments automatically once daily to the related accounts. In case there are any problems with payment, you can submit a complaint / grievance request via the website Note that the amount will be refunded within\u00a07 working days", "source": "DARB_FAQs"}, {"title": "DARB: I want to withdraw the available balance in my account, what should I do?", "category": "DARB FAQ", "content": "Q: I want to withdraw the available balance in my account, what should I do?\n\nA: According to the approved regulations, you can only retrieve the available balance in your account in the event that you completely closed the account. Please note that if the account is closed, you must re-create an account and register your vehicles by paying the registration fees again when you use the toll gates during the Peak Hours.", "source": "DARB_FAQs"}, {"title": "DARB: Can I charge the balance of a financial wallet to another customer?", "category": "DARB FAQ", "content": "Q: Can I charge the balance of a financial wallet to another customer?\n\nA: Click on the Start Service button of the Wallet Top up service from the list of Public Services Select the account whose balance is to be charged by entering the account\u2019s Traffic File Code, e-mail or Emirates ID number if it is an individual account Select the vehicle required to charge the balance of the financial wallet associated with it. You can skip this step if you know the name of the required financial wallet Select the desired financial Wallet and press Next Select the desired balance from the list of options, then click \"Recharge using a credit card\" Enter your card details and click \"Pay\" The payment will be confirmed successfully and you can print a financial receipt for the paid amount.", "source": "DARB_FAQs"}, {"title": "DARB: Can I change the wallet assigned for vehicle to another wallet?", "category": "DARB FAQ", "content": "Q: Can I change the wallet assigned for vehicle to another wallet?\n\nA: Yes, you can by login with your registered account, you have two options to change the assigned wallet for a specific vehicle : 1. you can change the wallet by press (\u25cf\u25cf\u25cf) action list from the dashboard on the registered vehicle options, 2. you can navigate to vehicles page where you can select one or more vehicles then click on change wallet. Exemption and Grievance Requests", "source": "DARB_FAQs"}, {"title": "DARB: What are the exempted/excluded vehicles from Toll fees?", "category": "DARB FAQ", "content": "Q: What are the exempted/excluded vehicles from Toll fees?\n\nA: These are vehicles that are not subject to toll charges when crossing toll gates Based on the approved regulations, vehicles that pass through the toll gates are exempted from the toll fee in the following cases: Vehicles excluded from the application of the toll fees automatically (without requesting an exemption): Ambulances, Armed Forces, and Civil Defence vehicles which are holding their numbers and logo. Public transport buses licensed in the Emirate of Abu Dhabi Motorcycles. Authorized public Taxi vehicles in Abu Dhabi. Authorized school buses. All passenger buses (capacity has been specified by the licensing authority for 26 passengers and above). Vehicles holding the numbers and logo of Abu Dhabi Police, Ministry of Interior, and other Local Emirates Police. Trailer vehicles. Categories that are excluded from the application of toll fees and require an exemption request: People of Determination category The vehicle owner of people of determination has the right to apply for exemption, provided that proof of belonging to this category is mandatory. It is not required that the vehicle is registered in the name of the person of People of Determination directly, provided that the vehicle is owned by one of the first and second degree relatives only. The necessary supporting documents are as follows: -\u202fThe People of Determination Card issued by the Ministry of Community Development or the Zayed Higher Organization for People of Determination (mandatory document). -\u202fProof of kindship in case the vehicle owned by one of the first and second degree relatives only (in case the vehicle is not owned by the same person). Category of vehicles for families with limited income from Emirati citizens One vehicle for each low-income citizens' family is exempted. Proof of belonging to this category to be provided from the competent authority (Ministry of Community Development or Abu Dhabi Social Support Authority.) (Optional) Senior citizens category The law defines senior citizens as every UAE citizen aged 60 years or over. It is required that the vehicle must be registered in the name of the concerned person. No documents are required when submitting the application. The retired citizen category Proof of belonging to this category must be provided from the competent authority as follows: A letter from the Pension and Retirement Fund. The exemption for the four categories is limited to one vehicle only, ", "source": "DARB_FAQs"}, {"title": "DARB: Am I entitled to receive more than one exemption?", "category": "DARB FAQ", "content": "Q: Am I entitled to receive more than one exemption?\n\nA: Account holders who are classified as People of Determination are entitled to receive an additional exemption if they meet any of the criteria of other categories (such as senior citizens, retirees, low income, or People of Determination).", "source": "DARB_FAQs"}, {"title": "DARB: How can I apply for exemption or grievance request?", "category": "DARB FAQ", "content": "Q: How can I apply for exemption or grievance request?\n\nA: You have to login by your registered account, then navigate to Requests page to apply for an exemption or complaint (complaint on fine or transaction or technical issue). The exempted categories are as the following: Senior Citizens. People of Determination. Pensioner Citizens. Low Income Citizens. Then the user must upload the required documents depending on the chosen exemption/request reason.", "source": "DARB_FAQs"}, {"title": "DARB: When should I apply for grievance request?", "category": "DARB FAQ", "content": "Q: When should I apply for grievance request?\n\nA: If you are facing one of the following: Incorrect Fine. Incorrect Toll transaction.", "source": "DARB_FAQs"}, {"title": "DARB: If I have an exempted vehicle and I sell it or change its plate number, do ", "category": "DARB FAQ", "content": "Q: If I have an exempted vehicle and I sell it or change its plate number, do I need to submit a new exemption request for the new vehicle?\n\nA: Yes, the customer must submit a new exemption request through the available channels. Note that Exemptions can be transferred from one vehicle to another, provided that the exemption has been\u00a0approved for a minimum of 3 months\u00a0on the first vehicle, if your vehicle still under your ownership.", "source": "DARB_FAQs"}, {"title": "DARB: How will I be informed that my exemption or grievance request has been appr", "category": "DARB FAQ", "content": "Q: How will I be informed that my exemption or grievance request has been approved or rejected?\n\nA: A notification email or SMS will be sent to you once the exemption or grievance request has been approved or rejected.", "source": "DARB_FAQs"}, {"title": "DARB: Can I request an exemption for a relative to benefit from the exemption?", "category": "DARB FAQ", "content": "Q: Can I request an exemption for a relative to benefit from the exemption?\n\nA: The account holder can apply for an exemption under the People of Determination category only for first and second-degree relatives, provided that proof of kinship is required. First degree (father, mother, spouse, spouse's father, spouse's mother, children of the spouse) Second degree (grandfather, grandmother, brother, sister, grandchild) Fines", "source": "DARB_FAQs"}, {"title": "DARB: What are the types of toll gate system violations?", "category": "DARB FAQ", "content": "Q: What are the types of toll gate system violations?\n\nA: Violation of non-registration:\u202fWhen passing through the toll gates during the peak hours without registering the vehicle in the \u201cDarb\u201d toll system as follows: If a vehicle is not registered in the system crosses toll gates, the user is given a period of 10 working days from the time of its crossing to register it in the system, otherwise it is considered violating as the following: AED 100 for the first day regardless of the number of crossings on the same day. In the event the person crosses on another day without registering (for the second time), a fine of AED 200\u202f per day will be applied regardless of the number of crossings on that day. If a person crosses another day without registering (for the third time), a fine of AED 400\u202f for the day will be applied regardless of the number of crossings on that day. Violation of insufficient balance:\u00a0when passing through the toll gates without having sufficient balance in the \u201cDarb\u201d toll gates system in the vehicle\u2019s financial wallet as follows:\u202fA fine of AED 50 is charged in the event that the balance is insufficient for vehicles bearing plates other than Abu Dhabi, after the end of the grace period (5 working days) without having sufficient balance in the wallet allocated to the vehicle. Violation of tampering with the vehicle's license plate\u00a0A fine of AED 10,000 will be charged in the event of tampering with the vehicle's license plate for the purpose of evading the payment of traffic tariff fees. Violation for causing damage:\u00a0A fine of AED 10,000 will be charged in the event of damage to any of the electronic payment machines or toll gates.", "source": "DARB_FAQs"}, {"title": "DARB: How will I be informed that I have been issued a violation?", "category": "DARB FAQ", "content": "Q: How will I be informed that I have been issued a violation?\n\nA: This responsibility rests with the vehicle owner, and the Darb system will send an SMS to the vehicle owner's phone number to inform him with the violation issued against him of the toll gate law and the approved regulations according to the type of violation.", "source": "DARB_FAQs"}, {"title": "DARB: Where can I pay my toll gates fines fees?", "category": "DARB FAQ", "content": "Q: Where can I pay my toll gates fines fees?\n\nA: You can pay your toll gates fines using the available balance in your financial wallet or using your credit card after login to the system using Darb website or using Darb mobile application.", "source": "DARB_FAQs"}, {"title": "DARB Wallet: Will any services be temporarily unavailable?", "category": "DARB Wallet", "content": "Q: Will any services be temporarily unavailable?\n\nA: As per the scheduled maintenance window notification.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: What is Wallet Migration?", "category": "DARB Wallet", "content": "Q: What is Wallet Migration?\n\nA: Wallet Migration is the transfer of customer wallet accounts and balances from the current DARB wallet system to a new and enhanced platform. This will enable DARB users to benefit from enhanced performance, security, and service reliability. This information is for internal use only. Please do not share it with customers, as no customer-visible changes have been applied.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: Why is DARB implementing this change?", "category": "DARB Wallet", "content": "Q: Why is DARB implementing this change?\n\nA: This upgrade is part of DARB\u2019s ongoing system improvements to enhance performance, security, and service reliability. This information is for internal use only. Please do not share it with customers, as no customer-visible changes have been applied.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: Will Customer wallet balance be affected?", "category": "DARB Wallet", "content": "Q: Will Customer wallet balance be affected?\n\nA: All available wallet balances will be migrated as-is with no impact for DARB users. This information is for internal use only. Please do not share it with customers, as no customer-visible changes have been applied.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: Will I lose any money during the migration?", "category": "DARB Wallet", "content": "Q: Will I lose any money during the migration?\n\nA: All necessary controls and validations are in place to ensure balance accuracy and safety. We thank you for your patience and your cooperation. This information is for internal use only. Please do not share it with customers, as no customer-visible changes have been applied.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: What happens if I top up my wallet and the balance is not reflected?", "category": "DARB Wallet", "content": "Q: What happens if I top up my wallet and the balance is not reflected?\n\nA: Any deducted amount will be refunded within 1-3 working days, if applicable.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: What happens if my payment was deducted but the service was not provided (P", "category": "DARB Wallet", "content": "Q: What happens if my payment was deducted but the service was not provided (Permits, Fines )?\n\nA: For any deducted amount will be refunded within 1-3 working days, if applicable.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: What happens if my payment was deducted but the service was not provided ( ", "category": "DARB Wallet", "content": "Q: What happens if my payment was deducted but the service was not provided ( Toll Vehicle Registration) and I found my balance on DARB Wallet?\n\nA: Please proceed with toll vehicle registration using your Wallet balance.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: I topped up my wallet through TAMM, but the amount is not reflected in my w", "category": "DARB Wallet", "content": "Q: I topped up my wallet through TAMM, but the amount is not reflected in my wallet balance. What should I do?\n\nA: Please raise a refund request through DARB Web/App. If you face any challenge, please contact our call centre by dialling 8003009 or by email: customers@qmobility.ae.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: I used the Pay for Parking service through DARB, the amount was deducted bu", "category": "DARB Wallet", "content": "Q: I used the Pay for Parking service through DARB, the amount was deducted but the parking ticket was not issued. What should I do?\n\nA: The deducted amount will be automatically refunded to your wallet as part of the reconciliation process within 1 to 3 working days.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: I used Pay for Parking through TAMM; the amount was deducted but the parkin", "category": "DARB Wallet", "content": "Q: I used Pay for Parking through TAMM; the amount was deducted but the parking ticket was not issued. What should I do?\n\nA: We thank you for your patience and your cooperation. Please raise a refund request through TAMM platform. Toll fees are not being deducted even though I have sufficient wallet balance. Please ensure that Auto Payment is enabled in the DARB Web or Mobile App. If the issue persists, please raise a case through the DARB Web/App or contact our call centre by dialling 8003009 or by Email : customers@qmobility.ae.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: Why am I unable to renew my vehicle license due to toll fee restrictions?", "category": "DARB Wallet", "content": "Q: Why am I unable to renew my vehicle license due to toll fee restrictions?\n\nA: Vehicle license renewal shall be restricted due to outstanding toll fees. Please top-up your DARB Wallet to clear the outstanding amount, Minimum Top-up will be AED 50.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: I requested to close my DARB account, but the refund has not been credited ", "category": "DARB Wallet", "content": "Q: I requested to close my DARB account, but the refund has not been credited to my bank account. What should I do?\n\nA: We thank you for your patience and your cooperation. Please raise a complaint through DARB platform.. If you face any challenge, please contact our call centre by dialling 8003009 or by email : customers@qmobility.ae.", "source": "DARB_Wallet"}, {"title": "DARB Wallet: Who can I contact if I face an issue?", "category": "DARB Wallet", "content": "Q: Who can I contact if I face an issue?\n\nA: Please contact Q Mobility Contact Centre at 800-3009 or by Email : customers@qmobility.ae. 1. \u0647\u0644 \u0633\u062a\u0643\u0648\u0646 \u0623\u064a \u0645\u0646 \u0627\u0644\u062e\u062f\u0645\u0627\u062a \u063a\u064a\u0631 \u0645\u062a\u0627\u062d\u0629 \u0645\u0624\u0642\u062a\u0627\u064b\u061f \u062d\u0633\u0628 \u0625\u0634\u0639\u0627\u0631 \u0646\u0627\u0641\u0630\u0629 \u0627\u0644\u0635\u064a\u0627\u0646\u0629 \u0627\u0644\u0645\u062d\u062f\u062f\u0629. 2. \u0645\u0627 \u0647\u0648 \u0646\u0642\u0644 \u0627\u0644\u0645\u062d\u0641\u0638\u0629\u061f \u0646\u0642\u0644 \u0627\u0644\u0645\u062d\u0641\u0638\u0629 \u0647\u0648 \u0639\u0645\u0644\u064a\u0629 \u0646\u0642\u0644 \u062d\u0633\u0627\u0628\u0627\u062a \u0648\u0623\u0631\u0635\u062f\u0629 \u0645\u064e\u062d\u0627\u0641\u0638 \u0627\u0644\u0639\u0645\u0644\u0627\u0621 \u0645\u0646 \u0646\u0638\u0627\u0645 \u0645\u062d\u0641\u0638\u0629 \u062f\u0631\u0628 \u0627\u0644\u062d\u0627\u0644\u064a \u0625\u0644\u0649 \u0645\u0646\u0635\u0629 \u062c\u062f\u064a\u062f\u0629. \u0627\u0644\u0623\u0645\u0631 \u0627\u0644\u0630\u064a \u0633\u064a\u0645\u0643\u0651\u0646 \u0645\u0633\u062a\u062e\u062f\u0645\u064a \u062f\u0631\u0628 \u0645\u0646 \u0627\u0644\u0627\u0633\u062a\u0641\u0627\u062f\u0629 \u0645\u0646 \u0623\u062f\u0627\u0621 \u0623\u0641\u0636\u0644 \u0648\u0623\u0643\u062b\u0631 \u0623\u0645\u0627\u0646\u0627\u064b\u060c \u0648\u0645\u0648\u062b\u0648\u0642\u064a\u0629 \u0623\u0643\u0628\u0631 \u0641\u064a \u0627\u0644\u062e\u062f\u0645\u0627\u062a. \u0647\u0630\u0647 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0629 \u0647\u064a \u0644\u0644\u0627\u0633\u062a\u062e\u062f\u0627\u0645 \u0627\u0644\u062f\u0627\u062e\u0644\u064a \u0641\u0642\u0637. \u064a\u0631\u062c\u0649 \u0639\u062f\u0645 \u0645\u0634\u0627\u0631\u0643\u062a\u0647\u0627 \u0645\u0639 \u0627\u0644\u0639\u0645\u0644\u0627\u0621\u060c \u062d\u064a\u062b \u0644\u0645 \u064a\u062a\u0645 \u062a\u0637\u0628\u064a\u0642 \u0623\u064a \u062a\u063a\u064a\u064a\u0631\u0627\u062a \u0638\u0627\u0647\u0631\u0629 \u0644\u0644\u0639\u0645\u0644\u0627\u0621. 3. \u0644\u0645\u0627\u0630\u0627 \u062a\u0642\u0648\u0645 \u062f\u0631\u0628 \u0628\u062a\u0646\u0641\u064a\u0630 \u0647\u0630\u0627 \u0627\u0644\u062a\u063a\u064a\u064a\u0631\u061f \u062a\u0645\u0627\u0634\u064a\u0627\u064b \u0645\u0639 \u0627\u0633\u062a\u0631\u0627\u062a\u064a\u062c\u064a\u0629 \u0643\u064a\u0648 \u0645\u0648\u0628\u064a\u0644\u064a\u062a\u064a \u0644\u062a\u062d\u0633\u064a\u0646 \u0627\u0644\u062e\u062f\u0645\u0627\u062a \u0627\u0644\u0631\u0642\u0645\u064a\u0629\u060c \u064a\u0623\u062a\u064a \u0647\u0630\u0627 \u0627\u0644\u062a\u062d\u062f\u064a\u062b \u0636\u0645\u0646 \u0627\u0644\u062a\u062d\u0633\u064a\u0646\u0627\u062a \u0627\u0644\u0645\u0633\u062a\u0645\u0631\u0629 \u0644\u0646\u0638\u0627\u0645 \u062f\u0631\u0628 \u0628\u0647\u062f\u0641 \u062a\u0639\u0632\u064a\u0632 \u0627\u0644\u0623\u062f\u0627\u0621 \u0648\u0627\u0644\u0623\u0645\u0627\u0646 \u0648\u0645\u0648\u062b\u0648\u0642\u064a\u0629 \u0627\u0644\u062e\u062f\u0645\u0629. \u0647\u0630\u0647 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0629 \u0647\u064a \u0644\u0644\u0627\u0633\u062a\u062e\u062f\u0627\u0645 \u0627\u0644\u062f\u0627\u062e\u0644\u064a \u0641\u0642\u0637. \u064a\u0631\u062c\u0649 \u0639\u062f\u0645 \u0645\u0634\u0627\u0631\u0643\u062a\u0647\u0627 \u0645\u0639 \u0627\u0644\u0639\u0645\u0644\u0627\u0621\u060c \u062d\u064a\u062b \u0644\u0645 \u064a\u062a\u0645 \u062a\u0637\u0628\u064a\u0642 \u0623\u064a \u062a\u063a\u064a\u064a\u0631\u0627\u062a \u0638\u0627\u0647\u0631\u0629 \u0644\u0644\u0639\u0645\u0644\u0627\u0621. 4. \u0647\u0644 \u0633\u064a\u062a\u0623\u062b\u0631 \u0631\u0635\u064a\u062f \u0645\u062d\u0641\u0638\u0629 \u0627\u0644\u0639\u0645\u064a\u0644/\u0627\u0644\u0645\u062a\u0639\u0627\u0645\u0644\u061f \u0633\u064a\u062a\u0645 \u0646\u0642\u0644 \u062c\u0645\u064a\u0639 \u0623\u0631\u0635\u062f\u0629 \u0627\u0644\u0645\u062d\u0627\u0641\u0638 \u0627\u0644\u0645\u062a\u0627\u062d\u0629 \u0643\u0645\u0627 \u0647\u064a \u062f\u0648\u0646 \u0623\u064a \u062a\u0623\u062b\u064a\u0631 \u0639\u0644\u0649 \u0645\u0633\u062a\u062e\u062f\u0645\u064a \u062f\u0631\u0628. \u0647\u0630\u0647 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0629 \u0647\u064a \u0644\u0644\u0627\u0633\u062a\u062e\u062f\u0627\u0645 \u0627\u0644\u062f\u0627\u062e\u0644\u064a \u0641\u0642\u0637. \u064a\u0631\u062c\u0649 \u0639\u062f\u0645 \u0645\u0634\u0627\u0631\u0643\u062a\u0647\u0627 \u0645\u0639 \u0627\u0644\u0639\u0645\u0644\u0627\u0621\u060c \u062d\u064a\u062b \u0644\u0645 \u064a\u062a\u0645 \u062a\u0637\u0628\u064a\u0642 \u0623\u064a \u062a\u063a\u064a\u064a\u0631\u0627\u062a \u0638\u0627\u0647\u0631\u0629 \u0644\u0644\u0639\u0645\u0644\u0627\u0621. 5. \u0647\u0644 \u0633\u0623\u0641\u0642\u062f \u0623\u064a \u0623\u0645\u0648\u0627\u0644 \u0623\u062b\u0646\u0627\u0621 \u0639\u0645\u0644\u064a\u0629 \u0627\u0644\u0646\u0642\u0644\u061f \u062a\u0645 \u062a\u0637\u0628\u064a\u0642 \u062c\u0645\u064a\u0639 \u0627\u0644\u0636\u0648\u0627\u0628\u0637 \u0648\u0639\u0645\u0644\u064a\u0627\u062a \u0627\u0644\u062a\u062d\u0642\u0642 \u0627\u0644\u0644\u0627\u0632\u0645\u0629 \u0644\u0636\u0645\u0627\u0646 \u062f\u0642\u0629 \u0648\u0633\u0644\u0627\u0645\u0629 \u0627\u0644\u0623\u0631\u0635\u062f\u0629. \u0647\u0630\u0647 \u0627\u0644\u0645\u0639\u0644\u0648\u0645\u0629 \u0647\u064a \u0644\u0644\u0627\u0633\u062a\u062e\u062f\u0627\u0645 \u0627\u0644\u062f\u0627\u062e\u0644\u064a \u0641\u0642\u0637. \u064a\u0631\u062c\u0649 \u0639\u062f\u0645 \u0645\u0634\u0627\u0631\u0643\u062a\u0647\u0627 \u0645\u0639 \u0627\u0644\u0639\u0645\u0644\u0627\u0621\u060c \u062d\u064a\u062b \u0644\u0645 \u064a\u062a\u0645 \u062a\u0637\u0628\u064a\u0642 \u0623\u064a \u062a\u063a\u064a\u064a\u0631\u0627\u062a \u0638\u0627\u0647\u0631\u0629 \u0644\u0644\u0639\u0645\u0644\u0627\u0621. 6. \u0645\u0627\u0630\u0627 \u064a\u062d\u062f\u062b \u0625\u0630\u0627 \u0642\u0645\u062a \u0628\u0634\u062d\u0646 \u0627\u0644\u0645\u062d\u0641\u0638\u0629 \u0648\u0644\u0645 \u064a\u0638\u0647\u0631 \u0627\u0644\u0631\u0635\u064a\u062f\u061f \u0633\u064a\u062a\u0645 \u0627\u0633\u062a\u0631\u062f\u0627\u062f \u0623\u064a \u0645\u0628\u0644\u063a \u062a\u0645 \u062e\u0635\u0645\u0647 \u062e\u0644\u0627\u0644 \u0645\u062f\u0629 \u062a\u062a\u0631\u0627\u0648\u062d \u0628\u064a\u0646 1 \u0625\u0644\u0649 3 \u0623\u064a\u0627\u0645 \u0639\u0645\u0644. 7. \u0645\u0627\u0630\u0627 \u064a\u062d\u062f\u062b \u0625\u0630\u0627 \u062a\u0645 \u062e\u0635\u0645 \u0627\u0644\u0645\u0628\u0644\u063a \u0648\u0644\u0645 \u064a\u062a\u0645 \u062a\u0642\u062f\u064a\u0645 \u0627\u0644\u062e\u062f\u0645\u0629 (\u0627\u0644\u062a\u0635\u0627\u0631\u064a\u062d\u060c \u0627\u0644\u0645\u062e\u0627\u0644\u0641\u0627\u062a)\u061f \u0633\u064a\u062a\u0645 \u0627\u0633\u062a\u0631\u062f\u0627\u062f \u0623\u064a \u0645\u0628\u0644\u063a \u062a\u0645 \u062e\u0635\u0645\u0647 \u062e\u0644\u0627\u0644 \u0645\u062f\u0629 \u062a\u062a\u0631\u0627\u0648\u062d \u0628\u064a\u0646 1 \u0625\u0644\u0649 3 \u0623\u064a\u0627\u0645 \u0639\u0645\u0644. 8. \u0645\u0627\u0630\u0627 \u064a\u062d\u062f\u062b \u0625\u0630\u0627 \u062a\u0645 \u062e\u0635\u0645 \u0627\u0644\u0645\u0628\u0644\u063a \u0648\u0644\u0645 \u064a\u062a\u0645 \u062a\u0642\u062f\u064a\u0645 \u0627\u0644\u062e\u062f\u0645\u0629 (\u062a\u0633\u062c\u064a\u0644 \u0645\u0631\u0643\u0628\u0629 \u0641\u064a \u0646\u0638\u0627\u0645 \u0627\u0644\u062a\u0639\u0631\u0641\u0629) \u0648\u0648\u062c\u062f\u062a \u0627\u0644\u0631\u0635\u064a\u062f \u0641\u064a \u0645\u062d\u0641\u0638\u0629 \u062f\u0631\u0628\u061f \u064a\u0631\u062c\u0649 \u0627\u0644\u0645\u062a\u0627\u0628\u0639\u0629 \u0648\u0625\u062a\u0645\u0627\u0645 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u0645\u0631\u0643\u0628\u0629 \u0641\u064a \u0646\u0638\u0627\u0645 \u0627\u0644\u062a\u0639\u0631\u0641\u0629 \u0628\u0627\u0633\u062a\u062e\u062f\u0627\u0645 \u0631\u0635\u064a\u062f \u0627\u0644\u0645\u062d\u0641\u0638\u0629. 9. \u0642\u0645\u062a \u0628\u0634\u062d\u0646 \u0645\u062d\u0641\u0638\u062a\u064a \u0639\u0628\u0631 \u0645\u0646\u0635\u0629 \u062a\u0645\u060c \u0648\u0644\u0643\u0646 \u0644\u0645 \u064a\u0638\u0647\u0631 \u0627\u0644\u0645\u0628\u0644\u063a \u0641\u064a \u0631\u0635\u064a\u062f \u0627\u0644\u0645\u062d\u0641\u0638\u0629. \u0645\u0627\u0630\u0627 \u064a\u062c\u0628 \u0623\u0646 \u0623\u0641\u0639\u0644\u061f \u0646\u0634\u0643\u0631\u0643\u0645 \u0639\u0644\u0649 \u0627\u0646\u062a\u0638\u0627\u0631\u0643\u0645 \u0648\u062a\u0639\u0627\u0648\u0646\u0643\u0645. \u064a\u0631\u062c\u0649 \u062a\u0642\u062f\u064a\u0645 \u0637\u0644\u0628 \u0627\u0633\u062a\u0631\u062f\u0627\u062f \u0639\u0628\u0631 \u0645\u0648\u0642\u0639 \u0623\u0648 \u062a\u0637\u0628\u064a\u0642 \u062f\u0631\u0628. \u0648\u0641\u064a \u062d\u0627\u0644 \u0648\u0627\u062c\u0647\u062a\u0645 \u0623\u064a \u0635\u0639\u0648\u0628\u0629\u060c \u064a\u0645\u0643\u0646\u0643\u0645 \u0627\u0644\u062a\u0648\u0627\u0635\u0644 \u0645\u0639 \u0645\u0631\u0643\u0632 \u0627\u0644\u0627\u062a\u0635\u0627\u0644 \u0639\u0644\u0649 \u0627\u0644\u0631\u0642\u0645 8003009 \u0623\u0648 \u0639\u0628\u0631 \u0627\u0644\u0628\u0631\u064a\u062f \u0627\u0644\u0625\u0644\u0643\u062a\u0631\u0648\u0646\u064a customers@qmobility.ae 10. \u0627\u0633\u062a\u062e\u062f\u0645\u062a \u062e\u062f\u0645\u0629 \u062f\u0641\u0639 \u0645\u0648\u0627\u0642\u0641 \u0639\u0628\u0631 \u062f\u0631\u0628\u060c \u0648\u062a\u0645 \u062e\u0635\u0645 \u0627\u0644\u0645\u0628\u0644\u063a\u060c \u0648\u0644\u0643\u0646 \u0644\u0645 \u064a\u062a\u0645 \u0625\u0635\u062f\u0627\u0631 \u062a\u0630\u0643\u0631\u0629 \u0627\u0644\u0645\u0648\u0642\u0641. \u0645\u0627\u0630\u0627 \u064a\u062c\u0628 \u0623\u0646 \u0623\u0641\u0639\u0644\u061f \u0633\u064a\u062a\u0645 \u0631\u062f\u0651 \u0627\u0644\u0645\u0628\u0644\u063a \u0627\u0644\u0645\u062e\u0635\u0648\u0645 \u062a\u0644\u0642\u0627\u0626\u064a\u0627\u064b \u0625\u0644\u0649 \u0645\u062d\u0641\u0638\u062a\u0643 \u0643\u062c\u0632\u0621 \u0645\u0646 \u0639\u0645\u0644\u064a\u0629 \u0627\u0644\u062a\u0633\u0648\u064a\u0629\u060c \u062e\u0644\u0627\u0644 \u0645\u062f\u0629 \u062a\u062a\u0631\u0627\u0648\u062d \u0628\u064a\u0646 1 \u0625\u0644\u0649 3 \u0623\u064a\u0627\u0645 \u0639\u0645\u0644. \u0646\u0634\u0643\u0631\u0643\u0645 \u0639\u0644\u0649 \u062a\u0639\u0627\u0648\u0646\u0643\u0645. 11. \u0627\u0633\u062a\u062e\u062f\u0645\u062a \u062e\u062f\u0645\u0629 \u062f\u0641\u0639 \u0645\u0648\u0627\u0642\u0641 \u0639\u0628\u0631 \u062a\u0645\u060c \u0648\u062a\u0645\u0651 \u062e\u0635\u0645 \u0627\u0644\u0645\u0628\u0644\u063a \u0648\u0644\u0643\u0646 \u0644\u0645 \u064a\u062a\u0645\u0651 \u0625\u0635\u062f\u0627\u0631 \u062a\u0630\u0643\u0631\u0629 \u0627\u0644\u0645\u0648\u0642\u0641. \u0645\u0627\u0630\u0627 \u064a\u062c\u0628 \u0623\u0646 \u0623\u0641\u0639\u0644\u061f \u064a\u0631\u062c\u0649 \u062a\u0642\u062f\u064a\u0645 \u0637\u0644\u0628 \u0627\u0633\u062a\u0631\u062f\u0627\u062f \u0639\u0628\u0631 \u0645\u0646\u0635\u0629 \u062a\u0645. 12. \u0644\u0645 \u064a\u062a\u0645 \u062e\u0635\u0645 \u0631\u0633\u0648\u0645 \u0627\u0644\u062a\u0639\u0631\u0641\u0629 \u0627\u0644\u0645\u0631\u0648\u0631\u064a\u0629 \u0631\u063a\u0645 \u062a\u0648\u0641\u0631 \u0631\u0635\u064a\u062f \u0643\u0627\u0641\u064d \u0641\u064a \u0627\u0644\u0645\u062d\u0641\u0638\u0629. \u064a\u0631\u062c\u0649 \u0627\u0644\u062a\u0623\u0643\u062f \u0645\u0646 \u062a\u0641\u0639\u064a\u0644 \u062e\u0627\u0635\u064a\u0629 \u0627\u0644\u062f\u0641\u0639 \u0627\u0644\u062a\u0644\u0642\u0627\u0626\u064a \u0639\u0628\u0631 \u0645\u0648\u0642\u0639", "source": "DARB_Wallet"}, {"title": "Mawaqif: What is a Commercial Parking Permit?", "category": "Mawaqif FAQ", "content": "Q: What is a Commercial Parking Permit?\n\nA: A Commercial Permit allows businesses to apply for various permit such as (parking reservation for construction & infrastructure maintenance, removal of PDM & Mawaqif Signages, parking reservation for charity campaigns, parking basement extension, parking space removal, utilize sidewalk for maintenance purpose, Parking reservation for eligible entities.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How do I apply for a Commercial Permit?", "category": "Mawaqif FAQ", "content": "Q: How do I apply for a Commercial Permit?\n\nA: Applications can be submitted through Tamm platform.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How much are the payment fees?", "category": "Mawaqif FAQ", "content": "Q: How much are the payment fees?\n\nA: The fees vary deepening the permit type and the applying entity classification Request Submission Fee for non-government entities: AED 200 Parking Reservation Permit - Government - per parking space per 6 months AED 10000 Parking Reservation Permit - Government - per parking space per day AED 55 Parking Reservation Permit - Government -per parking space per year AED 20000 Parking Reservation Permit - Private - Per parking space Per 6 Months AED 15000 Parking Reservation Permit - Private - Per parking space Per Day AED 85 Parking Reservation Permit - Private - per parking space per year AED 30000 Fees for removing machine or signboard AED 2000", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the process duration?", "category": "Mawaqif FAQ", "content": "Q: What is the process duration?\n\nA: Applications take 3 working days to be completed given that all required documentation are provided any payment if applicable is completed", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the renewal process?", "category": "Mawaqif FAQ", "content": "Q: What is the renewal process?\n\nA: Renewal must be initiated and completed prior to the expiry of the existing permit through TAMM", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What documents are required for a commercial permit?", "category": "Mawaqif FAQ", "content": "Q: What documents are required for a commercial permit?\n\nA: To apply for a commercial permit, you will need to provide your Emirates ID, trade license and some other documentation detailed under each type of permit. Ensure all information is accurate to avoid delays in processing.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Is there a limit on the number of Commercial Permits per company?", "category": "Mawaqif FAQ", "content": "Q: Is there a limit on the number of Commercial Permits per company?\n\nA: Yes, the number of max permits allowed depends on the entity classification and parking availability and project requirement for the construction companies. However number of approved parking spaces will depend on the operational status and occupancy of the sector. Customer Support", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I contact Q Mobility customer service?", "category": "Mawaqif FAQ", "content": "Q: How can I contact Q Mobility customer service?\n\nA: You can reach via the call center hotline, email\u00a0customers@qmobility.ae, or visit service centers in Abu Dhabi and Alain", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is Q Mobility call center?", "category": "Mawaqif FAQ", "content": "Q: What is Q Mobility call center?\n\nA: Q Mobility call center can be reached at 800-3009 around the clock", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the operating hours of the Q Mobility call center?", "category": "Mawaqif FAQ", "content": "Q: What are the operating hours of the Q Mobility call center?\n\nA: The call center operates 24 hours, 7 days a week Car Pound", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Is there an extra fee for cars that are not released on the same day?", "category": "Mawaqif FAQ", "content": "Q: Is there an extra fee for cars that are not released on the same day?\n\nA: There is a daily storage fees will be counted if the vehicle not released on the same day 100 AED daily for the first 30 days and then 500 AED monthly for the next 5 months after that the storage fees stop counted.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the terms for cars being impounded for long terms?", "category": "Mawaqif FAQ", "content": "Q: What are the terms for cars being impounded for long terms?\n\nA: Cars impounded for more than six months are sold at public auction according to the executive regulations of the Parking Law.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the documents required to release the vehicle?", "category": "Mawaqif FAQ", "content": "Q: What are the documents required to release the vehicle?\n\nA: To release the vehicle, the vehicle's ownership documents much be presented, such as the owner's ID, a copy of the vehicle registration, and a possession certificate for vehicles without plate numbers.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Where are the towing yards location?", "category": "Mawaqif FAQ", "content": "Q: Where are the towing yards location?\n\nA: AL Karma Car Pound :\u00a0https://maps.app.goo.gl/5sdreQ9627HRjrMt7 Al Ain Car Pound :\u00a0https://maps.app.goo.gl/46xQZzxhsZiCZ4Ki7 Musaffah Car Pound :\u00a0https://maps.app.goo.gl/eXe2XcwAuuaU6nJC9", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the accepted payment methods?", "category": "Mawaqif FAQ", "content": "Q: What are the accepted payment methods?\n\nA: The payment can be made in person at Pound customer service and using a credit card only.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How to appeal a towing fine?", "category": "Mawaqif FAQ", "content": "Q: How to appeal a towing fine?\n\nA: If you believe a fine was wrongly issued and your vehicle was towed, you can file a grievance online. If the grievance committee accepts your appeal, the vehicle will be released for free, or the amount will be refunded to your bank account if you made a payment.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the towing yards working hours?", "category": "Mawaqif FAQ", "content": "Q: What are the towing yards working hours?\n\nA: Al Krama Pound : 24 hours, 7 days a week Al Ain Pound : From 8 AM to 00:00 AM , 7 days a week Musaffah Car Pound : Temporary customer service operating hours: 8:00 AM to 6:00 PM , 7 days a week", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the towing fee?", "category": "Mawaqif FAQ", "content": "Q: What is the towing fee?\n\nA: The towing fee is AED 500 Institution / Government Permits", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Who can apply for an Institution / Government Permit?", "category": "Mawaqif FAQ", "content": "Q: Who can apply for an Institution / Government Permit?\n\nA: Institution and government permits are issued to employees of government institutions and other approved organizations. These permits allow parking in designated areas near the institution without additional charges.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How long are these permits valid for?", "category": "Mawaqif FAQ", "content": "Q: How long are these permits valid for?\n\nA: They are valid for 1 year and cost 1200.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Can these permits be transferred to another vehicle?", "category": "Mawaqif FAQ", "content": "Q: Can these permits be transferred to another vehicle?\n\nA: Yes, however, the request must be processed through the entity\u2019s contact person.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How do I apply for an institution/government permit?", "category": "Mawaqif FAQ", "content": "Q: How do I apply for an institution/government permit?\n\nA: Each entity must assign a contact person to process the application with Q Mobility.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Who is eligible for institution/government parking permits?", "category": "Mawaqif FAQ", "content": "Q: Who is eligible for institution/government parking permits?\n\nA: This service is applicable for government entities.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the duration process?", "category": "Mawaqif FAQ", "content": "Q: What is the duration process?\n\nA: The permit takes 3 working days after the payment has been made.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I renew this permit?", "category": "Mawaqif FAQ", "content": "Q: How can I renew this permit?\n\nA: You can renew your permit by submitting the correct documentation and payment before the expiry of the current permit. Limited term permit", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is a Limited-Term Permit?", "category": "Mawaqif FAQ", "content": "Q: What is a Limited-Term Permit?\n\nA: These are permits for all Mawaqif regulated areas in the Emirate of Abu Dhabi that allow the use of public parking spaces with sidewalks painted in black and turquoise, except for main parking areas, residential parking, and multi-story parking.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How long is a Limited-Term Permit valid?", "category": "Mawaqif FAQ", "content": "Q: How long is a Limited-Term Permit valid?\n\nA: Permits are available for durations such as one month, three months, six months, or one year.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I apply for a Limited term permit?", "category": "Mawaqif FAQ", "content": "Q: How can I apply for a Limited term permit?\n\nA: Customers can apply for the limited permit through Darb App and Tamm Platform.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the documents required?", "category": "Mawaqif FAQ", "content": "Q: What are the documents required?\n\nA: There are no required documents to submit the application.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the process duration?", "category": "Mawaqif FAQ", "content": "Q: What is the process duration?\n\nA: The permit will be issued immediately.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Who is eligible for a limited term permit?", "category": "Mawaqif FAQ", "content": "Q: Who is eligible for a limited term permit?\n\nA: Anyone with a car can apply for this permit.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Is it possible to renew limited term permit?", "category": "Mawaqif FAQ", "content": "Q: Is it possible to renew limited term permit?\n\nA: The limited permit cannot be renewed but the customer can issue a new permit instead, after the expiry of the previous one", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How much is the payment fee?", "category": "Mawaqif FAQ", "content": "Q: How much is the payment fee?\n\nA: The fees for the permit is AED 391 per month AED 1174 for the 3 months, AED 2348 for the 6 months, AED 4695 for the year Multi Story Car Park (MSCP)", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How does the Multi-Story Car Park system work?", "category": "Mawaqif FAQ", "content": "Q: How does the Multi-Story Car Park system work?\n\nA: Multi-story public parking is available in some areas of Abu Dhabi Island. The multi-story parking system operates through entrance and exit gates equipped with cameras or ticket readers, where the driver receives a ticket or their vehicle information is recorded electronically upon entry through the cameras, then they park their vehicle in one of the floors. Upon departure, the time spent is calculated and the parking fee is paid via a toll collection device, which will automatically open the gate or can be opened using the ticket after payment.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Are there monthly subscriptions for MSCPs?", "category": "Mawaqif FAQ", "content": "Q: Are there monthly subscriptions for MSCPs?\n\nA: Yes, there are 3 period available: 3 Month 1,369 6 Month 2,738 1 Year 5,475", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How much does it cost to park in an MSCP?", "category": "Mawaqif FAQ", "content": "Q: How much does it cost to park in an MSCP?\n\nA: AED 2 per hour capped at AED 15 for the 24hrs, the parking fees apply on weekends as well as public holidays.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the duration process?", "category": "Mawaqif FAQ", "content": "Q: What is the duration process?\n\nA: Permit will be issued immediately.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can the renewal be done?", "category": "Mawaqif FAQ", "content": "Q: How can the renewal be done?\n\nA: Renewal must be initiated and completed prior to the expiry of the existing permit.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Who is eligible?", "category": "Mawaqif FAQ", "content": "Q: Who is eligible?\n\nA: Anyone can apply for this permit.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Are there special parking spots in multi-story car parking?", "category": "Mawaqif FAQ", "content": "Q: Are there special parking spots in multi-story car parking?\n\nA: Yes, there are designated spots for people of determination and women drivers in multi-story car parks. These spots are clearly marked and reserved for specific use . Wheel Chair are availed at Control Room as well. Paid Public Parking", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I pay for public parking?", "category": "Mawaqif FAQ", "content": "Q: How can I pay for public parking?\n\nA: You can pay for public parking using the DARB mobile app, Parking Meters, SMS. Parking Meters accept coins, bank cards and rechargeable cards.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the process duration?", "category": "Mawaqif FAQ", "content": "Q: What is the process duration?\n\nA: Parking tickets will be issued immediately.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How to extend a parking ticket?", "category": "Mawaqif FAQ", "content": "Q: How to extend a parking ticket?\n\nA: Customer can extend their ticket after they receive a message that their ticket is going to be expired and prior to the expiry of the ticket.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the MAWAQIF paid parking hours?", "category": "Mawaqif FAQ", "content": "Q: What are the MAWAQIF paid parking hours?\n\nA: Monday to Saturday: 8:00 AM \u2013 12:00 AM (midnight). Free on Sundays and public holidays. Parking Fines", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How do I pay a parking fine?", "category": "Mawaqif FAQ", "content": "Q: How do I pay a parking fine?\n\nA: You can pay your parking fines online using the DARB application and TAMM platform. Ensure to pay within 60 days of the fine issuance date to avail the 25% discount.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I check if I have a parking fine?", "category": "Mawaqif FAQ", "content": "Q: How can I check if I have a parking fine?\n\nA: You can check your parking fines online using the DARB application or TAMM platform.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What happens if I don\u2019t pay my parking fine?", "category": "Mawaqif FAQ", "content": "Q: What happens if I don\u2019t pay my parking fine?\n\nA: Failure to pay your parking fines will result in the loss of the discount period, accumulation of substantial penalties, and may prevent you from renewing your car registration, among other consequences.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the common parking violations and fines?", "category": "Mawaqif FAQ", "content": "Q: What are the common parking violations and fines?\n\nA: Your can find the full list of violation through the following link\u00a0here Parking Grievance", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Can I dispute a parking fine?", "category": "Mawaqif FAQ", "content": "Q: Can I dispute a parking fine?\n\nA: Yes, if you believe a fine was wrongly issued, you can file a grievance online within 60 days of issuing the fine, unless you already paid the fine withing the discount period.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How long does it take to process grievance?", "category": "Mawaqif FAQ", "content": "Q: How long does it take to process grievance?\n\nA: It usually takes 7 working days for review and decision.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What happens if my grievance is rejected?", "category": "Mawaqif FAQ", "content": "Q: What happens if my grievance is rejected?\n\nA: You must pay the fine ASAP and within 60 days of the fine issuance date to avail the 25% discount.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the documents required?", "category": "Mawaqif FAQ", "content": "Q: What are the documents required?\n\nA: Customer needs to upload any proof that supports his grievance request.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I apply for a grievance?", "category": "Mawaqif FAQ", "content": "Q: How can I apply for a grievance?\n\nA: Customer can apply for grievance thorough Tamm platform. Parking Inspection", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How is parking enforced in Abu Dhabi?", "category": "Mawaqif FAQ", "content": "Q: How is parking enforced in Abu Dhabi?\n\nA: Parking inspectors regularly monitor areas to ensure compliance with paid and permit parking regulations.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What should I do if I see illegal parking?", "category": "Mawaqif FAQ", "content": "Q: What should I do if I see illegal parking?\n\nA: Complaints about improper parking or misuse of spaces can be submitted by calling the call center.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What happens during parking inspection?", "category": "Mawaqif FAQ", "content": "Q: What happens during parking inspection?\n\nA: During a parking inspection, Mawaqif inspectors check for parking violations such as expired parking tickets, incorrect parking, and unauthorized use of permit spaces. They issue fines and take appropriate measures as needed to enforce parking laws.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What should I do if I receive a violation notice by mistake?", "category": "Mawaqif FAQ", "content": "Q: What should I do if I receive a violation notice by mistake?\n\nA: You can appeal through the website or contact the customer service for clarification within 60 days from the issuing of the violation. Resident permits", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Who is eligible for a Resident Parking Permit?", "category": "Mawaqif FAQ", "content": "Q: Who is eligible for a Resident Parking Permit?\n\nA: Resident permits are available to individuals residing in areas with controlled parking. Applicants must provide proof of residency (Tawtheeq) , vehicle registration, valid Emirates ID, and the utility bill.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How can I apply for a Resident Parking Permit?", "category": "Mawaqif FAQ", "content": "Q: How can I apply for a Resident Parking Permit?\n\nA: You can apply online via Darb App or TAMM", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How long does it take to receive my permit?", "category": "Mawaqif FAQ", "content": "Q: How long does it take to receive my permit?\n\nA: Resident permits are issued upon completion of the payment process through the Darb application, followed by the review of the attached documents within a maximum period of 14 business days. Based on the results of the review, the permit is either approved or canceled without a refund of the paid amount. As for permit requests submitted through the Tam platform, their documents are verified within a period ranging from two to five business days, and a decision is made to either approve or reject. Fees are only paid after the request is approved..", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What is the payment fee to issue a resident permit?", "category": "Mawaqif FAQ", "content": "Q: What is the payment fee to issue a resident permit?\n\nA: Permit costs AED 800 per year for the first car AED 400 per 6 months, AED 1200 per year for the second car AED 600 per 6 moths. However for Emirati Citizens it is free", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: What are the documents required?", "category": "Mawaqif FAQ", "content": "Q: What are the documents required?\n\nA: The required documents are proof of residency (Tawtheeq) , vehicle registration, valid Emirates ID, and the utility bill.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: Can I apply for multiple vehicles?", "category": "Mawaqif FAQ", "content": "Q: Can I apply for multiple vehicles?\n\nA: Yes, but restrictions apply based on the number of vehicles registered at the same address.", "source": "Mawaqif_FAQ"}, {"title": "Mawaqif: How do I renew my Resident Permit?", "category": "Mawaqif FAQ", "content": "Q: How do I renew my Resident Permit?\n\nA: You can renew your permit online via Tamm Platform and Darb Platform Renewal must be initiated and completed prior to the expiry of the existing permit.", "source": "Mawaqif_FAQ"}, {"title": "DARB Official Rules", "category": "DARB Rules", "content": "DARB \u2013 OFFICIAL RULES\n1. What is Darb\nDarb is Abu Dhabi\u2019s electronic toll gate system. It operates without physical barriers. Vehicles are identified by plate number when crossing toll gates during peak hours.\n2. Toll Gate Locations\nToll gates are located on the main bridges entering Abu Dhabi City:\nSheikh Zayed Bridge\nSheikh Khalifa bin Zayed Bridge\nAl Maqtaa Bridge\nMussafah Bridge\n3. Peak Hours\nToll charges apply only during the following times:\nStandard Days (Monday to Saturday)\nMorning: 07:00 AM \u2013 09:00 AM\nEvening: 03:00 PM \u2013 07:00 PM\nSundays & Official Public Holidays\nNo toll charges.\nRamadan Peak Times\n08:00 AM \u2013 10:00 AM\n02:00 PM \u2013 04:00 PM\n4. Toll Charges\nAED 4 per crossing during peak hours.\n5. Registration Fees\nVehicle registration fee: AED 100\nAED 50 registration fee\nAED 50 credited to the wallet\n6. Wallet Rules\nAbu Dhabi vehicles can enable or disable auto-payment.\nVehicles registered outside Abu Dhabi must have sufficient wallet balance at all times.\n7. Exempt Vehicles (Automatic \u2013 No Application Required)\nAmbulances, Armed Forces, Civil Defence\nAbu Dhabi public buses\nMotorcycles\nAuthorized Abu Dhabi taxis\nAuthorized school buses\nPassenger buses (26+ seats)\nPolice and Ministry of Interior vehicles\nTrailer vehicles\n8. Exemptions by Application\nOnly one exemption vehicle allowed per account.\nExemptions cannot be changed unless 90 days have passed.\nPeople of Determination\nRequired:\nPOD Card from Ministry of Community Development or Zayed Higher Organization\nProof of kinship if vehicle owned by first or second degree relative\nLow Income Citizens\nRequired:\nLetter from Ministry of Community Development or Abu Dhabi Social Support Authority\nSenior Citizens\nUAE Citizen aged 60+\nVehicle must be in the person\u2019s name\nNo documents required\nPensioner Citizens\nRequired:\nLetter from Pension Authority\n9. Violations & Fines\nNon-Registration\nIf a vehicle crosses during peak hours without registration:\nApplies per day regardless of number of crossings.\nInsufficient Wallet Balance\nFor non-Abu Dhabi vehicles:\nAED 50 per day after 5 working days grace period\nPlate Tampering\nAED 10,000\nToll Gate Damage\nAED 10,000\nMaximum Caps\nPer violation: AED 10,000\nAnnual total: AED 25,000\n10. Official Channels\nWebsite: https://darb.qmobility.ae\nDarb Mobile App (App Store, Google Play, AppGallery)\nCall Center: 800 3009\nDARB \u2013 PROCEDURES\n(Step-by-step instructions only)\nCreate Individual Account\nOpen Darb App or darb.qmobility.ae\nLogin using UAE Pass\nComplete registration\nCreate E", "source": "DARB_Rules"}, {"title": "DARB General Info & Notes", "category": "General Info", "content": "### Important Notes\n1. Customers cannot issue Mawaqif permits for yachts or landscaping vehicles. Only daily parking payment is allowed using the Darb app or the parking machine.\n2. If the vehicle is a company vehicle, an NOC from the company is required, along with a valid employee ID showing the same company name.\n3. Darb registration can only be completed through the vehicle owner\u2019s Darb account.\n4. If a permit is cancelled due to missing documents, and the required documents are not submitted within 14 working days, the paid amount will not be refunded.\n5. Parking fees in Mohamed Bin Zayed City and Mussafah areas are not activated yet. Except for M1, M2, M3, M4, M24 in Mussafah they are payable areas.\n6. If you receive a Mawaqif fine, you will not receive another fine for the same reason and in the same sector on the same day.\n7. Prayer time exemption is available only in mosque parking areas. It is valid for 45 minutes starting from the first call to prayer (Adhan).\n8. The grace period is allowed only once per day before paying the first parking ticket. It is valid for 10 minutes only. If you already have a ticket and it expires, a fine will be issued immediately once the vehicle is detected by a smart vehicle or inspector.\n9. If you change your vehicle number and it is registered in the Darb toll system, you must submit a request through the Darb app by following these steps:\nLogin \u2192 Requests \u2192 Complaints \u2192 tap the (+) sign \u2192 submit a request.\nIf using the website, submit a vehicle registration complaint and attach both the old and new vehicle registration cards.\n10. If you change the vehicle but keep the same plate number, you must pay again to register the new vehicle in the Darb toll system.\n11. Darb toll fines have a grace period of 10 working days from the crossing time. For non-Abu Dhabi vehicles, if the vehicle is registered but has insufficient balance, a grace period of 5 working days is given to pay the unpaid toll fees.\n12. Toll fees cannot be paid without Darb registration. Registration is mandatory and is available only online through the Darb app or the TAMM app.\n13. The Darb toll gate does not require any card or badge. Only online registration is required.\n14. The Darb app is for individual use only. To create a company account, you must use the main website: [https://darb.qmobility.ae](https://darb.qmobility.ae)\n15. We would like to inform you that work is currently underway to develop and enhance parking services in order to facilit", "source": "General_Info"}, {"title": "DARB Comprehensive Guide", "category": "DARB Guide", "content": "Comprehensive Guide to Abu Dhabi Darb Toll Systems\nDarb\n1. Darb Toll Gates \u2013 Locations (with Google Maps links)\nDarb toll gates are installed on major bridges leading into Abu Dhabi City:\nSheikh Zayed Bridge\nGoogle Maps: https://maps.app.goo.gl/G4bDp5CeBDbbN7D1A\nSheikh Khalifa bin Zayed Bridge\nGoogle Maps: https://maps.app.goo.gl/q6pPdhg1f37xc85T6\nAl Maqtaa Bridge\nGoogle Maps: https://maps.app.goo.gl/2v2UziD3F3ybDN1Q9\nMussafah Bridge\nGoogle Maps: https://maps.app.goo.gl/w7sFG5E2XG8r5Lav7\n(These locations are confirmed by the Q Mobility FAQ and multiple secondary sources.)\n2. How the Darb System Works\nDarb is Abu Dhabi\u2019s electronic toll system; no physical toll booth barriers or tags are used. The system reads your vehicle plate automatically when you pass a toll gate.\nQ Mobility\nCharges apply only at peak hours on designated days.\nQ Mobility\nStandard Peak Hours\n\u2714 07:00 AM \u2013 09:00 AM\n\u2714 03:00 PM \u2013 07:00 PM\nImportant note : Sundays & official public holidays: no charges applied\n3. Registration & Account Basics \nRequired to register in Darb system:\nValid traffic file number (10 digits for Abu Dhabi; 8 digits for some other emirates)\nEmirates ID\nActive email\nMobile number linked with the traffic file\nVehicle registration in system:\nNew vehicles tied to your traffic file may be auto-added\nIf you change plates or sell a vehicle, system updates reflect automatically or may require re-registration or if you changed the plate only not the car then you can raise a complaint from Darb Application or Darb Website to review the car status and reregister it if confirmed, without paying the registration fees again.\nLogin options:\nEmirates ID\nRegistered email\nTraffic file number\n4. Toll Charges & Wallet Rules\nYou pay AED 4 per crossing during peak hours per vehicle.\nQ Mobility\nAccount wallet:\nVehicles registered outside Abu Dhabi must maintain sufficient balance in their wallet to avoid violations.\n5. Exemptions (Who Pays No Toll)\nVehicles automatically exempted from charges include:\nAmbulances, Armed Forces, Civil Defence\nPublic buses & authorized school buses\nMotorcycles\nAuthorized taxis in Abu Dhabi\nPassenger buses (26+ seats)\nPolice vehicles\nOther exemptions available upon application for:\n-Exemption People of determination\nRequired Documents:\nProof of kinship (required in case the vehicle is owned by first or second degree relative only) (Required)\nA card or letter issued by the Ministry of Community Development (Optional)\nPeople of determination card issued by the Mi", "source": "DARB_Guide"}, {"title": "Mawaqif Latest Updates", "category": "Mawaqif Updates", "content": "Mawaqif Last Updated\n### What is Mawaqif?\nMawaqif is Abu Dhabi's parking management system, designed to regulate public parking spaces, ease congestion, and improve road safety. It is operated by the Integrated Transport Centre (ITC) and includes different types of parking zones, permits, and payment methods.\n### Who is responsible for Mawaqif now?\nQ Mobility Company.\n### What is Q Mobility?\nQ Mobility, a wholly owned subsidiary of Abu Dhabi Investment and Holding Company (ADQ), focuses on providing sustainable and integrated smart mobility solutions to enhance the efficiency, reliability, and convenience of transportation infrastructure, in line with Abu Dhabi's vision for progress and development.\nQ Mobility manages, operates, and develops:\n* Darb (Abu Dhabi\u2019s toll system)\n* Mawaqif (Abu Dhabi\u2019s public parking system)\n### Q Mobility Vision & Mission\n* **Vision:** Redefining Urban Mobility for a Sustainable Future\n* **Mission:** Delivering best-in-class, digitally enabled mobility experiences to enhance livability\n---\n## 2. Contact Information\n* **Call Center:** 8003009 (Free of charge)\n* **Email:** [customer.care@qmobility.ae](mailto:customer.care@qmobility.ae)\n### Careers\n* **Email:** [careers@qmobility.ae](mailto:careers@qmobility.ae)\n---\n## 3. Areas Under Mawaqif Authority\n### Abu Dhabi City\nW64, W65, W54, W56, W66, W67, W57, W68, W58, W69, W59-01, W59-02, E42, E40, E35, W31, E34-02, E34-01, W49, W48, W47, E32, E33, E38, E37, E38-01, W52-01, W52-03, W52-02, W52, E31, E30, E39, E29, E28, E26, E21, W46-02, W46-01, W46, E27, E25, E19-02, E24, E22-02, E23, E22-01, W24-01, W24-02, W23-01, W23, W26, W22, W25, W21, W27, W25-01, W27-01, W28-01, W30, W28, W20, W19-01, W19-02, W15-01, W15-02, E20-01, E20-02, E19-01, W14-02, W14-01, W18-01, W18-02, W29, W18-03, W35, W34, W33, W16, W39, W36, W37, W17-03, W17-02, W17-01, W13-02, W13-01, E18-01, E18-02, E18-03, E36, E43, E41, E41-01, E11, E4-02, E4-01, W4, W9, W11, W10, W8, W7-02, W6, W5, W2, W1, E1, E2, E3-01, E3-02, E8, E6, E5, E7, E9-01, E9-02, E10, E16-02, E16-01, E16, E15, E12, E13, E14, W12, W45, W38, W41, W44, W43, W42, W40, SW2, SE-48, SE-45, RB11, RB12, RB9, RB8, RB7, RB5, RB4, RB3, RB2, RB1, Sas Al Nakhl, W7-01, Dolphin Park, Eastern Mangrove, Al Khaleej Al Arabi Park 1, Al Khaleej Al Arabi Park 2, Al Khaleej Al Arabi Park 4, Al Khaleej Al Arabi Park 5, Al Gurm Plaza.\n### Al Ain \u2013 Sanaiya\nAS01, AS02, AS03, AS04, AS05, AS06, AS07, ASH01, ASH02, ASH03, ASH04\n### Al Ain City\nSector 33, Sector 32, Sector 26, ", "source": "Mawaqif_Updates"}, {"title": "Mawaqif Zone Data", "category": "Mawaqif Updates", "content": "Name | Definition | Services | how to apply | Documents | Fees | Modify and Renew | Cancellation | Channels\nAccount Registration | DARB Account Registration allows individuals and establishments to create and manage a DARB account to access toll services, vehicle registration, wallet management, and transaction history,  access Mawaqif Services. | Account registration services include creating individual accounts, creating establishment accounts, updating phone numbers, and changing  passwords, Darb Vehicle Registration, Wallet Top up, Pay mawaqif Parking fees, Create Mawaqif  Permits. | Customers can register through the DARB application or website by following the guided registration steps. | The traffic file number code of the person or company.\nThe Emirates ID of the account holder .\nAn active personal email if you are registering a personal account, preferably to use the establishment mail when registering an establishment account.\nMobile number registered with the traffic file number. | Free of charges | Not required for the service | Not required for the service | Darb Application / Website\nVehicle Registration | DARB Vehicle Registration allows users to register individual or company vehicles in the DARB toll system by linking the vehicle traffic file number to the account. The service ensures the vehicle passing through toll gates without receiving fines during peak hours. | Vehicle registration services include registering individual vehicles, registering company vehicles, registering vehicles after changing the vehicle. | Customers can register vehicles through the DARB application or website by logging into the account and register the Vehicles to be able to pass through the toll gate without getting fines during peak hours. | Not required. | Vehicle registration fees 50 AED for each new Vehicle, to register a new car the wallet should have at least 100 AED in the balance to be able to proceed, GCC vehicles are exempt from registration fees. | any update in Police traffic reflect automatically in Darb Account, changing the plate don\u2019t require any action to be taken, changing the car require to reregister it again. | Vehicle unregistration is handled automatically once the vehicle is removed from the system and no manual cancellation is required. | DARB Application, DARB Website, TAMM Application, TAMM Website, \nAdd Traffic File Number | Adding a traffic file number from another emirates under the same name of the account holder to be able to re", "source": "Mawaqif_data"}, {"title": "DARB Script: Call Scripts", "category": "Call Scripts", "content": "Call Scripts\nAdd Traffic Number (Vehicle) \u2013 Request Already Exists\nAdd Traffic Number (Vehicle) \u2013 Used Wrong TC Number\nCustomer: Hello, I added my TC number in the Darb app but my\nvehicle is still not showing.\nAgent: Okay sir, which TC number did you use \u2014 the one on the car\nregistration card or the driving license?\nCustomer: I used the driving license one.\nAgent: That\u2019s the issue, sir. To see your vehicle, you must use the TC\nnumber on the car registration card.\nCustomer: Okay, let me check\u2026 yes, it\u2019s showing now. Thank you.\nAdd Traffic Number (Vehicle) \u2013 Miraged TC Number Issue\nCustomer: Hello, I added my TC number under my Darb app but my\nvehicle is still not showing.\nAgent: Okay sir, which TC number did you use \u2014 the one on the car\nregistration card or the driving license?\nCustomer: I used the car registration one.\nAgent: Did you merge your TC number?\nCustomer: Yes, I did.\nAgent: Okay sir, in this case, you need to contact RTA or MOI to obtain\nyour merged TC number.\nCustomer: Okay, let me check. Thank you.\nAdd Traffic Number (Vehicle) for Another Person\nCustomer: Hello, I want to know how to apply for a POD parking permit.\nAgent: Of course, sir. You can apply through the TAMM platform or TAMM app.\nIf you\u2019re not familiar with the steps, you may also contact Zayed Higher Organization for assistance.\nCustomer: Can you tell me their number?\nAgent: Sure, here you go: 800555.\nCustomer: Thank you.\nAdd Traffic Number (Vehicle) \u2013 Same Owner\nCustomer: I got a Mawaqif fine, but it was prayer time.\nAgent: I can check that for you. May I have the fine number or the plate number?\nCustomer: Yes, the fine number is 15050*****.\nAgent: The fine was issued because your vehicle was parked in a regular public parking area, not a mosque parking area, and there was no ticket.\nCustomer: I thought prayer time was allowed in all parking areas.\nAgent: I understand the confusion. Prayer-time exemption is only available in mosque-designated parking areas.\nCustomer: Thank you.\nHow to register for DARB toll?\nError: \u201cNo mobile phone number\nretrieved\u201d When Creating Account\nCustomer: Hello, I'm trying to create a new account on Darb, but it's showing \u201cNo mobile phone number retrieved, please call 8003009.\u201d\nAgent: Okay sir, may I have the TC number, please?\nCustomer: Here you go: 5098****\nAgent: Thank you. Can you confirm the full company name and trade license number?\nCustomer: Company name is Trad*** LLC and TL is 7845***\nAgent: Thank you. May I have the mobile number you want to link", "source": "Darb_Scripts"}, {"title": "Mawaqif Script: Mawaqif Call Scripts", "category": "Call Scripts", "content": "Mawaqif Call Scripts\nMawaqif Fines:\nFines in Sectors Not Under Mawaqif Authority\nCustomer: Can you check why I got a Mawaqif fine?\nAgent: Of course. May I have the fine number or the plate number?\nCustomer: Yes, the fine number is 15050*****.\nAgent: You received this fine in sector M40. It was issued by the Marsad Team for incorrect parking. Since this area is under ITC and not Mawaqif, please contact ITC at 800850 for further details.\nCustomer: Okay, thank you.\nNote: To check if a sector is under Mawaqif or not, please refer to the Smart Sector Map:\nhttps://www.google.com/maps/d/viewer?mid=1ivwUYz7_0q_mj-8SIK7WlafLfVN6ZoI&ll=24.49756041175288%2C54.363391899003474&z=16\nVehicle Impounded (Mostly Mussafah &\nBani Yas)\nCustomer: I can\u2019t find my vehicle. I think it was impounded. Can you check?\nAgent: Of course. May I have the fine number or the plate number?\nCustomer: Yes, the fine number is 15050*****.\nAgent: Thank you. I can see the fine was issued by the Marsad Team, and the last location of your vehicle was in Bani Yas. It was not impounded by Mawaqif. Please contact the confiscated impound yard at 02 5134278 or Emirates Auctions at 800 0666666 to check the vehicle status.\nCustomer: Okay, thank you.\nGrace Period Fines\nCustomer: I got a fine, but I didn\u2019t get my 10-minute grace period.\nAgent: I can help with that. May I have the fine number or the plate number?\nCustomer: Sure, the fine number is 15050*****.\nAgent: Thank you. The fine was issued because your parking ticket duration had already lapsed.\nCustomer: But there is a 10-minute grace period, right?\nAgent: Yes, there is, but only if there was no parking ticket reserved on the same day. In your case, you had a valid ticket and you received a reminder 15 minutes before the expiry time.\nCustomer: Okay, I understand. How can I appeal this fine?\nAgent: You can submit a grievance request through the TAMM App or platform. Sign in to the vehicle owner\u2019s account, search for Grievance for Transport Violations, submit your request, and you\u2019ll receive feedback by SMS within 7 working days.\nCustomer: Okay, thank you.\nPrayer Time Fines\nCustomer: I got a Mawaqif fine, but it was prayer time.\nAgent: I can check that for you. May I have the fine number or the plate number?\nCustomer: Yes, the fine number is 15050*****.\nAgent: The fine was issued because your vehicle was parked in a regular public parking area, not a mosque parking area, and there was no ticket.\nCustomer: I thought prayer time was allowed in all parking", "source": "Mawaqif_Scripts"}];

// Search KB for relevant articles
function kbSearch(query) {
  const q = query.toLowerCase();
  const scored = AI_KB_ARTICLES.map(a => {
    let score = 0;
    const title = a.title.toLowerCase();
    const content = a.content.toLowerCase();
    const words = q.split(/\s+/).filter(w=>w.length>2);
    words.forEach(w => {
      if(title.includes(w)) score += 10;
      if(content.includes(w)) score += 2;
    });
    if(title.includes(q)) score += 20;
    if(content.includes(q)) score += 5;
    return { ...a, score };
  }).filter(a => a.score > 0).sort((a,b) => b.score - a.score);
  return scored.slice(0, 5);
}

async function sendAgentChat() {
  var input = document.getElementById("agentChatInput");
  var mode = document.getElementById("agentChatMode") ? document.getElementById("agentChatMode").value : "eleven";
  var msg = input.value.trim();
  if (!msg) return;
  input.value = "";
  appendAgentMsg("user", msg);
  agentChatHistory.push({ role: "user", content: msg });
  var typingEl = document.getElementById("agentTypingRow");
  var sendBtn = document.getElementById("agentSendBtn");
  if(typingEl) typingEl.style.display = "block";
  if(sendBtn) sendBtn.disabled = true;
  var kbResults = kbSearch(msg);
  try {
    if(mode === "kb") {
      if(typingEl) typingEl.style.display = "none";
      if(kbResults.length) {
        appendAgentMsg("agent", kbResults[0].title + "\n\n" + kbResults[0].content.slice(0, 800));
        if(kbResults.length > 1) appendAgentMsg("system", "Related: " + kbResults.slice(1,4).map(function(a){return a.title;}).join(" | "));
      } else {
        appendAgentMsg("agent", "No matching KB articles found for: " + msg);
      }
    } else {
      var kbContext = kbResults.length > 0 ? kbResults.slice(0,3).map(function(a){return "--- " + a.title + " ---\n" + a.content.slice(0,600);}).join("\n\n") : "";
      var payload = { agent_id: ELEVEN_AGENT_ID, text: msg, conversation_history: agentChatHistory.slice(-8) };
      if(kbContext) payload.context = kbContext;
      var res = await fetch("https://api.elevenlabs.io/v1/convai/conversation/text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if(typingEl) typingEl.style.display = "none";
      if (res.ok) {
        var data = await res.json();
        var reply = data.response || data.text || data.message || data.answer || "";
        if(reply) {
          agentChatHistory.push({ role: "assistant", content: reply });
          appendAgentMsg("agent", reply);
        } else { throw new Error("Empty"); }
      } else {
        if(kbResults.length) {
          appendAgentMsg("agent", kbResults[0].title + "\n\n" + kbResults[0].content.slice(0, 800));
        } else {
          appendAgentMsg("agent", "Please use Voice Mode for full AI conversation.");
        }
      }
    }
  } catch(e) {
    if(typingEl) typingEl.style.display = "none";
    if(kbResults.length) {
      appendAgentMsg("agent", kbResults[0].title + "\n\n" + kbResults[0].content.slice(0, 600));
    } else {
      appendAgentMsg("system", "Connection error. Try Voice Mode.");
    }
  }
  if(sendBtn) sendBtn.disabled = false;
}

function appendAgentMsg(role, text) {
  var log = document.getElementById("agentChatLog");
  if (!log) return;
  var isUser = role === "user";
  var isSystem = role === "system";
  var col = isUser ? "var(--cyn)" : isSystem ? "var(--tx3)" : "var(--acc)";
  var bg = isUser ? "var(--s3)" : "var(--s2)";
  var label = isUser ? "You" : isSystem ? "Info" : "Qmobility Agent";
  var safe = text.replace(/&/g,"&amp;").replace(/\x3C/g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
  var div = document.createElement("div");
  div.style.cssText = "border-radius:8px;padding:10px 12px;border-left:3px solid "+col+";background:"+bg;
  div.innerHTML = "<b style='color:"+col+";font-size:11px'>"+label+"</b><br><span style='color:var(--tx2);font-size:12px'>"+safe+"</span>";
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function clearAgentChat() {
  agentChatHistory = [];
  const log = document.getElementById("agentChatLog");
  if(log) log.innerHTML = '<div style="background:var(--s3);border-radius:8px;padding:10px 12px;border-left:3px solid var(--acc)"><b style="color:var(--acc);font-size:11px">Qmobility Agent</b><br><span style="color:var(--tx2);font-size:12px">Hello! I have full DARB and Mawaqif knowledge. How can I help?</span></div>';
}

function agentQuickPrompt(p) {
  const i = document.getElementById("agentChatInput");
  if(i) { i.value = p; sendAgentChat(); }
}

function renderAIKB() {
  const el = document.getElementById("aiKBList");
  if(!el) return;
  const q = (document.getElementById("aiKBSearch")?.value||"").toLowerCase();
  const cat = document.getElementById("aiKBCat")?.value||"";
  let items = AI_KB_ARTICLES;
  if(q) items = items.filter(a => a.title.toLowerCase().includes(q) || a.content.toLowerCase().includes(q));
  if(cat) items = items.filter(a => a.category===cat);
  const countEl = document.getElementById("aiKBCount");
  if(countEl) countEl.textContent = items.length;
  if(!items.length){el.innerHTML='<p style="color:var(--tx3)">No matching articles</p>';return}
  el.innerHTML = items.slice(0,50).map(a => 
    '<div style="padding:6px 8px;border-bottom:1px solid var(--brd);cursor:pointer" onclick="agentQuickPrompt(this.dataset.q)" data-q="'+a.title.replace(/"/g,"&quot;")+'"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;background:var(--s3);color:var(--tx3)">'+a.category+'</span><b style="font-size:12px">'+a.title+'</b></div><p style="font-size:10px;color:var(--tx3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+a.content.slice(0,100)+'</p></div>'
  ).join("");
}
function loadKBIntoAgent() {
  const el = document.getElementById("aiKBStatus");
  if(el) el.textContent = AI_KB_ARTICLES.length + " articles loaded";
  renderAIKB();
}


</script>
</body>
</html>
