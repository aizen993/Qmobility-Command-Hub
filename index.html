<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yousef Shtawi Schedule</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0c10;--s1:#12151c;--s2:#1a1e28;--s3:#232938;--brd:#2a3148;--brd2:#384160;--tx:#e2e6ef;--tx2:#8490a8;--tx3:#586380;--acc:#3b82f6;--acc2:#2563eb;--grn:#10b981;--red:#ef4444;--orn:#f59e0b;--pur:#8b5cf6;--cyn:#06b6d4;--r:10px;--ff:'Outfit',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--ff);background:var(--bg);color:var(--tx);min-height:100vh}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--s1)}::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:3px}
.topbar{background:var(--s1);border-bottom:1px solid var(--brd);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:300}
.topbar h1{font-size:17px;font-weight:800;letter-spacing:-.5px}.topbar h1 em{font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.top-r{display:flex;gap:8px;align-items:center;flex-shrink:0}
.shell{display:flex;min-height:calc(100vh - 52px)}.side{width:210px;background:var(--s1);border-right:1px solid var(--brd);padding:8px 0;flex-shrink:0;position:sticky;top:52px;height:calc(100vh - 52px);overflow-y:auto}.pane{flex:1;padding:20px 24px;overflow-x:auto;min-width:0}
.ns{padding:8px 14px 4px;font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:1.8px;color:var(--tx3);margin-top:6px}
.ni{display:flex;align-items:center;gap:9px;padding:8px 14px;cursor:pointer;font-size:12.5px;font-weight:500;color:var(--tx2);transition:all .12s;border-left:3px solid transparent;user-select:none}.ni:hover{color:var(--tx);background:var(--s2)}.ni.on{color:var(--acc);background:rgba(59,130,246,.07);border-left-color:var(--acc);font-weight:600}.ni .ic{width:16px;text-align:center;font-size:13px}.nb{margin-left:auto;font-size:9.5px;font-weight:700;background:var(--s3);color:var(--tx2);padding:1px 7px;border-radius:9px;font-family:var(--mono)}
.card{background:var(--s1);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:14px;overflow:visible}.ch{padding:12px 16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between}.ch h3{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--tx2)}.cb{padding:14px 16px}
.btn{font-family:var(--ff);font-size:11.5px;font-weight:600;padding:6px 14px;border-radius:7px;cursor:pointer;transition:all .12s;border:none;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}.bp{background:var(--acc);color:#fff}.bp:hover{background:var(--acc2)}.bs2{background:var(--s3);color:var(--tx);border:1px solid var(--brd)}.bs2:hover{background:var(--brd)}.bd{background:#7f1d1d;color:#fca5a5}.bd:hover{background:#991b1b}.bg{background:#064e3b;color:#6ee7b7}.bg:hover{background:#065f46}.bsm{padding:4px 10px;font-size:10.5px}.bic{width:26px;height:26px;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;font-size:12px}
input,select{font-family:var(--ff);font-size:12.5px;background:var(--s2);border:1px solid var(--brd);border-radius:6px;padding:7px 10px;color:var(--tx);outline:none;transition:border .12s}input:focus,select:focus{border-color:var(--acc)}input[type=number]{width:62px;text-align:center;font-family:var(--mono)}input[type=color]{width:36px;height:34px;padding:2px;cursor:pointer;border-radius:4px}input[type=date]{width:148px}input[type=time]{width:110px;font-size:13px}select{cursor:pointer}label{font-size:11.5px;font-weight:500;color:var(--tx2)}.fr{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}.fg{display:flex;flex-direction:column;gap:3px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:8px;font-size:13px;font-weight:500;z-index:9999;max-width:600px;text-align:center;opacity:0;transition:opacity .3s}.toast.show{opacity:1}.toast.ok{background:#052e16;border:1px solid #064e3b;color:#86efac}.toast.err{background:#450a0a;border:1px solid #7f1d1d;color:#fca5a5}
.tw{overflow-x:auto;border-radius:var(--r);border:1px solid var(--brd)}table{width:100%;border-collapse:collapse;font-size:12.5px}th{padding:9px 10px;background:var(--s2);font-weight:600;color:var(--tx2);font-size:10.5px;text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--brd);text-align:center;white-space:nowrap}td{padding:6px 10px;border-bottom:1px solid var(--brd);text-align:center;white-space:nowrap}td:first-child{text-align:left}tr:hover td{background:rgba(255,255,255,.02)}
.sb{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:24px;border-radius:5px;font-family:var(--mono);font-size:10.5px;font-weight:600;color:#fff}
.di{width:48px;text-align:center;background:transparent;border:1px solid transparent;color:var(--tx);font-family:var(--mono);font-size:12.5px;padding:3px;border-radius:4px}.di:hover{border-color:var(--brd)}.di:focus{border-color:var(--acc);background:var(--s2)}.dt{font-family:var(--mono);font-weight:700}.dok{color:var(--grn)}.dbd{color:var(--red)}
.ar{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:6px;margin-bottom:4px;background:var(--s2);transition:background .08s;font-size:13px}.ar:hover{background:var(--s3)}.gb{font-size:9.5px;font-weight:700;padding:2px 6px;border-radius:4px;font-family:var(--mono)}.gf{background:#4c1d95;color:#c4b5fd}.gm{background:#1e3a5f;color:#93c5fd}
.ir{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--s2);border-radius:6px;margin-bottom:4px;font-size:13px}.tg{font-size:9.5px;font-weight:700;padding:2px 7px;border-radius:4px;font-family:var(--mono);text-transform:uppercase}.tgh{background:#7f1d1d;color:#fca5a5}.tga{background:#064e3b;color:#6ee7b7}
.sg{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:14px}.sc{background:var(--s2);border-radius:8px;padding:10px;text-align:center}.scd{font-size:10px;font-weight:700;color:var(--tx2);text-transform:uppercase;margin-bottom:6px}.scs{display:flex;flex-wrap:wrap;gap:2px;justify-content:center}
.tgw{display:flex;align-items:center;gap:7px}.tg2{position:relative;width:36px;height:19px;background:var(--brd);border-radius:10px;cursor:pointer;transition:background .2s;flex-shrink:0}.tg2.on{background:var(--acc)}.tg2::after{content:'';position:absolute;top:2px;left:2px;width:15px;height:15px;background:#fff;border-radius:50%;transition:transform .2s}.tg2.on::after{transform:translateX(17px)}
.ph{margin-bottom:16px}.ph h2{font-size:18px;font-weight:700;letter-spacing:-.3px}.ph p{font-size:12px;color:var(--tx2);margin-top:3px}.emp{text-align:center;padding:28px;color:var(--tx3);font-size:12.5px}
.spin{display:inline-block;width:13px;height:13px;border:2px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:sp .5s linear infinite}@keyframes sp{to{transform:rotate(360deg)}}
.day-checks{display:flex;gap:4px;flex-wrap:wrap}.day-checks label{display:inline-flex;align-items:center;gap:3px;font-size:11.5px;cursor:pointer;padding:3px 7px;border-radius:4px;background:var(--s3);border:1px solid var(--brd)}.day-checks input:checked+span{color:var(--acc);font-weight:600}
/* Shift card improved */
.shift-card{display:flex;align-items:center;gap:14px;padding:12px 16px;border-radius:8px;margin-bottom:6px;background:var(--s2);border-left:5px solid var(--acc)}.shift-card .s-badge{min-width:44px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:13px;font-weight:700;color:#fff}.shift-card .s-name{font-weight:600;font-size:14px;min-width:140px}.shift-card .s-time{font-family:var(--mono);font-size:14px;font-weight:500;color:var(--cyn);background:var(--s3);padding:4px 10px;border-radius:5px}
@media(max-width:860px){.side{display:none}.sg{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body>
<div class="topbar"><h1><em>Yousef Shtawi</em>&nbsp;Command Hub</h1><div class="top-r"><div class="tgw"><div class="tg2" id="tRand" onclick="this.classList.toggle('on')"></div><label style="font-size:11px;color:var(--tx2)">Random</label></div><input type="date" id="wkStart"><button class="btn bp" id="btnG" onclick="doGen()">&#9654; Generate</button><button class="btn bg" style="margin-left:4px" onclick="cloudSave()" id="btnCS" title="Save to Supabase">&#9729; Cloud Save</button></div></div>
<div class="shell">
<nav class="side" id="sideNav">
<div class="ni on" data-p="dashboard" style="margin-bottom:4px"><span class="ic">&#128200;</span>Dashboard</div>
<div class="ni" data-p="roster"><span class="ic">&#128197;</span>Schedule</div>
<div class="ni" data-p="dist"><span class="ic">&#9638;</span>Distribution</div>
<div class="ni" data-p="shifts"><span class="ic">&#9200;</span>Shifts<span class="nb" id="bS">0</span></div>
<div class="ni" data-p="rules"><span class="ic">&#9881;</span>Rules &amp; Gender</div>
<div class="ni" data-p="bksettings"><span class="ic">&#9881;</span>Break Settings</div>
<div class="ni" data-p="bklive"><span class="ic" style="color:#10b981">&#9679;</span>Breaks Live</div>
<div class="ni" data-p="attendance"><span class="ic">&#9989;</span>Attendance</div>
<div class="ni" data-p="al"><span class="ic">&#128197;</span>Annual Leave</div>
<div class="ni" data-p="sr"><span class="ic">&#128221;</span>Requests</div>
<div class="ni" data-p="kpis"><span class="ic">&#128200;</span>Team KPIs</div>
<div class="ni" data-p="kb"><span class="ic">&#128214;</span>Knowledge Base</div>
<div class="ni" data-p="agents"><span class="ic">&#128101;</span>Agents<span class="nb" id="bA">0</span></div>
<div class="ni" data-p="coaching"><span class="ic">&#128100;</span>Coaching</div>
<div class="ni" data-p="conduct"><span class="ic">&#9888;</span>Conduct</div>
<div style="flex:1"></div>
<div class="ni" data-p="cloud"><span class="ic">&#9881;</span>Settings</div>
</nav>
<div class="pane">
<div id="p-roster" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Weekly Roster</h2><p>Generated schedule — click any shift to swap</p></div><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn bg bsm" onclick="saveWeekArchive()">&#128190; Save Week</button><button class="btn bs2 bsm" onclick="exportCSV()">&#128196; CSV</button><button class="btn bg bsm" onclick="exportXLSX()">&#128202; Excel</button><button class="btn bp bsm" onclick="exportTeamHTML()">&#128279; Team View</button></div></div><div id="rArea"><div class="emp">Configure settings then click <b>Generate</b>.</div></div><div id="sArea"></div></div>
<div id="p-dist" class="pg" style="display:none"><div class="ph"><h2>Daily Distribution</h2><p>Headcount per shift per day. Total must = agent count (<b id="dAC">0</b>).</p></div><div class="card"><div class="cb" style="overflow-x:auto"><table id="dTbl"></table></div></div><div class="card"><div class="ch"><h3>Quick Adjust</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Day</label><select id="qaDay" style="width:80px"></select></div><div class="fg"><label>From</label><select id="qaFrom" style="width:90px"></select></div><div class="fg"><label>To</label><select id="qaTo" style="width:90px"></select></div><div class="fg"><label>Amt</label><input type="number" id="qaAmt" value="1" min="1" style="width:50px"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="quickAdj()">Move</button></div></div></div></div></div>
<div id="p-agents" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Agents</h2><p>Manage team</p></div><div style="display:flex;gap:4px"><button class="btn bp bsm" onclick="showEl('addAF')">+ Add Agent</button><button class="btn bs2 bsm" onclick="showEl('agLinksPanel')">&#128279; Agent Links</button></div></div><div id="addAF" class="card" style="display:none"><div class="cb"><div class="fr"><div class="fg"><label>Name</label><input id="nAN" placeholder="Full name..." style="width:240px"></div><div class="fg"><label>Gender</label><select id="nAG"><option value="F">Female</option><option value="M" selected>Male</option></select></div><div style="display:flex;gap:4px;align-self:flex-end"><button class="btn bp bsm" onclick="addAgent()">Add</button><button class="btn bs2 bsm" onclick="hideEl('addAF')">Cancel</button></div></div></div></div><div id="agLinksPanel" class="card" style="display:none"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>&#128279; Agent Portal Links</h3><button class="btn bs2 bsm bic" onclick="hideEl('agLinksPanel')">&#10005;</button></div><div class="cb"><p style="font-size:11px;color:var(--tx2);margin-bottom:8px">Each agent gets a unique link to view their schedule, breaks, annual leave, and submit requests.</p><div id="agLinksArea" style="max-height:350px;overflow-y:auto"></div></div></div><div class="card"><div class="cb" id="aList"></div></div></div>
<div id="p-shifts" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Shift Definitions</h2><p>Add/edit/remove shifts</p></div><button class="btn bp bsm" onclick="showEl('addSF')">+ Add Shift</button></div><div id="addSF" class="card" style="display:none"><div class="cb"><div class="fr"><div class="fg"><label>Code</label><input id="nSI" placeholder="E" style="width:60px;text-transform:uppercase"></div><div class="fg"><label>Name</label><input id="nSN" placeholder="Evening" style="width:150px"></div><div class="fg"><label>Start</label><input type="time" id="nSS" value="09:00"></div><div class="fg"><label>End</label><input type="time" id="nSE" value="17:00"></div><div class="fg"><label>Color</label><input type="color" id="nSC" value="#6366f1"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="addShift()">Add</button></div></div></div></div><div id="sList"></div></div>
<div id="p-rules" class="pg" style="display:none"><div class="ph"><h2>Rules &amp; Gender</h2></div><div class="card"><div class="ch"><h3>Weekly Limits</h3></div><div class="cb"><div class="fr"><label style="width:220px">Max OFF / agent / week</label><input type="number" id="rMO" min="0" max="7" value="2"></div><div class="fr"><label style="width:220px">Max working days / agent / week</label><input type="number" id="rMW" min="1" max="7" value="5"></div><button class="btn bp bsm" style="margin-top:8px" onclick="saveRules()">Save</button></div></div><div class="card"><div class="ch"><h3>Gender → Shift Restrictions</h3></div><div class="cb" id="grArea"></div></div></div>
<div id="p-al" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Annual Leave</h2><p>Year-based tracking, overlap validation, agent request portal</p></div><div style="display:flex;gap:6px"><button class="btn bs2 bsm" onclick="showEl('alRulesPanel')">&#9881; Rules</button><button class="btn bs2 bsm" onclick="showEl('alLinksPanel')">&#128279; Agent Links</button></div></div>
<div id="alRulesPanel" class="card" style="display:none;margin-bottom:14px"><div class="ch"><h3>Annual Leave Rules</h3><button class="btn bs2 bsm bic" onclick="hideEl('alRulesPanel')">✕</button></div><div class="cb"><div class="fr"><div class="fg"><label>Total AL days/year</label><input type="number" id="alrTotal" value="30" min="0" max="60" onchange="saveALRules()"></div><div class="fg"><label>Max concurrent agents on AL</label><input type="number" id="alrMaxConc" value="2" min="1" max="10" onchange="saveALRules()"></div><div class="fg"><label>Min notice (days)</label><input type="number" id="alrNotice" value="14" min="0" max="90" onchange="saveALRules()"></div></div><div class="fr" style="margin-top:8px"><div class="fg"><label>Min agents on shift</label><input type="number" id="alrMinCoverage" value="10" min="1" max="50" onchange="saveALRules()"></div><div class="fg"><label>Notify before (days)</label><input type="number" id="alrNotifyDays" value="7" min="1" max="30" onchange="saveALRules()"></div><div class="fg"><label>Blackout dates</label><input id="alrBlackout" placeholder="2026-12-25,2026-01-01" style="width:240px" onchange="saveALRules()"></div></div><div style="margin-top:10px;padding:8px 12px;background:var(--s3);border-radius:6px;font-size:11px;color:var(--tx2)">&#9432; Overlap rule: If <b>Max concurrent</b> is 2, any new request that overlaps with 2+ existing approved/ongoing leaves will be <b>blocked</b>. Set to 1 for strict single-agent AL.</div></div></div>
<div id="alLinksPanel" class="card" style="display:none;margin-bottom:14px"><div class="ch"><h3>&#128279; Agent Portal Links</h3><button class="btn bs2 bsm bic" onclick="hideEl('alLinksPanel')">✕</button></div><div class="cb" id="alLinksArea"></div></div>
<div id="alNotifications" style="margin-bottom:14px"></div>
<div style="display:flex;gap:6px;margin-bottom:14px"><button class="btn bs2 bsm alYearBtn" data-y="2025" onclick="setALYear(2025)">2025</button><button class="btn bp bsm alYearBtn" data-y="2026" onclick="setALYear(2026)">2026</button><button class="btn bs2 bsm alYearBtn" data-y="all" onclick="setALYear('all')">All</button></div>
<div class="card"><div class="ch"><h3>Add Leave</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="alA" style="width:240px"></select></div><div class="fg"><label>From</label><input type="date" id="alS"></div><div class="fg"><label>To</label><input type="date" id="alE"></div><div class="fg"><label>Status</label><select id="alSt"><option value="Pending">Pending</option><option value="Approved">Approved</option><option value="Completed">Completed</option><option value="Ongoing">Ongoing</option><option value="Rejected">Rejected</option></select></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="addAL()">Add Leave</button></div></div><div id="alPreview" style="margin-top:8px"></div></div></div>
<div class="card"><div class="ch"><h3>Leave Records</h3><span class="nb" id="alCount">0</span></div><div class="cb" id="alL"></div></div>
<div class="card"><div class="ch"><h3>Agent Balance Summary</h3></div><div class="cb" id="alBalance"></div></div>
<div id="alPendingRequests" style="margin-top:14px"></div></div>
<div id="p-sr" class="pg" style="display:none"><div class="ph"><h2>Special Requests</h2><p>Assign a weekly shift or specific-day overrides. Solver places OFFs automatically.</p></div><div class="card"><div class="ch"><h3>Add Request</h3></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="srA" style="width:220px"></select></div><div class="fg"><label>Shift</label><select id="srSh" style="width:100px"></select></div></div><div style="margin:6px 0 4px"><label>Days</label></div><div class="fr" style="margin-bottom:10px"><div class="day-checks" id="srDays"></div><button class="btn bs2 bsm" onclick="toggleAllD()" style="margin-left:4px">All/None</button></div><button class="btn bp bsm" onclick="addSR()">Add Request</button></div></div><div class="card"><div class="cb" id="srL"></div></div></div>
<div id="p-attendance" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Attendance</h2><p>Track daily attendance — Present / Absent / Sick / Annual</p></div><div class="fr"><button class="btn bs2 bsm" onclick="attPrevWeek()">◀ Prev</button><input type="date" id="attWeek" onchange="renderAttendance()" style="width:140px"><button class="btn bs2 bsm" onclick="attNextWeek()">Next ▶</button></div></div><div id="attArea"><div class="emp">Generate roster first.</div></div></div>
<div id="p-cloud" class="pg" style="display:none"><div class="ph"><h2>Settings &amp; Cloud Sync</h2><p>Save to Supabase, share with team, host your app</p></div>
<div class="card" style="margin-bottom:12px;border-left:3px solid var(--orn)"><div class="ch"><h3>&#127760; Host Online — Agent Links</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Your agent links use <code>file:///</code> which only works on your laptop. To share with agents, you need to host this file online. <b>Free options:</b></p>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px;margin-bottom:8px">
<b style="color:var(--grn)">Option 1: Netlify Drop (easiest — 30 seconds)</b><br>
1. Go to <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--cyn)">app.netlify.com/drop</a><br>
2. Drag and drop your YousefShtawiSchedule.html file<br>
3. You'll get a URL like <code>https://xyz-abc.netlify.app</code><br>
4. Agent links become: <code>https://xyz-abc.netlify.app/YousefShtawiSchedule.html?agent=ID</code>
</div>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px;margin-bottom:8px">
<b style="color:var(--grn)">Option 2: GitHub Pages (permanent)</b><br>
1. Create a free GitHub account → New repository<br>
2. Upload the HTML file → Enable Pages in Settings<br>
3. Get a permanent URL like <code>https://username.github.io/repo/</code>
</div>
<div style="background:var(--s2);padding:10px;border-radius:6px;font-size:11px">
<b style="color:var(--grn)">Option 3: Tiiny.host (instant)</b><br>
1. Go to <a href="https://tiiny.host" target="_blank" style="color:var(--cyn)">tiiny.host</a><br>
2. Upload the HTML file → Get a shareable link instantly
</div>
<p style="font-size:10px;color:var(--tx3);margin-top:8px">Once hosted, all agent links will work from any device. The app still uses Supabase for data, so everything syncs automatically.</p>
</div></div>
<div id="cloudArea"></div></div>
<div id="p-bklive" class="pg" style="display:none"><div class="ph"><h2>Live Break View</h2><p>Real-time break tracking</p></div><div id="bkLiveArea"><div class="emp">Generate roster first, then generate breaks from <b>Break Settings</b>.</div></div></div>
<div id="p-bkday" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Day Break Schedule</h2><p>Click a day to view breaks</p></div><div style="display:flex;gap:4px" id="bkDayTabs"></div></div><div id="bkDayArea"><div class="emp">Generate breaks first.</div></div></div>
<div id="p-bksettings" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Break Settings</h2><p>Configure break patterns and peak windows</p></div><button class="btn bp" id="btnBK" onclick="genBreaks()">&#9654; Generate Breaks</button></div><div id="bkSettingsArea"></div></div>
<div id="p-archive" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px"><div><h2>Week Archive</h2><p>Saved schedules. Load any past week or import from file.</p></div><div style="display:flex;gap:6px"><button class="btn bp bsm" onclick="importWeekFile()">&#128194; Import JSON</button><input type="file" id="impFile" accept=".json" style="display:none" onchange="handleImport(event)"></div></div><div class="card"><div class="cb" id="archList"><div class="emp">No saved weeks yet. Generate a roster and click <b>Save Week</b>.</div></div></div></div>
<div id="p-dashboard" class="pg"><div class="ph"><h2>Dashboard</h2><p>Call Center Command Hub</p></div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
<div class="card" style="border-left:3px solid var(--acc)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">Active Agents</div><div id="dashAgents" style="font-size:28px;font-weight:800">0</div></div><span style="font-size:24px">&#128101;</span></div></div>
<div class="card" style="border-left:3px solid var(--grn)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">Scheduled Today</div><div id="dashScheduled" style="font-size:28px;font-weight:800">0</div></div><span style="font-size:24px">&#128197;</span></div></div>
<div class="card" style="border-left:3px solid var(--cyn)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">Present</div><div id="dashPresent" style="font-size:28px;font-weight:800;color:var(--grn)">0</div></div><span style="font-size:24px">&#9989;</span></div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
<div class="card" style="border-left:3px solid var(--orn)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">On Break Now</div><div id="dashBreak" style="font-size:28px;font-weight:800;color:var(--orn)">0</div></div><span style="font-size:24px">&#9749;</span></div></div>
<div class="card" style="border-left:3px solid var(--pur)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">Pending Leave</div><div id="dashPendAL" style="font-size:28px;font-weight:800;color:var(--pur)">0</div></div><span style="font-size:24px">&#9201;</span></div></div>
<div class="card" style="border-left:3px solid var(--red)"><div class="cb" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:11px;color:var(--tx2)">Open Incidents</div><div id="dashIncidents" style="font-size:28px;font-weight:800;color:var(--red)">0</div></div><span style="font-size:24px">&#9888;</span></div></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="card"><div class="ch"><h3>Attendance Exceptions</h3></div><div class="cb" id="dashAttExc"><p style="color:var(--tx3)">No exceptions today</p></div></div>
<div class="card"><div class="ch"><h3>Pending Leave Requests</h3></div><div class="cb" id="dashLeaveReq"><p style="color:var(--tx3)">No pending requests</p></div></div>
</div></div>
<div id="p-kpis" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap"><div><h2>Team Performance Dashboard</h2><p>Monthly KPI tracking, outlier detection &amp; action plans</p></div><div style="display:flex;gap:4px"><select id="kpiMonth" onchange="renderKPIs()" style="width:130px"><option value="2026-02">Feb 2026</option><option value="2026-01">Jan 2026</option><option value="2025-12">Dec 2025</option><option value="2025-11">Nov 2025</option><option value="2025-10">Oct 2025</option><option value="2025-09">Sep 2025</option></select><button class="btn bp bsm" onclick="showEl('kpiEntry');document.getElementById('kpiAgent').innerHTML=D.agents.map(a=>'<option value=&quot;'+a.id+'&quot;>'+a.name+'</option>').join('')">+ Enter Data</button></div></div>
<div id="kpiSummary" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:12px"></div>
<div id="kpiEntry" style="display:none" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>Enter Monthly KPI Data</h3><button class="btn bs2 bsm bic" onclick="hideEl('kpiEntry')">✕</button></div><div class="cb"><div class="fr" style="margin-bottom:8px"><div class="fg"><label>Agent</label><select id="kpiAgent" style="width:200px"></select></div><div class="fg"><label>Month</label><input type="month" id="kpiDataMonth" value="2026-02"></div></div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px">
<div class="fg"><label>QA Score (0-100)</label><input type="number" id="kd_qa" min="0" max="100" step="0.1"></div>
<div class="fg"><label>AHT (seconds)</label><input type="number" id="kd_aht" min="0"></div>
<div class="fg"><label>Unplanned Leaves</label><input type="number" id="kd_unplanned" min="0"></div>
<div class="fg"><label>Adherence %</label><input type="number" id="kd_adherence" min="0" max="100" step="0.1"></div>
<div class="fg"><label>Interactions</label><input type="number" id="kd_interactions" min="0"></div>
<div class="fg"><label>CSAT (0-5)</label><input type="number" id="kd_csat" min="0" max="5" step="0.01"></div>
</div><button class="btn bp bsm" onclick="saveKPI()">Save KPI Data</button></div></div>
<div class="card" style="margin-bottom:12px"><div class="ch"><h3>Agent KPIs — <span id="kpiMonthLabel">Feb 2026</span></h3></div><div class="cb"><div class="tw" id="kpiTable"></div></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
<div class="card"><div class="ch"><h3 style="color:var(--red)">&#9888; Outliers &amp; Action Required</h3></div><div class="cb" id="kpiOutliers"><p style="color:var(--tx3)">Enter data to detect outliers</p></div></div>
<div class="card"><div class="ch"><h3 style="color:var(--grn)">&#127942; Top Performers</h3></div><div class="cb" id="kpiTop"><p style="color:var(--tx3)">Enter data to see rankings</p></div></div>
</div>
<div class="card"><div class="ch"><h3>&#128218; Recommended Training &amp; Action Plans</h3></div><div class="cb" id="kpiActions"><p style="color:var(--tx3)">Outliers will get automatic training recommendations</p></div></div></div>
<div id="p-kb" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Knowledge Base</h2><p>Articles, guides, and chat assistant</p></div><button class="btn bp bsm" onclick="showEl('kbAddForm')">+ New Article</button></div>
<div class="card" style="margin-bottom:12px"><div class="cb" style="display:flex;gap:8px"><input id="kbSearch" placeholder="Search articles, topics, keywords..." style="flex:1" oninput="renderKB()"><select id="kbCat" style="width:140px" onchange="renderKB()"><option value="">All Categories</option><option>Product</option><option>Process</option><option>Policy</option><option>Technical</option><option>Training</option></select></div></div>
<div class="card" style="margin-bottom:12px;border-left:3px solid var(--acc)"><div class="cb" style="display:flex;align-items:center;justify-content:space-between"><div><b style="font-size:13px">KB Chat Assistant</b><p style="font-size:11px;color:var(--tx2)">Ask questions and get instant answers from the knowledge base</p></div><button class="btn bp bsm" onclick="showEl('kbChat')">Open Chat</button></div></div>
<div id="kbChat" style="display:none;margin-bottom:12px" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>&#128172; KB Assistant</h3><button class="btn bs2 bsm bic" onclick="hideEl('kbChat')">✕</button></div><div class="cb"><div style="margin-bottom:6px;display:flex;gap:4px;align-items:center"><label style="font-size:10px;color:var(--tx2)">ChatGPT API Key:</label><input id="kbApiKey" type="password" placeholder="sk-..." style="flex:1;font-size:10px" value=""><button class="btn bs2 bsm" style="font-size:9px" onclick="localStorage.setItem('gpt_key',document.getElementById('kbApiKey').value);toast('Key saved')">Save</button></div><div id="kbChatLog" style="height:250px;overflow-y:auto;margin-bottom:8px;font-size:12px;padding:8px;background:var(--bg);border-radius:6px"><p style="color:var(--tx3)">Ask me anything about the knowledge base. If you provide a ChatGPT API key, I'll use AI to give detailed answers based on your KB articles.</p></div><div style="display:flex;gap:4px"><input id="kbChatIn" placeholder="Type a question..." style="flex:1" onkeydown="if(event.key==='Enter')kbAsk()"><button class="btn bp bsm" onclick="kbAsk()">Send</button></div></div></div>
<div id="kbAddForm" style="display:none;margin-bottom:12px" class="card"><div class="ch" style="display:flex;justify-content:space-between;align-items:center"><h3>New Article</h3><button class="btn bs2 bsm bic" onclick="hideEl('kbAddForm')">✕</button></div><div class="cb"><div class="fr"><div class="fg"><label>Title</label><input id="kbTitle" style="width:300px"></div><div class="fg"><label>Category</label><select id="kbNewCat"><option>Product</option><option>Process</option><option>Policy</option><option>Technical</option><option>Training</option></select></div></div><div class="fg" style="margin-top:8px"><label>Content</label><textarea id="kbContent" rows="6" style="width:100%;resize:vertical"></textarea></div><div style="margin-top:8px;padding:10px;background:var(--s2);border-radius:6px;border:1px dashed var(--brd)"><div style="font-size:11px;font-weight:600;margin-bottom:4px">&#128194; Upload File to KB</div><p style="font-size:10px;color:var(--tx3);margin-bottom:6px">Upload .docx, .txt, .csv, .xlsx — content will be extracted and added as articles</p><input type="file" id="kbFileUpload" accept=".txt,.csv,.xlsx,.json,.docx,.doc" onchange="kbProcessFile(event)" style="font-size:10px"></div><button class="btn bp bsm" style="margin-top:8px" onclick="addKBArticle()">Save Article</button></div></div>
<div class="card"><div class="cb" id="kbList"><div class="emp" style="text-align:center"><span style="font-size:48px;opacity:.3">&#128214;</span><p style="margin-top:8px">No articles found. Create your first knowledge base article.</p></div></div></div></div>
<div id="p-coaching" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Coaching &amp; Development</h2><p>Track coaching sessions and agent development</p></div><button class="btn bp bsm" onclick="showEl('coachForm')">&#128100; New Session</button></div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Total Sessions</div><div id="coachTotal" style="font-size:24px;font-weight:800">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">This Month</div><div id="coachMonth" style="font-size:24px;font-weight:800;color:var(--orn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Follow-ups Needed</div><div id="coachFollow" style="font-size:24px;font-weight:800;color:var(--red)">0</div></div></div>
</div>
<div id="coachForm" style="display:none;margin-bottom:12px" class="card"><div class="ch"><h3>New Coaching Session</h3><button class="btn bs2 bsm bic" onclick="hideEl('coachForm')">✕</button></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="coachAgent" style="width:200px"></select></div><div class="fg"><label>Type</label><select id="coachType"><option>Quality</option><option>Performance</option><option>Behavior</option><option>Development</option></select></div><div class="fg"><label>Date</label><input type="date" id="coachDate"></div></div><div class="fg" style="margin-top:8px"><label>Notes</label><textarea id="coachNotes" rows="3" style="width:100%"></textarea></div><div style="display:flex;gap:4px;margin-top:6px"><label style="font-size:11px"><input type="checkbox" id="coachFup"> Needs follow-up</label></div><button class="btn bp bsm" style="margin-top:8px" onclick="addCoaching()">Save Session</button></div></div>
<div class="card"><div class="ch"><h3>Recent Coaching Sessions</h3></div><div class="cb" id="coachList"><p style="color:var(--tx3)">No coaching sessions recorded yet.</p></div></div></div>
<div id="p-conduct" class="pg" style="display:none"><div class="ph" style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2>Behavior &amp; Conduct Management</h2><p>Log and track incidents</p></div><button class="btn bd bsm" onclick="showEl('incidentForm')">&#9888; Log Incident</button></div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Open Incidents</div><div id="condOpen" style="font-size:24px;font-weight:800;color:var(--red)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Critical</div><div id="condCrit" style="font-size:24px;font-weight:800;color:var(--orn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Improved</div><div id="condImpr" style="font-size:24px;font-weight:800;color:var(--grn)">0</div></div></div>
<div class="card"><div class="cb"><div style="font-size:10px;color:var(--tx2)">Repeated</div><div id="condRep" style="font-size:24px;font-weight:800;color:var(--pur)">0</div></div></div>
</div>
<div id="incidentForm" style="display:none;margin-bottom:12px" class="card"><div class="ch"><h3>Log Incident</h3><button class="btn bs2 bsm bic" onclick="hideEl('incidentForm')">✕</button></div><div class="cb"><div class="fr"><div class="fg"><label>Agent</label><select id="incAgent" style="width:200px"></select></div><div class="fg"><label>Severity</label><select id="incSev"><option>Low</option><option>Medium</option><option>High</option><option>Critical</option></select></div><div class="fg"><label>Type</label><select id="incType"><option>Attendance</option><option>Quality</option><option>Behavior</option><option>Policy Violation</option><option>Customer Complaint</option></select></div></div><div class="fg" style="margin-top:8px"><label>Description</label><textarea id="incDesc" rows="3" style="width:100%"></textarea></div><button class="btn bd bsm" style="margin-top:8px" onclick="addIncident()">Log Incident</button></div></div>
<div class="card"><div class="ch"><h3>All Incidents</h3></div><div class="cb" id="incList"><p style="color:var(--tx3)">No incidents recorded.</p></div></div></div>
</div></div>
<div id="loginOverlay" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:9000;align-items:center;justify-content:center"><div style="background:var(--s1);border:1px solid var(--brd);border-radius:12px;padding:32px;width:360px;text-align:center"><h1 style="font-size:20px;font-weight:800;margin-bottom:4px"><em style="font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Command Hub</h1><p style="color:var(--tx2);font-size:12px;margin-bottom:20px">Admin Login</p><input id="lEmail" placeholder="Email" style="width:100%;margin-bottom:8px;padding:10px"><input id="lPass" type="password" placeholder="Password" style="width:100%;margin-bottom:8px;padding:10px"><p id="lErr" style="color:var(--red);font-size:11px;margin-bottom:8px;min-height:16px"></p><button class="btn bp" style="width:100%;padding:12px" onclick="doLogin()">Sign In</button></div></div>
<div id="viewerBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#064e3b,#065f46);z-index:400;padding:8px 20px;align-items:center;justify-content:space-between"><span style="font-size:12px;font-weight:600;color:#6ee7b7">&#128279; Shared Live View — Read Only</span><span style="font-size:11px;color:#a7f3d0" id="viewerUpdate">Last updated: —</span></div>
<div id="toast" class="toast"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const uid=()=>Math.random().toString(36).slice(2,9);
let D={
  shifts:[{id:"A",name:"Morning",start:"07:00",end:"16:00",color:"#059669"},{id:"MS",name:"Middle Support",start:"11:00",end:"20:00",color:"#d97706"},{id:"B",name:"Afternoon",start:"16:00",end:"01:00",color:"#7c3aed"},{id:"C",name:"Night",start:"00:00",end:"09:00",color:"#1e3a5f"}],
  agents:[
    ...["Nafisa Ali","AYA Alaeldin","Mennatallah Mohamed Farouk Mostafa Ismail","Amina Saad","Nadeen Ahmed Said Salem","Habiba Ayman Mohamed Refaat Mahmoud Elbassyouny","Shimaa Adel Abdelmanaem Khalil Ebrahem"].map(n=>({id:uid(),name:n,gender:"F"})),
    ...["Walid Hamdy Mahmoud Ahmed","Mohamed Nada","Omer Hassan","Mahmoud Yasser Mahmoud Zanker","Islam Abdalla Suliman Khalifa","Morad Mahmoud Hassen Mohamed Morad","Mohamed Magdi Mohamed Hassan Ali","Mohamed Ezzat Mohamed Hussein Sadiq","Amir Mounir RizqAllah Fam","Mohamed Ahmed Abdallah Zidan","Omar Nasreldien Mahrous","Mohamed Mahmoud Nasr Othman Kher","Ali Yasser Ali Elgohary","Abdelrahman Reda Mohamed Abouelnasr Elmaghraby"].map(n=>({id:uid(),name:n,gender:"M"}))
  ],
  rules:{max_off:2,max_work:5},
  genderRules:{F:["A"],M:[]},
  dist:{Mon:{A:8,MS:2,B:5,C:1,OFF:5,AL:2},Tue:{A:7,MS:2,B:4,C:1,OFF:7,AL:2},Wed:{A:7,MS:2,B:4,C:1,OFF:7,AL:2},Thu:{A:7,MS:2,B:5,C:1,OFF:6,AL:2},Fri:{A:8,MS:2,B:5,C:1,OFF:5,AL:2},Sat:{A:8,MS:2,B:4,C:1,OFF:6,AL:2},Sun:{A:8,MS:2,B:4,C:1,OFF:6,AL:2}},
  al:[
{id:uid(),aid:"",name:"Mennatallah Mohamed Farouk Mostafa Ismail",start:"2025-08-25",end:"2025-09-07",status:"Completed"},
{id:uid(),aid:"",name:"Mennatallah Mohamed Farouk Mostafa Ismail",start:"2025-09-29",end:"2025-10-14",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Aly",start:"2025-07-01",end:"2025-07-17",status:"Completed"},
{id:uid(),aid:"",name:"Omar Nasreldien Mahrous",start:"2025-07-24",end:"2025-08-19",status:"Completed"},
{id:uid(),aid:"",name:"Nadeen Ahmed Said Salem",start:"2025-06-23",end:"2025-07-22",status:"Completed"},
{id:uid(),aid:"",name:"Abanoub Soliman",start:"2025-08-05",end:"2025-09-03",status:"Completed"},
{id:uid(),aid:"",name:"Amir Mounir RizqAllah Fam",start:"2025-07-21",end:"2025-08-05",status:"Completed"},
{id:uid(),aid:"",name:"Amir Mounir RizqAllah Fam",start:"2025-11-17",end:"2025-12-01",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Mahmoud Nasr Othman Kher",start:"2025-10-06",end:"2025-11-02",status:"Completed"},
{id:uid(),aid:"",name:"Nafisa Abdi",start:"2025-10-16",end:"2025-10-30",status:"Completed"},
{id:uid(),aid:"",name:"Nafisa Abdi",start:"2025-11-01",end:"2025-11-15",status:"Completed"},
{id:uid(),aid:"",name:"Mahmoud Yasser Mahmoud Zanker",start:"2025-11-07",end:"2025-12-09",status:"Completed"},
{id:uid(),aid:"",name:"AYA Alaeldin",start:"2025-09-14",end:"2025-09-28",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Magdi Mohamed Hassan Ali",start:"2025-09-03",end:"2025-09-15",status:"Completed"},
{id:uid(),aid:"",name:"Habiba Ayman Mohamed Refaat Mahmoud Elbassyouny",start:"2025-09-07",end:"2025-09-29",status:"Completed"},
{id:uid(),aid:"",name:"Joud Mohammad Alkurdi",start:"2025-07-31",end:"2025-08-20",status:"Completed"},
{id:uid(),aid:"",name:"Omer Hassan",start:"2025-12-05",end:"2025-12-30",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Ezzat Mohamed Hussein Sadiq",start:"2026-01-04",end:"2026-02-02",status:"Completed"},
{id:uid(),aid:"",name:"Morad Mahmoud Hassen Mohamed Morad",start:"2026-01-04",end:"2026-02-02",status:"Completed"},
{id:uid(),aid:"",name:"Mohamed Nada",start:"2026-02-01",end:"2026-03-02",status:"Ongoing"},
{id:uid(),aid:"",name:"Ahmed Nasser",start:"2025-12-10",end:"2025-12-31",status:"Completed"},
{id:uid(),aid:"",name:"Amina Saad",start:"2026-06-04",end:"2026-06-26",status:"Pending"},
{id:uid(),aid:"",name:"Islam Abdalla Suliman Khalifa",start:"2026-02-09",end:"2026-03-11",status:"Ongoing"},
{id:uid(),aid:"",name:"Omar Nasreldien Mahrous",start:"2026-03-02",end:"2026-04-03",status:"Pending"}
],sr:[],swapRequests:[],roster:null,summary:null
};
function allIds(){return D.shifts.map(s=>s.id).concat(["OFF","AL"])}
function workIds(){return D.shifts.map(s=>s.id)}
function sColor(sid){const s=D.shifts.find(x=>x.id===sid);if(s)return s.color;if(sid==="OFF")return"#4b5563";if(sid==="AL")return"#dc2626";return"#374151"}
function save(){try{localStorage.setItem("ys_v11",JSON.stringify(D))}catch(e){}}
function loadSaved(){try{const s=localStorage.getItem("ys_v11");if(s){const p=JSON.parse(s);if(p.agents&&p.shifts)Object.assign(D,p)}}catch(e){}}
function showEl(id){document.getElementById(id).style.display="block"}
function hideEl(id){document.getElementById(id).style.display="none"}
let toastT;function toast(m,t="ok"){const el=document.getElementById("toast");el.textContent=m;el.className="toast "+t+" show";clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove("show"),4000)}
document.getElementById("sideNav").addEventListener("click",e=>{const ni=e.target.closest(".ni");if(!ni)return;const p=ni.dataset.p;if(!p)return;document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-"+p).style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));ni.classList.add("on")});

// ══════════════════════════════════════════════════════
// SOLVER — Two-phase with 12hr rest, consecutive OFFs, single-shift
// ══════════════════════════════════════════════════════
function _shiftMins(sid){const s=D.shifts.find(x=>x.id===sid);if(!s)return null;const[sh,sm]=s.start.split(":").map(Number),[eh,em]=s.end.split(":").map(Number);let st=sh*60+sm,en=eh*60+em;if(en<=st)en+=1440;return{s:st,e:en}}
function _restOk(s1,s2){if(!s1||!s2)return true;const a=_shiftMins(s1),b=_shiftMins(s2);if(!a||!b)return true;const rest=(b.s+1440)-a.e;return rest>=720}
function _checkRest(sch,ai,wk){for(let di=0;di<6;di++){const s1=sch[ai][di],s2=sch[ai][di+1];if(wk.includes(s1)&&wk.includes(s2)&&!_restOk(s1,s2))return false}return true}
function solve(randomize){
  const agents=D.agents,N=agents.length,wk=workIds(),all=allIds();
  let maxOff=D.rules.max_off,maxWork=D.rules.max_work;
  const dist={};for(const d of DAYS){dist[d]={};for(const k of Object.keys(D.dist[d]))dist[d][k]=D.dist[d][k]}
  const errors=[];
  for(const day of DAYS){const t=all.reduce((s,id)=>s+(dist[day][id]||0),0);if(t!==N){errors.push(`${day}: total=${t}, need ${N}. Fix Distribution.`);return{ok:false,errors}}}
  const gAllow=g=>{const r=D.genderRules[g]||[];return r.length?new Set(r.filter(x=>wk.includes(x))):new Set(wk)};
  const idx={};agents.forEach((a,i)=>idx[a.id]=i);
  const alAll=new Set();
  const alByDay=Array.from({length:7},()=>new Set());
  const ws=document.getElementById("wkStart").value;
  if(ws){const wd=new Date(ws+"T12:00:00");for(const al of D.al){if(al.status==="Rejected")continue;const sd=new Date(al.start+"T12:00:00"),ed=new Date(al.end+"T12:00:00");if(idx[al.aid]===undefined)continue;const ai=idx[al.aid];let fullWeek=true;for(let i=0;i<7;i++){const dd=new Date(wd);dd.setDate(wd.getDate()+i);if(dd>=sd&&dd<=ed){alByDay[i].add(ai)}else{fullWeek=false}}if(fullWeek)alAll.add(ai)}}
  const srMap=Array.from({length:N},()=>({}));
  for(const sr of D.sr){if(idx[sr.aid]===undefined)continue;const ai=idx[sr.aid],di=DAYS.indexOf(sr.day);if(di>=0)srMap[ai][di]=sr.sid}
  // Auto-adjust: AL in distribution must match actual AL agents
  const actualAL=alAll.size;
  for(const day of DAYS){
    const distAL=dist[day].AL||0;
    if(distAL!==actualAL){
      let diff=distAL-actualAL; // positive = excess AL to redistribute
      dist[day].AL=actualAL;
      // Redistribute excess to work shifts (highest need first), not OFF
      while(diff>0){
        // Find work shift with highest current count (most agents needed)
        let bestS=wk[0],bestV=0;
        for(const s of wk){if((dist[day][s]||0)>=bestV){bestV=dist[day][s]||0;bestS=s}}
        dist[day][bestS]=(dist[day][bestS]||0)+1;
        diff--;
      }
      // If diff<0 (more AL than distribution), reduce from largest work shift
      while(diff<0){
        let bestS=wk[0],bestV=0;
        for(const s of wk){if((dist[day][s]||0)>bestV){bestV=dist[day][s]||0;bestS=s}}
        if(bestV<=0)break;
        dist[day][bestS]--;
        diff++;
      }
    }
  }
  const nonAL=N-actualAL;
  const totalOff=DAYS.reduce((s,d)=>s+(dist[d].OFF||0),0);
  const totalWork=DAYS.reduce((s,d)=>s+wk.reduce((s2,id)=>s2+(dist[d][id]||0),0),0);
  if(totalOff>nonAL*maxOff){
    // Allow maxOff to flex up by 1 if distribution requires it (soft constraint)
    const needed=Math.ceil(totalOff/nonAL);
    if(needed<=maxOff+1)maxOff=needed;
    else{
      let excess=totalOff-nonAL*maxOff;
      while(excess>0){let bestD=null,bestV=0;for(const d of DAYS){if((dist[d].OFF||0)>bestV){bestV=dist[d].OFF||0;bestD=d}}if(!bestD||bestV<=0)break;dist[bestD].OFF--;let bestS=wk[0],bestSV=0;for(const s of wk){if((dist[bestD][s]||0)>=bestSV){bestSV=dist[bestD][s]||0;bestS=s}}dist[bestD][bestS]=(dist[bestD][bestS]||0)+1;excess--}
    }
  }
  if(totalWork>nonAL*maxWork){errors.push(`Need ${totalWork} work slots but only ${nonAL}*${maxWork}=${nonAL*maxWork} capacity.`);return{ok:false,errors}}
  let seed=randomize?Date.now():42;
  const rng=()=>{seed=(seed*16807)%2147483647;return(seed-1)/2147483646};
  const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b};
  const nightShifts=new Set();for(const s of D.shifts){const[eh]=s.end.split(":").map(Number);const[sh]=s.start.split(":").map(Number);if(eh<sh||eh<=9)nightShifts.add(s.id)}
  const OFF_PAIRS=[[0,1],[1,2],[2,3],[3,4],[4,5],[5,6]];
  let bestSch=null,bestScore=[-1,-1,-1,-1];
  for(let attempt=0;attempt<8000;attempt++){
    seed=(randomize?Date.now():42)+attempt;
    const sch=Array.from({length:N},()=>Array(7).fill(null));
    for(const ai of alAll) for(let di=0;di<7;di++) sch[ai][di]="AL";
    for(let ai=0;ai<N;ai++) if(!alAll.has(ai)) for(const di in srMap[ai]) sch[ai][parseInt(di)]=srMap[ai][di];
    const agPri=new Array(N).fill(null),agOff=new Array(N).fill(null);
    for(let ai=0;ai<N;ai++){
      if(alAll.has(ai))continue;
      const srS=[];for(let di=0;di<7;di++){const s=sch[ai][di];if(s&&wk.includes(s))srS.push(s)}
      if(srS.length){const c={};srS.forEach(s=>c[s]=(c[s]||0)+1);agPri[ai]=Object.keys(c).reduce((a,b)=>c[a]>c[b]?a:b)}
      const srO=[];for(let di=0;di<7;di++)if(sch[ai][di]==="OFF")srO.push(di);
      if(srO.length>=2)agOff[ai]=[srO[0],srO[1]];
    }
    const weekNeed={};for(const s of wk)weekNeed[s]=DAYS.reduce((sum,d)=>sum+(dist[d][s]||0),0);
    const demand={};for(const s of wk)demand[s]=Math.round(weekNeed[s]/maxWork);
    const have={};for(let ai=0;ai<N;ai++)if(agPri[ai])have[agPri[ai]]=(have[agPri[ai]]||0)+1;
    const pool=[];for(const s of wk){const n=Math.max(0,(demand[s]||0)-(have[s]||0));for(let i=0;i<n;i++)pool.push(s)}
    const sp=shuffle(pool);
    const unAsg=shuffle([...Array(N).keys()].filter(ai=>!alAll.has(ai)&&!agPri[ai]));
    let pi=0;
    for(const ai of unAsg){const al=gAllow(agents[ai].gender);let done=false;for(let j=pi;j<sp.length;j++){if(al.has(sp[j])){agPri[ai]=sp[j];[sp[j],sp[pi]]=[sp[pi],sp[j]];pi++;done=true;break}}if(!done){const opts=[...al].filter(s=>wk.includes(s));agPri[ai]=opts.length?opts[Math.floor(rng()*opts.length)]:"A"}}
    for(let ai=0;ai<N;ai++){
      if(alAll.has(ai)||agOff[ai])continue;const p=agPri[ai];
      let pairs=nightShifts.has(p)?[[0,1],[1,2]]:shuffle([...OFF_PAIRS]);
      const srO=[];for(let di=0;di<7;di++)if(sch[ai][di]==="OFF")srO.push(di);
      if(srO.length===1){const d0=srO[0],adj=[];if(d0>0)adj.push([d0-1,d0]);if(d0<6)adj.push([d0,d0+1]);for(const pr of adj){if(pr.every(d=>sch[ai][d]===null||sch[ai][d]==="OFF")){agOff[ai]=pr;break}}if(!agOff[ai])agOff[ai]=[d0,d0<6?d0+1:d0-1]}
      else{for(const pr of pairs){if(pr.every(d=>sch[ai][d]===null||sch[ai][d]==="OFF")){agOff[ai]=pr;break}}if(!agOff[ai])agOff[ai]=pairs[0]}
    }
    for(let ai=0;ai<N;ai++){if(alAll.has(ai))continue;for(let di=0;di<7;di++){if(sch[ai][di]!==null)continue;sch[ai][di]=agOff[ai]&&agOff[ai].includes(di)?"OFF":agPri[ai]}}
    let restFail=false;for(let ai=0;ai<N;ai++){if(!alAll.has(ai)&&!_checkRest(sch,ai,wk)){restFail=true;break}}
    if(restFail)continue;
    for(let iter=0;iter<200;iter++){let allOk=true;for(let di=0;di<7;di++){const dd=dist[DAYS[di]],counts={};for(let ai=0;ai<N;ai++)counts[sch[ai][di]]=(counts[sch[ai][di]]||0)+1;for(const sO of all){const excess=(counts[sO]||0)-(dd[sO]||0);if(excess<=0)continue;allOk=false;for(const sU of all){const deficit=(dd[sU]||0)-(counts[sU]||0);if(deficit<=0)continue;const cands=[];for(let ai=0;ai<N;ai++){if(alAll.has(ai)||sch[ai][di]!==sO)continue;if(srMap[ai][di]!==undefined)continue;if(wk.includes(sU)&&!gAllow(agents[ai].gender).has(sU))continue;if(sU==="OFF"&&sch[ai].filter(s=>s==="OFF").length>=maxOff)continue;if(sO==="OFF"&&sch[ai].filter(s=>s==="OFF").length<=1)continue;if(wk.includes(sU)&&sch[ai].filter(s=>wk.includes(s)).length>=maxWork)continue;const old=sch[ai][di];sch[ai][di]=sU;const rok=_checkRest(sch,ai,wk);sch[ai][di]=old;if(!rok)continue;let pen=0;if(agPri[ai]===sO&&sU!==sO)pen+=10;if(sU==="OFF"){const eo=[];for(let d2=0;d2<7;d2++)if(sch[ai][d2]==="OFF")eo.push(d2);if(eo.length&&!eo.some(e=>Math.abs(di-e)===1))pen+=5}cands.push([ai,pen])}cands.sort((a,b)=>a[1]-b[1]);let sw=0;for(const[ai]of cands){if(sw>=Math.min(excess,deficit))break;sch[ai][di]=sU;sw++}if(sw>0)break}}}if(allOk)break}
    let valid=true;
    for(let di=0;di<7&&valid;di++){const counts={};for(let ai=0;ai<N;ai++)counts[sch[ai][di]]=(counts[sch[ai][di]]||0)+1;const dd=dist[DAYS[di]];for(const s of all)if((counts[s]||0)!==(dd[s]||0)){valid=false;break}}
    if(!valid)continue;
    for(let ai=0;ai<N&&valid;ai++){const w=sch[ai].filter(s=>wk.includes(s)).length,o=sch[ai].filter(s=>s==="OFF").length;if(w>maxWork||o>maxOff){valid=false;break}}
    if(!valid)continue;
    for(let ai=0;ai<N&&valid;ai++){if(!alAll.has(ai)&&!_checkRest(sch,ai,wk)){valid=false;break}}
    if(!valid)continue;
    let rest12=0,consec=0,single=0,obc=0;
    for(let ai=0;ai<N;ai++){if(alAll.has(ai))continue;if(_checkRest(sch,ai,wk))rest12++;const offs=[];for(let di=0;di<7;di++)if(sch[ai][di]==="OFF")offs.push(di);if(offs.length===2&&Math.abs(offs[1]-offs[0])===1)consec++;const ws2=new Set();for(let di=0;di<7;di++){const s=sch[ai][di];if(wk.includes(s))ws2.add(s)}if(ws2.size<=1)single++;for(const ns of nightShifts){if(ws2.has(ns)){let cs=7;for(let di=0;di<7;di++)if(sch[ai][di]===ns){cs=di;break}if(cs>0&&sch[ai][cs-1]==="OFF")obc++;break}}}
    const score=[rest12,consec,single,obc];
    if(score[0]>bestScore[0]||(score[0]===bestScore[0]&&(score[1]>bestScore[1]||(score[1]===bestScore[1]&&score[2]>bestScore[2])))){bestScore=score;bestSch=sch.map(r=>[...r])}
    if(rest12===nonAL&&consec>=nonAL-3&&single>=nonAL-4)break;
  }
  if(bestSch)return{ok:true,schedule:bestSch};
  errors.push("Could not find valid schedule. Check that distribution totals match agent count and constraints don't conflict.");
  return{ok:false,errors};
}

// ══════════════════════════════════════════════════════
// RENDER
// ══════════════════════════════════════════════════════
function renderAll(){document.getElementById("bA").textContent=D.agents.length;document.getElementById("bS").textContent=D.shifts.length;renderDist();renderAgents();renderShifts();renderGR();renderAL();renderSR();popSel();save()}
function renderDist(){
  const ai=allIds();document.getElementById("dAC").textContent=D.agents.length;
  let h="<thead><tr><th>Day</th>";ai.forEach(s=>h+=`<th>${s}</th>`);h+="<th>Total</th><th></th></tr></thead><tbody>";
  DAYS.forEach(day=>{const dd=D.dist[day]||{};h+=`<tr><td style="font-weight:600">${day}</td>`;ai.forEach(s=>h+=`<td><input class="di" type="number" min="0" value="${dd[s]||0}" data-d="${day}" data-s="${s}" onchange="chDist(this)"></td>`);const t=ai.reduce((s,id)=>s+(dd[id]||0),0);const ok=t===D.agents.length;h+=`<td class="dt ${ok?"dok":"dbd"}">${t}</td><td class="dt ${ok?"dok":"dbd"}">${ok?"✓":"≠"+D.agents.length}</td></tr>`});
  document.getElementById("dTbl").innerHTML=h+"</tbody>";
  ["qaDay","qaFrom","qaTo"].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.innerHTML=(i===0?DAYS:ai).map(v=>`<option>${v}</option>`).join("")});
}
function chDist(el){D.dist[el.dataset.d][el.dataset.s]=parseInt(el.value)||0;renderDist();save()}
function quickAdj(){const d=document.getElementById("qaDay").value,f=document.getElementById("qaFrom").value,t=document.getElementById("qaTo").value,a=parseInt(document.getElementById("qaAmt").value)||1;if(f===t)return toast("Same","err");if((D.dist[d][f]||0)<a)return toast("Not enough","err");D.dist[d][f]-=a;D.dist[d][t]=(D.dist[d][t]||0)+a;renderDist();save();toast(`Moved ${a}: ${f}→${t}`)}
function renderAgents(){const el=document.getElementById("aList");if(!D.agents.length){el.innerHTML='<div class="emp">No agents.</div>';return}el.innerHTML=D.agents.map(a=>`<div class="ar"><span class="gb ${a.gender==="F"?"gf":"gm"}">${a.gender}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis" title="${a.name}">${a.name}</span><button class="btn bd bsm bic" onclick="delAgent('${a.id}')">✕</button></div>`).join("")}
function renderAgentLinks(){const el=document.getElementById("agLinksArea");if(!el)return;const base=location.origin+location.pathname;el.innerHTML=D.agents.map(a=>'<div class="ar"><span class="gb '+(a.gender==="F"?"gf":"gm")+'" style="font-size:9px">'+a.gender+'</span><b style="min-width:160px;font-size:11px;overflow:hidden;text-overflow:ellipsis">'+a.name+'</b><code style="font-family:var(--mono);font-size:9px;color:var(--cyn);background:var(--s3);padding:2px 5px;border-radius:3px;flex:1;word-break:break-all;overflow:hidden;text-overflow:ellipsis">'+base+'?agent='+a.id+'</code><button class="btn bs2 bsm" style="font-size:10px" onclick="navigator.clipboard.writeText(\''+base+'?agent='+a.id+'\');toast(\'Copied!\')">Copy</button></div>').join("")}
function addAgent(){const n=document.getElementById("nAN").value.trim(),g=document.getElementById("nAG").value;if(!n)return toast("Name required","err");D.agents.push({id:uid(),name:n,gender:g});document.getElementById("nAN").value="";hideEl("addAF");renderAll();toast("Added")}
function delAgent(id){if(!confirm("Remove?"))return;D.agents=D.agents.filter(a=>a.id!==id);D.al=D.al.filter(x=>x.aid!==id);D.sr=D.sr.filter(x=>x.aid!==id);renderAll()}
function renderShifts(){
  const el=document.getElementById("sList");
  el.innerHTML=D.shifts.map(s=>`<div class="shift-card" style="border-left-color:${s.color}"><span class="s-badge" style="background:${s.color}">${s.id}</span><input class="s-name" value="${s.name}" style="background:transparent;border:none;color:var(--tx);font-size:14px;font-weight:600;width:150px" onchange="updS('${s.id}','name',this.value)"><span class="s-time">${s.start} → ${s.end}</span><input type="time" value="${s.start}" onchange="updS('${s.id}','start',this.value)" style="width:110px"><span style="color:var(--tx3)">to</span><input type="time" value="${s.end}" onchange="updS('${s.id}','end',this.value)" style="width:110px"><input type="color" value="${s.color}" onchange="updS('${s.id}','color',this.value)"><button class="btn bd bsm bic" onclick="delShift('${s.id}')">✕</button></div>`).join("");
}
function addShift(){const id=document.getElementById("nSI").value.trim().toUpperCase();if(!id||id==="OFF"||id==="AL")return toast("Invalid","err");if(D.shifts.find(s=>s.id===id))return toast("Exists","err");D.shifts.push({id,name:document.getElementById("nSN").value.trim()||id,start:document.getElementById("nSS").value,end:document.getElementById("nSE").value,color:document.getElementById("nSC").value});DAYS.forEach(d=>D.dist[d][id]=0);hideEl("addSF");renderAll();toast("Shift added")}
function updS(id,f,v){const s=D.shifts.find(x=>x.id===id);if(s){s[f]=v;renderShifts();save()}}
function delShift(id){if(!confirm("Delete "+id+"?"))return;D.shifts=D.shifts.filter(s=>s.id!==id);DAYS.forEach(d=>delete D.dist[d][id]);D.sr=D.sr.filter(x=>x.sid!==id);for(const g in D.genderRules)D.genderRules[g]=D.genderRules[g].filter(x=>x!==id);renderAll()}
function renderGR(){const area=document.getElementById("grArea"),wk=workIds();let h='<p style="font-size:11.5px;color:var(--tx2);margin-bottom:10px">Check which shifts each gender <b>can</b> work. None = all.</p>';["F","M"].forEach(g=>{const al=D.genderRules[g]||[];h+=`<div class="fr" style="margin-bottom:8px"><label style="width:70px;font-weight:600">${g==="F"?"Female":"Male"}</label>`;wk.forEach(sid=>{h+=`<label style="display:inline-flex;align-items:center;gap:3px;cursor:pointer;font-size:12px"><input type="checkbox" ${al.includes(sid)?"checked":""} onchange="tgGR('${g}','${sid}',this.checked)"> ${sid}</label>`});if(!al.length)h+='<span style="font-size:10.5px;color:var(--grn);margin-left:6px">All</span>';h+="</div>"});area.innerHTML=h}
function tgGR(g,sid,on){if(!D.genderRules[g])D.genderRules[g]=[];if(on){if(!D.genderRules[g].includes(sid))D.genderRules[g].push(sid)}else D.genderRules[g]=D.genderRules[g].filter(x=>x!==sid);renderGR();save()}
function saveRules(){D.rules.max_off=parseInt(document.getElementById("rMO").value);D.rules.max_work=parseInt(document.getElementById("rMW").value);save();toast("Saved")}
function alDays(start,end){const s=new Date(start+"T00:00:00"),e=new Date(end+"T00:00:00");if(e<s)return 0;return Math.round((e-s)/86400000)+1}
function alStatusColor(st){return{Pending:"#f59e0b",Approved:"#10b981",Completed:"#6b7280",Ongoing:"#3b82f6",Rejected:"#ef4444"}[st]||"#586380"}
function alYear(d,rec){if(rec&&rec.yearTag)return rec.yearTag;return new Date(d+"T00:00:00").getFullYear()}
if(!D.alRules)D.alRules={totalDays:30,noticeDays:14,maxConcurrent:2,minCoverage:10,notifyDays:7,blackoutDates:""};
let AL_YEAR=2026;
function setALYear(y){AL_YEAR=y;document.querySelectorAll(".alYearBtn").forEach(b=>{b.className="btn bsm alYearBtn "+(b.dataset.y==String(y)?"bp":"bs2")});renderAL()}
function alFiltered(){if(AL_YEAR==="all")return D.al;return D.al.filter(a=>alYear(a.start,a)===AL_YEAR||alYear(a.end,a)===AL_YEAR)}
function alOverlap(start,end,excludeId){const s=new Date(start+"T00:00:00"),e=new Date(end+"T00:00:00");return D.al.filter(a=>{if(a.id===excludeId)return false;const st=a.status||"Approved";if(st==="Rejected"||st==="Completed")return false;const as2=new Date(a.start+"T00:00:00"),ae=new Date(a.end+"T00:00:00");return as2<=e&&ae>=s})}
function alValidateRequest(aid,start,end,excludeId){const errs=[],warns=[];const days=alDays(start,end);const maxConc=D.alRules?.maxConcurrent||2;const overlap=alOverlap(start,end,excludeId);if(overlap.length>=maxConc)errs.push("❌ BLOCKED: "+overlap.length+" agents already on leave (max "+maxConc+"). Overlapping: "+overlap.map(a=>a.name).join(", "));
  const today=new Date();const startD=new Date(start+"T00:00:00");const notice=Math.round((startD-today)/86400000);if(notice<(D.alRules?.noticeDays||14))warns.push("⚠ Only "+notice+" days notice (min "+(D.alRules?.noticeDays||14)+")");
  const blackout=(D.alRules?.blackoutDates||"").split(",").map(x=>x.trim()).filter(Boolean);for(const bd of blackout){const bdt=new Date(bd+"T00:00:00");if(bdt>=new Date(start+"T00:00:00")&&bdt<=new Date(end+"T00:00:00"))errs.push("❌ Includes blackout date: "+bd)}
  const yr=alYear(start);const agLeaves=D.al.filter(a=>a.aid===aid&&a.id!==excludeId&&alYear(a.start)===yr&&(a.status||"Approved")!=="Rejected");const usedDays=agLeaves.reduce((s,a)=>s+alDays(a.start,a.end),0);const totalYear=D.alRules?.totalDays||30;if(usedDays+days>totalYear)warns.push("⚠ Would exceed yearly allowance: "+usedDays+"+"+days+"="+( usedDays+days)+" / "+totalYear+" days for "+yr);
  return{days,errs,warns,overlap,blocked:errs.length>0}}
function saveALRules(){D.alRules={totalDays:parseInt(document.getElementById("alrTotal").value)||30,noticeDays:parseInt(document.getElementById("alrNotice").value)||14,maxConcurrent:parseInt(document.getElementById("alrMaxConc").value)||2,minCoverage:parseInt(document.getElementById("alrMinCoverage").value)||10,notifyDays:parseInt(document.getElementById("alrNotifyDays").value)||7,blackoutDates:(document.getElementById("alrBlackout").value||"").trim()};save();toast("Rules saved")}
function loadALRules(){if(!D.alRules)return;const r=D.alRules;const g=id=>document.getElementById(id);if(g("alrTotal"))g("alrTotal").value=r.totalDays||30;if(g("alrNotice"))g("alrNotice").value=r.noticeDays||14;if(g("alrMaxConc"))g("alrMaxConc").value=r.maxConcurrent||2;if(g("alrMinCoverage"))g("alrMinCoverage").value=r.minCoverage||10;if(g("alrNotifyDays"))g("alrNotifyDays").value=r.notifyDays||7;if(g("alrBlackout"))g("alrBlackout").value=r.blackoutDates||""}
function alPreview(){const s=document.getElementById("alS").value,e=document.getElementById("alE").value,aid=document.getElementById("alA").value,el=document.getElementById("alPreview");if(!el||!s||!e){if(el)el.innerHTML="";return}const v=alValidateRequest(aid,s,e);el.innerHTML='<div style="font-size:12px"><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+v.days+' days</span>'+(v.errs.length?'<div style="margin-top:4px">'+v.errs.map(w=>'<div style="color:var(--red);font-size:11px;font-weight:600">'+w+'</div>').join("")+"</div>":"")+(v.warns.length?'<div style="margin-top:2px">'+v.warns.map(w=>'<div style="color:var(--orn);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(!v.errs.length&&!v.warns.length?'<span style="color:var(--grn);margin-left:8px">✓ No issues</span>':"")+"</div>"}
function renderAL(){const el=document.getElementById("alL");const filtered=alFiltered();document.getElementById("alCount").textContent=filtered.length;if(!filtered.length){el.innerHTML='<div class="emp">No leave records'+(AL_YEAR!=="all"?" for "+AL_YEAR:"")+'.</div>';renderALBalance();renderALNotify();renderALPending();return}const sorted=[...filtered].sort((a,b)=>new Date(a.start)-new Date(b.start));el.innerHTML=sorted.map(a=>{const days=alDays(a.start,a.end);const st=a.status||"Approved";const ol=alOverlap(a.start,a.end,a.id);const olWarn=ol.length>=(D.alRules?.maxConcurrent||2)?' <span style="color:var(--red);font-size:10px;font-weight:700">⚠ OVERLAP('+ol.length+')</span>':"";return'<div class="ir" style="border-left:4px solid '+alStatusColor(st)+'"><span class="tg" style="background:'+alStatusColor(st)+'20;color:'+alStatusColor(st)+'">'+st+'</span><b style="min-width:180px">'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' → '+a.end+'</span><span style="font-family:var(--mono);font-weight:700;color:var(--cyn);min-width:50px">'+days+'d</span>'+olWarn+'<select onchange="chALStatus(\''+a.id+'\',this.value)" style="width:90px;font-size:10px;padding:3px"><option '+(st==="Pending"?"selected":"")+'>Pending</option><option '+(st==="Approved"?"selected":"")+'>Approved</option><option '+(st==="Ongoing"?"selected":"")+'>Ongoing</option><option '+(st==="Completed"?"selected":"")+'>Completed</option><option '+(st==="Rejected"?"selected":"")+'>Rejected</option></select>'+(a.adminNote?'<span style="font-size:10px;color:var(--tx3)" title="'+a.adminNote+'">💬</span>':'')+(a.yearTag&&a.yearTag!==new Date(a.start+"T00:00:00").getFullYear()?'<span style="font-size:9px;background:#4c1d95;color:#c4b5fd;padding:1px 5px;border-radius:3px">→'+a.yearTag+'</span>':'')+'<button class="btn bs2 bsm bic" onclick="editALDates(\''+a.id+'\')" title="Edit dates">✏</button><button class="btn bs2 bsm bic" onclick="editALYear(\''+a.id+'\')" title="Assign year">📅</button><button class="btn bs2 bsm bic" onclick="addALNote(\''+a.id+'\')" title="Add note">💬</button><button class="btn bd bsm bic" onclick="delAL(\''+a.id+'\')">✕</button></div>'}).join("");renderALBalance();renderALNotify();renderALPending();renderALLinks();loadALRules()}
function chALStatus(id,st){const a=D.al.find(x=>x.id===id);if(a){a.status=st;a.decidedAt=new Date().toISOString();save();renderAL();autoCloudSync()}}
async function autoCloudSync(){if(!SB||!SB_WS||!SB_WEEK_ID)return;try{await SB.from("weeks").update({annual_leave_json:D.al,settings_json:{shifts:D.shifts,rules:D.rules,genderRules:D.genderRules,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows,alRules:D.alRules||{},swapRequests:D.swapRequests||[],kpis:D.kpis||{},coaching:D.coaching||[],incidents:D.incidents||[],kb:D.kb||[]},attendance_json:D.attendance||{},roster_json:D.roster||null,breaks_json:BK.results||null}).eq("id",SB_WEEK_ID)}catch(e){console.log("Auto-sync failed:",e)}}
function editALDates(id){const a=D.al.find(x=>x.id===id);if(!a)return;const ns=prompt("Start date (YYYY-MM-DD):",a.start);if(!ns)return;const ne=prompt("End date (YYYY-MM-DD):",a.end);if(!ne)return;if(new Date(ne)<new Date(ns)){toast("End before start","err");return}a.start=ns;a.end=ne;save();renderAL();toast("Dates updated: "+alDays(ns,ne)+" days")}
function editALYear(id){const a=D.al.find(x=>x.id===id);if(!a)return;const yr=prompt("Assign to year (e.g. 2025 or 2026):",a.yearTag||alYear(a.start));if(!yr)return;a.yearTag=parseInt(yr);save();renderAL();toast("Assigned to "+yr)}
function addALNote(id){const a=D.al.find(x=>x.id===id);if(!a)return;const note=prompt("Admin note for "+a.name+":",a.adminNote||"");if(note!==null){a.adminNote=note;save();renderAL()}}
function addAL(){const aid=document.getElementById("alA").value,s=document.getElementById("alS").value,e=document.getElementById("alE").value,st=document.getElementById("alSt").value;if(!aid||!s||!e)return toast("Fill all","err");if(new Date(e)<new Date(s))return toast("End before start","err");const v=alValidateRequest(aid,s,e);if(v.blocked&&st!=="Rejected"){if(!confirm("⚠ OVERLAP VIOLATION\\n\\n"+v.errs.join("\\n")+"\\n\\nAdd anyway?"))return}const ag=D.agents.find(a=>a.id===aid);D.al.push({id:uid(),aid,name:ag?.name||"",start:s,end:e,status:st,addedAt:new Date().toISOString()});renderAL();save();toast("Leave added — "+v.days+" days")}
function delAL(id){if(!confirm("Delete this leave?"))return;D.al=D.al.filter(x=>x.id!==id);renderAL();save()}
function renderALBalance(){const el=document.getElementById("alBalance");if(!el)return;const yr=AL_YEAR==="all"?null:AL_YEAR;const totalYear=D.alRules?.totalDays||30;const byAgent={};D.agents.forEach(a=>byAgent[a.id]={name:a.name,used:0,pending:0,approved:0});D.al.forEach(a=>{if(!byAgent[a.aid])return;if(yr&&alYear(a.start)!==yr)return;const days=alDays(a.start,a.end);const st=a.status||"Approved";if(st==="Completed"||st==="Ongoing")byAgent[a.aid].used+=days;else if(st==="Approved")byAgent[a.aid].approved+=days;else if(st==="Pending")byAgent[a.aid].pending+=days});let h='<div class="tw"><table><thead><tr><th style="text-align:left">Agent</th><th>Year</th><th>Entitled</th><th>Used</th><th>Approved</th><th>Pending</th><th>Remaining</th></tr></thead><tbody>';const entries=Object.entries(byAgent).filter(([,b])=>b.used||b.approved||b.pending).sort((a,b)=>(totalYear-a[1].used-a[1].approved)-(totalYear-b[1].used-b[1].approved));for(const[aid,b]of entries){const rem=totalYear-b.used-b.approved;const remC=rem<=0?"var(--red)":rem<=5?"var(--orn)":"var(--grn)";h+='<tr><td style="text-align:left">'+b.name+'</td><td style="font-family:var(--mono);color:var(--tx3)">'+(yr||"All")+'</td><td style="font-family:var(--mono)">'+totalYear+'</td><td style="font-family:var(--mono)">'+b.used+'</td><td style="font-family:var(--mono)">'+b.approved+'</td><td style="font-family:var(--mono);color:var(--orn)">'+b.pending+'</td><td style="font-family:var(--mono);font-weight:700;color:'+remC+'">'+rem+'</td></tr>'}h+='</tbody></table></div>';el.innerHTML=h}
function renderALNotify(){const el=document.getElementById("alNotifications");if(!el)return;const notifyDays=D.alRules?.notifyDays||7;const today=new Date();const upcoming=[];D.al.forEach(a=>{if(a.status==="Rejected"||a.status==="Completed")return;const startD=new Date(a.start+"T00:00:00");const daysUntil=Math.round((startD-today)/86400000);if(daysUntil>=0&&daysUntil<=notifyDays)upcoming.push({name:a.name,start:a.start,end:a.end,status:a.status||"Approved",daysUntil,days:alDays(a.start,a.end)})});if(!upcoming.length){el.innerHTML="";return}upcoming.sort((a,b)=>a.daysUntil-b.daysUntil);el.innerHTML='<div class="card" style="border-left:4px solid var(--orn)"><div class="ch"><h3 style="color:var(--orn)">&#128276; Upcoming Leave</h3></div><div class="cb">'+upcoming.map(a=>'<div class="ar" style="border-left:3px solid '+(a.daysUntil<=2?"var(--red)":"var(--orn)")+'"><span class="tg" style="background:'+(a.daysUntil<=2?"#7f1d1d":"#78350f")+';color:'+(a.daysUntil<=2?"#fca5a5":"#fcd34d")+'">'+(a.daysUntil===0?"TODAY":a.daysUntil===1?"TOMORROW":"in "+a.daysUntil+"d")+'</span><b>'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' → '+a.end+' ('+a.days+'d)</span><span class="tg" style="background:'+alStatusColor(a.status)+'20;color:'+alStatusColor(a.status)+'">'+a.status+'</span></div>').join("")+'</div></div>'}
function renderALPending(){const el=document.getElementById("alPendingRequests");if(!el)return;const pending=D.al.filter(a=>(a.status||"Approved")==="Pending"&&a.source==="agent");if(!pending.length){el.innerHTML="";return}el.innerHTML='<div class="card" style="border-left:4px solid var(--pur)"><div class="ch"><h3 style="color:var(--pur)">&#128233; Agent Requests Awaiting Approval</h3></div><div class="cb">'+pending.map(a=>{const v=alValidateRequest(a.aid,a.start,a.end,a.id);return'<div class="ar" style="border-left:3px solid var(--pur)"><b>'+a.name+'</b><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">'+a.start+' → '+a.end+' ('+v.days+'d)</span>'+(v.blocked?'<span style="font-size:10px;color:var(--red);font-weight:700">⚠ OVERLAP</span>':'<span style="font-size:10px;color:var(--grn)">✓ OK</span>')+'<button class="btn bg bsm" onclick="chALStatus(\''+a.id+'\',\'Approved\')">✓ Approve</button><button class="btn bd bsm" onclick="rejectALRequest(\''+a.id+'\')">✗ Reject</button></div>'}).join("")+'</div></div>'}
function rejectALRequest(id){const reason=prompt("Rejection reason:");if(reason===null)return;const a=D.al.find(x=>x.id===id);if(a){a.status="Rejected";a.adminNote=reason;a.decidedAt=new Date().toISOString();save();renderAL();toast("Rejected with comment")}}
function renderALLinks(){const el=document.getElementById("alLinksArea");if(!el)return;const base=location.origin+location.pathname;el.innerHTML='<p style="font-size:12px;color:var(--tx2);margin-bottom:10px">Each agent gets a unique link to view their schedule, breaks, and AL — and submit leave requests.</p><div style="max-height:300px;overflow-y:auto">'+D.agents.map(a=>'<div class="ar"><b style="min-width:200px;font-size:12px">'+a.name+'</b><code style="font-family:var(--mono);font-size:10px;color:var(--cyn);background:var(--s3);padding:2px 6px;border-radius:3px;word-break:break-all;flex:1">'+base+'?agent='+a.id+'</code><button class="btn bs2 bsm" onclick="navigator.clipboard.writeText(\''+base+'?agent='+a.id+'\');toast(\'Copied!\')">Copy</button></div>').join("")+'</div>'}
function renderSR(){const el=document.getElementById("srL");if(!D.sr.length){el.innerHTML='<div class="emp">No requests.</div>';return}const byA={};D.sr.forEach(s=>{if(!byA[s.aid])byA[s.aid]=[];byA[s.aid].push(s)});let h="";for(const aid in byA){const items=byA[aid];const byS={};items.forEach(s=>{if(!byS[s.sid])byS[s.sid]=[];byS[s.sid].push(s)});for(const sid in byS){const g=byS[sid],days=g.map(s=>s.day).join(", "),ids=g.map(s=>s.id);h+=`<div class="ir"><span class="tg tgh">HARD</span><b>${g[0].name}</b><span style="color:var(--tx2)">${sid} → ${days}</span><span style="flex:1"></span><button class="btn bd bsm" onclick="delSRG('${ids.join(",")}')">✕</button></div>`}}el.innerHTML=h}
function initSRD(){document.getElementById("srDays").innerHTML=DAYS.map(d=>`<label><input type="checkbox" value="${d}" checked><span>${d}</span></label>`).join("")}
function toggleAllD(){const c=document.querySelectorAll("#srDays input");const on=[...c].every(x=>x.checked);c.forEach(x=>x.checked=!on)}
function addSR(){const aid=document.getElementById("srA").value,sid=document.getElementById("srSh").value;const days=[...document.querySelectorAll("#srDays input:checked")].map(c=>c.value);if(!aid||!sid||!days.length)return toast("Select all","err");const ag=D.agents.find(a=>a.id===aid);days.forEach(day=>{D.sr=D.sr.filter(x=>!(x.aid===aid&&x.day===day));D.sr.push({id:uid(),aid,name:ag?.name||"",day,sid,type:"hard"})});renderSR();save();toast(`Added ${sid} × ${days.length} days`)}
function delSRG(s){const ids=s.split(",");D.sr=D.sr.filter(x=>!ids.includes(x.id));renderSR();save()}
function popSel(){const ao=D.agents.map(a=>`<option value="${a.id}">${a.gender==="F"?"♀":"♂"} ${a.name}</option>`).join("");["alA","srA"].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=ao});const el=document.getElementById("srSh");if(el)el.innerHTML=allIds().map(s=>`<option>${s}</option>`).join("");initSRD()}

function doGen(){const btn=document.getElementById("btnG");btn.innerHTML='<span class="spin"></span>';btn.disabled=true;setTimeout(()=>{try{const t0=performance.now();const r=solve(document.getElementById("tRand").classList.contains("on"));const ms=Math.round(performance.now()-t0);if(r.ok){buildRoster(r.schedule);toast(`Generated in ${ms}ms`);document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-roster").style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="roster"]').classList.add("on")}else toast(r.errors[0],"err")}catch(e){toast("Solver error: "+e.message,"err");console.error(e)}btn.innerHTML="&#9654; Generate";btn.disabled=false},30)}
function buildRoster(sch){const wk=workIds(),N=D.agents.length;D.roster=D.agents.map((a,ai)=>{const shifts={};let wd=0,od=0,ald=0;DAYS.forEach((d,di)=>{const s=sch[ai][di];shifts[d]=s;if(wk.includes(s))wd++;else if(s==="OFF")od++;else if(s==="AL")ald++});return{...a,shifts,wd,od,ald}});D.summary={};DAYS.forEach((day,di)=>{const c={};for(let ai=0;ai<N;ai++){const s=sch[ai][di];c[s]=(c[s]||0)+1}D.summary[day]=c});const bREl=document.getElementById("bR");if(bREl)bREl.textContent=N;renderRoster();save()}
function renderRoster(){if(!D.roster){document.getElementById("rArea").innerHTML='<div class="emp">No schedule yet.</div>';return}const ai=allIds();let h='';
  // Show pending swap requests from agents
  if(D.swapRequests&&D.swapRequests.filter(r=>r.status==="Pending").length){h+='<div style="background:#1e1b4b;border:1px solid #312e81;border-radius:8px;padding:10px 14px;margin-bottom:10px"><div style="font-size:12px;font-weight:700;color:#a78bfa;margin-bottom:6px">🔄 Shift Swap Requests</div>';D.swapRequests.filter(r=>r.status==="Pending").forEach(r=>{const from=D.roster.find(x=>x.id===r.from),to=D.roster.find(x=>x.id===r.to);if(!from||!to)return;h+='<div style="display:flex;align-items:center;gap:8px;padding:4px 0;flex-wrap:wrap"><b style="font-size:11px">'+r.fromName+'</b> <span class="sb" style="background:'+sColor(from.shifts[r.day])+';height:18px;min-width:28px;font-size:9px">'+from.shifts[r.day]+'</span> <span style="font-size:11px;color:var(--tx3)">↔</span> <b style="font-size:11px">'+r.toName+'</b> <span class="sb" style="background:'+sColor(to.shifts[r.day])+';height:18px;min-width:28px;font-size:9px">'+to.shifts[r.day]+'</span> <span style="font-size:10px;color:var(--tx3)">on '+r.day+'</span><button class="btn bg bsm" style="font-size:10px;padding:2px 8px" onclick="approveSwapReq(\''+r.id+'\')">✓ Approve</button><button class="btn bd bsm" style="font-size:10px;padding:2px 8px" onclick="rejectSwapReq(\''+r.id+'\')">✗ Reject</button></div>'});h+='</div>'}
  if(SWAP_MODE)h+='<div style="background:#78350f;border:1px solid #92400e;border-radius:6px;padding:8px 12px;margin-bottom:10px;font-size:12px;color:#fcd34d">&#128260; <b>SWAP MODE</b> — Click another agent on <b>'+SWAP_MODE.day+'</b> to swap with <b>'+D.roster[SWAP_MODE.ri].name+'</b> <button class="btn bs2 bsm" style="margin-left:8px" onclick="SWAP_MODE=null;renderRoster()">Cancel</button></div>';
  h+='<div class="tw"><table><thead><tr><th style="text-align:left;min-width:180px">Agent</th><th>G</th>';DAYS.forEach(d=>h+=`<th>${d}</th>`);h+="<th>W</th><th>O</th><th>AL</th></tr></thead><tbody>";D.roster.forEach((r,ri)=>{const isSwapSrc=SWAP_MODE&&SWAP_MODE.ri===ri;h+=`<tr style="${isSwapSrc?"background:rgba(245,158,11,0.1)":""}"><td title="${r.name}" style="max-width:220px;overflow:hidden;text-overflow:ellipsis">${isSwapSrc?"🔄 ":""}${r.name}</td><td><span class="gb ${r.gender==="F"?"gf":"gm"}" style="font-size:9px">${r.gender}</span></td>`;DAYS.forEach((d,di)=>{const s=r.shifts[d];const isSwapDay=SWAP_MODE&&SWAP_MODE.day===d&&!isSwapSrc;h+=`<td><span class="sb" style="background:${sColor(s)};cursor:pointer;${isSwapDay?"outline:2px solid #f59e0b;outline-offset:1px":""}" onclick="swapShift(${ri},'${d}')" title="${isSwapDay?"Click to swap":"Click to change"}">${s}</span></td>`});h+=`<td style="font-family:var(--mono);font-weight:600">${r.wd}</td><td style="font-family:var(--mono);font-weight:600">${r.od}</td><td style="font-family:var(--mono);font-weight:600">${r.ald}</td></tr>`});document.getElementById("rArea").innerHTML=h+"</tbody></table></div>";
let sh='<div style="margin-top:16px"><h3 style="font-size:12px;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px">Daily Summary</h3><div class="sg">';DAYS.forEach(day=>{const c=D.summary[day]||{};sh+=`<div class="sc"><div class="scd">${day}</div><div class="scs">`;ai.forEach(sid=>{sh+=`<span class="sb" style="background:${sColor(sid)};font-size:9.5px;min-width:40px;height:20px">${sid}:${c[sid]||0}</span>`});sh+="</div></div>"});document.getElementById("sArea").innerHTML=sh+"</div></div>"}
// Inline shift swap + agent-to-agent swap
let SWAP_MODE=null;
function swapShift(ri,day){const r=D.roster[ri];if(!r)return;const cur=r.shifts[day];
  // If swap mode is active, do agent-to-agent swap
  if(SWAP_MODE&&SWAP_MODE.day===day&&SWAP_MODE.ri!==ri){const r2=D.roster[SWAP_MODE.ri];const s1=r.shifts[day],s2=r2.shifts[day];
    const wk2=workIds();
    for(const[ag,ns] of [[r,s2],[r2,s1]]){const old={};DAYS.forEach(d=>old[d]=ag.shifts[d]);old[day]=ns;
      for(let i=0;i<6;i++){const a=old[DAYS[i]],b=old[DAYS[i+1]];if(wk2.includes(a)&&wk2.includes(b)&&!_restOk(a,b)){toast(ag.name+": rest violation "+a+"→"+b,"err");SWAP_MODE=null;renderRoster();return}}}
    r.shifts[day]=s2;r2.shifts[day]=s1;
    [r,r2].forEach(ag=>{let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=ag.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});ag.wd=wd2;ag.od=od2;ag.ald=ald2});
    D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
    SWAP_MODE=null;renderRoster();save();toast("Swapped: "+r.name+" ↔ "+r2.name+" on "+day);return}
  if(SWAP_MODE){SWAP_MODE=null;renderRoster();return}
  // Show inline action popup
  const popup=document.createElement("div");popup.id="shiftPopup";popup.style.cssText="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--s1);border:1px solid var(--brd);border-radius:10px;padding:16px;z-index:9000;min-width:280px;box-shadow:0 8px 32px rgba(0,0,0,.5)";
  let ph='<div style="font-size:13px;font-weight:700;margin-bottom:10px">'+r.name+' — '+day+' <span class="sb" style="background:'+sColor(cur)+'">'+cur+'</span></div>';
  ph+='<div style="font-size:11px;color:var(--tx2);margin-bottom:8px">Change shift:</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px">';
  allIds().forEach(sid=>{ph+='<span class="sb" style="background:'+sColor(sid)+';cursor:pointer;'+(sid===cur?"outline:2px solid #fff;":"opacity:0.7")+'" onclick="doShiftChange('+ri+',\''+day+'\',\''+sid+'\')">'+sid+'</span>'});
  ph+='</div><div style="display:flex;gap:6px"><button class="btn bp bsm" onclick="SWAP_MODE={ri:'+ri+',day:\''+day+'\'};document.getElementById(\'shiftPopup\').remove();renderRoster();toast(\'Click another agent on '+day+' to swap\')">↔ Swap Agents</button><button class="btn bs2 bsm" onclick="document.getElementById(\'shiftPopup\').remove()">Cancel</button></div>';
  popup.innerHTML=ph;document.body.appendChild(popup)}
function doShiftChange(ri,day,ns){document.getElementById("shiftPopup")?.remove();const r=D.roster[ri];const cur=r.shifts[day];if(ns===cur)return;
  const wk2=workIds();const oldShifts={};DAYS.forEach(d=>oldShifts[d]=r.shifts[d]);oldShifts[day]=ns;
  for(let i=0;i<6;i++){const s1=oldShifts[DAYS[i]],s2=oldShifts[DAYS[i+1]];if(wk2.includes(s1)&&wk2.includes(s2)&&!_restOk(s1,s2)){toast("Rest violation: "+s1+"→"+s2,"err");return}}
  r.shifts[day]=ns;
  let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=r.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});r.wd=wd2;r.od=od2;r.ald=ald2;
  D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
  const dist=D.dist[day]||{};const actual=D.summary[day]||{};let distOk=true;allIds().forEach(sid=>{if((actual[sid]||0)!==(dist[sid]||0))distOk=false});
  renderRoster();save();toast(r.name+": "+day+" → "+ns+(distOk?"":" ⚠ Distribution mismatch!"))}
function approveSwapReq(reqId){if(!D.swapRequests)return;const req=D.swapRequests.find(r=>r.id===reqId);if(!req)return;
  const fromR=D.roster.find(r=>r.id===req.from),toR=D.roster.find(r=>r.id===req.to);if(!fromR||!toR){toast("Agents not found","err");return}
  const s1=fromR.shifts[req.day],s2=toR.shifts[req.day];fromR.shifts[req.day]=s2;toR.shifts[req.day]=s1;
  const wk2=workIds();[fromR,toR].forEach(ag=>{let wd2=0,od2=0,ald2=0;DAYS.forEach(d=>{const s=ag.shifts[d];if(wk2.includes(s))wd2++;else if(s==="OFF")od2++;else if(s==="AL")ald2++});ag.wd=wd2;ag.od=od2;ag.ald=ald2});
  D.summary={};DAYS.forEach(d=>{const c={};D.roster.forEach(ag=>{const s=ag.shifts[d];c[s]=(c[s]||0)+1});D.summary[d]=c});
  req.status="Approved";req.decidedAt=new Date().toISOString();save();renderRoster();toast("Swap approved: "+req.fromName+" ↔ "+req.toName+" on "+req.day)}
function rejectSwapReq(reqId){if(!D.swapRequests)return;const req=D.swapRequests.find(r=>r.id===reqId);if(!req)return;req.status="Rejected";req.decidedAt=new Date().toISOString();save();renderRoster();toast("Swap rejected")}
// ═══ ARCHIVE ═══
function getArchiveKey(){return"ys_archive"}
function loadArchiveList(){try{const s=localStorage.getItem(getArchiveKey());return s?JSON.parse(s):[]}catch(e){return[]}}
function saveArchiveList(list){try{localStorage.setItem(getArchiveKey(),JSON.stringify(list))}catch(e){}}
function saveWeekArchive(){if(!D.roster)return toast("Generate first","err");const wk=document.getElementById("wkStart").value;if(!wk)return toast("Set week date","err");const snap={week:wk,savedAt:new Date().toISOString(),data:JSON.parse(JSON.stringify(D)),breaks:BK.results?JSON.parse(JSON.stringify({results:BK.results,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows})):null};const list=loadArchiveList();const idx=list.findIndex(x=>x.week===wk);if(idx>=0){if(!confirm(`Overwrite saved week ${wk}?`))return;list[idx]=snap}else list.unshift(snap);saveArchiveList(list);renderArchive();toast(`Week ${wk} saved!`);
  // Also download as JSON file
  const blob=new Blob([JSON.stringify(snap,null,2)],{type:"application/json"});dl(blob,`schedule_${wk}.json`)}
function loadWeekArchive(wk){const list=loadArchiveList();const snap=list.find(x=>x.week===wk);if(!snap)return toast("Not found","err");if(!confirm(`Load week ${wk}? Current unsaved changes will be lost.`))return;Object.assign(D,snap.data);if(snap.breaks){BK.results=snap.breaks.results;BK.breakPattern=snap.breaks.breakPattern;BK.breakPatternC=snap.breaks.breakPatternC;BK.peakWindows=snap.breaks.peakWindows}else{BK.results=null}document.getElementById("wkStart").value=snap.week;document.getElementById("rMO").value=D.rules.max_off;document.getElementById("rMW").value=D.rules.max_work;renderAll();if(D.roster)renderRoster();toast(`Loaded week ${wk}`);document.querySelectorAll(".pg").forEach(x=>x.style.display="none");document.getElementById("p-roster").style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="roster"]').classList.add("on")}
function deleteWeekArchive(wk){if(!confirm(`Delete week ${wk}?`))return;const list=loadArchiveList().filter(x=>x.week!==wk);saveArchiveList(list);renderArchive();toast("Deleted")}
function renderArchive(){const el=document.getElementById("archList");const list=loadArchiveList();if(!list.length){el.innerHTML='<div class="emp">No saved weeks.</div>';return}el.innerHTML=list.map(s=>{const d=new Date(s.savedAt);const agents=s.data.roster?s.data.roster.length:s.data.agents.length;return`<div class="ar" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:10px"><b style="font-family:var(--mono)">${s.week}</b><span style="color:var(--tx2);font-size:11px">${agents} agents — saved ${d.toLocaleDateString()} ${d.toLocaleTimeString()}</span></div><div style="display:flex;gap:4px"><button class="btn bp bsm" onclick="loadWeekArchive('${s.week}')">Load</button><button class="btn bs2 bsm" onclick="dlArchive('${s.week}')">&#128229; JSON</button><button class="btn bd bsm bic" onclick="deleteWeekArchive('${s.week}')">✕</button></div></div>`}).join("")}
function dlArchive(wk){const list=loadArchiveList();const snap=list.find(x=>x.week===wk);if(!snap)return;dl(new Blob([JSON.stringify(snap,null,2)],{type:"application/json"}),`schedule_${wk}.json`)}
function importWeekFile(){document.getElementById("impFile").click()}
function handleImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const snap=JSON.parse(ev.target.result);if(!snap.data||!snap.week)throw"Invalid";const list=loadArchiveList();const idx=list.findIndex(x=>x.week===snap.week);if(idx>=0)list[idx]=snap;else list.unshift(snap);saveArchiveList(list);renderArchive();toast(`Imported week ${snap.week}`)}catch(err){toast("Invalid file","err")}};r.readAsText(f);e.target.value=""}
// ═══ TEAM VIEW EXPORT ═══
function exportTeamHTML(){if(!D.roster)return toast("Generate first","err");const wk=document.getElementById("wkStart").value;let h=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Schedule ${wk}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#0a0c10;color:#e2e6ef;padding:20px}h1{font-size:20px;margin-bottom:4px}h1 em{font-style:normal;color:#38bdf8}.sub{color:#8490a8;font-size:12px;margin-bottom:16px}table{width:100%;border-collapse:collapse;font-size:13px;background:#12151c;border-radius:10px;overflow:hidden}th{padding:10px;background:#1a1e28;color:#8490a8;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid #2a3148}td{padding:8px 10px;border-bottom:1px solid #2a3148;text-align:center;white-space:nowrap}td:first-child{text-align:left}.sb{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:24px;border-radius:5px;font-family:monospace;font-size:11px;font-weight:600;color:#fff}.sg{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:16px}.sc{background:#1a1e28;border-radius:8px;padding:10px;text-align:center}.scd{font-size:10px;font-weight:700;color:#8490a8;text-transform:uppercase;margin-bottom:6px}.scs{display:flex;flex-wrap:wrap;gap:2px;justify-content:center}.m{font-size:10px;color:#586380;margin-top:16px;text-align:center}</style></head><body>`;
  h+=`<h1><em>Yousef Shtawi</em> Schedule</h1><p class="sub">Week of ${wk} — ${D.roster.length} agents</p>`;
  h+=`<table><thead><tr><th style="text-align:left;min-width:180px">Agent</th><th>G</th>`;DAYS.forEach(d=>h+=`<th>${d}</th>`);h+=`<th>W</th><th>O</th><th>AL</th></tr></thead><tbody>`;
  D.roster.forEach(r=>{h+=`<tr><td>${r.name}</td><td>${r.gender}</td>`;DAYS.forEach(d=>{const s=r.shifts[d];h+=`<td><span class="sb" style="background:${sColor(s)}">${s}</span></td>`});h+=`<td>${r.wd}</td><td>${r.od}</td><td>${r.ald}</td></tr>`});
  h+=`</tbody></table><div class="sg">`;const ai2=allIds();DAYS.forEach(day=>{const c=D.summary[day]||{};h+=`<div class="sc"><div class="scd">${day}</div><div class="scs">`;ai2.forEach(sid=>{h+=`<span class="sb" style="background:${sColor(sid)};font-size:9px;min-width:36px;height:18px">${sid}:${c[sid]||0}</span>`});h+=`</div></div>`});
  h+=`</div><p class="m">Generated by Yousef Shtawi Schedule</p>`;
  // Add breaks if available — click-by-day tabs
  if(BK.results){h+=`<h2 style="font-size:16px;margin:20px 0 10px;color:#e2e6ef">Break Schedule</h2>`;
    h+=`<div style="display:flex;gap:4px;margin-bottom:12px">`;
    DAYS.forEach((day,i)=>{const dd=BK.results[day];if(!dd||!dd.assignments||!dd.assignments.length)return;h+=`<button onclick="document.querySelectorAll('.bkTabContent').forEach(e=>e.style.display='none');document.getElementById('bk_${day}').style.display='block';document.querySelectorAll('.bkTabBtn').forEach(b=>{b.style.background='#1a1e28';b.style.color='#8490a8'});this.style.background='#3b82f6';this.style.color='#fff'" class="bkTabBtn" style="padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:${i===0?'#3b82f6':'#1a1e28'};color:${i===0?'#fff':'#8490a8'}">${day}</button>`});
    h+=`</div>`;let first=true;
    DAYS.forEach(day=>{const dd=BK.results[day];if(!dd||!dd.assignments||!dd.assignments.length)return;
      const maxS=Math.max(BK.breakPattern.length,BK.breakPatternC.length,4);
      h+=`<div id="bk_${day}" class="bkTabContent" style="display:${first?'block':'none'}"><table><thead><tr><th style="text-align:left">Agent</th><th>Shift</th><th>Hours</th>`;
      for(let i=0;i<maxS;i++)h+=`<th>Break ${i+1}</th>`;h+=`<th>Total</th></tr></thead><tbody>`;
      for(const a of dd.assignments){const br=fBR(a.breakSlots,a.pattern);h+=`<tr><td style="text-align:left">${a.name}</td><td><span class="sb" style="background:${sColor(a.code)}">${a.code}</span></td><td style="font-family:monospace;font-size:11px">${mT2(a.start)}-${mT2(a.end)}</td>`;
        for(let i=0;i<maxS;i++)h+=i<br.length?`<td style="font-family:monospace;font-size:11px">${br[i]}</td>`:`<td style="color:#586380">—</td>`;
        h+=`<td style="font-family:monospace;font-weight:600">${a.breakSlots.length*15}m</td></tr>`}h+=`</tbody></table></div>`;first=false})}
  h+=`</body></html>`;
  dl(new Blob([h],{type:"text/html"}),`team_schedule_${wk}.html`);toast("Team view exported!")}
function exportCSV(){if(!D.roster)return toast("Generate first","err");let c="Agent,Gender,"+DAYS.join(",")+",Work,OFF,AL\n";D.roster.forEach(r=>{c+=`"${r.name}",${r.gender},`+DAYS.map(d=>r.shifts[d]).join(",")+`,${r.wd},${r.od},${r.ald}\n`});dl(new Blob([c],{type:"text/csv"}),"schedule.csv")}
function exportXLSX(){if(!D.roster)return toast("Generate first","err");if(typeof XLSX==="undefined")return toast("SheetJS not loaded","err");const wb=XLSX.utils.book_new();const hdr=["Agent","Gender",...DAYS,"Work","OFF","AL"];const rows=D.roster.map(r=>[r.name,r.gender,...DAYS.map(d=>r.shifts[d]),r.wd,r.od,r.ald]);const ws=XLSX.utils.aoa_to_sheet([hdr,...rows]);ws["!cols"]=[{wch:40},{wch:7},...DAYS.map(()=>({wch:6})),{wch:6},{wch:6},{wch:6}];XLSX.utils.book_append_sheet(wb,ws,"Roster");const ai2=allIds();const sh=[["Day",...ai2,"Total"],...DAYS.map(d=>{const c=D.summary[d]||{};const v=ai2.map(s=>c[s]||0);return[d,...v,v.reduce((a,b)=>a+b,0)]})];XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sh),"Summary");XLSX.writeFile(wb,"schedule.xlsx");toast("Excel exported")}
function dl(b,n){const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=n;a.click();URL.revokeObjectURL(a.href)}
// ═══ BREAK ENGINE ═══
const BK={breakPattern:[1,1,1,1],breakPatternC:[1,1],peakWindows:[{from:420,to:660,max:1},{from:660,to:900,max:2},{from:900,to:1020,max:1},{from:1020,to:1500,max:2},{from:0,to:420,max:2}],results:null};
const SH_MAP=()=>{const m={};D.shifts.forEach(s=>{const[sh2,sm2]=s.start.split(":").map(Number),[eh2,em2]=s.end.split(":").map(Number);let st=sh2*60+sm2,en=eh2*60+em2;if(en<=st)en+=1440;m[s.id]={s:st,e:en}});return m};
const NW2=new Set(["OFF","AL"]);
const mT2=m=>`${String(Math.floor(m/60)%24).padStart(2,"0")}:${String(m%60).padStart(2,"0")}`;
const tToMin=s=>{const[h,m]=s.split(":").map(Number);return h*60+m};
function bkCapAt(t){for(const pw of BK.peakWindows){let f=pw.from,to=pw.to;if(f<to){if(t>=f&&t<to)return pw.max}else{if(t>=f||t<to)return pw.max}}return 2}
function bkSlots(code){const sh=SH_MAP();const sd=sh[code];if(!sd)return[];const r=[];if(code==="C"){for(let t=sd.s+30;t<=(sd.e-30)-15;t+=15){if(t>=60&&t<420)continue;r.push(t)}}else{for(let t=sd.s+60;t<=sd.e-60-15;t+=15)r.push(t)}return r}
function bkSolveDay(dn,agents){const sh=SH_MAP();const w=[],errs=[];for(const{name,code}of agents){if(NW2.has(code))continue;if(!sh[code]){errs.push(`Unknown '${code}' for ${name}`);continue}const pat=code==="C"?BK.breakPatternC:BK.breakPattern;const rq=pat.reduce((a,b)=>a+b,0);w.push({name,code,rq,pattern:pat,vs:bkSlots(code),start:sh[code].s,end:sh[code].e})}
  if(errs.length)return{ok:false,error:{day:dn,reasons:errs}};
  const rng=(()=>{let s=42;return()=>{s=Math.imul(s^(s>>>16),0x45d9f3b);s=Math.imul(s^(s>>>13),0x45d9f3b);return((s^=s>>>16)>>>0)/4294967296}})();
  const ord=[...w.keys()].sort((a,b)=>w[a].vs.length-w[b].vs.length);const su={},asgn=w.map(()=>[]);let iters=0;
  function getIdeal(ag,pat){const us=ag.start+60,ue=ag.end-60,ul=ue-us,pos=[];for(let si=0;si<pat.length;si++)pos.push(us+Math.round(ul*(si+1)/(pat.length+1)));return pos}
  function bt(oidx){if(iters>300000)return false;if(oidx>=ord.length)return true;const ai=ord[oidx],ag=w[ai];return tryA(ai,ag,0,[],ag.pattern,oidx,getIdeal(ag,ag.pattern))}
  function tryA(ai,ag,si,placed,pat,oidx,ideals){if(iters>300000)return false;iters++;if(si>=pat.length){asgn[ai]=[...placed];return bt(oidx+1)}
    const segLen=pat[si],minGap=60,minStart=placed.length>0?placed[placed.length-1]+15+minGap:ag.vs[0];const cands=[];
    for(let i=0;i<=ag.vs.length-segLen;i++){if(ag.vs[i]<minStart)continue;let ok=true;const ss=[];for(let j=0;j<segLen;j++){const t=ag.vs[i+j];if(j>0&&t!==ag.vs[i+j-1]+15){ok=false;break}if((su[t]||0)>=bkCapAt(t)){ok=false;break}ss.push(t)}if(!ok)continue;
      let score=-Math.abs(ss[0]-(ideals[si]||0))*0.5;for(const t of ss)score-=(su[t]||0)*40;score+=rng()*4;cands.push({slots:ss,score})}
    cands.sort((a,b)=>b.score-a.score);for(let ci=0;ci<Math.min(cands.length,15);ci++){const{slots}=cands[ci];for(const t of slots)su[t]=(su[t]||0)+1;
      if(tryA(ai,ag,si+1,[...placed,...slots],pat,oidx,ideals))return true;for(const t of slots){su[t]--;if(!su[t])delete su[t]}}return false}
  if(!bt(0))return{ok:false,error:{day:dn,reasons:["Solver exhausted options"]}};
  const sc={};w.forEach(a=>sc[a.code]=(sc[a.code]||0)+1);const tReq=w.reduce((s2,a)=>s2+a.rq,0);
  return{ok:true,assignments:w.map((a,i)=>({name:a.name,code:a.code,start:a.start,end:a.end,breakSlots:asgn[i].slice().sort((a2,b)=>a2-b),pattern:a.pattern})),validation:{shiftCounts:sc,totalAgents:w.length,totalRequired:tReq}}
}
function fBR(slots,pat){if(!slots.length)return[];const sorted=[...slots].sort((a,b)=>a-b);const ranges=[];let idx=0;for(const segLen of pat){if(idx>=sorted.length)break;ranges.push(`${mT2(sorted[idx])}-${mT2(sorted[idx+segLen-1]+15)}`);idx+=segLen}return ranges}
function genBreaks(){if(!D.roster){toast("Generate roster first","err");return}
  const btn=document.getElementById("btnBK");btn.innerHTML='<span class="spin"></span>';btn.disabled=true;
  setTimeout(()=>{BK.results={};DAYS.forEach(d=>{const agents=D.roster.filter(r=>r.shifts[d]&&!NW2.has(r.shifts[d])).map(r=>({name:r.name,code:r.shifts[d]}));
    const off=D.roster.filter(r=>NW2.has(r.shifts[d])).map(r=>[r.name,r.shifts[d]]);
    const r=bkSolveDay(d,agents);BK.results[d]={assignments:r.ok?r.assignments:[],error:r.ok?null:r.error,offAgents:off,validation:r.validation||{}}});
    D.breakResults=BK.results;D.breakPattern=BK.breakPattern;D.breakPatternC=BK.breakPatternC;D.peakWindows=BK.peakWindows;save();
    btn.innerHTML="&#9654; Generate Breaks";btn.disabled=false;toast("Breaks generated!");showBkDay("Mon")},30)}
function renderBkSettings(){const el=document.getElementById("bkSettingsArea");if(!el)return;
  let bpH="";BK.breakPattern.forEach((seg,i)=>{bpH+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700;color:var(--acc);width:24px">${i+1}</span><label style="font-size:12px">Duration:</label><select style="width:80px" onchange="BK.breakPattern[${i}]=parseInt(this.value);renderBkSettings()"><option value="1" ${seg===1?"selected":""}>15 min</option><option value="2" ${seg===2?"selected":""}>30 min</option><option value="3" ${seg===3?"selected":""}>45 min</option></select>${BK.breakPattern.length>1?`<button class="btn bd bsm" onclick="BK.breakPattern.splice(${i},1);renderBkSettings()">Remove</button>`:""}</div>`});
  let bpCH="";BK.breakPatternC.forEach((seg,i)=>{bpCH+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700;color:var(--orn);width:24px">${i+1}</span><label style="font-size:12px">Duration:</label><select style="width:80px" onchange="BK.breakPatternC[${i}]=parseInt(this.value);renderBkSettings()"><option value="1" ${seg===1?"selected":""}>15 min</option><option value="2" ${seg===2?"selected":""}>30 min</option></select>${BK.breakPatternC.length>1?`<button class="btn bd bsm" onclick="BK.breakPatternC.splice(${i},1);renderBkSettings()">Remove</button>`:""}</div>`});
  let pkH="";BK.peakWindows.forEach((pw,i)=>{pkH+=`<div class="fr" style="padding:6px 0"><input type="time" value="${mT2(pw.from)}" onchange="BK.peakWindows[${i}].from=tToMin(this.value)" style="width:100px"><span style="color:var(--tx3)">to</span><input type="time" value="${mT2(pw.to)}" onchange="BK.peakWindows[${i}].to=tToMin(this.value)" style="width:100px"><span style="font-size:11px">max:</span><select style="width:50px" onchange="BK.peakWindows[${i}].max=parseInt(this.value)"><option value="1" ${pw.max===1?"selected":""}>1</option><option value="2" ${pw.max===2?"selected":""}>2</option><option value="3" ${pw.max===3?"selected":""}>3</option></select><span class="tg" style="background:${pw.max===1?"#7f1d1d":"#064e3b"};color:${pw.max===1?"#fca5a5":"#6ee7b7"}">${pw.max===1?"PEAK":"NORMAL"}</span><button class="btn bd bsm bic" onclick="BK.peakWindows.splice(${i},1);renderBkSettings()">✕</button></div>`});
  const totA=BK.breakPattern.reduce((a,b)=>a+b,0)*15,totC=BK.breakPatternC.reduce((a,b)=>a+b,0)*15;
  el.innerHTML=`<div class="card"><div class="ch"><h3>A/MS/B Break Pattern (${totA}min total)</h3></div><div class="cb">${bpH}<button class="btn bs2 bsm" onclick="BK.breakPattern.push(1);renderBkSettings()" style="margin-top:6px">+ Add Break</button></div></div><div class="card"><div class="ch"><h3>C Shift Break Pattern (${totC}min total)</h3></div><div class="cb">${bpCH}<button class="btn bs2 bsm" onclick="BK.breakPatternC.push(1);renderBkSettings()" style="margin-top:6px">+ Add Break</button></div></div><div class="card"><div class="ch"><h3>Peak / Capacity Windows</h3></div><div class="cb"><p style="font-size:11px;color:var(--tx2);margin-bottom:8px">Max concurrent agents on break per time window. Peak = max 1.</p>${pkH}<button class="btn bs2 bsm" onclick="BK.peakWindows.push({from:0,to:60,max:1});renderBkSettings()" style="margin-top:6px">+ Add Window</button></div></div>`}
function showBkDay(day){const pg=document.getElementById("p-bkday");if(pg.style.display==="none"){document.querySelectorAll(".pg").forEach(x=>x.style.display="none");pg.style.display="block";document.querySelectorAll(".ni").forEach(x=>x.classList.remove("on"));document.querySelector('.ni[data-p="bkday"]').classList.add("on")}
  const tabs=document.getElementById("bkDayTabs");tabs.innerHTML=DAYS.map(d=>`<button class="btn ${d===day?"bp":"bs2"} bsm" onclick="showBkDay('${d}')">${d}</button>`).join("");
  const area=document.getElementById("bkDayArea");if(!BK.results||!BK.results[day]){area.innerHTML='<div class="emp">Generate breaks first.</div>';return}
  const dd=BK.results[day],as=dd.assignments||[],off=dd.offAgents||[];
  if(dd.error){area.innerHTML=`<div class="card"><div class="ch"><h3 style="color:var(--red)">Error — ${day}</h3></div><div class="cb">${(dd.error.reasons||[]).map(r=>`<p style="color:var(--red);font-size:12px">${r}</p>`).join("")}</div></div>`;return}
  const maxS=Math.max(BK.breakPattern.length,BK.breakPatternC.length,4);let thB="";for(let i=0;i<maxS;i++)thB+=`<th>Break ${i+1}</th>`;
  let rows="";for(const a of as){const br=fBR(a.breakSlots,a.pattern);let c="";for(let i=0;i<maxS;i++)c+=i<br.length?`<td><span style="font-family:var(--mono);font-size:11px;background:var(--s3);padding:2px 6px;border-radius:4px">${br[i]}</span></td>`:'<td style="color:var(--tx3)">—</td>';
    rows+=`<tr><td style="text-align:left">${a.name}</td><td><span class="sb" style="background:${sColor(a.code)}">${a.code}</span></td><td style="font-family:var(--mono);font-size:11px">${mT2(a.start)}-${mT2(a.end)}</td>${c}<td style="font-family:var(--mono);font-weight:600">${a.breakSlots.length*15}m</td></tr>`}
  let offH="";if(off.length){offH='<div style="margin-top:12px"><p style="font-size:11px;color:var(--tx2);margin-bottom:6px">Not Working:</p><div style="display:flex;flex-wrap:wrap;gap:4px">'+off.map(([n,c])=>`<span style="font-size:11px;background:var(--s3);padding:2px 8px;border-radius:4px;color:var(--tx2)">${n} (${c})</span>`).join("")+"</div></div>"}
  const val=dd.validation||{};let valH=`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px"><span class="tg tga">${val.totalAgents||0} Working</span>`;if(val.shiftCounts)for(const[s2,c]of Object.entries(val.shiftCounts))valH+=`<span class="sb" style="background:${sColor(s2)};font-size:10px">${s2}: ${c}</span>`;valH+=`<span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">${val.totalRequired||0} break slots needed</span><span class="tg tga">✓ Feasible</span></div>`;
  area.innerHTML=valH+`<div class="tw"><table><thead><tr><th style="text-align:left">Agent</th><th>Shift</th><th>Hours</th>${thB}<th>Total</th></tr></thead><tbody>${rows}</tbody></table></div>`+offH}
function renderBkLive(){const area=document.getElementById("bkLiveArea");if(!area)return;if(!BK.results){area.innerHTML='<div class="emp">Generate breaks first.</div>';return}
  const now=new Date(),h=now.getHours(),m=now.getMinutes(),s=now.getSeconds(),nowMin=h*60+m;
  const dayName=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][now.getDay()];const dd=BK.results[dayName];
  if(!dd){area.innerHTML=`<div class="emp">No break data for ${dayName}.</div>`;return}
  const as=dd.assignments||[];const onBreak=[],upcoming=[];
  for(const a of as){const sorted=[...a.breakSlots].sort((x,y)=>x-y);let idx=0;for(const segLen of a.pattern){if(idx>=sorted.length)break;const ss=sorted[idx],se=sorted[idx+segLen-1]+15;
    if(nowMin>=ss&&nowMin<se){onBreak.push({name:a.name,code:a.code,start:ss,end:se,elapsed:nowMin-ss,total:se-ss,progress:((nowMin-ss)/(se-ss))*100})}
    else if(ss>nowMin&&ss-nowMin<=60){upcoming.push({name:a.name,code:a.code,start:ss,end:se,mins:ss-nowMin})}idx+=segLen}}
  upcoming.sort((a,b)=>a.mins-b.mins);
  const timeStr=`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;const secStr=String(s).padStart(2,"0");
  const dayFull=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][now.getDay()];
  const mn=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  let bH="";if(!onBreak.length)bH='<p style="color:var(--tx3);font-size:12px">No agents on break right now</p>';
  else for(const b of onBreak){bH+=`<div class="ar" style="gap:8px"><span class="sb" style="background:${sColor(b.code)};font-size:9px">${b.code}</span><span style="flex:1;font-weight:600">${b.name}</span><span style="font-family:var(--mono);font-size:11px;color:var(--cyn)">${mT2(b.start)}-${mT2(b.end)}</span><span style="font-size:10px;color:var(--tx2)">${b.elapsed}/${b.total}min</span></div><div style="height:3px;background:var(--s3);border-radius:2px;margin:-2px 0 4px;overflow:hidden"><div style="height:100%;width:${b.progress}%;background:linear-gradient(90deg,var(--acc),var(--grn));border-radius:2px"></div></div>`}
  let uH="";if(!upcoming.length)uH='<p style="color:var(--tx3);font-size:12px">No upcoming breaks</p>';
  else for(const u of upcoming.slice(0,5)){uH+=`<div class="ar" style="gap:8px;background:var(--s3)"><span class="sb" style="background:${sColor(u.code)};font-size:9px">${u.code}</span><span style="flex:1;color:var(--tx2)">${u.name}</span><span style="font-family:var(--mono);font-size:11px;color:var(--tx2)">${mT2(u.start)}-${mT2(u.end)}</span><span style="font-family:var(--mono);font-size:12px;font-weight:700;color:var(--orn)">in ${u.mins}m</span></div>`}
  area.innerHTML=`<div class="card" style="background:linear-gradient(135deg,rgba(59,130,246,.04),rgba(16,185,129,.03));border-color:rgba(59,130,246,.2)"><div class="ch"><h3 style="color:var(--grn)">● Live — ${dayName}</h3><span style="font-size:11px;color:var(--tx2)">${as.length} agents working</span></div><div class="cb"><div style="display:grid;grid-template-columns:auto 1fr;gap:16px"><div style="text-align:center"><div style="font-family:var(--mono);font-size:2rem;font-weight:700;color:var(--acc)">${timeStr}<span style="font-size:1rem;color:var(--tx3)">:${secStr}</span></div><div style="font-size:11px;color:var(--tx2)">${dayFull}, ${now.getDate()} ${mn[now.getMonth()]} ${now.getFullYear()}</div><div class="card" style="margin-top:10px;padding:10px;text-align:center"><div style="font-size:2rem;font-weight:800;color:${onBreak.length?"var(--acc)":"var(--tx3)"}">${onBreak.length}</div><div style="font-size:9px;color:var(--tx3);text-transform:uppercase">On Break Now</div></div></div><div><div style="margin-bottom:12px"><p style="font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;margin-bottom:6px">☕ Currently on Break</p>${bH}</div><div><p style="font-size:10px;font-weight:700;color:var(--tx3);text-transform:uppercase;margin-bottom:6px">⏳ Coming Up (60min)</p>${uH}</div></div></div></div></div>`}
let bkLiveTimer=null;

// ═══ AGENT PORTAL ═══
let AGENT_MODE=false,AGENT_ID=null,AGENT_DATA=null;
function checkAgentMode(){const params=new URLSearchParams(location.search);const agId=params.get("agent");if(!agId)return false;AGENT_MODE=true;AGENT_ID=agId;AGENT_DATA=D.agents.find(a=>a.id===agId);if(!AGENT_DATA){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--tx)"><div style="text-align:center"><h2>Agent not found</h2><p style="color:var(--tx2)">This link may be outdated. Contact your supervisor.</p></div></div>';return true}
  // If Supabase is available, load fresh data from cloud then render
  if(SB){agLoadFromCloud().then(()=>renderAgentPortal())}else renderAgentPortal();
  return true}
async function agLoadFromCloud(){if(!SB)return;
  // Find workspace
  const{data:ws}=await SB.from("workspaces").select("*").limit(1).single();if(!ws)return;
  const{data:weeks}=await SB.from("weeks").select("*").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1);
  if(weeks&&weeks.length){const row=weeks[0];const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(s.rules)D.rules=s.rules;if(s.alRules)D.alRules=s.alRules;
    if(row.agents_json)D.agents=row.agents_json;if(row.distribution_json)D.dist=row.distribution_json;
    if(row.roster_json)D.roster=row.roster_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
    if(row.attendance_json)D.attendance=row.attendance_json;
    if(row.breaks_json&&s.breakPattern){BK.results=row.breaks_json;BK.breakPattern=s.breakPattern;BK.breakPatternC=s.breakPatternC;BK.peakWindows=s.peakWindows}
    AGENT_DATA=D.agents.find(a=>a.id===AGENT_ID)}
  // Subscribe to realtime updates
  SB.channel("agent-live").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:"workspace_id=eq."+ws.id},payload=>{
    const row=payload.new;const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(row.roster_json)D.roster=row.roster_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
    if(row.attendance_json)D.attendance=row.attendance_json;if(row.breaks_json){BK.results=row.breaks_json;if(s.breakPattern)BK.breakPattern=s.breakPattern}
    if(row.agents_json)D.agents=row.agents_json;AGENT_DATA=D.agents.find(a=>a.id===AGENT_ID);
    renderAgentPortal();showAgToast("Schedule updated!")}).subscribe()}
let agToastT;function showAgToast(m){const el=document.getElementById("agToast");if(!el)return;el.textContent=m;el.style.opacity="1";clearTimeout(agToastT);agToastT=setTimeout(()=>el.style.opacity="0",3000)}
function renderAgentPortal(){
  const a=AGENT_DATA;if(!a){document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--tx)"><h2>Agent not found</h2></div>';return}
  const myLeaves=D.al.filter(x=>x.aid===AGENT_ID).sort((x,y)=>new Date(y.start)-new Date(x.start));const myRoster=D.roster?D.roster.find(r=>r.id===AGENT_ID):null;const totalYear=D.alRules?.totalDays||30;const yr=new Date().getFullYear();const usedDays=myLeaves.filter(l=>alYear(l.start)===yr&&(l.status==="Completed"||l.status==="Ongoing")).reduce((s,l)=>s+alDays(l.start,l.end),0);const approvedDays=myLeaves.filter(l=>alYear(l.start)===yr&&l.status==="Approved").reduce((s,l)=>s+alDays(l.start,l.end),0);const rem=totalYear-usedDays-approvedDays;
  let h='<div style="max-width:960px;margin:0 auto;padding:20px">';
  h+='<div style="text-align:center;margin-bottom:20px"><h1 style="font-size:20px;font-weight:800"><em style="font-style:normal;background:linear-gradient(135deg,var(--acc),var(--cyn));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Yousef Shtawi</em> Schedule</h1><p style="color:var(--tx2);font-size:13px;margin-top:4px">'+a.name+'</p></div>';
  h+='<div style="display:flex;gap:6px;justify-content:center;margin-bottom:16px"><button class="btn bp bsm agTab" data-t="sched" onclick="agTab(\'sched\')">📅 Schedule</button><button class="btn bs2 bsm agTab" data-t="breaks" onclick="agTab(\'breaks\')">☕ Breaks</button><button class="btn bs2 bsm agTab" data-t="leave" onclick="agTab(\'leave\')">🌴 Leave</button><button class="btn bs2 bsm agTab" data-t="att" onclick="agTab(\'att\')">✅ Attendance</button><button class="btn bs2 bsm agTab" data-t="kpi" onclick="agTab(\'kpi\')">📊 Performance</button></div>';
  // Schedule
  h+='<div id="agSched" class="card"><div class="ch"><h3>📅 My Weekly Schedule</h3></div><div class="cb">';
  if(myRoster){h+='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px">';DAYS.forEach(d=>{const s2=myRoster.shifts[d];h+='<div style="text-align:center;padding:12px 6px;background:var(--s2);border-radius:6px;cursor:pointer" onclick="agSwapPick(\''+d+'\')"><div style="font-size:10px;font-weight:700;color:var(--tx2);margin-bottom:6px">'+d+'</div><span class="sb" style="background:'+sColor(s2)+';min-width:48px;height:30px;font-size:13px">'+s2+'</span></div>'});h+='</div><div style="margin-top:8px;text-align:center;font-size:12px;color:var(--tx2)">Work: <b>'+myRoster.wd+'</b> | OFF: <b>'+myRoster.od+'</b>'+(myRoster.ald?' | AL: <b>'+myRoster.ald+'</b>':'')+'</div>';
    h+='<div style="margin-top:10px;font-size:10px;color:var(--tx3);text-align:center">Click a day to request a shift swap</div>';
    h+='<div id="agSwapArea"></div>'}else h+='<p style="color:var(--tx3)">No roster generated yet</p>';
  h+='</div></div>';
  // Breaks
  h+='<div id="agBreaks" class="card" style="display:none"><div class="ch"><h3>☕ My Breaks</h3></div><div class="cb">';
  if(BK.results){let hasDays=[];DAYS.forEach(d=>{const dd=BK.results[d];if(!dd||!dd.assignments)return;const my=dd.assignments.find(x=>x.name===a.name);if(my)hasDays.push(d)});
    if(hasDays.length){h+='<div style="display:flex;gap:4px;margin-bottom:10px">';hasDays.forEach((d,i)=>{h+='<button class="btn '+(i===0?'bp':'bs2')+' bsm agBkBtn" data-d="'+d+'" onclick="document.querySelectorAll(\'.agBkDay\').forEach(e=>e.style.display=\'none\');document.getElementById(\'agBk_'+d+'\').style.display=\'block\';document.querySelectorAll(\'.agBkBtn\').forEach(b=>b.className=\'btn bs2 bsm agBkBtn\');this.className=\'btn bp bsm agBkBtn\'">'+d+'</button>'});h+='</div>';
      hasDays.forEach((d,i)=>{const dd=BK.results[d];const my=dd.assignments.find(x=>x.name===a.name);const br=fBR(my.breakSlots,my.pattern);
        h+='<div id="agBk_'+d+'" class="agBkDay" style="display:'+(i===0?'block':'none')+'"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span class="sb" style="background:'+sColor(my.code)+';height:24px;min-width:36px;font-size:10px">'+my.code+'</span><span style="font-family:var(--mono);font-size:12px;color:var(--tx2)">'+mT2(my.start)+'–'+mT2(my.end)+'</span></div>';
        h+='<div style="display:grid;grid-template-columns:repeat('+br.length+',1fr);gap:8px">';br.forEach((b2,bi)=>{h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3);margin-bottom:4px">Break '+(bi+1)+'</div><div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--cyn)">'+b2+'</div></div>'});
        h+='</div></div>'})}else h+='<p style="color:var(--tx3)">No breaks this week</p>'}else h+='<p style="color:var(--tx3)">Breaks not generated yet</p>';
  h+='</div></div>';
  // Leave
  h+='<div id="agLeave" class="card" style="display:none"><div class="ch"><h3>🌴 My Annual Leave</h3></div><div class="cb">';
  h+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;text-align:center"><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Entitled '+yr+'</div><div style="font-size:20px;font-weight:700;color:var(--cyn)">'+totalYear+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Used</div><div style="font-size:20px;font-weight:700">'+usedDays+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Approved</div><div style="font-size:20px;font-weight:700;color:var(--grn)">'+approvedDays+'</div></div><div style="padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Remaining</div><div style="font-size:20px;font-weight:700;color:'+(rem<=5?"var(--red)":rem<=10?"var(--orn)":"var(--grn)")+'">'+rem+'</div></div></div>';
  h+='<div style="border:1px solid var(--brd);border-radius:8px;padding:12px;margin-bottom:12px;background:var(--s2)"><h4 style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:8px">REQUEST LEAVE</h4><div class="fr"><div class="fg"><label>From</label><input type="date" id="agReqS" onchange="agReqPreview()"></div><div class="fg"><label>To</label><input type="date" id="agReqE" onchange="agReqPreview()"></div><div style="align-self:flex-end"><button class="btn bp bsm" onclick="agSubmitRequest()">Submit</button></div></div><div id="agReqPreview" style="margin-top:6px"></div></div>';
  if(myLeaves.length){myLeaves.forEach(l=>{const days=alDays(l.start,l.end);const st=l.status||"Approved";h+='<div class="ar" style="border-left:3px solid '+alStatusColor(st)+'"><span class="tg" style="background:'+alStatusColor(st)+'20;color:'+alStatusColor(st)+';font-size:9px">'+st+'</span><span style="font-family:var(--mono);font-size:11px">'+l.start+' → '+l.end+'</span><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+days+'d</span>'+(l.adminNote?'<span style="font-size:10px;color:var(--tx3)">💬 '+l.adminNote+'</span>':'')+'</div>'})}
  h+='</div></div>';
  // Attendance
  h+='<div id="agAtt" class="card" style="display:none"><div class="ch"><h3>✅ My Attendance</h3></div><div class="cb">';
  const att=D.attendance||{};const attDates=Object.keys(att).filter(d=>att[d][AGENT_ID]).sort().reverse().slice(0,28);
  if(attDates.length){h+='<div class="tw"><table><thead><tr><th>Date</th><th>Day</th><th>Status</th></tr></thead><tbody>';attDates.forEach(d=>{const st=att[d][AGENT_ID];const dayName=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(d+"T00:00:00").getDay()];h+='<tr><td style="font-family:var(--mono)">'+d+'</td><td>'+dayName+'</td><td style="font-weight:600;color:'+(ATT_COLORS[st]||"var(--tx3)")+'">'+st+'</td></tr>'});h+='</tbody></table></div>'}else h+='<p style="color:var(--tx3)">No attendance records yet</p>';
  h+='</div></div>';
  // Agent KPI section
  h+='<div id="agKpi" class="card" style="display:none"><div class="ch"><h3>📊 My Performance</h3></div><div class="cb">';
  const kpis=D.kpis||{};const months=Object.keys(kpis).sort().reverse();const myKpiMonths=months.filter(m=>kpis[m]&&kpis[m][AGENT_ID]);
  if(myKpiMonths.length){const curM=myKpiMonths[0];const cur=kpis[curM][AGENT_ID];
    h+='<div style="font-size:11px;color:var(--tx2);margin-bottom:8px">Latest: <b>'+curM+'</b></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">QA Score</div><div style="font-size:20px;font-weight:800;color:var(--pur)">'+(cur.qa||0).toFixed(1)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">AHT</div><div style="font-size:20px;font-weight:800;color:var(--orn)">'+Math.floor((cur.aht||0)/60)+':'+String(Math.round((cur.aht||0)%60)).padStart(2,"0")+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">CSAT</div><div style="font-size:20px;font-weight:800;color:var(--acc)">'+(cur.csat||0).toFixed(2)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Adherence</div><div style="font-size:20px;font-weight:800;color:var(--cyn)">'+(cur.adherence||0).toFixed(1)+'%</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Interactions</div><div style="font-size:20px;font-weight:800;color:var(--grn)">'+(cur.interactions||0)+'</div></div>';
    h+='<div style="text-align:center;padding:10px;background:var(--s2);border-radius:6px"><div style="font-size:9px;color:var(--tx3)">Unplanned</div><div style="font-size:20px;font-weight:800;color:var(--red)">'+(cur.unplanned||0)+'</div></div>';
    h+='</div>';
    // Coaching notes if any
    const myCoach=(D.coaching||[]).filter(c=>c.aid===AGENT_ID).sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(myCoach.length){h+='<div style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:4px">Recent Coaching Notes:</div>';myCoach.slice(0,5).forEach(c=>{h+='<div style="font-size:10px;padding:4px 8px;margin-bottom:3px;background:var(--s2);border-radius:4px;border-left:2px solid '+(c.followUp?"var(--red)":"var(--grn)")+'"><b>'+c.date+'</b> — '+c.type+(c.notes?' — <span style="color:var(--tx2)">'+c.notes+'</span>':'')+'</div>'})}
    // History
    if(myKpiMonths.length>1){h+='<div style="font-size:11px;font-weight:700;color:var(--tx2);margin-top:10px;margin-bottom:4px">Monthly History:</div><div class="tw"><table style="font-size:10px"><thead><tr><th>Month</th><th>QA</th><th>AHT</th><th>CSAT</th><th>Adh%</th><th>Int</th><th>UPL</th></tr></thead><tbody>';myKpiMonths.forEach(m=>{const d2=kpis[m][AGENT_ID];h+='<tr><td>'+m+'</td><td>'+(d2.qa||0).toFixed(1)+'</td><td>'+Math.floor((d2.aht||0)/60)+':'+String(Math.round((d2.aht||0)%60)).padStart(2,"0")+'</td><td>'+(d2.csat||0).toFixed(2)+'</td><td>'+(d2.adherence||0).toFixed(1)+'%</td><td>'+(d2.interactions||0)+'</td><td>'+(d2.unplanned||0)+'</td></tr>'});h+='</tbody></table></div>'}
  }else h+='<p style="color:var(--tx3)">No performance data available yet.</p>';
  h+='</div></div>';
  h+='<div id="agToast" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#052e16;border:1px solid #064e3b;color:#86efac;padding:10px 20px;border-radius:8px;font-size:13px;opacity:0;transition:opacity .3s;z-index:999"></div>';
  h+='</div>';
  document.body.innerHTML='<div style="min-height:100vh;background:var(--bg);color:var(--tx)">'+h+'</div>'}
function agTab(t){["sched","breaks","leave","att","kpi"].forEach(x=>{const map={sched:"Sched",breaks:"Breaks",leave:"Leave",att:"Att",kpi:"Kpi"};const el=document.getElementById("ag"+map[x]);if(el)el.style.display=x===t?"block":"none"});document.querySelectorAll(".agTab").forEach(b=>b.className="btn bsm agTab "+(b.dataset.t===t?"bp":"bs2"))}
function agSwapPick(day){const el=document.getElementById("agSwapArea");if(!el)return;const myRoster=D.roster?D.roster.find(r=>r.id===AGENT_ID):null;if(!myRoster)return;const mySh=myRoster.shifts[day];if(mySh==="AL"){showAgToast("Can't swap AL day");return}
  const others=D.roster.filter(r=>r.id!==AGENT_ID&&r.shifts[day]!=="AL").map(r=>({id:r.id,name:r.name,shift:r.shifts[day]}));
  let h2='<div style="border:1px solid var(--brd);border-radius:8px;padding:12px;margin-top:10px;background:var(--s2)"><h4 style="font-size:11px;font-weight:700;color:var(--tx2);margin-bottom:8px">REQUEST SWAP — '+day+' (your shift: <span class="sb" style="background:'+sColor(mySh)+';height:18px;min-width:28px;font-size:9px">'+mySh+'</span>)</h4>';
  h2+='<div style="max-height:200px;overflow-y:auto">';
  others.forEach(o=>{h2+='<div class="ar" style="cursor:pointer" onclick="agSubmitSwap(\''+day+'\',\''+o.id+'\',\''+o.name+'\')"><b style="font-size:12px;min-width:180px">'+o.name+'</b><span class="sb" style="background:'+sColor(o.shift)+';height:20px;min-width:32px;font-size:9px">'+o.shift+'</span><span style="font-size:10px;color:var(--cyn)">→ Click to request swap</span></div>'});
  h2+='</div><button class="btn bs2 bsm" style="margin-top:6px" onclick="document.getElementById(\'agSwapArea\').innerHTML=\'\'">Cancel</button></div>';
  el.innerHTML=h2}
async function agSubmitSwap(day,targetId,targetName){if(!D.swapRequests)D.swapRequests=[];
  D.swapRequests.push({id:uid(),from:AGENT_ID,fromName:AGENT_DATA.name,to:targetId,toName:targetName,day:day,status:"Pending",addedAt:new Date().toISOString()});
  save();
  if(SB){const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();if(ws){const{data:wk}=await SB.from("weeks").select("id,settings_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();if(wk){const sj=wk.settings_json||{};sj.swapRequests=D.swapRequests;await SB.from("weeks").update({settings_json:sj}).eq("id",wk.id)}}}
  showAgToast("Swap request sent to admin!");document.getElementById("agSwapArea").innerHTML='<div style="padding:8px;background:#052e16;border:1px solid #064e3b;border-radius:6px;margin-top:8px;font-size:12px;color:#86efac">✓ Swap request sent for '+day+' with '+targetName+'. Waiting for admin approval.</div>'}
function agReqPreview(){const s=document.getElementById("agReqS").value,e=document.getElementById("agReqE").value,el=document.getElementById("agReqPreview");if(!s||!e){el.innerHTML="";return}const v=alValidateRequest(AGENT_ID,s,e);el.innerHTML='<div style="font-size:12px"><span style="font-family:var(--mono);font-weight:700;color:var(--cyn)">'+v.days+' days</span>'+(v.errs.length?'<div style="margin-top:4px">'+v.errs.map(w=>'<div style="color:var(--red);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(v.warns.length?'<div>'+v.warns.map(w=>'<div style="color:var(--orn);font-size:11px">'+w+'</div>').join("")+"</div>":"")+(!v.blocked?'<span style="color:var(--grn);margin-left:6px">✓ Eligible</span>':"")+"</div>"}
async function agSubmitRequest(){const s=document.getElementById("agReqS").value,e=document.getElementById("agReqE").value;if(!s||!e){showAgToast("Select dates");return}if(new Date(e)<new Date(s)){showAgToast("End before start");return}const v=alValidateRequest(AGENT_ID,s,e);if(v.blocked){showAgToast("Blocked — overlap with "+v.overlap.length+" agents");return}
  D.al.push({id:uid(),aid:AGENT_ID,name:AGENT_DATA.name,start:s,end:e,status:"Pending",source:"agent",addedAt:new Date().toISOString()});save();
  // Also push to Supabase if available
  if(SB){const{data:ws}=await SB.from("workspaces").select("id").limit(1).single();if(ws){const{data:wk}=await SB.from("weeks").select("id,annual_leave_json").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1).single();if(wk){await SB.from("weeks").update({annual_leave_json:D.al}).eq("id",wk.id)}}}
  showAgToast("Request submitted! Waiting for approval.");renderAgentPortal()}

// ═══ ATTENDANCE ═══
if(!D.attendance)D.attendance={};
const ATT_STATUSES=["Present","Absent","Sick","Annual"];
const ATT_COLORS={Present:"#059669",Absent:"#ef4444",Sick:"#f59e0b",Annual:"#8b5cf6"};
function renderAttendance(){const el=document.getElementById("attArea");if(!el)return;
  if(!D.attendance||Array.isArray(D.attendance))D.attendance={};
  const wkInput=document.getElementById("attWeek");if(!wkInput.value)wkInput.value=document.getElementById("wkStart").value||new Date().toISOString().split("T")[0];
  const wkStart=new Date(wkInput.value+"T12:00:00");const dow=wkStart.getDay();const monOffset=dow===0?-6:1-dow;const mon=new Date(wkStart);mon.setDate(wkStart.getDate()+monOffset);
  const weekDates=[];for(let i=0;i<7;i++){const d2=new Date(mon);d2.setDate(mon.getDate()+i);weekDates.push(d2.getFullYear()+"-"+String(d2.getMonth()+1).padStart(2,"0")+"-"+String(d2.getDate()).padStart(2,"0"))}
  const agents=D.agents||[];if(!agents.length){el.innerHTML='<div class="emp">Add agents first.</div>';return}
  let h='<div class="tw"><table style="font-size:11px"><thead><tr><th style="text-align:left;min-width:140px">Agent</th>';
  DAYS.forEach((d,i)=>h+='<th>'+d+'<div style="font-size:8px;color:var(--tx3);font-weight:400">'+weekDates[i].slice(5)+'</div></th>');
  h+='<th>P</th><th>A</th><th>S</th></tr></thead><tbody>';
  agents.forEach(r=>{let pC=0,aC=0,sC=0;
    h+='<tr><td style="text-align:left;max-width:150px;overflow:hidden;text-overflow:ellipsis;font-size:11px" title="'+r.name+'">'+r.name+'</td>';
    weekDates.forEach(dateStr=>{const cur=(D.attendance[dateStr]&&D.attendance[dateStr][r.id])||"";if(cur==="Present")pC++;if(cur==="Absent")aC++;if(cur==="Sick")sC++;
      if(VIEWER_MODE||AGENT_MODE){h+='<td style="font-size:10px;font-weight:600;color:'+(ATT_COLORS[cur]||"var(--tx3)")+'">'+(cur?cur.charAt(0):"\u2014")+'</td>'}
      else{h+='<td><select onchange="setAtt(\''+r.id+'\',\''+dateStr+'\',this.value)" style="width:58px;font-size:9px;padding:2px;'+(cur?"color:"+ATT_COLORS[cur]:"")+'">';
        h+='<option value="">\u2014</option>';ATT_STATUSES.forEach(s=>h+='<option value="'+s+'" '+(cur===s?"selected":"")+'>'+s+'</option>');h+='</select></td>'}});
    h+='<td style="font-family:var(--mono);color:var(--grn);font-weight:600;font-size:11px">'+pC+'</td><td style="font-family:var(--mono);color:var(--red);font-weight:600;font-size:11px">'+aC+'</td><td style="font-family:var(--mono);color:var(--orn);font-weight:600;font-size:11px">'+sC+'</td></tr>'});
  h+='</tbody></table></div>';el.innerHTML=h}
function setAtt(aid,dateStr,val){if(!D.attendance)D.attendance={};if(!D.attendance[dateStr])D.attendance[dateStr]={};D.attendance[dateStr][aid]=val;save()}
function attPrevWeek(){const w=document.getElementById("attWeek");const d=new Date(w.value+"T00:00:00");d.setDate(d.getDate()-7);w.value=d.toISOString().split("T")[0];renderAttendance()}
function attNextWeek(){const w=document.getElementById("attWeek");const d=new Date(w.value+"T00:00:00");d.setDate(d.getDate()+7);w.value=d.toISOString().split("T")[0];renderAttendance()}

// ═══ SUPABASE CLOUD LAYER ═══
const SB_URL="https://flgngysndlvkgbyvhqoz.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZ25neXNuZGx2a2dieXZocW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODA0NTAsImV4cCI6MjA4MjA1NjQ1MH0.-8AWG-ocwHXJlEmjwNQhnzipT3NilH21ZGPJ8AP2t8Q"; // ← Replace with your key from Supabase Settings > API
let SB=null,SB_USER=null,SB_WS=null,VIEWER_MODE=false,SB_WEEK_ID=null;

function initSupabase(){
  if(typeof supabase==="undefined"){console.warn("Supabase JS not loaded");return false}
  if(!supabase.createClient){console.warn("Supabase createClient not found");return false}
  if(!SB_KEY||SB_KEY.length<20||SB_KEY.indexOf("PASTE")>=0){console.warn("Supabase key not set");return false}
  try{SB=supabase.createClient(SB_URL,SB_KEY);console.log("Supabase connected!");return true}catch(e){console.error("Supabase init failed:",e);return false}}

async function checkViewerMode(){
  const params=new URLSearchParams(window.location.search);
  const viewId=params.get("view");
  if(!viewId||!SB)return false;
  VIEWER_MODE=true;
  // Hide admin controls
  document.querySelectorAll(".btn.bp,.btn.bg,.btn.bd,#btnG,#btnCS,#btnBK").forEach(el=>el.style.display="none");
  document.querySelectorAll("input,select").forEach(el=>{if(!el.closest("#viewerBanner"))el.disabled=true});
  document.getElementById("viewerBanner").style.display="flex";
  document.querySelector(".topbar").style.marginTop="36px";
  // Load data
  const{data:ws}=await SB.from("workspaces").select("*").eq("public_id",viewId).single();
  if(!ws){toast("Workspace not found","err");return true}
  SB_WS=ws;
  const{data:weeks}=await SB.from("weeks").select("*").eq("workspace_id",ws.id).order("week_start",{ascending:false}).limit(1);
  if(weeks&&weeks.length){loadWeekFromCloud(weeks[0]);document.getElementById("viewerUpdate").textContent="Last updated: "+new Date(weeks[0].updated_at).toLocaleString()}
  // Subscribe to realtime
  SB.channel("viewer").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:`workspace_id=eq.${ws.id}`},payload=>{
    loadWeekFromCloud(payload.new);document.getElementById("viewerUpdate").textContent="Last updated: "+new Date().toLocaleTimeString();toast("Schedule updated!")}).subscribe();
  return true}

function loadWeekFromCloud(row){
  const s=row.settings_json||{};if(s.shifts)D.shifts=s.shifts;if(s.rules)D.rules=s.rules;if(s.genderRules)D.genderRules=s.genderRules;
  if(row.agents_json)D.agents=row.agents_json;if(row.distribution_json)D.dist=row.distribution_json;
  if(row.special_requests_json)D.sr=row.special_requests_json;if(row.annual_leave_json)D.al=row.annual_leave_json;
  if(row.roster_json)D.roster=row.roster_json;if(row.breaks_json){BK.results=row.breaks_json;D.breakResults=row.breaks_json}
  if(row.attendance_json)D.attendance=row.attendance_json;
  if(s.breakPattern)BK.breakPattern=s.breakPattern;if(s.breakPatternC)BK.breakPatternC=s.breakPatternC;if(s.peakWindows)BK.peakWindows=s.peakWindows;if(s.alRules)D.alRules=s.alRules;if(s.swapRequests)D.swapRequests=s.swapRequests;if(s.kpis)D.kpis=s.kpis;if(s.coaching)D.coaching=s.coaching;if(s.incidents)D.incidents=s.incidents;if(s.kb)D.kb=s.kb;
  SB_WEEK_ID=row.id;document.getElementById("wkStart").value=row.week_start;
  renderAll();if(D.roster)renderRoster();renderAttendance()}

async function doCloudLogin(){
  if(!SB){toast("Supabase not ready","err");return}
  const email=(document.getElementById("cEmail")||document.getElementById("lEmail")).value.trim();
  const pass=(document.getElementById("cPass")||document.getElementById("lPass")).value;
  const errEl=document.getElementById("cErr")||document.getElementById("lErr");
  if(errEl)errEl.textContent="";
  if(!email||!pass){if(errEl)errEl.textContent="Enter email and password";return}
  const{data,error}=await SB.auth.signInWithPassword({email,password:pass});
  if(error){if(errEl)errEl.textContent=error.message;return}
  SB_USER=data.user;document.getElementById("loginOverlay").style.display="none";
  const{data:ws}=await SB.from("workspaces").select("*").eq("owner_id",SB_USER.id).single();
  if(ws){SB_WS=ws;toast("Logged in! Workspace: "+ws.name)}
  else{const{data:nws}=await SB.from("workspaces").insert({name:"Qmobility Call Center",public_id:"qmobility-live",owner_id:SB_USER.id}).select().single();
    if(nws){SB_WS=nws;toast("Workspace created!")}}
  renderCloudPanel();await cloudLoadLatest()}

async function doLogin(){await doCloudLogin()}

async function cloudSave(){
  if(!SB||!SB_WS){toast("Log in to cloud first","err");return}
  const ws=document.getElementById("wkStart").value;if(!ws){toast("Set week date","err");return}
  const end=new Date(ws+"T00:00:00");end.setDate(end.getDate()+6);
  const row={workspace_id:SB_WS.id,week_start:ws,week_end:end.toISOString().split("T")[0],
    settings_json:{shifts:D.shifts,rules:D.rules,genderRules:D.genderRules,breakPattern:BK.breakPattern,breakPatternC:BK.breakPatternC,peakWindows:BK.peakWindows,alRules:D.alRules||{},swapRequests:D.swapRequests||[],kpis:D.kpis||{},coaching:D.coaching||[],incidents:D.incidents||[],kb:D.kb||[]},
    distribution_json:D.dist,agents_json:D.agents,special_requests_json:D.sr,annual_leave_json:D.al,
    annual_leave_json:D.al,
    roster_json:D.roster||null,breaks_json:BK.results||null,attendance_json:D.attendance||{}};
  let res;
  if(SB_WEEK_ID){res=await SB.from("weeks").update(row).eq("id",SB_WEEK_ID)}
  else{const{data:existing}=await SB.from("weeks").select("id").eq("workspace_id",SB_WS.id).eq("week_start",ws).single();
    if(existing){SB_WEEK_ID=existing.id;res=await SB.from("weeks").update(row).eq("id",SB_WEEK_ID)}
    else{res=await SB.from("weeks").insert(row).select().single();if(res.data)SB_WEEK_ID=res.data.id}}
  if(res.error)toast("Save failed: "+res.error.message,"err");else{toast("Saved to cloud! Viewers will update.");renderCloudPanel();subscribeAdminRealtime()}}

function subscribeAdminRealtime(){if(!SB||!SB_WS||window._adminSubbed)return;window._adminSubbed=true;
  SB.channel("admin-live").on("postgres_changes",{event:"UPDATE",schema:"public",table:"weeks",filter:"workspace_id=eq."+SB_WS.id},payload=>{
    const row=payload.new;const s=row.settings_json||{};
    if(row.annual_leave_json){D.al=row.annual_leave_json;renderAL()}
    if(s.swapRequests){D.swapRequests=s.swapRequests;if(D.roster)renderRoster()}
    if(row.attendance_json)D.attendance=row.attendance_json;
    save();toast("Data updated from cloud!")}).subscribe()}

async function cloudLoadLatest(){
  if(!SB||!SB_WS)return;
  const{data}=await SB.from("weeks").select("*").eq("workspace_id",SB_WS.id).order("week_start",{ascending:false}).limit(1);
  if(data&&data.length){loadWeekFromCloud(data[0]);subscribeAdminRealtime()}}

async function cloudLoadWeek(weekStart){
  if(!SB||!SB_WS)return;
  const{data}=await SB.from("weeks").select("*").eq("workspace_id",SB_WS.id).eq("week_start",weekStart).single();
  if(data)loadWeekFromCloud(data);else toast("Not found","err")}

function renderCloudPanel(){const el=document.getElementById("cloudArea");if(!el)return;
  if(!SB){el.innerHTML='<div class="card"><div class="cb"><p style="color:var(--orn);font-size:13px;margin-bottom:10px">⚠ Supabase not configured.</p><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Open this HTML file in a text editor (Notepad) and replace <code style="background:var(--s3);padding:2px 6px;border-radius:3px">PASTE_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsZ25neXNuZGx2a2dieXZocW96Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0ODA0NTAsImV4cCI6MjA4MjA1NjQ1MH0.-8AWG-ocwHXJlEmjwNQhnzipT3NilH21ZGPJ8AP2t8Q</code> with your Supabase anon key.</p><p style="font-size:11px;color:var(--tx3)">Key length: '+SB_KEY.length+' chars. Key starts with: '+SB_KEY.substring(0,20)+'...</p><p style="font-size:11px;color:var(--tx3);margin-top:4px">Supabase loaded: '+(typeof supabase!=="undefined"?"YES":"NO")+'</p></div></div>';return}
  if(!SB_USER){el.innerHTML='<div class="card" style="max-width:400px"><div class="ch"><h3>☁ Cloud Login</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:12px">Log in with your Supabase account to enable cloud save, shared views, and real-time sync.</p><div class="fg" style="margin-bottom:8px"><label>Email</label><input id="cEmail" placeholder="chtiwe007@gmail.com" style="width:100%"></div><div class="fg" style="margin-bottom:8px"><label>Password</label><input id="cPass" type="password" placeholder="Your password" style="width:100%"></div><p id="cErr" style="color:var(--red);font-size:11px;min-height:16px;margin-bottom:8px"></p><button class="btn bp" style="width:100%" onclick="doCloudLogin()">Sign In</button><p style="font-size:10px;color:var(--tx3);margin-top:10px">Don\'t have an account? Create one in Supabase Dashboard → Authentication → Users → Add User</p></div></div>';return}
  let h=`<div class="card"><div class="ch"><h3>Connection</h3></div><div class="cb"><div class="fr"><span class="tg tga">● Connected</span><span style="font-size:12px;color:var(--tx2)">${SB_USER.email}</span><span style="font-size:11px;color:var(--tx3)">Workspace: ${SB_WS?SB_WS.name:"—"}</span></div></div></div>`;
  h+=`<div class="card"><div class="ch"><h3>Actions</h3></div><div class="cb"><div class="fr"><button class="btn bg" onclick="cloudSave()">☁ Save to Cloud</button><button class="btn bs2" onclick="cloudLoadLatest()">↓ Load Latest</button><button class="btn bs2" onclick="SB.auth.signOut().then(()=>{SB_USER=null;renderCloudPanel();toast('Logged out')})">Logout</button></div></div></div>`;
  if(SB_WS)h+=`<div class="card"><div class="ch"><h3>Shared View Link</h3></div><div class="cb"><p style="font-size:12px;color:var(--tx2);margin-bottom:8px">Share this link with your team (read-only, auto-updates):</p><div class="fr"><code style="font-family:var(--mono);font-size:13px;background:var(--s3);padding:8px 12px;border-radius:6px;color:var(--cyn);word-break:break-all;flex:1" id="shareLink">${location.origin+location.pathname}?view=${SB_WS.public_id}</code><button class="btn bs2 bsm" onclick="navigator.clipboard.writeText(document.getElementById('shareLink').textContent);toast('Copied!')">Copy</button></div></div></div>`;
  // Week list
  if(SB_WS){SB.from("weeks").select("week_start,version,updated_at").eq("workspace_id",SB_WS.id).order("week_start",{ascending:false}).then(({data})=>{
    if(!data||!data.length)return;let wh='<div class="card"><div class="ch"><h3>Cloud Archive</h3></div><div class="cb">';
    data.forEach(w=>{wh+=`<div class="ar"><span style="font-family:var(--mono);font-weight:700">${w.week_start}</span><span style="font-size:11px;color:var(--tx2)">v${w.version} — ${new Date(w.updated_at).toLocaleString()}</span><button class="btn bs2 bsm" onclick="cloudLoadWeek('${w.week_start}')">Load</button></div>`});
    wh+='</div></div>';el.innerHTML+=wh})}
  el.innerHTML=h}

// ═══ INIT CLOUD ═══
async function initCloud(){
  // Retry up to 3 times if supabase script hasn't loaded yet
  for(let i=0;i<3;i++){if(initSupabase())break;await new Promise(r=>setTimeout(r,500))}
  if(!SB){console.warn("Supabase not available after retries");renderCloudPanel();return}
  // Check if viewer mode
  if(await checkViewerMode())return;
  // Check existing session
  const{data}=await SB.auth.getSession();
  if(data.session){SB_USER=data.session.user;
    const{data:ws}=await SB.from("workspaces").select("*").eq("owner_id",SB_USER.id).single();
    if(ws)SB_WS=ws;renderCloudPanel();await cloudLoadLatest()}else{renderCloudPanel()}}

// ═══ INIT BREAKS ═══
function initBkSettings(){if(D.breakPattern)BK.breakPattern=D.breakPattern;if(D.breakPatternC)BK.breakPatternC=D.breakPatternC;if(D.peakWindows)BK.peakWindows=D.peakWindows;if(D.breakResults)BK.results=D.breakResults;renderBkSettings()}

loadSaved();if(!D.kb)D.kb=[];if(!D.coaching)D.coaching=[];if(!D.incidents)D.incidents=[];if(!D.swapRequests)D.swapRequests=[];if(!D.attendance||Array.isArray(D.attendance))D.attendance={};if(!D.kpis)D.kpis={};
// Auto-link AL records to agent IDs by name
D.al.forEach(a=>{if(!a.aid||!D.agents.find(x=>x.id===a.aid)){const match=D.agents.find(x=>x.name===a.name||a.name.includes(x.name.split(" ")[0])&&a.name.includes(x.name.split(" ").pop()));if(match)a.aid=match.id}});
// Check if agent portal mode — init Supabase first for live data
initSupabase(); // Try immediate init
if(checkAgentMode()){/* Agent portal rendered, stop admin init */}else{
const td=new Date(),w2=td.getDay(),d2=w2===0?1:(w2===1?0:8-w2);const m2=new Date(td);m2.setDate(td.getDate()+d2);document.getElementById("wkStart").value=m2.toISOString().split("T")[0];document.getElementById("rMO").value=D.rules.max_off;document.getElementById("rMW").value=D.rules.max_work;renderAll();if(D.roster){renderRoster();renderAttendance()}renderArchive();initBkSettings();renderDashboard();
// Live break timer on nav change
document.getElementById("sideNav").addEventListener("click",e=>{const ni=e.target.closest(".ni");if(!ni)return;if(bkLiveTimer){clearInterval(bkLiveTimer);bkLiveTimer=null}if(ni.dataset.p==="bklive"&&BK.results){renderBkLive();bkLiveTimer=setInterval(renderBkLive,1000)}if(ni.dataset.p==="bksettings")renderBkSettings();if(ni.dataset.p==="attendance")renderAttendance();if(ni.dataset.p==="cloud")renderCloudPanel();if(ni.dataset.p==="al"){renderAL();loadALRules();setTimeout(()=>{const aS=document.getElementById("alS"),aE=document.getElementById("alE");if(aS)aS.onchange=alPreview;if(aE)aE.onchange=alPreview},50)}if(ni.dataset.p==="dashboard")renderDashboard();if(ni.dataset.p==="agents")renderAgentLinks();if(ni.dataset.p==="kb"){renderKB();const k=localStorage.getItem("gpt_key");if(k)document.getElementById("kbApiKey").value=k}if(ni.dataset.p==="kpis")renderKPIs();if(ni.dataset.p==="coaching"){renderCoaching();const cs=document.getElementById("coachAgent");if(cs)cs.innerHTML=D.agents.map(a=>'<option value="'+a.id+'">'+a.name+'</option>').join("")}if(ni.dataset.p==="conduct"){renderIncidents();const is2=document.getElementById("incAgent");if(is2)is2.innerHTML=D.agents.map(a=>'<option value="'+a.id+'">'+a.name+'</option>').join("")}});
// Init Supabase cloud
initCloud();
// ═══ DASHBOARD ═══
function renderDashboard(){
  const el=id=>document.getElementById(id);
  el("dashAgents").textContent=D.agents.length;
  const today=new Date();const dayN=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][today.getDay()];
  let scheduled=0,onBreak=0;
  if(D.roster){D.roster.forEach(r=>{const s=r.shifts[dayN];if(s&&s!=="OFF"&&s!=="AL")scheduled++})}
  el("dashScheduled").textContent=scheduled;
  const todayStr=today.toISOString().split("T")[0];const att=D.attendance&&D.attendance[todayStr]||{};let pres=0;Object.values(att).forEach(v=>{if(v==="Present")pres++});el("dashPresent").textContent=pres;
  const pendAL=D.al.filter(a=>a.status==="Pending").length;el("dashPendAL").textContent=pendAL;
  const incidents=(D.incidents||[]).filter(i=>i.status==="Open").length;el("dashIncidents").textContent=incidents;
  // Attendance exceptions
  const excEl=el("dashAttExc");const excs=[];if(D.roster&&att){D.roster.forEach(r=>{const s=r.shifts[dayN];if(s&&s!=="OFF"&&s!=="AL"&&!att[r.id])excs.push(r.name)})}
  excEl.innerHTML=excs.length?excs.slice(0,5).map(n=>'<div style="font-size:11px;padding:3px 0;border-bottom:1px solid var(--brd)">'+n+' — <span style="color:var(--red)">No status</span></div>').join(""):'<p style="color:var(--tx3)">No exceptions today</p>';
  // Pending leave
  const lrEl=el("dashLeaveReq");const pends=D.al.filter(a=>a.status==="Pending");
  lrEl.innerHTML=pends.length?pends.map(a=>'<div style="font-size:11px;padding:3px 0;border-bottom:1px solid var(--brd)">'+a.name+' — '+a.start+' → '+a.end+' ('+alDays(a.start,a.end)+'d)</div>').join(""):'<p style="color:var(--tx3)">No pending requests</p>'}
// ═══ KPIs ═══
if(!D.kpis)D.kpis={};// {month: {agentId: {qa,aht,unplanned,adherence,interactions,csat}}}
const KPI_METRICS=[{id:"qa",label:"QA Score",unit:"",color:"var(--pur)",target:85,dir:"high",fmt:v=>v.toFixed(1)},{id:"aht",label:"AHT",unit:"s",color:"var(--orn)",target:300,dir:"low",fmt:v=>Math.floor(v/60)+":"+String(Math.round(v%60)).padStart(2,"0")},{id:"unplanned",label:"Unplanned",unit:"",color:"var(--red)",target:1,dir:"low",fmt:v=>v.toFixed(0)},{id:"adherence",label:"Adherence",unit:"%",color:"var(--cyn)",target:90,dir:"high",fmt:v=>v.toFixed(1)+"%"},{id:"interactions",label:"Interactions",unit:"",color:"var(--grn)",target:800,dir:"high",fmt:v=>v.toFixed(0)},{id:"csat",label:"CSAT",unit:"",color:"var(--acc)",target:4.0,dir:"high",fmt:v=>v.toFixed(2)}];
function saveKPI(){const aid=document.getElementById("kpiAgent").value;const month=document.getElementById("kpiDataMonth").value;if(!aid||!month)return toast("Select agent and month","err");if(!D.kpis[month])D.kpis[month]={};D.kpis[month][aid]={qa:parseFloat(document.getElementById("kd_qa").value)||0,aht:parseFloat(document.getElementById("kd_aht").value)||0,unplanned:parseFloat(document.getElementById("kd_unplanned").value)||0,adherence:parseFloat(document.getElementById("kd_adherence").value)||0,interactions:parseFloat(document.getElementById("kd_interactions").value)||0,csat:parseFloat(document.getElementById("kd_csat").value)||0};save();renderKPIs();toast("KPI data saved")}
function renderKPIs(){const month=document.getElementById("kpiMonth")?.value||"2026-02";const data=D.kpis[month]||{};const agents=D.kpis[month]?Object.keys(data).map(id=>({id,...D.agents.find(a=>a.id===id)||{name:"Unknown"},...data[id]})):[];
  document.getElementById("kpiMonthLabel").textContent=month;
  // Summary cards
  const sumEl=document.getElementById("kpiSummary");let sh="";KPI_METRICS.forEach(m=>{const vals=agents.map(a=>a[m.id]||0).filter(v=>v>0);const avg=vals.length?vals.reduce((s,v)=>s+v,0)/vals.length:0;sh+='<div class="card"><div class="cb" style="text-align:center"><div style="font-size:9px;color:var(--tx2)">Avg '+m.label+'</div><div style="font-size:20px;font-weight:800;color:'+m.color+'">'+m.fmt(avg)+'</div><div style="font-size:8px;color:var(--tx3)">Target: '+(m.id==="aht"?m.fmt(m.target):m.target+m.unit)+'</div></div></div>'});sumEl.innerHTML=sh;
  // Agent table
  const tEl=document.getElementById("kpiTable");if(!agents.length){tEl.innerHTML='<p style="color:var(--tx3)">No data for this month. Click <b>+ Enter Data</b> to add.</p>';document.getElementById("kpiOutliers").innerHTML='<p style="color:var(--tx3)">Enter data to detect outliers</p>';document.getElementById("kpiTop").innerHTML='<p style="color:var(--tx3)">Enter data to see rankings</p>';document.getElementById("kpiActions").innerHTML='<p style="color:var(--tx3)">Enter data for recommendations</p>';return}
  let th='<table style="font-size:11px;width:100%"><thead><tr><th style="text-align:left">Agent</th>';KPI_METRICS.forEach(m=>th+='<th style="color:'+m.color+'">'+m.label+'</th>');th+='</tr></thead><tbody>';
  agents.forEach(a=>{th+='<tr><td style="text-align:left;font-size:10px;max-width:130px;overflow:hidden;text-overflow:ellipsis">'+a.name+'</td>';KPI_METRICS.forEach(m=>{const v=a[m.id]||0;const bad=m.dir==="high"?v<m.target*0.8:v>m.target*1.3;th+='<td style="font-family:var(--mono);font-size:10px;'+(bad?"color:var(--red);font-weight:700":"")+'">'+m.fmt(v)+'</td>'});th+='</tr>'});
  th+='<tr style="border-top:2px solid var(--brd);font-weight:700"><td style="text-align:left;color:var(--cyn)">TEAM AVG</td>';KPI_METRICS.forEach(m=>{const vals=agents.map(a=>a[m.id]||0).filter(v=>v>0);const avg=vals.length?vals.reduce((s,v)=>s+v,0)/vals.length:0;th+='<td style="font-family:var(--mono);font-size:10px;color:var(--cyn)">'+m.fmt(avg)+'</td>'});th+='</tr></tbody></table>';tEl.innerHTML=th;
  // Outliers
  const outliers=[];agents.forEach(a=>{const issues=[];KPI_METRICS.forEach(m=>{const v=a[m.id]||0;if(v===0)return;if(m.dir==="high"&&v<m.target*0.8)issues.push({metric:m.label,val:m.fmt(v),target:m.id==="aht"?m.fmt(m.target):m.target+m.unit,gap:"below"});if(m.dir==="low"&&v>m.target*1.3)issues.push({metric:m.label,val:m.fmt(v),target:m.id==="aht"?m.fmt(m.target):m.target+m.unit,gap:"above"})});if(issues.length)outliers.push({name:a.name,id:a.id,issues})});
  const oEl=document.getElementById("kpiOutliers");oEl.innerHTML=outliers.length?outliers.map(o=>'<div style="border-left:3px solid var(--red);padding:6px 10px;margin-bottom:6px;background:var(--s2);border-radius:0 4px 4px 0"><b style="font-size:12px">'+o.name+'</b>'+o.issues.map(i=>'<div style="font-size:10px;color:var(--red)">'+i.metric+': <b>'+i.val+'</b> (target: '+i.target+') — '+i.gap+'</div>').join("")+'</div>').join(""):'<p style="color:var(--grn)">No outliers — all agents within target range!</p>';
  // Top performers
  const ranked=[...agents].sort((a,b)=>(b.qa||0)-(a.qa||0));document.getElementById("kpiTop").innerHTML=ranked.slice(0,5).map((a,i)=>'<div class="ar"><span style="font-size:14px;min-width:24px">'+(i===0?"🥇":i===1?"🥈":i===2?"🥉":"#"+(i+1))+'</span><b style="font-size:11px;flex:1">'+a.name+'</b><span style="font-family:var(--mono);color:var(--pur);font-weight:700">QA: '+(a.qa||0).toFixed(1)+'</span></div>').join("");
  // Action plans
  const actEl=document.getElementById("kpiActions");const PLANS={qa:{course:"QA Fundamentals & Call Quality Workshop",action:"Schedule 1:1 QA coaching, review 5 calls together"},aht:{course:"Efficient Call Handling & Wrap-up Optimization",action:"Shadow top performer, practice concise summarization"},unplanned:{course:"Time Management & Attendance Awareness",action:"HR meeting, set attendance improvement plan"},adherence:{course:"Schedule Adherence & Time Management Training",action:"Daily adherence check-ins for 2 weeks"},interactions:{course:"Productivity & Efficiency Workshop",action:"Review idle time, optimize after-call work"},csat:{course:"Customer Experience & Empathy Training",action:"Role-play exercises, listen to top CSAT calls"}};
  if(outliers.length){actEl.innerHTML=outliers.map(o=>'<div class="card" style="margin-bottom:8px;border-left:3px solid var(--orn)"><div class="cb"><b style="font-size:12px">'+o.name+'</b>'+o.issues.map(i=>{const mid=KPI_METRICS.find(m=>m.label===i.metric)?.id||"";const plan=PLANS[mid]||{course:"General training",action:"Schedule coaching"};return'<div style="margin-top:4px;font-size:10px"><span style="color:var(--red)">'+i.metric+':</span> '+i.val+' → <span style="color:var(--orn)">&#128218; '+plan.course+'</span><br><span style="color:var(--tx3)">Action: '+plan.action+'</span></div>'}).join("")+'</div></div>').join("")}else{actEl.innerHTML='<p style="color:var(--grn)">All agents performing within targets. Consider advanced development programs.</p>'}
  // Populate agent select
  const sel=document.getElementById("kpiAgent");if(sel)sel.innerHTML=D.agents.map(a=>'<option value="'+a.id+'">'+a.name+'</option>').join("")}
// ═══ KNOWLEDGE BASE ═══
if(!D.kb)D.kb=[];
function addKBArticle(){const t=document.getElementById("kbTitle").value,c=document.getElementById("kbContent").value,cat=document.getElementById("kbNewCat").value;if(!t||!c)return toast("Fill title and content","err");D.kb.push({id:uid(),title:t,content:c,category:cat,createdAt:new Date().toISOString()});save();hideEl("kbAddForm");renderKB();toast("Article saved")}
function renderKB(){const el=document.getElementById("kbList");if(!el)return;const q=(document.getElementById("kbSearch")?.value||"").toLowerCase();const cat=document.getElementById("kbCat")?.value||"";let items=D.kb||[];if(q)items=items.filter(a=>a.title.toLowerCase().includes(q)||a.content.toLowerCase().includes(q));if(cat)items=items.filter(a=>a.category===cat);if(!items.length){el.innerHTML='<div class="emp" style="text-align:center"><span style="font-size:48px;opacity:.3">&#128214;</span><p style="margin-top:8px">No articles found.</p></div>';return}el.innerHTML=items.map(a=>'<div class="ar" style="border-left:3px solid var(--acc)"><div style="flex:1"><b style="font-size:13px">'+a.title+'</b><span class="tg" style="background:var(--s3);color:var(--tx2);margin-left:8px;font-size:9px">'+a.category+'</span><p style="font-size:11px;color:var(--tx2);margin-top:2px">'+a.content.slice(0,120)+(a.content.length>120?"...":"")+'</p></div><button class="btn bd bsm bic" onclick="delKB(\''+a.id+'\')">✕</button></div>').join("")}
function delKB(id){D.kb=D.kb.filter(x=>x.id!==id);save();renderKB()}
function kbAsk(){const inp=document.getElementById("kbChatIn");const q=inp.value.trim();if(!q)return;inp.value="";const log=document.getElementById("kbChatLog");log.innerHTML+='<div style="margin-bottom:6px"><b style="color:var(--acc)">You:</b> '+q+'</div>';
  const apiKey=document.getElementById("kbApiKey")?.value||localStorage.getItem("gpt_key")||"";
  const articles=(D.kb||[]).map(a=>a.title+": "+a.content).join("\n\n");
  if(apiKey&&apiKey.startsWith("sk-")){
    log.innerHTML+='<div style="margin-bottom:6px;color:var(--tx3)"><i>Thinking...</i></div>';log.scrollTop=log.scrollHeight;
    fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},body:JSON.stringify({model:"gpt-4o-mini",max_tokens:500,messages:[{role:"system",content:"You are a call center knowledge base assistant. Answer ONLY based on the following KB articles. If the answer is not in the articles, say so. Be concise and helpful.\n\nKB ARTICLES:\n"+articles},{role:"user",content:q}]})}).then(r=>r.json()).then(data=>{log.lastElementChild.remove();const ans=data.choices?.[0]?.message?.content||data.error?.message||"Error getting response";log.innerHTML+='<div style="margin-bottom:8px;padding:8px;background:var(--s2);border-radius:4px;border-left:3px solid var(--grn)"><b style="color:var(--grn)">AI:</b> '+ans.replace(/\n/g,"<br>")+'</div>';log.scrollTop=log.scrollHeight}).catch(e=>{log.lastElementChild.remove();log.innerHTML+='<div style="color:var(--red)">Error: '+e.message+'</div>';log.scrollTop=log.scrollHeight})
  }else{const results=(D.kb||[]).filter(a=>a.title.toLowerCase().includes(q.toLowerCase())||a.content.toLowerCase().includes(q.toLowerCase()));if(results.length){log.innerHTML+='<div style="margin-bottom:8px;padding:6px;background:var(--s2);border-radius:4px"><b style="color:var(--grn)">KB:</b> Found '+results.length+' article(s):<br>'+results.map(a=>'• <b>'+a.title+'</b>: '+a.content.slice(0,120)+'...').join("<br>")+'</div>'}else{log.innerHTML+='<div style="margin-bottom:8px;padding:6px;background:var(--s2);border-radius:4px"><b style="color:var(--orn)">KB:</b> No matching articles. Add a ChatGPT API key for AI-powered answers, or create more articles.</div>'}log.scrollTop=log.scrollHeight}}
function kbProcessFile(e){const file=e.target.files[0];if(!file)return;const ext=file.name.split(".").pop().toLowerCase();
  if(ext==="txt"||ext==="csv"){const reader=new FileReader();reader.onload=ev=>{const text=ev.target.result;if(ext==="csv"){const lines=text.split("\n").filter(l=>l.trim());const headers=lines[0];lines.slice(1).forEach((line,i)=>{if(line.trim())D.kb.push({id:uid(),title:file.name+" - Row "+(i+1),content:line.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(lines.length-1+" rows imported as KB articles")}else{const chunks=text.split(/\n\n+/).filter(c=>c.trim().length>20);if(chunks.length>1){chunks.forEach((chunk,i)=>{D.kb.push({id:uid(),title:file.name+" - Section "+(i+1),content:chunk.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(chunks.length+" sections imported")}else{document.getElementById("kbTitle").value=file.name.replace(/\.[^.]+$/,"");document.getElementById("kbContent").value=text;toast("File loaded — click Save Article")}}};reader.readAsText(file)}
  else if(ext==="xlsx"){const reader=new FileReader();reader.onload=ev=>{if(typeof XLSX==="undefined"){toast("XLSX library not loaded","err");return}const wb=XLSX.read(ev.target.result,{type:"array"});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{header:1});rows.forEach((row,i)=>{if(i===0||!row[0])return;D.kb.push({id:uid(),title:String(row[0]),content:row.slice(1).join(" | "),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast((rows.length-1)+" rows imported from Excel")};reader.readAsArrayBuffer(file)}
  else if(ext==="json"){const reader=new FileReader();reader.onload=ev=>{try{const data=JSON.parse(ev.target.result);if(Array.isArray(data)){data.forEach(item=>{D.kb.push({id:uid(),title:item.title||item.name||"Imported",content:JSON.stringify(item),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(data.length+" items imported")}else{document.getElementById("kbContent").value=JSON.stringify(data,null,2);toast("JSON loaded")}}catch(err){toast("Invalid JSON","err")}};reader.readAsText(file)}
  else if(ext==="docx"||ext==="doc"){const reader=new FileReader();reader.onload=ev=>{if(typeof mammoth==="undefined"){toast("Mammoth.js not loaded","err");return}mammoth.extractRawText({arrayBuffer:ev.target.result}).then(result=>{const text=result.value;const sections=text.split(/\n\n+/).filter(s=>s.trim().length>15);if(sections.length>1){sections.forEach((sec,i)=>{const title=sec.split("\n")[0].slice(0,80)||file.name+" - Section "+(i+1);D.kb.push({id:uid(),title:title,content:sec.trim(),category:"Technical",createdAt:new Date().toISOString()})});save();renderKB();toast(sections.length+" sections imported from "+file.name)}else{document.getElementById("kbTitle").value=file.name.replace(/\.[^.]+$/,"");document.getElementById("kbContent").value=text;toast("Word doc loaded — click Save Article")}}).catch(err=>toast("Error reading docx: "+err.message,"err"))};reader.readAsArrayBuffer(file)}
  else{toast("Unsupported file type. Use .docx, .txt, .csv, .xlsx, or .json","err")}}
// ═══ COACHING ═══
if(!D.coaching)D.coaching=[];
function addCoaching(){const aid=document.getElementById("coachAgent").value,type=document.getElementById("coachType").value,date=document.getElementById("coachDate").value,notes=document.getElementById("coachNotes").value,fup=document.getElementById("coachFup").checked;if(!aid)return toast("Select agent","err");const ag=D.agents.find(a=>a.id===aid);D.coaching.push({id:uid(),aid,name:ag?.name||"",type,date:date||new Date().toISOString().split("T")[0],notes,followUp:fup,status:fup?"Pending":"Done",createdAt:new Date().toISOString()});save();hideEl("coachForm");renderCoaching();toast("Session saved")}
function renderCoaching(){const el=document.getElementById("coachList");if(!el)return;const now=new Date();const month=now.getMonth();const yr=now.getFullYear();const total=D.coaching.length;const thisMonth=D.coaching.filter(c=>{const d=new Date(c.date);return d.getMonth()===month&&d.getFullYear()===yr}).length;const fups=D.coaching.filter(c=>c.followUp&&c.status==="Pending").length;document.getElementById("coachTotal").textContent=total;document.getElementById("coachMonth").textContent=thisMonth;document.getElementById("coachFollow").textContent=fups;if(!D.coaching.length){el.innerHTML='<p style="color:var(--tx3)">No coaching sessions yet.</p>';return}el.innerHTML=[...D.coaching].reverse().slice(0,20).map(c=>'<div class="ar" style="border-left:3px solid '+(c.followUp&&c.status==="Pending"?"var(--red)":"var(--grn)")+'"><b>'+c.name+'</b><span class="tg" style="background:var(--s3);color:var(--tx2);font-size:9px">'+c.type+'</span><span style="font-family:var(--mono);font-size:10px;color:var(--tx3)">'+c.date+'</span>'+(c.notes?'<span style="font-size:10px;color:var(--tx2)">'+c.notes.slice(0,60)+'</span>':'')+(c.followUp?'<span class="tg" style="background:#7f1d1d;color:#fca5a5;font-size:9px">Follow-up</span>':'')+'</div>').join("")}
// ═══ CONDUCT ═══
if(!D.incidents)D.incidents=[];
function addIncident(){const aid=document.getElementById("incAgent").value,sev=document.getElementById("incSev").value,type=document.getElementById("incType").value,desc=document.getElementById("incDesc").value;if(!aid||!desc)return toast("Fill agent and description","err");const ag=D.agents.find(a=>a.id===aid);D.incidents.push({id:uid(),aid,name:ag?.name||"",severity:sev,type,description:desc,status:"Open",createdAt:new Date().toISOString()});save();hideEl("incidentForm");renderIncidents();toast("Incident logged")}
function renderIncidents(){const el=document.getElementById("incList");if(!el)return;const open=D.incidents.filter(i=>i.status==="Open").length;const crit=D.incidents.filter(i=>i.severity==="Critical"&&i.status==="Open").length;const impr=D.incidents.filter(i=>i.status==="Improved").length;const rep=D.incidents.filter(i=>{const same=D.incidents.filter(j=>j.aid===i.aid);return same.length>1}).length;document.getElementById("condOpen").textContent=open;document.getElementById("condCrit").textContent=crit;document.getElementById("condImpr").textContent=impr;document.getElementById("condRep").textContent=rep;if(!D.incidents.length){el.innerHTML='<p style="color:var(--tx3)">No incidents recorded.</p>';return}el.innerHTML=[...D.incidents].reverse().map(i=>{const sevC={Low:"var(--grn)",Medium:"var(--orn)",High:"var(--red)",Critical:"#dc2626"}[i.severity]||"var(--tx3)";return'<div class="ar" style="border-left:3px solid '+sevC+'"><b>'+i.name+'</b><span class="tg" style="background:'+sevC+'20;color:'+sevC+';font-size:9px">'+i.severity+'</span><span class="tg" style="background:var(--s3);color:var(--tx2);font-size:9px">'+i.type+'</span><span style="font-size:10px;color:var(--tx2)">'+i.description.slice(0,60)+'</span><span style="font-family:var(--mono);font-size:9px;color:var(--tx3)">'+i.createdAt.split("T")[0]+'</span><select onchange="chIncStatus(\''+i.id+'\',this.value)" style="width:80px;font-size:9px;padding:2px"><option '+(i.status==="Open"?"selected":"")+'>Open</option><option '+(i.status==="In Progress"?"selected":"")+'>In Progress</option><option '+(i.status==="Improved"?"selected":"")+'>Improved</option><option '+(i.status==="Closed"?"selected":"")+'>Closed</option></select></div>'}).join("")}
function chIncStatus(id,st){const i=D.incidents.find(x=>x.id===id);if(i){i.status=st;save();renderIncidents()}}
} // end of admin mode init
</script>
</body>
</html>
